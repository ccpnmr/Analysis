<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.util.Bmrb.bmrb &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.util.Bmrb.bmrb</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python2</span>

<span class="sd">&quot;&quot;&quot;This module provides entry, saveframe, and loop objects. Use python&#39;s built in help function for documentation.</span>

<span class="sd">There are five module variables you can set to control our behavior.</span>

<span class="sd">*Setting bmrb.verbose to True will print some of what is going on to the terminal.</span>
<span class="sd">*Setting bmrb.raise_parse_warnings to true will raise an exception if the parser encounters something problematic. Normally warnings are suppressed.</span>
<span class="sd">*Setting skip_empty_loops to True will suppress the printing of empty loops when calling __str__ methods.</span>
<span class="sd">*Adding key-&gt;value pairs to str_conversion_dict will automatically convert tags whose value matches &quot;key&quot; to the string &quot;value&quot; when printing. This allows you to set the default conversion value for Booleans or other objects.</span>
<span class="sd">*Setting bmrb.allow_v2_entries will allow parsing of and printing of NMR-STAR version 2.1 entries. Most other methods will not operate correctly on parsed 2.1 entries. This is only to allow you parse and access the data in these entries - nothing else. Only set this if you have a really good reason to.</span>

<span class="sd">Some errors will be detected and exceptions raised, but this does not implement a full validator (at least at present).</span>

<span class="sd">Call directly (rather than importing) to run a self-test.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;entry&#39;</span><span class="p">,</span> <span class="s">&#39;saveframe&#39;</span><span class="p">,</span> <span class="s">&#39;loop&#39;</span><span class="p">,</span> <span class="s">&#39;schema&#39;</span><span class="p">,</span> <span class="s">&#39;diff&#39;</span><span class="p">,</span> <span class="s">&#39;validate&#39;</span><span class="p">,</span> <span class="s">&#39;PY3&#39;</span><span class="p">]</span>

<span class="c">#############################################</span>
<span class="c">#                 Imports                   #</span>
<span class="c">#############################################</span>

<span class="c"># Standard library imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c"># Determine if we are running in python3</span>
<span class="n">PY3</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

<span class="c"># Python version dependent loads</span>
<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">HTTPError</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span><span class="p">,</span> <span class="n">HTTPError</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
    <span class="n">BytesIO</span> <span class="o">=</span> <span class="n">StringIO</span>

<span class="c"># Local libraries</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Bmrb.sans</span> <span class="kn">import</span> <span class="n">STARLexer</span>
<span class="c"># from ccpn.util.Bmrb.sans import SansParser</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Bmrb.sans</span> <span class="kn">import</span> <span class="n">DicParser</span> <span class="k">as</span> <span class="n">SansParser</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Bmrb.sans</span> <span class="kn">import</span> <span class="n">ErrorHandler</span><span class="p">,</span> <span class="n">ContentHandler</span>

<span class="c">#############################################</span>
<span class="c">#            Global Variables               #</span>
<span class="c">#############################################</span>

<span class="c"># May be set by calling code</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">allow_v2_entries</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">raise_parse_warnings</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">skip_empty_loops</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># WARNING: str_conversion_dict cannot contain both booleans and </span>
<span class="c"># arithmetic types. Attempting to use both will cause an issue since </span>
<span class="c"># boolean True == 1 in python and False == 0.</span>
<span class="n">str_conversion_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">None</span><span class="p">:</span><span class="s">&quot;.&quot;</span> <span class="p">}</span>

<span class="c"># Used internally</span>
<span class="n">standard_schema</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c"># Get the svn revision number of this file</span>
<span class="n">svn_revision</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="s">&quot;$Revision: 9300 $&quot;</span><span class="p">))</span>

<span class="c">#############################################</span>
<span class="c">#             Module methods                #</span>
<span class="c">#############################################</span>

<span class="c"># Public use methods</span>

<span class="k">def</span> <span class="nf">enableNEFDefaults</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Sets the module variables such that our behavior matches the NEF standard. Specifically, suppress printing empty loops by default and convert True -&gt; &quot;true&quot; and False -&gt; &quot;false&quot; when printing.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">str_conversion_dict</span><span class="p">,</span> <span class="n">skip_empty_loops</span>
    <span class="n">str_conversion_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">None</span><span class="p">:</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">:</span><span class="s">&quot;true&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span><span class="s">&quot;false&quot;</span> <span class="p">}</span>
    <span class="n">skip_empty_loops</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">enableBMRBDefaults</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Sets the module variables such that our behavior matches the BMRB standard. This is the default behavior of this module. This method only exists to revert after calling enableNEFDefaults().&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">str_conversion_dict</span><span class="p">,</span> <span class="n">skip_empty_loops</span>
    <span class="n">str_conversion_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">None</span><span class="p">:</span><span class="s">&quot;.&quot;</span> <span class="p">}</span>
    <span class="n">skip_empty_loops</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="diff"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.diff">[docs]</a><span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">entry1</span><span class="p">,</span> <span class="n">entry2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints the differences between two entries. Non-equal entries will always be detected, but specific differences detected depends on order of entries.&quot;&quot;&quot;</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">entry1</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">entry2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Identical entries.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">difference</span> <span class="ow">in</span> <span class="n">diffs</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">difference</span><span class="p">)</span></div>

<div class="viewcode-block" id="validate"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.validate">[docs]</a><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints a validation report of an entry.&quot;&quot;&quot;</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;No problems found during validation.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">cleanValue</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Automatically quotes the value in the appropriate way. Don&#39;t quote values you send to this method or they will show up in another set of quotes as part of the actual data. E.g.:</span>

<span class="sd">    cleanValue(&#39;&quot;e. coli&quot;&#39;) returns &#39;\&#39;&quot;e. coli&quot;\&#39;&#39;</span>

<span class="sd">    while</span>

<span class="sd">    cleanValue(&quot;e. coli&quot;) returns &quot;&#39;e. coli&#39;&quot;</span>

<span class="sd">    This will automatically be called on all values when you use a str() method (so don&#39;t call it before inserting values into tags or loops).</span>

<span class="sd">    Be mindful of the value of str_conversion_dict as it will effect the way the value is converted to a string.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Allow manual specification of conversions for booleans, Nones, etc.</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">str_conversion_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">str_conversion_dict</span><span class="p">):</span>
            <span class="c"># The additional check prevents numerical types from being</span>
            <span class="c"># interpreted as booleans. This is PROVIDED the dictionary</span>
            <span class="c"># does not contain both numericals and booleans</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">str_conversion_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="c"># Convert non-string types to string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c"># If it&#39;s going on it&#39;s own line, don&#39;t touch it</span>
    <span class="k">if</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Empty strings are not allowed as values. Use a &#39;.&#39; or a &#39;?&#39; if needed.&quot;</span><span class="p">)</span>

    <span class="c"># Put tags with newlines on their own ; delimited line</span>
    <span class="k">if</span> <span class="s">&quot; &quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">value</span> \
     <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;data_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;save_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;loop_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;stop_&quot;</span><span class="p">))):</span>
        <span class="k">if</span> <span class="s">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="s">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="s">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="s">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">value</span>

    <span class="c"># It&#39;s good to go</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="c"># Internal use only methods</span>

<span class="k">def</span> <span class="nf">_formatCategory</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a &#39;_&#39; to the front of a tag (if not present) and strips out anything after a &#39;.&#39;&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_formatTag</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Strips anything before the &#39;.&#39;&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_getSchema</span><span class="p">(</span><span class="n">passed_schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If passed a schema (not None) it returns it. If passed none, it checks if the default schema has been initialized. If not initialzed, it initializes it. Then it returns the default schema.&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">standard_schema</span>
    <span class="k">if</span> <span class="n">passed_schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">passed_schema</span> <span class="o">=</span> <span class="n">standard_schema</span>
    <span class="k">if</span> <span class="n">passed_schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">standard_schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">()</span>
        <span class="n">passed_schema</span> <span class="o">=</span> <span class="n">standard_schema</span>

    <span class="k">return</span> <span class="n">passed_schema</span>

<span class="k">def</span> <span class="nf">_interpretFile</span><span class="p">(</span><span class="n">the_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper method returns some sort of object with a read() method. the_file could be a URL, a file location, a file object, or a gzipped version of any of the above.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">the_file</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">the_file</span><span class="p">,</span> <span class="s">&#39;readline&#39;</span><span class="p">):</span>
        <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">the_file</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">the_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;http://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">the_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;https://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">the_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;ftp://&quot;</span><span class="p">):</span>
            <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">the_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">the_file</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot figure out how to interpret the file you passed.&quot;</span><span class="p">)</span>

    <span class="c"># Decompress the buffer if we are looking at a gzipped file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gzip_buffer</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">star_buffer</span><span class="p">)</span>
        <span class="n">gzip_buffer</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">gzip_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">gzip_buffer</span>
    <span class="c"># Apparently we are not looking at a gzipped file</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnicodeDecodeError</span><span class="p">):</span>
        <span class="n">star_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="c"># If the type is still bytes, convert it to string for python3</span>
    <span class="n">full_star</span> <span class="o">=</span> <span class="n">star_buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">star_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PY3</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">full_star</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">full_star</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">star_buffer</span>

<span class="c">#############################################</span>
<span class="c">#                Classes                    #</span>
<span class="c">#############################################</span>

<span class="c"># Internal use class</span>
<span class="k">class</span> <span class="nc">_entryParser</span><span class="p">(</span><span class="n">ContentHandler</span><span class="p">,</span> <span class="n">ErrorHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses an entry directly using a SANS parser. You should not ever use this class directly.&quot;&quot;&quot;</span>
    <span class="n">ent</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">curframe</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">curloop</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You must provide an entry to parse into. Also, why are you using this class?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ent</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curloop</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Comment &#39;</span><span class="si">%s</span><span class="s">&#39; on line: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">startData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Data &#39;</span><span class="si">%s</span><span class="s">&#39; started on line: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ent</span><span class="o">.</span><span class="n">bmrb_id</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">endData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Data &#39;</span><span class="si">%s</span><span class="s">&#39; ended on line: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">startSaveframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Saveframe &#39;</span><span class="si">%s</span><span class="s">&#39; started on line: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="o">=</span> <span class="n">saveframe</span><span class="o">.</span><span class="n">fromScratch</span><span class="p">(</span><span class="n">saveframe_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ent</span><span class="o">.</span><span class="n">addSaveframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">endSaveframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Saveframe &#39;</span><span class="si">%s</span><span class="s">&#39; ended on line: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">startLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Loop started on line: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curloop</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">fromScratch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">addLoop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curloop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">endLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Loop ended on line: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curloop</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">tagline</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valline</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">inloop</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Tag / value: </span><span class="si">%s</span><span class="s"> : </span><span class="si">%s</span><span class="s"> ( </span><span class="si">%d</span><span class="s"> : </span><span class="si">%d</span><span class="s"> ) d </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tagline</span><span class="p">,</span> <span class="n">valline</span><span class="p">,</span> <span class="n">delim</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">delim</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;$&quot;</span><span class="o">+</span><span class="n">val</span>

        <span class="k">if</span> <span class="n">inloop</span> <span class="p">:</span>
            <span class="c"># Update the columns and then add the data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curloop</span><span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ignore_duplicates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># This is needed to determine when two columns have the same name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curloop</span><span class="o">.</span><span class="n">addDataByColumn</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s">&quot;You cannot add data out of column order.&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You cannot have two columns with the same name. Column name: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curframe</span><span class="o">.</span><span class="n">addTag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Parse error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fatalError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Fatal parse error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">raise_parse_warnings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span><span class="s">&quot;Parse warning: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Parse warning: </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>


<div class="viewcode-block" id="schema"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.schema">[docs]</a><span class="k">class</span> <span class="nc">schema</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A BMRB schema. Used to validate STAR files.&quot;&quot;&quot;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">schema_order</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">schema_file</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a BMRB schema. With no arguments the most up-to-date schema will be fetched from the BMRB FTP site. Otherwise pass a URL or a file to load a schema from using the schema_url or schema_file optional arguments.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">schema_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">schema_file</span> <span class="o">=</span> <span class="s">&#39;https://svn.bmrb.wisc.edu/svn/nmr-star-dictionary/bmrb_star_v3_files/adit_input/xlschem_ann.csv&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema_file</span> <span class="o">=</span> <span class="n">schema_file</span>

        <span class="n">schem_stream</span> <span class="o">=</span> <span class="n">_interpretFile</span><span class="p">(</span><span class="n">schema_file</span><span class="p">)</span>
        <span class="n">fix_newlines</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">schem_stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()))</span>

        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fix_newlines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">)</span>

        <span class="c"># Skip the header descriptions and header index values and anything else before the real data starts</span>
        <span class="k">while</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;TBL_BEGIN&quot;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>

            <span class="c"># Stop at the end</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;TBL_END&quot;</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">][:</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">42</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schema_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Detected invalid tag in schema: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return how we can be initialized.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;bmrb.schema(schema_file=&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Invalid BMRB schema.&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the schema that we are adhering to.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;BMRB schema loaded from: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;BMRB schema from ??? (If you see this you did something wrong.)&quot;</span>

<div class="viewcode-block" id="schema.valType"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.schema.valType">[docs]</a>    <span class="k">def</span> <span class="nf">valType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">linenum</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Tag &#39;</span><span class="si">%s</span><span class="s">&#39; not found in schema. Line &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">linenum</span><span class="p">)]</span>

        <span class="n">valtype</span><span class="p">,</span> <span class="n">null_allowed</span><span class="p">,</span> <span class="n">allowed_category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">category</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">category</span> <span class="o">!=</span> <span class="n">allowed_category</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&quot;The tag &#39;</span><span class="si">%s</span><span class="s">&#39; in category &#39;</span><span class="si">%s</span><span class="s">&#39; should be in category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">allowed_category</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">null_allowed</span> <span class="o">==</span> <span class="s">&quot;NOT NULL&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Value cannot be NULL but is: &#39;</span><span class="si">%s</span><span class="s">&#39;:&#39;</span><span class="si">%s</span><span class="s">&#39; on line &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">linenum</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s">&quot;VARCHAR&quot;</span> <span class="ow">in</span> <span class="n">valtype</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valtype</span><span class="p">[</span><span class="n">valtype</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">valtype</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Length of value &#39;</span><span class="si">%d</span><span class="s">&#39; is too long for VARCHAR(</span><span class="si">%d</span><span class="s">): &#39;</span><span class="si">%s</span><span class="s">&#39;:&#39;</span><span class="si">%s</span><span class="s">&#39; on line &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">linenum</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="s">&quot;CHAR&quot;</span> <span class="ow">in</span> <span class="n">valtype</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valtype</span><span class="p">[</span><span class="n">valtype</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">valtype</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Length of value &#39;</span><span class="si">%d</span><span class="s">&#39; is too long for CHAR(</span><span class="si">%d</span><span class="s">): &#39;</span><span class="si">%s</span><span class="s">&#39;:&#39;</span><span class="si">%s</span><span class="s">&#39; on line &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">linenum</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="s">&quot;FLOAT&quot;</span> <span class="ow">in</span> <span class="n">valtype</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Value is not of type FLOAT.:&#39;</span><span class="si">%s</span><span class="s">&#39;:&#39;</span><span class="si">%s</span><span class="s">&#39; on line &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">linenum</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="s">&quot;INTEGER&quot;</span> <span class="ow">in</span> <span class="n">valtype</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&quot;Value is not of type INTEGER.:&#39;</span><span class="si">%s</span><span class="s">&#39;:&#39;</span><span class="si">%s</span><span class="s">&#39; on line &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">linenum</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>

<div class="viewcode-block" id="entry"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry">[docs]</a><span class="k">class</span> <span class="nc">entry</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An OO representation of a BMRB entry. You can initialize this object several ways; (e.g. from a file, from the official database, from scratch) see the classmethods.&quot;&quot;&quot;</span>

    <span class="c"># Put these here for reference</span>
    <span class="n">bmrb_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">frame_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the indicated saveframe.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">saveframe</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this entry is equal to another entry, false if it is not equal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the indicated saveframe.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSaveframeByName</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Don&#39;t use this directly, use fromFile, fromScratch, fromString, or fromDatabase to construct.&quot;&quot;&quot;</span>

        <span class="c"># They initialized us wrong</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You must provide either a BMRB ID, a file name, an entry number, or a string to initialize. Use the class methods.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You cannot provide multiple optional arguments. Use the class methods instead of initializing directly.&quot;</span><span class="p">)</span>

        <span class="c"># Initialize our local variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s">&#39;the_string&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="c"># Parse from a string by wrapping it in StringIO</span>
            <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;the_string&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;file_name&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">_interpretFile</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;file_name&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;entry_num&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="c"># Parse from the official BMRB library</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                    <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;http://rest.bmrb.wisc.edu/bmrb/NMR-STAR3/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kargs</span><span class="p">[</span><span class="s">&#39;entry_num&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;http://rest.bmrb.wisc.edu/bmrb/NMR-STAR3/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kargs</span><span class="p">[</span><span class="s">&#39;entry_num&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Entry &#39;</span><span class="si">%s</span><span class="s">&#39; does not exist in the public database.&quot;</span> <span class="o">%</span> <span class="n">kargs</span><span class="p">[</span><span class="s">&#39;entry_num&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Initialize a blank entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bmrb_id</span> <span class="o">=</span> <span class="n">kargs</span><span class="p">[</span><span class="s">&#39;bmrb_id&#39;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c"># Load the BMRB entry from the file</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_entryParser</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">SansParser</span><span class="o">.</span><span class="n">parser</span><span class="p">(</span><span class="n">STARLexer</span><span class="p">(</span><span class="n">star_buffer</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if this entry is less than another entry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmrb_id</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">bmrb_id</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a description of the entry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;&lt;bmrb.entry &#39;</span><span class="si">%s</span><span class="s">&#39;&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmrb_id</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the indicated saveframe.&quot;&quot;&quot;</span>

        <span class="c"># It is a saveframe</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">saveframe</span><span class="p">):</span>
            <span class="c"># Add by ordinal</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c"># Add by key</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameDict</span><span class="p">():</span>
                    <span class="nb">dict</span><span class="p">((</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Saveframe with name &#39;</span><span class="si">%s</span><span class="s">&#39; does not exist and therefore cannot be written to. Use the addSaveframe method to add new saveframes.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You can only assign an entry to a saveframe splice.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the entire entry in STAR format as a string.&quot;&quot;&quot;</span>
        <span class="n">ret_string</span> <span class="o">=</span> <span class="s">&quot;data_</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmrb_id</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">:</span>
            <span class="n">ret_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">ret_string</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="entry.fromFile"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.fromFile">[docs]</a>    <span class="k">def</span> <span class="nf">fromFile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">the_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an entry by loading in a file. If the_file starts with http://, https://, or ftp:// then we will use those protocols to attempt to open the file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">the_file</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="entry.fromDatabase"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.fromDatabase">[docs]</a>    <span class="k">def</span> <span class="nf">fromDatabase</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">entry_num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an entry corresponding to the most up to date entry on the public BMRB server. (Requires ability to initiate outbound HTTP connections.)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">entry_num</span><span class="o">=</span><span class="n">entry_num</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="entry.fromString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.fromString">[docs]</a>    <span class="k">def</span> <span class="nf">fromString</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">the_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an entry by parsing a string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">the_string</span><span class="o">=</span><span class="n">the_string</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="entry.fromScratch"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.fromScratch">[docs]</a>    <span class="k">def</span> <span class="nf">fromScratch</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">bmrb_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an empty entry that you can programatically add to. You must pass a number corresponding to the BMRB ID. If this is not a &quot;real&quot; BMRB entry, use 0 as the BMRB ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">bmrb_id</span><span class="o">=</span><span class="n">bmrb_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="entry.addSaveframe"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.addSaveframe">[docs]</a>    <span class="k">def</span> <span class="nf">addSaveframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a saveframe to the entry.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">saveframe</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You can only add instances of saveframes using this method.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></div>

<div class="viewcode-block" id="entry.compare"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the differences between two entries as a list. Otherwise returns 1 if different and 0 if equal. Non-equal entries will always be detected, but specific differences detected depends on order of entries.&quot;&quot;&quot;</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&#39;String was not exactly equal to entry.&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bmrb_id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bmrb_id</span><span class="p">):</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;BMRB ID does not match between entries: &#39;</span><span class="si">%s</span><span class="s">&#39; vs &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bmrb_id</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">bmrb_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">frame_list</span><span class="p">):</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;The number of saveframes in the entries are not equal: &#39;</span><span class="si">%d</span><span class="s">&#39; vs &#39;</span><span class="si">%d</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">frame_list</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameDict</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">frameDict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;No saveframe with name &#39;</span><span class="si">%s</span><span class="s">&#39; in other entry.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameDict</span><span class="p">()[</span><span class="n">frame</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameDict</span><span class="p">()[</span><span class="n">frame</span><span class="p">]</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">frameDict</span><span class="p">()[</span><span class="n">frame</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Saveframes do not match: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameDict</span><span class="p">()[</span><span class="n">frame</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">diffs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;An exception occured while comparing: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">diffs</span></div>

<div class="viewcode-block" id="entry.frameDict"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.frameDict">[docs]</a>    <span class="k">def</span> <span class="nf">frameDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of saveframe name -&gt; saveframe object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="entry.getLoopsByCategory"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.getLoopsByCategory">[docs]</a>    <span class="k">def</span> <span class="nf">getLoopsByCategory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allows fetching loops by category.&quot;&quot;&quot;</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="entry.getSaveframeByName"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.getSaveframeByName">[docs]</a>    <span class="k">def</span> <span class="nf">getSaveframeByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allows fetching a saveframe by name.&quot;&quot;&quot;</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">frames</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;No saveframe with name &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">frame</span><span class="p">)</span></div>

<div class="viewcode-block" id="entry.getSaveframesByCategory"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.getSaveframesByCategory">[docs]</a>    <span class="k">def</span> <span class="nf">getSaveframesByCategory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allows fetching saveframes by category.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSaveframesByTagAndValue</span><span class="p">(</span><span class="s">&quot;sf_category&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="entry.getSaveframesByTagAndValue"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.getSaveframesByTagAndValue">[docs]</a>    <span class="k">def</span> <span class="nf">getSaveframesByTagAndValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allows fetching saveframe(s) by tag and tag value.&quot;&quot;&quot;</span>

        <span class="n">ret_frames</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">results</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">ret_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret_frames</span></div>

<div class="viewcode-block" id="entry.getTag"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.getTag">[docs]</a>    <span class="k">def</span> <span class="nf">getTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">whole_tag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Given a tag (E.g. _Assigned_chem_shift_list.Data_file_name) return a list of all values for that tag. Specify whole_tag=True and the [tag_name, tag_value] pair will be returned.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_v2_entries</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You must provide the tag category to call this method at the entry level.&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_list</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">whole_tag</span><span class="o">=</span><span class="n">whole_tag</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="entry.nefString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.nefString">[docs]</a>    <span class="k">def</span> <span class="nf">nefString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a string representation of the entry in NEF. &quot;&quot;&quot;</span>

        <span class="c"># Store the current values of these module variables</span>
        <span class="k">global</span> <span class="n">str_conversion_dict</span><span class="p">,</span> <span class="n">skip_empty_loops</span>
        <span class="n">tmp_dict</span><span class="p">,</span> <span class="n">tmp_loops_state</span> <span class="o">=</span> <span class="n">str_conversion_dict</span><span class="p">,</span> <span class="n">skip_empty_loops</span>

        <span class="c"># Change to NEF defaults and get the string representation</span>
        <span class="n">enableNEFDefaults</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># Revert module variables</span>
        <span class="n">str_conversion_dict</span><span class="p">,</span> <span class="n">skip_empty_loops</span> <span class="o">=</span> <span class="n">tmp_dict</span><span class="p">,</span> <span class="n">tmp_loops_state</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="entry.printTree"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.printTree">[docs]</a>    <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints a summary, tree style, of the frames and loops in the entry.&quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[</span><span class="si">%d</span><span class="s">] </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">frame</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">loop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">[</span><span class="si">%d</span><span class="s">] </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos2</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">loop</span><span class="p">)))</span></div>

<div class="viewcode-block" id="entry.validate"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.entry.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate an entry against a STAR schema. You can pass your own custom schema if desired, otherwise the schema will be fetched from the BMRB servers. Returns a list of errors found. 0-length list indicates no errors found.&quot;&quot;&quot;</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">validation_schema</span><span class="o">=</span><span class="n">validation_schema</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errors</span></div></div>

<div class="viewcode-block" id="saveframe"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe">[docs]</a><span class="k">class</span> <span class="nc">saveframe</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A saveframe. Use the classmethod fromScratch to create one.&quot;&quot;&quot;</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">loops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">tag_prefix</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the indicated tag or loop.&quot;&quot;&quot;</span>

        <span class="c"># If they specify the specific loop to delete, go ahead and delete it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span>
            <span class="k">return</span>

        <span class="c"># See if the result of get(item) is a loop. If so, delete it (calls this method recursively)</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_delete</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># It must be a tag. Try to delete the tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deleteTag</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this saveframe is equal to another saveframem, False if it is equal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the indicated loop or tag.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">results</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loopDict</span><span class="p">()[</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;No tag or loop matching &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of loops in this saveframe.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this saveframe sorts lower than the compared saveframe, false otherwise. The alphabetical ordering of the saveframe category is used to perform the comparison.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">tag_prefix</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Don&#39;t use this directly. Use the class methods to construct.&quot;&quot;&quot;</span>

        <span class="c"># They initialized us wrong</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Use the class methods to initialize.&quot;</span><span class="p">)</span>

        <span class="c"># Initialize our local variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s">&#39;the_string&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="c"># Parse from a string by wrapping it in StringIO</span>
            <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;the_string&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;file_name&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">_interpretFile</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;file_name&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;saveframe_name&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="c"># If they are creating from scratch, just get the saveframe name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kargs</span><span class="p">[</span><span class="s">&#39;saveframe_name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;tag_prefix&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;tag_prefix&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="c"># If we are reading from a CSV file, go ahead and parse it</span>
        <span class="k">if</span> <span class="s">&#39;csv&#39;</span> <span class="ow">in</span> <span class="n">kargs</span> <span class="ow">and</span> <span class="n">kargs</span><span class="p">[</span><span class="s">&#39;csv&#39;</span><span class="p">]:</span>
            <span class="n">csvreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">star_buffer</span><span class="p">)</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csvreader</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csvreader</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Your CSV data is invalid. The header length does not match the data length.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addTag</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="s">&quot;data_1</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="n">star_buffer</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">tmp_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">fromScratch</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Load the BMRB entry from the file</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_entryParser</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="n">tmp_entry</span><span class="p">)</span>
        <span class="n">SansParser</span><span class="o">.</span><span class="n">parser</span><span class="p">(</span><span class="n">STARLexer</span><span class="p">(</span><span class="n">star_buffer</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="c"># Copy the first parsed saveframe into ourself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tmp_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="n">tmp_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">tmp_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="o">=</span> <span class="n">tmp_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag_prefix</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="saveframe.fromScratch"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.fromScratch">[docs]</a>    <span class="k">def</span> <span class="nf">fromScratch</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">saveframe_name</span><span class="p">,</span> <span class="n">tag_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an empty saveframe that you can programatically add to. You may also pass the tag prefix as the second argument. If you do not pass the tag prefix it will be set the first time you add a tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">saveframe_name</span><span class="o">=</span><span class="n">saveframe_name</span><span class="p">,</span> <span class="n">tag_prefix</span><span class="o">=</span><span class="n">tag_prefix</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="saveframe.fromFile"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.fromFile">[docs]</a>    <span class="k">def</span> <span class="nf">fromFile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">the_file</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a saveframe by loading in a file. Specify csv=True is the file is a CSV file. If the_file starts with http://, https://, or ftp:// then we will use those protocols to attempt to open the file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">the_file</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="saveframe.fromString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.fromString">[docs]</a>    <span class="k">def</span> <span class="nf">fromString</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">the_string</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a saveframe by parsing a string. Specify csv=True is the string is in CSV format and not NMR-STAR format.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">the_string</span><span class="o">=</span><span class="n">the_string</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a description of the saveframe.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;&lt;bmrb.saveframe &#39;</span><span class="si">%s</span><span class="s">&#39;&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the indicated loop or tag.&quot;&quot;&quot;</span>

        <span class="c"># It&#39;s a loop</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">integer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">integer</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loopDict</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">tmp_loop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">tmp_loop</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Loop with category &#39;</span><span class="si">%s</span><span class="s">&#39; does not exist and therefore cannot be written to. Use addLoop instead.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If the tag already exists, set its value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addTag</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the saveframe in STAR format as a string.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">allow_v2_entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The tag prefix was never set!&quot;</span><span class="p">)</span>

            <span class="c"># Make sure this isn&#39;t a dummy saveframe before proceeding</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">save_</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">save_</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c"># Print the saveframe</span>
        <span class="n">ret_string</span> <span class="o">=</span> <span class="s">&quot;save_</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">pstring</span> <span class="o">=</span> <span class="s">&quot;   </span><span class="si">%%</span><span class="s">-</span><span class="si">%d</span><span class="s">s  </span><span class="si">%%</span><span class="s">s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">width</span>
        <span class="n">mstring</span> <span class="o">=</span> <span class="s">&quot;   </span><span class="si">%%</span><span class="s">-</span><span class="si">%d</span><span class="s">s</span><span class="se">\n</span><span class="s">;</span><span class="se">\n</span><span class="si">%%</span><span class="s">s;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">width</span>

        <span class="c"># Print the tags</span>
        <span class="k">for</span> <span class="n">each_tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">cleanTag</span> <span class="o">=</span> <span class="n">cleanValue</span><span class="p">(</span><span class="n">each_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">allow_v2_entries</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">cleanTag</span><span class="p">:</span>
                    <span class="n">ret_string</span> <span class="o">+=</span>  <span class="n">mstring</span> <span class="o">%</span> <span class="p">(</span><span class="n">each_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cleanTag</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_string</span> <span class="o">+=</span>  <span class="n">pstring</span> <span class="o">%</span> <span class="p">(</span><span class="n">each_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cleanTag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">cleanTag</span><span class="p">:</span>
                    <span class="n">ret_string</span> <span class="o">+=</span>  <span class="n">mstring</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">each_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cleanTag</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_string</span> <span class="o">+=</span>  <span class="n">pstring</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="n">each_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cleanTag</span><span class="p">)</span>

        <span class="c"># Print any loops</span>
        <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="n">ret_string</span> <span class="o">+=</span>  <span class="nb">str</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

        <span class="c"># Close the saveframe</span>
        <span class="n">ret_string</span> <span class="o">+=</span> <span class="s">&quot;save_</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">ret_string</span>

<div class="viewcode-block" id="saveframe.addLoop"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.addLoop">[docs]</a>    <span class="k">def</span> <span class="nf">addLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a loop to the saveframe loops.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loopDict</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loopDict</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You cannot have two loops with the same category in one saveframe. You are getting this error because you haven&#39;t yet set your loop categories.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You cannot have two loops with the same category in one saveframe. Category: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.addTag"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.addTag">[docs]</a>    <span class="k">def</span> <span class="nf">addTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a tag to the tag list. Does a bit of validation and parsing. Set update to true to update a tag if it exists rather than raise an exception.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="o">!=</span> <span class="n">prefix</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;One saveframe cannot have tags with different categories (or tags that don&#39;t match the set category)! &#39;</span><span class="si">%s</span><span class="s">&#39; vs &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c"># No duplicate tags</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;There is already a tag with the name &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">whole_tag</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;There cannot be more than one &#39;.&#39; in a tag name.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot; &quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Tag names can not contain spaces.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Adding tag: &#39;</span><span class="si">%s</span><span class="s">&#39; with value &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">])</span></div>

<div class="viewcode-block" id="saveframe.addTags"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.addTags">[docs]</a>    <span class="k">def</span> <span class="nf">addTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_list</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds multiple tags to the list. Input should be a list of tuples that are either [key, value] or [key]. In the latter case the value will be set to &quot;.&quot;.  Set update to true to update a tag if it exists rather than raise an exception.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tag_pair</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_pair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addTag</span><span class="p">(</span><span class="n">tag_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_pair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addTag</span><span class="p">(</span><span class="n">tag_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You provided an invalid tag/value to add: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">tag_pair</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.compare"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the differences between two saveframes as a list. Non-equal saveframes will always be detected, but specific differences detected depends on order of saveframes.&quot;&quot;&quot;</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Check if this is literally the same object</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c"># Check if the other object is our string representation</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&#39;String was not exactly equal to saveframe.&#39;</span><span class="p">]</span>
        <span class="c"># Do STAR comparison</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="c"># No point comparing apples to oranges. If the tags are this different just return</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Saveframe names do not match: &#39;</span><span class="si">%s</span><span class="s">&#39; vs &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">diffs</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">):</span>
                <span class="c"># No point comparing apples to oranges. If the tags are this different just return</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Tag prefix does not match: &#39;</span><span class="si">%s</span><span class="s">&#39; vs &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">diffs</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Number of tags does not match: &#39;</span><span class="si">%d</span><span class="s">&#39; vs &#39;</span><span class="si">%d</span><span class="s">&#39;. The compared entry has at least one tag this entry does not.&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tags</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>

                <span class="n">other_tag</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">other_tag</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">No tag with name &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39; in compared entry.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">other_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Mismatched tag values for tag &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;: &#39;</span><span class="si">%s</span><span class="s">&#39; vs &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">other_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">))</span> <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">loops</span><span class="p">):</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Number of children loops does not match: &#39;</span><span class="si">%d</span><span class="s">&#39; vs &#39;</span><span class="si">%d</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">loops</span><span class="p">)))</span>

            <span class="n">compare_loop_dict</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">loopDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">compare_loop_dict</span><span class="p">:</span>
                    <span class="n">compare</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">compare_loop_dict</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Loops do not match: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span> <span class="p">)</span>
                        <span class="n">diffs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">No loop with category &#39;</span><span class="si">%s</span><span class="s">&#39; in other entry.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">An exception occured while comparing: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">diffs</span></div>

<div class="viewcode-block" id="saveframe.deleteTag"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.deleteTag">[docs]</a>    <span class="k">def</span> <span class="nf">deleteTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes a tag from the saveframe based on tag name.&quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">position</span><span class="p">,</span><span class="n">each_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
            <span class="c"># If the tag is a match, remove it</span>
            <span class="k">if</span> <span class="n">each_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;There is no tag with name &#39;</span><span class="si">%s</span><span class="s">&#39; to remove.&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.getDataAsCSV"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.getDataAsCSV">[docs]</a>    <span class="k">def</span> <span class="nf">getDataAsCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show_category</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the data contained in the loops, properly CSVd, as a string. Set header to False omit the header. Set show_category to False to omit the loop category from the headers.&quot;&quot;&quot;</span>
        <span class="n">csv_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">cwriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show_category</span><span class="p">:</span>
                <span class="n">cwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">])</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each_tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">cwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">csv_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">csv_buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.getLoopByCategory"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.getLoopByCategory">[docs]</a>    <span class="k">def</span> <span class="nf">getLoopByCategory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a loop based on the loop name (category).&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">loop</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;No loop with category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.getTag"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.getTag">[docs]</a>    <span class="k">def</span> <span class="nf">getTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">whole_tag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allows fetching the value of a tag by tag name. Specify whole_tag=True and the [tag_name, tag_value] pair will be returned.&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Make sure this is the correct saveframe if they specify a tag prefix</span>
        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">tag_prefix</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span>

        <span class="c"># Check the loops</span>
        <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tag_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">or</span> <span class="n">allow_v2_entries</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">whole_tag</span><span class="o">=</span><span class="n">whole_tag</span><span class="p">))</span>

        <span class="c"># Check our tags</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tag_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tag_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">or</span> <span class="n">allow_v2_entries</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">whole_tag</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="saveframe.loopDict"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.loopDict">[docs]</a>    <span class="k">def</span> <span class="nf">loopDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a hash of loop category -&gt; loop.&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">category</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="saveframe.loopIterator"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.loopIterator">[docs]</a>    <span class="k">def</span> <span class="nf">loopIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an iterator for saveframe loops.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.setTagPrefix"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.setTagPrefix">[docs]</a>    <span class="k">def</span> <span class="nf">setTagPrefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the tag prefix for this saveframe.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">tag_prefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.sortTags"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.sortTags">[docs]</a>    <span class="k">def</span> <span class="nf">sortTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sort the tags so they are in the same order as a BMRB schema. Will automatically use the standard schema if none is provided.&quot;&quot;&quot;</span>

        <span class="n">new_tag_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">_getSchema</span><span class="p">(</span><span class="n">validation_schema</span><span class="p">)</span><span class="o">.</span><span class="n">schema_order</span><span class="p">:</span>
            <span class="c"># Only proceed if it has the same category as us</span>
            <span class="k">if</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">check</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">tag_name</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
                <span class="c"># If we currently have the tag, add it to the new tag list</span>
                <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">whole_tag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">existing</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">new_tag_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tag_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Refusing to sort. There are tags in the saveframe that do not exist in the schema.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">new_tag_list</span></div>

<div class="viewcode-block" id="saveframe.tagIterator"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.tagIterator">[docs]</a>    <span class="k">def</span> <span class="nf">tagIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an iterator for saveframe tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveframe.printTree"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.printTree">[docs]</a>    <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints a summary, tree style, of the loops in the saveframe.&quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">loop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[</span><span class="si">%d</span><span class="s">] </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span> <span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">loop</span><span class="p">)))</span></div>

<div class="viewcode-block" id="saveframe.validate"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.saveframe.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a saveframe against a STAR schema. You can pass your own custom schema if desired, otherwise the schema will be fetched from the BMRB servers. Returns a list of errors found. 0-length list indicates no errors found.&quot;&quot;&quot;</span>

        <span class="c"># Get the default schema if we are not passed a schema</span>
        <span class="n">my_schema</span> <span class="o">=</span> <span class="n">_getSchema</span><span class="p">(</span><span class="n">validation_schema</span><span class="p">)</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">my_schema</span><span class="o">.</span><span class="n">valType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_prefix</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s">&quot;Sf_category&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linenum</span><span class="o">=</span><span class="n">pos</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">validation_schema</span><span class="o">=</span><span class="n">validation_schema</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="s">&quot;Sf_category&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">errors</span></div></div>

<div class="viewcode-block" id="loop"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop">[docs]</a><span class="k">class</span> <span class="nc">loop</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A BMRB loop object.&quot;&quot;&quot;</span>

    <span class="n">category</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this loop is equal to another loop, False if it is different.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the indicated row from the data array.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the classmethods to initialize.&quot;&quot;&quot;</span>

        <span class="c"># Initialize our local variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Update our category if provided</span>
        <span class="k">if</span> <span class="s">&#39;category&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="c"># They initialized us wrong</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Use the class methods to initialize.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;the_string&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="c"># Parse from a string by wrapping it in StringIO</span>
            <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;the_string&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;file_name&#39;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">_interpretFile</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s">&#39;file_name&#39;</span><span class="p">])</span>

        <span class="c"># If we are reading from a CSV file, go ahead and parse it</span>
        <span class="k">if</span> <span class="s">&#39;csv&#39;</span> <span class="ow">in</span> <span class="n">kargs</span> <span class="ow">and</span> <span class="n">kargs</span><span class="p">[</span><span class="s">&#39;csv&#39;</span><span class="p">]:</span>
            <span class="n">csvreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">star_buffer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">csvreader</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csvreader</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addData</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">star_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="s">&quot;data_0</span><span class="se">\n</span><span class="s">save_internaluseyoushouldntseethis_frame</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">star_buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;save_&quot;</span><span class="p">)</span>
        <span class="n">tmp_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">fromScratch</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Load the BMRB entry from the file</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_entryParser</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="n">tmp_entry</span><span class="p">)</span>
        <span class="n">SansParser</span><span class="o">.</span><span class="n">parser</span><span class="p">(</span><span class="n">STARLexer</span><span class="p">(</span><span class="n">star_buffer</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="c"># Copy the first parsed saveframe into ourself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">tmp_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tmp_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">tmp_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">category</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of rows of data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this loop sorts lower than the compared loop, false otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">category</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a description of the loop.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">allow_v2_entries</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">common</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">):</span>
                <span class="n">common</span> <span class="o">=</span> <span class="n">common</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">common</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">common</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span>
            <span class="k">return</span> <span class="s">&quot;&lt;bmrb.loop &#39;</span><span class="si">%s</span><span class="s">&#39;&gt;&quot;</span> <span class="o">%</span> <span class="n">common</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&lt;bmrb.loop &#39;</span><span class="si">%s</span><span class="s">&#39;&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the loop in STAR format as a string.&quot;&quot;&quot;</span>

        <span class="c"># Check if there is any data in this loop</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># They do not want us to print empty loops</span>
            <span class="k">if</span> <span class="n">skip_empty_loops</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># If we have no columns than return the empty loop</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">   loop_</span><span class="se">\n\n</span><span class="s">   stop_</span><span class="se">\n</span><span class="s">&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Impossible to print data if there are no associated tags. Loop: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>

        <span class="c"># Make sure that if there is data, it is the same width as the column tags</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="c"># if row[0][0] in (&#39;.&#39;,&#39;1&#39;):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The number of column tags must match width of the data. Loop: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>

        <span class="c"># Start the loop</span>
        <span class="n">ret_string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">   loop_</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="c"># Print the columns</span>
        <span class="n">pstring</span> <span class="o">=</span> <span class="s">&quot;      </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;</span>


        <span class="c"># Check to make sure our category is set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_v2_entries</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The category was never set for this loop. Either add a column with the category intact, specify it when generating the loop, or set it using setCategory.&quot;</span><span class="p">)</span>

        <span class="c"># Print the categories</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">ret_string</span> <span class="o">+=</span> <span class="n">pstring</span> <span class="o">%</span> <span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">ret_string</span> <span class="o">+=</span> <span class="n">pstring</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">column</span><span class="p">)</span>

        <span class="n">ret_string</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># The nightmare below creates a list of the maximum length of elements in each column in the self.data matrix</span>
            <span class="c">#  Don&#39;t try to understand it. It&#39;s an imcomprehensible list comprehension.</span>
            <span class="n">title_widths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">+</span><span class="mi">3</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]]</span>
            <span class="c"># Generate the format string</span>
            <span class="n">pstring</span> <span class="o">=</span> <span class="s">&quot;     &quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%-*s</span><span class="s">&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; </span><span class="se">\n</span><span class="s">&quot;</span>

            <span class="c"># Print the data, with the columns sized appropriately</span>
            <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>

                <span class="c"># Put quotes as needed on the data</span>
                <span class="n">datum</span> <span class="o">=</span> <span class="p">[</span><span class="n">cleanValue</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">datum</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datum</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                        <span class="n">datum</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">;</span><span class="se">\n</span><span class="si">%s</span><span class="s">;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">item</span>

                <span class="c"># Print the data (combine the columns widths with their data)</span>
                <span class="n">ret_string</span> <span class="o">+=</span> <span class="n">pstring</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">title_widths</span><span class="p">,</span> <span class="n">datum</span><span class="p">)]))</span>

        <span class="c"># Close the loop</span>
        <span class="n">ret_string</span> <span class="o">+=</span> <span class="s">&quot;   stop_</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">ret_string</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="loop.fromFile"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.fromFile">[docs]</a>    <span class="k">def</span> <span class="nf">fromFile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">the_file</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a saveframe by loading in a file. Specify csv=True is the file is a CSV file. If the_file starts with http://, https://, or ftp:// then we will use those protocols to attempt to open the file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">the_file</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="loop.fromScratch"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.fromScratch">[docs]</a>    <span class="k">def</span> <span class="nf">fromScratch</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an empty saveframe that you can programatically add to. You may also pass the tag prefix as the second argument. If you do not pass the tag prefix it will be set the first time you add a tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="loop.fromString"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.fromString">[docs]</a>    <span class="k">def</span> <span class="nf">fromString</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">the_string</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a saveframe by parsing a string. Specify csv=True is the string is in CSV format and not NMR-STAR format.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">the_string</span><span class="o">=</span><span class="n">the_string</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="n">csv</span><span class="p">)</span></div>

<div class="viewcode-block" id="loop.addColumn"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.addColumn">[docs]</a>    <span class="k">def</span> <span class="nf">addColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ignore_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a column to the column list. Does a bit of validation and parsing. Set ignore_duplicates to true to ignore attempts to add the same tag more than once rather than raise an exception.</span>

<span class="sd">        You can also pass a list of column names to add more than one column at a time.&quot;&quot;&quot;</span>

        <span class="c"># If they have passed multiple columns to add, call ourself on each of them in succession</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ignore_duplicates</span><span class="o">=</span><span class="n">ignore_duplicates</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">category</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;_&quot;</span><span class="p">:</span>
                    <span class="n">category</span> <span class="o">=</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">category</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;One loop cannot have columns with different categories (or columns that don&#39;t match the set prefix)!&quot;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c"># Ignore duplicate tags</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ignore_duplicates</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;There is already a column with the name &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;There cannot be more than one &#39;.&#39; in a tag name.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot; &quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Column names can not contain spaces.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="loop.addData"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.addData">[docs]</a>    <span class="k">def</span> <span class="nf">addData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">the_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a list to the data field. Items in list can be any type, they will be converted to string and formatted correctly. The list must have the same cardinality as the column names.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The list must have the same number of elements as the number of columns! Insert column names first.&quot;</span><span class="p">)</span>
        <span class="c"># Add the user data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="loop.addDataByColumn"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.addDataByColumn">[docs]</a>    <span class="k">def</span> <span class="nf">addDataByColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_id</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add data to the loop one element at a time, based on column. Useful when adding data from SANS parsers.&quot;&quot;&quot;</span>

        <span class="c"># Make sure the category matches - if provided</span>
        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">column_id</span><span class="p">:</span>
            <span class="n">supplied_category</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">column_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">supplied_category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Category provided in your column &#39;</span><span class="si">%s</span><span class="s">&#39; does not match this loop&#39;s category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">supplied_category</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">))</span>

        <span class="n">column_id</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="n">column_id</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The column tag &#39;</span><span class="si">%s</span><span class="s">&#39; to which you are attempting to add data does not yet exist. Create the columns before adding data.&quot;</span> <span class="o">%</span> <span class="n">column_id</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">column_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You cannot add data out of column order.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="loop.clearData"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.clearData">[docs]</a>    <span class="k">def</span> <span class="nf">clearData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Erases all data in this loop. Does not erase the data columns or loop category.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="loop.compare"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the differences between two loops as a list. Otherwise returns 1 if different and 0 if equal. Order of loops being compared does not make a difference on the specific errors detected.&quot;&quot;&quot;</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Check if this is literally the same object</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c"># Check if the other object is our string representation</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s">&#39;String was not exactly equal to loop.&#39;</span><span class="p">]</span>
        <span class="c"># Do STAR comparison</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Category of loops does not match: &#39;</span><span class="si">%s</span><span class="s">&#39; vs &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">category</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Loop data does not match for loop with category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">columns</span><span class="p">]:</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Loop columns do not match for loop with category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">An exception occured while comparing: &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">diffs</span></div>

<div class="viewcode-block" id="loop.deleteDataByTagValue"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.deleteDataByTagValue">[docs]</a>    <span class="k">def</span> <span class="nf">deleteDataByTagValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index_tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes all rows which contain the provided value in the provided column. If index_tag is provided, that column is renumbered starting with 1. Returns the deleted rows.&quot;&quot;&quot;</span>

        <span class="c"># Make sure the category matches - if provided</span>
        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">supplied_category</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">supplied_category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Category provided in your column &#39;</span><span class="si">%s</span><span class="s">&#39; does not match this loop&#39;s category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">supplied_category</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">))</span>

        <span class="n">cleaned_tag</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">columns_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">search_column</span> <span class="o">=</span> <span class="n">columns_lower</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cleaned_tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The tag you provided &#39;</span><span class="si">%s</span><span class="s">&#39; isn&#39;t in this loop!&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

        <span class="n">deleted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Delete all rows in which the user-provided tag matched</span>
        <span class="n">cur_row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">cur_row</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cur_row</span><span class="p">][</span><span class="n">search_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">deleted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cur_row</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">cur_row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Re-number if they so desire</span>
        <span class="k">if</span> <span class="n">index_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumberRows</span><span class="p">(</span><span class="n">index_tag</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deleted</span></div>

<div class="viewcode-block" id="loop.getDataAsCSV"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.getDataAsCSV">[docs]</a>    <span class="k">def</span> <span class="nf">getDataAsCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show_category</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the data contained in the loops, properly CSVd, as a string. Set header to False to omit the header. Set show_category to false to omit the loop category from the headers.&quot;&quot;&quot;</span>
        <span class="n">csv_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">cwriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_buffer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show_category</span><span class="p">:</span>
                <span class="n">cwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">piece</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piece</span><span class="p">)</span>

            <span class="n">cwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">csv_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">csv_buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="loop.getDataByTag"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.getDataByTag">[docs]</a>    <span class="k">def</span> <span class="nf">getDataByTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Identical to getTag but wraps the results in a list even if only fetching one tag. Primarily exists for legacy code.&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTag</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="loop.getTag"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.getTag">[docs]</a>    <span class="k">def</span> <span class="nf">getTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">whole_tag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provided a tag name (or a list of tag names), or ordinals corresponding to columns, return the selected tags by row as a list of lists.&quot;&quot;&quot;</span>

        <span class="c"># All tags</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="c"># Turn single elements into lists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tags</span><span class="p">]</span>

        <span class="c"># Strip the category if they provide it (also validate it during the process)</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]):</span>
            <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot fetch data with column &#39;</span><span class="si">%s</span><span class="s">&#39; because the category does not match the category of this loop &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">))</span>
            <span class="n">tags</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c"># Make a lower case copy of the columns</span>
        <span class="n">columns_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="c"># Map column name to column position in list</span>
        <span class="n">column_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">columns_lower</span><span class="p">),</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns_lower</span><span class="p">)))))</span>

        <span class="c"># Make sure their fields are actually present in the entry</span>
        <span class="n">column_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="ow">in</span> <span class="n">column_mapping</span><span class="p">:</span>
                <span class="n">column_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_mapping</span><span class="p">[</span><span class="n">query</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">column_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Could not locate the the column with name or ID: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>

        <span class="c"># Use a list comprehension to pull the correct tags out of the rows</span>
        <span class="k">if</span> <span class="n">whole_tag</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">+</span><span class="s">&quot;.&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_id</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">col_id</span><span class="p">]]</span> <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">column_ids</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If only returning one tag (the usual behavior) then don&#39;t wrap the results in a list</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">column_ids</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[[</span><span class="n">row</span><span class="p">[</span><span class="n">col_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">column_ids</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span></div>

<div class="viewcode-block" id="loop.printTree"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.printTree">[docs]</a>    <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints a summary, tree style, of the loop.&quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="loop.renumberRows"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.renumberRows">[docs]</a>    <span class="k">def</span> <span class="nf">renumberRows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_tag</span><span class="p">,</span> <span class="n">start_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maintain_ordering</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renumber a given column incrementally. Set start_value to initial value if 1 is not acceptable. Set maintain_ordering to preserve sequence with offset. E.g. 2,3,3,5 would become 1,2,2,4.&quot;&quot;&quot;</span>

        <span class="c"># Make sure the category matches</span>
        <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_tag</span><span class="p">):</span>
            <span class="n">supplied_category</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index_tag</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">supplied_category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Category provided in your tag &#39;</span><span class="si">%s</span><span class="s">&#39; does not match this loop&#39;s category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">supplied_category</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">))</span>

        <span class="n">cleaned_tag</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index_tag</span><span class="p">))</span>
        <span class="n">columns_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="c"># The column to replace in is the column they specify</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">renumber_column</span> <span class="o">=</span> <span class="n">columns_lower</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cleaned_tag</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># Or, perhaps they specified an integer to represent the column?</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">renumber_column</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index_tag</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The renumbering column you provided &#39;</span><span class="si">%s</span><span class="s">&#39; isn&#39;t in this loop!&quot;</span> <span class="o">%</span> <span class="n">cleaned_tag</span><span class="p">)</span>

        <span class="c"># Verify the renumbering column ID</span>
        <span class="k">if</span> <span class="n">renumber_column</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="n">renumber_column</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The renumbering column ID you provided &#39;</span><span class="si">%s</span><span class="s">&#39; is too large or too small! Value column ids are 0-</span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index_tag</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c"># Do nothing if we have no data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">maintain_ordering</span><span class="p">:</span>
            <span class="c"># If they have a string buried somewhere in the row, we&#39;ll have to restore the original values</span>
            <span class="n">data_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">start_value</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">renumber_column</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">renumber_column</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">renumber_column</span><span class="p">])</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_copy</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;You can&#39;t renumber a row containing anything that can&#39;t be coerced into an integer using maintain_ordering. I.e. what am I suppose to renumber &#39;</span><span class="si">%s</span><span class="s">&#39; to?&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">renumber_column</span><span class="p">])</span>

        <span class="c"># Simple renumbering algorithm if we don&#39;t need to maintain the ordering</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">renumber_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">start_value</span></div>

<div class="viewcode-block" id="loop.setCategory"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.setCategory">[docs]</a>    <span class="k">def</span> <span class="nf">setCategory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the category of the loop. Usefull if you didn&#39;t know the category at loop creation time.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">category</span><span class="p">)</span></div>

<div class="viewcode-block" id="loop.sortRows"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.sortRows">[docs]</a>    <span class="k">def</span> <span class="nf">sortRows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sort the data in the rows by their values for a given column or columns. Specify the columns using their names or ordinals. Accepts a list or an int/float. By default we will sort numerically. If that fails we do a string sort. Supply a function as key_func and we will order the elements based on the keys it provides. See the help for sorted() for more details. If you provide multiple columns to sort by, they are interpreted as increasing order of sort priority.&quot;&quot;&quot;</span>

        <span class="c"># Do nothing if we have no data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># This will determine how we sort</span>
        <span class="n">sort_ordinals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">processing_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">processing_list</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processing_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tags</span><span class="p">]</span>

        <span class="c"># Get a lower case list of columns</span>
        <span class="n">columns_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="c"># Process their input to determine which columns to operate on</span>
        <span class="k">for</span> <span class="n">cur_tag</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">processing_list</span><span class="p">):</span>

            <span class="c"># Make sure the category matches</span>
            <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">cur_tag</span><span class="p">:</span>
                <span class="n">supplied_category</span> <span class="o">=</span> <span class="n">_formatCategory</span><span class="p">(</span><span class="n">cur_tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">supplied_category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Category provided in your tag &#39;</span><span class="si">%s</span><span class="s">&#39; does not match this loop&#39;s category &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">supplied_category</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">))</span>

            <span class="c"># Get a lower case version of the tag</span>
            <span class="n">cleaned_tag</span> <span class="o">=</span> <span class="n">_formatTag</span><span class="p">(</span><span class="n">cur_tag</span><span class="p">)</span>

            <span class="c"># The column to replace in is the column they specify</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">renumber_column</span> <span class="o">=</span> <span class="n">columns_lower</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cleaned_tag</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c"># Or, perhaps they specified an integer to represent the column?</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">renumber_column</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur_tag</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The sorting column you provided &#39;</span><span class="si">%s</span><span class="s">&#39; isn&#39;t in this loop!&quot;</span> <span class="o">%</span> <span class="n">cur_tag</span><span class="p">)</span>

            <span class="c"># Verify the renumbering column ID</span>
            <span class="k">if</span> <span class="n">renumber_column</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="n">renumber_column</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The sorting column ID you provided &#39;</span><span class="si">%s</span><span class="s">&#39; is too large or too small! Value column ids are 0-</span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_tag</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">sort_ordinals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renumber_column</span><span class="p">)</span>

        <span class="c"># Do the sort(s)</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">sort_ordinals</span><span class="p">:</span>
            <span class="c"># Going through each column, first attempt to sort as integer. Then fallback to string sort.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">tmp_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">column</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">tmp_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tmp_data</span></div>

<div class="viewcode-block" id="loop.validate"><a class="viewcode-back" href="../../../../ccpn/ccpn.util.Bmrb.html#ccpn.util.Bmrb.bmrb.loop.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate a loop against a STAR schema. You can pass your own custom schema if desired, otherwise the schema will be fetched from the BMRB servers. Returns a list of errors found. 0-length list indicates no errors found.&quot;&quot;&quot;</span>

        <span class="c"># Get the default schema if we are not passed a schema</span>
        <span class="n">my_schema</span> <span class="o">=</span> <span class="n">_getSchema</span><span class="p">(</span><span class="n">validation_schema</span><span class="p">)</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Check the data</span>
        <span class="k">for</span> <span class="n">rownum</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="c"># Make sure the width matches</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Loop &#39;</span><span class="si">%s</span><span class="s">&#39; data width does not match it&#39;s column tag width on row &#39;</span><span class="si">%d</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">rownum</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">my_schema</span><span class="o">.</span><span class="n">valType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">datum</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">linenum</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">rownum</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; column &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">errors</span></div></div>

<span class="c"># Allow using diff or validate if ran directly</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">ccpn.util.Bmrb.unit_tests</span> <span class="kn">import</span> <span class="n">bmrb_test</span>
    <span class="kn">import</span> <span class="nn">optparse</span>
    <span class="c"># Specify some basic information about our command</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&quot;usage: %prog&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;SVN_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">svn_revision</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;NMR-STAR handling python module. Usually you&#39;ll want to import this. When ran without arguments a unit test is performed.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--diff&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE1 FILE2&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;diff&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;Print a comparison of two entries.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--validate&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;validate&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;Print the validation report for an entry.&quot;</span><span class="p">)</span>
    <span class="c"># Options, parse &#39;em</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">cmd_input</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">validate</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">diff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Running unit tests...&quot;</span><span class="p">)</span>
        <span class="n">bmrb_test</span><span class="o">.</span><span class="n">start_tests</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">validate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;You cannot validate and diff at the same time.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">validate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">validate</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">validate</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">diff</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">entry</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">diff</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>