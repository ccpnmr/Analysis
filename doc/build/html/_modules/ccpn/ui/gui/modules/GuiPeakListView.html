<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.ui.gui.modules.GuiPeakListView &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.ui.gui.modules.GuiPeakListView</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module Documentation here</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan&quot;</span>
               <span class="s2">&quot;Simon P Skinner &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>

<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: Ed Brooksbank $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-04-07 11:40:41 +0100 (Fri, April 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b1 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: Wayne Boucher $&quot;</span>

<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-03-22 15:13:45 +0000 (Wed, March 22, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

<span class="c1"># import pyqtgraph as pg</span>

<span class="kn">from</span> <span class="nn">ccpn.core.Project</span> <span class="kn">import</span> <span class="n">Project</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Peak</span> <span class="kn">import</span> <span class="n">Peak</span>
<span class="c1"># from ccpn.core.NmrAtom import NmrAtom</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.api.ccp.nmr</span> <span class="kn">import</span> <span class="n">Nmr</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import AbstractPeakDimContrib as ApiAbstractPeakDimContrib</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import Resonance as ApiResonance</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import ResonanceGroup as ApiResonanceGroup</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import NmrChain as ApiNmrChain</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import PeakDim as ApiPeakDim</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import Peak as ApiPeak</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import DataDimRef as ApiDataDimRef</span>
<span class="c1"># from ccpnmodel.ccpncore.api.ccp.nmr.Nmr import FreqDataDim as ApiFreqDataDim</span>

<span class="n">NULL_RECT</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span><span class="p">()</span>
<span class="n">IDENTITY</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTransform</span><span class="p">()</span>
<span class="n">IDENTITY</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="c1"># class PeakLayer(QtGui.QGraphicsItem):</span>
<span class="c1">#</span>
<span class="c1">#   def __init__(self, scene):</span>
<span class="c1">#</span>
<span class="c1">#     QtGui.QGraphicsItem.__init__(self, scene=scene)</span>
<span class="c1">#</span>
<span class="c1">#     # self.glWidget = glWidget</span>
<span class="c1">#     self.peaks = {}</span>
<span class="c1">#     self.setFlag(QtGui.QGraphicsItem.ItemHasNoContents, True)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#   def boundingRect(self):</span>
<span class="c1">#</span>
<span class="c1">#     return NULL_RECT</span>
<span class="c1">#</span>
<span class="c1">#   def paint(self, painter, option, widget):</span>

    <span class="c1"># return</span>
<span class="c1">#</span>
<span class="c1"># def peakItemNotifier(project, apiPeak):</span>
<span class="c1">#   apiPeakListViews = apiPeak.PeakList.PeakListViews</span>
<span class="c1">#   for apiPeakListView in apiPeakListViews:</span>
<span class="c1">#     for apiStripPeakListView in apiPeakListView._apiStripPeakListViews:</span>

<span class="k">def</span> <span class="nf">_getPeakAnnotation</span><span class="p">(</span><span class="n">peak</span><span class="p">):</span>
  <span class="n">peakLabel</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span><span class="p">):</span>
    <span class="n">pdNA</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">dimensionNmrAtoms</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdNA</span><span class="p">[</span><span class="n">dimension</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdNA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">peakLabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;1H&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">peakLabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">peakNmrResidues</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">pdNA</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">peakNmrResidues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">peakNmrResidues</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pdNA</span><span class="p">[</span><span class="n">dimension</span><span class="p">]:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peakLabel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">peakLabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">peakLabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pdNA</span><span class="p">[</span><span class="n">dimension</span><span class="p">]:</span>
          <span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="n">item</span><span class="o">.</span><span class="n">name</span>
          <span class="n">peakLabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

  <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">peakLabel</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">text</span>

<span class="c1"># @profile</span>
<span class="c1"># def _getPeakAnnotation(peak):</span>
<span class="c1">#</span>
<span class="c1">#   peakLabel = []</span>
<span class="c1">#   for dimension in range(peak.peakList.spectrum.dimensionCount):</span>
<span class="c1">#     if len(peak.dimensionNmrAtoms[dimension]) == 0:</span>
<span class="c1">#       if len(peak.dimensionNmrAtoms) == 1:</span>
<span class="c1">#         peakLabel.append(&#39;1H&#39;)</span>
<span class="c1">#       else:</span>
<span class="c1">#         peakLabel.append(&#39;-&#39;)</span>
<span class="c1">#     else:</span>
<span class="c1">#       peakNmrResidues = [atom[0].nmrResidue.id for atom in peak.dimensionNmrAtoms if len(atom) != 0]</span>
<span class="c1">#       if all(x==peakNmrResidues[0] for x in peakNmrResidues):</span>
<span class="c1">#         for item in peak.dimensionNmrAtoms[dimension]:</span>
<span class="c1">#           if len(peakLabel) &gt; 0:</span>
<span class="c1">#             peakLabel.append(item.name)</span>
<span class="c1">#           else:</span>
<span class="c1">#             peakLabel.append(item.pid.id)</span>
<span class="c1">#</span>
<span class="c1">#       else:</span>
<span class="c1">#         for item in peak.dimensionNmrAtoms[dimension]:</span>
<span class="c1">#           label = item.nmrResidue.id+item.name</span>
<span class="c1">#           peakLabel.append(label)</span>
<span class="c1">#</span>
<span class="c1">#   text = &#39;, &#39;.join(peakLabel)</span>
<span class="c1">#   return text</span>

<div class="viewcode-block" id="GuiPeakListView"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.GuiPeakListView">[docs]</a><span class="k">class</span> <span class="nc">GuiPeakListView</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; peakList is the CCPN wrapper object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#FIXME: apparently it gets passed an object which already has crucial attributes</span>
    <span class="c1"># A big NONO!!!</span>
    <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">strip</span><span class="o">.</span><span class="n">plotWidget</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span>
    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">)</span>
    <span class="c1">###self.strip = strip</span>
    <span class="c1">###self.peakList = peakList</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peakItems</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># CCPN peak -&gt; Qt peakItem</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemHasNoContents</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">application</span>

    <span class="n">strip</span><span class="o">.</span><span class="n">viewBox</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="c1">###self.parent = parent</span>
    <span class="c1"># self.displayed = True</span>
    <span class="c1"># self.symbolColour = None</span>
    <span class="c1"># self.symbolStyle = None</span>
    <span class="c1"># self.isSymbolDisplayed = True</span>
    <span class="c1"># self.textColour = None</span>
    <span class="c1"># self.isTextDisplayed = True</span>
    <span class="c1"># self.regionChanged()</span>


  <span class="k">def</span> <span class="nf">_printToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">printer</span><span class="p">):</span>
    <span class="c1"># CCPN INTERNAL - called in _printToFile method of GuiSpectrumViewNd</span>

    <span class="c1"># NOTE: only valid for ND so far</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isVisible</span><span class="p">():</span>
      <span class="k">return</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">width</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">height</span>
    <span class="n">xCount</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">xCount</span>
    <span class="n">yCount</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">yCount</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">peakHalfSize</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span>
    <span class="n">plotWidget</span> <span class="o">=</span> <span class="n">strip</span><span class="o">.</span><span class="n">plotWidget</span>
    <span class="n">viewRegion</span> <span class="o">=</span> <span class="n">plotWidget</span><span class="o">.</span><span class="n">viewRange</span><span class="p">()</span>
    <span class="c1"># dataDims = self.spectrumView._wrappedData.spectrumView.orderedDataDims</span>
    <span class="n">spectrumIndices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">_displayOrderSpectrumDimensionIndices</span>
    <span class="n">xAxisIndex</span> <span class="o">=</span> <span class="n">spectrumIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yAxisIndex</span> <span class="o">=</span> <span class="n">spectrumIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">viewRegion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># TBD: relies on axes being backwards</span>
    <span class="n">xScale</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">xCount</span>
    <span class="n">xTranslate</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">xScale</span>

    <span class="n">y1</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">viewRegion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># TBD: relies on axes being backwards</span>
    <span class="n">yScale</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="n">yCount</span>
    <span class="n">yTranslate</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">y0</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">yScale</span>

    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">strip</span><span class="o">.</span><span class="n">peakIsInPlane</span><span class="p">(</span><span class="n">peak</span><span class="p">):</span>
        <span class="c1"># xPpm = xScale*peak.position[dataDims[0].dimensionIndex] + xTranslate</span>
        <span class="c1"># yPpm = yScale*peak.position[dataDims[1].dimensionIndex] + yTranslate</span>
        <span class="n">xPpm</span> <span class="o">=</span> <span class="n">xScale</span><span class="o">*</span><span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">xAxisIndex</span><span class="p">]</span> <span class="o">+</span> <span class="n">xTranslate</span>
        <span class="n">yPpm</span> <span class="o">=</span> <span class="n">yScale</span><span class="o">*</span><span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">yAxisIndex</span><span class="p">]</span> <span class="o">+</span> <span class="n">yTranslate</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">xPpm</span> <span class="o">-</span> <span class="n">peakHalfSize</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">yPpm</span> <span class="o">-</span> <span class="n">peakHalfSize</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">xPpm</span> <span class="o">+</span> <span class="n">peakHalfSize</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">yPpm</span> <span class="o">+</span> <span class="n">peakHalfSize</span><span class="p">)</span>
        <span class="n">printer</span><span class="o">.</span><span class="n">writeLine</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
        <span class="n">printer</span><span class="o">.</span><span class="n">writeLine</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">_getPeakAnnotation</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
          <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">peakHalfSize</span>
          <span class="n">printer</span><span class="o">.</span><span class="n">writeText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">a1</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">b1</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span>

<div class="viewcode-block" id="GuiPeakListView.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.GuiPeakListView.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">NULL_RECT</span></div>

<div class="viewcode-block" id="GuiPeakListView.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.GuiPeakListView.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">return</span></div>

  <span class="c1"># For notifiers - moved from core PeakListView</span>
  <span class="k">def</span> <span class="nf">_createdPeakListView</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">spectrumView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrumView</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrumView</span><span class="o">.</span><span class="n">spectrum</span>
    <span class="c1"># NBNB TBD FIXME we should get rid of this API-level access</span>
    <span class="c1"># But that requires refactoring the spectrumActionDict</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">spectrumDisplay</span><span class="o">.</span><span class="n">spectrumActionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">action</span><span class="p">:</span>
      <span class="n">action</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setVisible</span><span class="p">)</span> <span class="c1"># TBD: need to undo this if peakListView removed</span>

    <span class="n">strip</span> <span class="o">=</span> <span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span>
    <span class="k">for</span> <span class="n">peakList</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">peakLists</span><span class="p">:</span>
      <span class="n">strip</span><span class="o">.</span><span class="n">showPeaks</span><span class="p">(</span><span class="n">peakList</span><span class="p">)</span>

  <span class="c1"># For notifiers - moved from core PeakListView</span>
  <span class="k">def</span> <span class="nf">_deletedStripPeakListView</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">ccpn.core.IntegralList</span> <span class="kn">import</span> <span class="n">IntegralList</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakList</span><span class="p">,</span> <span class="n">IntegralList</span><span class="p">):</span>
      <span class="k">return</span>

    <span class="n">spectrumView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrumView</span>
    <span class="n">strip</span> <span class="o">=</span> <span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span>
    <span class="n">spectrumDisplay</span> <span class="o">=</span> <span class="n">strip</span><span class="o">.</span><span class="n">spectrumDisplay</span>

    <span class="n">peakItemDict</span> <span class="o">=</span> <span class="n">spectrumDisplay</span><span class="o">.</span><span class="n">activePeakItemDict</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
    <span class="n">peakItems</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">spectrumDisplay</span><span class="o">.</span><span class="n">inactivePeakItemDict</span><span class="p">[</span><span class="bp">self</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">apiPeak</span> <span class="ow">in</span> <span class="n">peakItemDict</span><span class="p">:</span>
      <span class="c1"># NBNB TBD FIXME change to get rid of API peaks here</span>
      <span class="n">peakItem</span> <span class="o">=</span> <span class="n">peakItemDict</span><span class="p">[</span><span class="n">apiPeak</span><span class="p">]</span>
      <span class="n">peakItems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span>

    <span class="n">scene</span> <span class="o">=</span> <span class="n">strip</span><span class="o">.</span><span class="n">plotWidget</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">peakItem</span> <span class="ow">in</span> <span class="n">peakItems</span><span class="p">:</span>
      <span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">spectrumDisplay</span><span class="o">.</span><span class="n">is1D</span><span class="p">:</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">peakItem</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
      <span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span>
    <span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">spectrumDisplay</span><span class="o">.</span><span class="n">activePeakItemDict</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">spectrumDisplay</span><span class="o">.</span><span class="n">inactivePeakItemDict</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">_changedPeakListView</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">peakItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakItems</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">peakItem</span><span class="p">,</span> <span class="n">PeakNd</span><span class="p">):</span>
        <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">setupPeakAnnotationItem</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peak1d"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1d">[docs]</a><span class="k">class</span> <span class="nc">Peak1d</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; A GraphicsItem that is not actually drawn itself,</span>
<span class="sd">  but is the parent of the peak symbol and peak annotation.</span>
<span class="sd">      TODO: Add hover effect for 1D peaks. &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">peakListView</span><span class="p">):</span>


    <span class="n">scene</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">plotWidget</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span>
    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">peakListView</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">application</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">peakHeight</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">height</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">peak</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span> <span class="o">=</span> <span class="n">peakListView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span>
    <span class="c1"># self.spectrumView, spectrumMapping = self.spectrumWindow.getViewMapping(analysisSpectrum)</span>
    <span class="c1"># self.setZValue(10)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">screenPos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># print(scene.itemsBoundingRect)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">Peak1dAnnotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setupPeakItem</span><span class="p">(</span><span class="n">peakListView</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">press</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptHoverEvents</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotationScreenPos</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">NULL_RECT</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NoCache</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemHasNoContents</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemIsSelectable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="c1"># self.scene().sigMouseClicked.connect(self.peakClicked)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pointPos</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">pointPosition</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ppm</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">height</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
      <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">_apiPeak</span><span class="o">.</span><span class="n">findFirstPeakIntensity</span><span class="p">(</span><span class="n">intensityType</span> <span class="o">=</span> <span class="s1">&#39;height&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">height</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="o">.</span><span class="n">value</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#self.height *= self.spectrum.scale  # should not need this now</span>
    <span class="c1">#</span>
    <span class="c1"># # if peakDims[dim].numAliasing:</span>
    <span class="c1"># #   self.isAliased = True</span>
    <span class="c1"># # else:</span>
    <span class="c1"># #   self.isAliased = False</span>
    <span class="c1"># if self.ppm and self.height:</span>
    <span class="c1">#   self.setPos(self.ppm, self.height)</span>

    <span class="c1"># try:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">Peak1dSymbol</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="c1"># except AttributeError:</span>
    <span class="c1">#   return</span>

    <span class="c1"># group.addToGroup(self)</span>
  <span class="c1"># def peakClicked(self, event):</span>
  <span class="c1">#   print(self, &#39;click&#39;, event)</span>

<div class="viewcode-block" id="Peak1d.setupPeakItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1d.setupPeakItem">[docs]</a>  <span class="k">def</span> <span class="nf">setupPeakItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakListView</span><span class="p">,</span> <span class="n">peak</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span> <span class="o">=</span> <span class="n">peakListView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">peak</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="n">peak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">peaks</span><span class="p">)</span>

    <span class="c1"># dataDims = peakListView.spectrumView._wrappedData.spectrumView.orderedDataDims</span>
    <span class="c1"># xPpm = peak.position[dataDims[0].dimensionIndex]</span>
    <span class="n">xAxisIndex</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">_displayOrderSpectrumDimensionIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xPpm</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">xAxisIndex</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">xPpm</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">height</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">setupPeakAnnotation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">peakListView</span><span class="o">.</span><span class="n">peakItems</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Peak1d.mousePressEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1d.mousePressEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">press</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hover</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;pressed&#39;</span><span class="p">,</span> <span class="s1">&#39;GuiPeakListView L 300&#39;</span><span class="p">)</span></div>

  <span class="c1"># def mousePressEvent(self, event):</span>
  <span class="c1">#</span>
  <span class="c1">#   if (event.button() == QtCore.Qt.LeftButton) and (</span>
  <span class="c1">#             event.modifiers() &amp; QtCore.Qt.ControlModifier) and not (</span>
  <span class="c1">#             event.modifiers() &amp; QtCore.Qt.ShiftModifier):</span>
  <span class="c1">#</span>
  <span class="c1">#     event.accept()</span>
  <span class="c1">#     self.scene.clearSelection()</span>
  <span class="c1">#     self.setFlag(QtGui.QGraphicsItem.ItemIsMovable)</span>
  <span class="c1">#     QtGui.QGraphicsSimpleTextItem.mousePressEvent(self, event)</span>
  <span class="c1">#     self.setSelected(True)</span>
  <span class="c1">#     print(self.peak)</span>


<div class="viewcode-block" id="Peak1d.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1d.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">NULL_RECT</span></div>


<div class="viewcode-block" id="Peak1d.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1d.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">return</span></div></div>

<div class="viewcode-block" id="Peak1dAnnotation"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dAnnotation">[docs]</a><span class="k">class</span> <span class="nc">Peak1dAnnotation</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; A text annotation of a peak.</span>
<span class="sd">      The text rotation is currently always +-45 degrees (depending on peak height). &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakItem</span><span class="p">,</span> <span class="n">scene</span><span class="p">):</span>

    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">_ccpnApplication</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span> <span class="o">=</span> <span class="n">peakItem</span> <span class="c1"># When exporting to e.g. PDF the parentItem is temporarily set to None, which means that there must be a separate link to the PeakItem.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">scene</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peak</span>
    <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
    <span class="n">font</span><span class="o">.</span><span class="n">setPointSize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
    <span class="c1"># self.setCacheMode(self.DeviceCoordinateCache)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ItemIgnoresTransformations</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="c1"># self.setFlag(self.ItemIsMovable, True)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ItemIsSelectable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="c1"># self.setFlag(self.ItemSendsScenePositionChanges, True)</span>
    <span class="c1"># if self.isSelected():</span>
    <span class="c1">#   print(self)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">colourScheme</span>
    <span class="c1"># color.setRgbF(*self.peakItem.glWidget._hexToRgba(textColor))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setColour</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">updatePos</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setupPeakAnnotation</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span>


<div class="viewcode-block" id="Peak1dAnnotation.sceneEventFilter"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dAnnotation.sceneEventFilter">[docs]</a>  <span class="k">def</span> <span class="nf">sceneEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">watched</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peak1dAnnotation.mousePressEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dAnnotation.mousePressEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Peak1dAnnotation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">mousePressEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">:</span>

    <span class="c1"># if (event.button() == QtCore.Qt.LeftButton) and (</span>
    <span class="c1">#           event.modifiers() &amp; QtCore.Qt.ControlModifier) and not (</span>
    <span class="c1">#           event.modifiers() &amp; QtCore.Qt.ShiftModifier):</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">clearSelection</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="o">.</span><span class="n">ItemIsMovable</span><span class="p">)</span>
      <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="o">.</span><span class="n">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>
      <span class="c1"># print(&#39;selected:&#39;, self.peak)</span>

      <span class="c1"># print(&#39;peak item:&#39;, self.peakItem.pos())</span>


<div class="viewcode-block" id="Peak1dAnnotation.setupPeakAnnotation"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dAnnotation.setupPeakAnnotation">[docs]</a>  <span class="k">def</span> <span class="nf">setupPeakAnnotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakItem</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span> <span class="o">=</span> <span class="n">peakItem</span> <span class="c1"># When exporting to e.g. PDF the parentItem is temporarily set to None, which means that there must be a separate link to the PeakItem.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span>


    <span class="n">peak</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peak</span>
    <span class="n">spectrumId</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">id</span>

    <span class="c1"># NBNB TBD FIXME</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">_getPeakAnnotation</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
    <span class="c1"># text = text + &quot;*&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">spectrumId</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peak1dAnnotation.updatePos"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dAnnotation.updatePos">[docs]</a>  <span class="k">def</span> <span class="nf">updatePos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">peakItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span>
    <span class="k">if</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peakHeight</span> <span class="ow">and</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peakHeight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># Translate first to rotate around bottom left corner</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="c1">#self.setPos(0, min(peakItem.pos().y()*0.75, peakItem.spectrum.positiveContourBase * peakItem.spectrum.scale))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">peakItem</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">positiveContourBase</span><span class="p">))</span>
      <span class="c1"># print(peakItem.height, max(peakItem.pos().y()*0.75, peakItem.spectrum.positiveContourBase * peakItem.spectrum.scale))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1">#self.setPos(0, min(peakItem.pos().y()*0.75, -peakItem.spectrum.positiveContourBase * peakItem.spectrum.scale))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">peakItem</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="n">peakItem</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">positiveContourBase</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span></div>

<div class="viewcode-block" id="Peak1dAnnotation.setColour"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dAnnotation.setColour">[docs]</a>  <span class="k">def</span> <span class="nf">setColour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">==</span> <span class="s1">&#39;light&#39;</span><span class="p">:</span>
      <span class="n">colour</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s1">&#39;#080000&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">colour</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s1">&#39;#f7ffff&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">colour</span><span class="p">)</span>
    <span class="n">textColor</span> <span class="o">=</span> <span class="n">colour</span></div>

<div class="viewcode-block" id="Peak1dAnnotation.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dAnnotation.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">:</span> <span class="c1"># TBD: is this ever not true??</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">peaks</span><span class="p">)</span>
      <span class="c1"># self.setSelected(self.peak.isSelected)</span>
    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="o">.</span><span class="n">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">)</span></div></div>

    <span class="c1"># if self.peakItem.peak in self.analysisLayout.currentPeaks:</span>
    <span class="c1"># painter.drawRect(self.boundingRect())</span>

<div class="viewcode-block" id="Peak1dSymbol"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dSymbol">[docs]</a><span class="k">class</span> <span class="nc">Peak1dSymbol</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; A graphical symbol representing the peak.</span>
<span class="sd">      Currently only a dashed line from the peak to the peak annotation is used. This can be improved.</span>
<span class="sd">      The length of the line is related to the height of the peak. &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>

    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">)</span>



    <span class="bp">self</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span> <span class="o">=</span> <span class="n">parent</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setCacheMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceCoordinateCache</span><span class="p">)</span>
    <span class="c1"># self.setFlag(self.ItemIsMovable, True)</span>
    <span class="c1"># self.setFlag(self.ItemIsSelectable, True)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lineWidth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setBbox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<div class="viewcode-block" id="Peak1dSymbol.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dSymbol.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span></div>

<div class="viewcode-block" id="Peak1dSymbol.setBbox"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dSymbol.setBbox">[docs]</a>  <span class="k">def</span> <span class="nf">setBbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">peakItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span>


    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">():</span>
      <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
      <span class="n">right</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">left</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
      <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">():</span>
      <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
      <span class="n">lower</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">upper</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
      <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">lower</span><span class="p">))</span></div>

<div class="viewcode-block" id="Peak1dSymbol.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dSymbol.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>

    <span class="n">peakItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span>


    <span class="n">pos</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># When exporting to e.g. pdf the symbol has no parent item, which means that its position is its screen pos.</span>
                               <span class="c1"># To compensate for that the line pos needs to be explicitly (0, 0).</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentItem</span><span class="p">():</span>
      <span class="n">annotationPos</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">annotationPos</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">scenePos</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenePos</span><span class="p">()</span> <span class="o">-</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Fix for export to e.g. PDF</span>

    <span class="n">pen</span> <span class="o">=</span> <span class="n">painter</span><span class="o">.</span><span class="n">pen</span><span class="p">()</span>
    <span class="n">pen</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DashLine</span><span class="p">)</span>
    <span class="n">pen</span><span class="o">.</span><span class="n">setWidth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineWidth</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">colourScheme</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">==</span> <span class="s1">&#39;light&#39;</span><span class="p">:</span>
      <span class="n">colour</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s1">&#39;#080000&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">colour</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s1">&#39;#f7ffff&#39;</span><span class="p">)</span>

    <span class="c1"># self.setBrush(colour)</span>
    <span class="c1"># lineColor = peakItem.analysisPeakList.symbolColor</span>
    <span class="c1"># color.setRgbF(*peakItem.glWidget._hexToRgba(lineColor))</span>
    <span class="c1">#</span>
    <span class="c1"># if peakItem.peak not in self.analysisLayout.currentPeaks:</span>
    <span class="c1">#   color.setAlphaF(0.5)</span>

    <span class="n">pen</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">colour</span><span class="p">)</span>
    <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>

    <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">annotationPos</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setBbox</span><span class="p">()</span></div>

<div class="viewcode-block" id="Peak1dSymbol.mousePressEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.Peak1dSymbol.mousePressEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="c1"># print(&#39;symbol&#39;)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
              <span class="n">event</span><span class="o">.</span><span class="n">modifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ControlModifier</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
              <span class="n">event</span><span class="o">.</span><span class="n">modifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span><span class="p">):</span>

      <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
      <span class="c1"># self.scene.clearSelection()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemIsMovable</span><span class="p">)</span>
      <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="o">.</span><span class="n">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div></div>



<div class="viewcode-block" id="PeakNd"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.PeakNd">[docs]</a><span class="k">class</span> <span class="nc">PeakNd</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakListView</span><span class="p">,</span> <span class="n">peak</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">application</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">plotWidget</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span>
    <span class="c1">#QtGui.QGraphicsItem.__init__(self, scene=scene)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">colourScheme</span>
    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">peakListView</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">)</span>
    <span class="c1">###QtGui.QGraphicsItem.__init__(self, peakLayer)</span>
    <span class="c1">###scene.addItem(self)</span>
    <span class="c1">###strip.plotWidget.plotItem.vb.addItem(self)</span>
    <span class="c1"># turn off ItemIsSelectable because it fails miserably when you zoom in (have to pick exactly in the centre)</span>
    <span class="c1">###self.setFlag(QtGui.QGraphicsItem.ItemIsSelectable + self.ItemIgnoresTransformations)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ItemIgnoresTransformations</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span> <span class="o">=</span> <span class="n">peakListView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">PeakNdAnnotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setupPeakItem</span><span class="p">(</span><span class="n">peakListView</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span>
    <span class="c1"># self.glWidget = peakLayer.glWidget</span>
    <span class="c1">#self.setParentItem(peakLayer)</span>
    <span class="c1">###self.peakLayer = peakLayer</span>
    <span class="c1"># self.spectrumWindow = spectrumWindow</span>
    <span class="c1"># self.panel = spectrumWindow.panel</span>
    <span class="c1">#self.peakList = peak._parent</span>
    <span class="c1">##self.strip = strip</span>
    <span class="c1">#self.parent = strip.plotWidget</span>
    <span class="c1">#self.spectrum = self.peakList.spectrum</span>
    <span class="c1">#self.setCacheMode(self.NoCache)</span>
    <span class="c1">#self.setFlags(self.ItemIgnoresTransformations)</span>
    <span class="c1"># self.setSelected(False)</span>
    <span class="c1">#self.hover = False</span>
    <span class="c1">#self.press = False</span>
    <span class="c1">#self.setAcceptHoverEvents(True)</span>
    <span class="c1">#self.bbox  = NULL_RECT</span>
    <span class="c1">#self.color = NULL_COLOR</span>
    <span class="c1">#self.brush = NULL_COLOR</span>
    <span class="c1">###self.peak = peak</span>
    <span class="c1">###xPpm = peak.position[0]</span>
    <span class="c1">###yPpm = peak.position[1]</span>
    <span class="c1"># self.setPos(self.parent.viewBox.mapSceneToView</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">viewBox</span><span class="o">.</span><span class="n">peakWidthPixels</span>
    <span class="n">hz</span> <span class="o">=</span> <span class="n">sz</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="c1"># self.bbox = QtCore.QRectF(-hz, -hz, sz, sz)</span>
    <span class="c1"># self.drawData = (hz, sz, QtCore.QRectF(-hz, -hz, sz, sz))</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    self.rectItem = QtGui.QGraphicsRectItem(-hz, -hz, sz, sz, self.peakLayer, scene)</span>
<span class="sd">    color = QtGui.QColor(&#39;cyan&#39;)</span>
<span class="sd">    self.rectItem.setBrush(QtGui.QBrush(color))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span> <span class="o">=</span> <span class="p">(</span><span class="n">hz</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span><span class="c1">#, QtCore.QRectF(-hz, -hz, sz, sz))</span>
    <span class="c1">###xDim = strip.spectrumViews[0].dimensionOrdering[0] - 1</span>
    <span class="c1">###yDim = strip.spectrumViews[0].dimensionOrdering[1] - 1</span>
    <span class="c1">###xPpm = peak.position[xDim] # TBD: does a peak have to have a position??</span>
    <span class="c1">###yPpm = peak.position[yDim]</span>
    <span class="c1">###self.setPos(xPpm, yPpm)</span>
    <span class="c1"># self.inPlane = self.isInPlane()</span>

    <span class="c1"># from ccpn.ui.gui.widgets.Action import Action</span>
    <span class="c1"># self.deleteAction = QtGui.QAction(self, triggered=self.deletePeak, shortcut=QtCore.Qt.Key_Delete)</span>
    <span class="c1">#peakLayer.peakItems.append(self)</span>
  <span class="c1">#</span>

<div class="viewcode-block" id="PeakNd.setupPeakItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.PeakNd.setupPeakItem">[docs]</a>  <span class="k">def</span> <span class="nf">setupPeakItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakListView</span><span class="p">,</span> <span class="n">peak</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span> <span class="o">=</span> <span class="n">peakListView</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">peak</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;_isSelected&#39;</span><span class="p">):</span>
      <span class="n">peak</span><span class="o">.</span><span class="n">_isSelected</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">spectrumIndices</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">_displayOrderSpectrumDimensionIndices</span>
    <span class="n">xAxisIndex</span> <span class="o">=</span> <span class="n">spectrumIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yAxisIndex</span> <span class="o">=</span> <span class="n">spectrumIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xPpm</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">xAxisIndex</span><span class="p">]</span>
    <span class="n">yPpm</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">yAxisIndex</span><span class="p">]</span>
    <span class="c1"># dataDims = peakListView.spectrumView._wrappedData.spectrumView.orderedDataDims</span>
    <span class="c1"># xPpm = peak.position[dataDims[0].dimensionIndex]</span>
    <span class="c1"># yPpm = peak.position[dataDims[1].dimensionIndex]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">xPpm</span><span class="p">,</span> <span class="n">yPpm</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">setupPeakAnnotationItem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">peakListView</span><span class="o">.</span><span class="n">peakItems</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_stripRegionUpdated</span><span class="p">()</span></div>

  <span class="k">def</span> <span class="nf">_stripRegionUpdated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CCPN internal, used in GuiStrip._axisRegionChanged()&quot;&quot;&quot;</span>

    <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">strip</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_isInPlane</span> <span class="o">=</span> <span class="n">strip</span><span class="o">.</span><span class="n">peakIsInPlane</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isInPlane</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_isInFlankingPlane</span> <span class="o">=</span> <span class="n">strip</span><span class="o">.</span><span class="n">peakIsInFlankingPlane</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">)</span>

  <span class="c1"># replaced by Strip.peakIsInPlane</span>
  <span class="c1"># def isInPlane(self):</span>
  <span class="c1">#</span>
  <span class="c1">#   orderedAxes = self.peakListView.spectrumView.strip.orderedAxes</span>
  <span class="c1">#   for ii,zDataDim in enumerate(self.peakListView._wrappedData.spectrumView.orderedDataDims[2:]):</span>
  <span class="c1">#     zPosition = self.peak.position[zDataDim.dimensionIndex]</span>
  <span class="c1">#     zPlaneSize = zDataDim.getDefaultPlaneSize()</span>
  <span class="c1">#     zRegion = orderedAxes[2+ii].region</span>
  <span class="c1">#     if zPosition &lt; zRegion[0]-zPlaneSize or zPosition &gt; zRegion[1]+zPlaneSize:</span>
  <span class="c1">#       return False</span>
  <span class="c1">#   #</span>
  <span class="c1">#   return True</span>

    <span class="c1"># strip = self.peakListView.spectrumView.strip</span>
    <span class="c1">#</span>
    <span class="c1"># if len(strip.orderedAxes) &gt; 2:</span>
    <span class="c1">#   zDim = strip.spectrumViews[0].dimensionOrdering[2] - 1</span>
    <span class="c1">#   zPlaneSize = strip.spectrumViews[0].zPlaneSize()</span>
    <span class="c1">#   zPosition = self.peak.position[zDim]</span>
    <span class="c1">#</span>
    <span class="c1">#   zRegion = strip.orderedAxes[2].region</span>
    <span class="c1">#   if zRegion[0]-zPlaneSize &lt;= zPosition &lt;= zRegion[1]+zPlaneSize:</span>
    <span class="c1">#     return True</span>
    <span class="c1">#   else:</span>
    <span class="c1">#     return False</span>
    <span class="c1"># else:</span>
    <span class="c1">#   return True</span>

  <span class="c1"># def hoverEnterEvent(self, event):</span>
  <span class="c1">#</span>
  <span class="c1">#   self.hover = True</span>
  <span class="c1">#   self.annotation.hoverEnterEvent(event)</span>
  <span class="c1">#   self.update()</span>
  <span class="c1">#</span>
  <span class="c1"># def hoverLeaveEvent(self, event):</span>
  <span class="c1">#</span>
  <span class="c1">#   self.hover = False</span>
  <span class="c1">#   self.press = False</span>
  <span class="c1">#   r, w, box = self.drawData</span>
  <span class="c1">#   self.bbox = box</span>
  <span class="c1">#   self.peakLayer.hideIcons()</span>
  <span class="c1">#   self.annotation.hoverLeaveEvent(event)</span>
  <span class="c1">#   self.update()</span>

  <span class="c1">###def mousePressEvent(self, event):</span>

    <span class="c1">###print(event)</span>
    <span class="c1"># self.setSelected(True)</span>
    <span class="c1"># self.press = True</span>
    <span class="c1"># self.hover = True</span>
    <span class="c1">###r, w, box = self.drawData</span>
    <span class="c1">###self.bbox = box.adjusted(-26,-51, 2, 51)</span>
    <span class="c1"># # self.peakLayer.showIcons(self)</span>
    <span class="c1"># self.update()</span>
    <span class="c1"># QtGui.QGraphicsItem.mousePressEvent(self, event)</span>


<div class="viewcode-block" id="PeakNd.boundingRect"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.PeakNd.boundingRect">[docs]</a>  <span class="k">def</span> <span class="nf">boundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1">###return self.bbox # .adjust(-2,-2, 2, 2)</span>

    <span class="n">r</span><span class="p">,</span> <span class="n">w</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span>

    <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="p">)</span></div>

  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  def itemChange(self, change, value):</span>

<span class="sd">    if change == QtGui.QGraphicsItem.ItemSelectedHasChanged:</span>
<span class="sd">      peak = self.peak</span>
<span class="sd">      selected = peak.isSelected = self.isSelected()</span>
<span class="sd">      current = self.application.current</span>
<span class="sd">      if selected:</span>
<span class="sd">        if peak not in current.peaks:</span>
<span class="sd">          current.addPeak(peak)</span>
<span class="sd">      else:</span>
<span class="sd">        if peak in current.peaks:</span>
<span class="sd">          current.removePeak(peak)</span>

<span class="sd">    return QtGui.QGraphicsItem.itemChange(self, change, value)</span>
<span class="sd">&quot;&quot;&quot;</span>
  <span class="c1">#@profile</span>
<div class="viewcode-block" id="PeakNd.paint"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.PeakNd.paint">[docs]</a>  <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span> <span class="c1"># strip has been deleted</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">:</span> <span class="c1"># TBD: is this ever not true??</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
        <span class="k">return</span>

      <span class="c1">###self.setSelected(self.peak in self.application.current.peaks)</span>
      <span class="c1"># self.setSelected(self.peak.isSelected) # need this because dragging region to select peaks sets peak.isSelected but not self.isSelected()</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isInPlane</span><span class="p">:</span>
        <span class="c1"># do not ever do the below in paint(), see comment at setupPeakAnnotationItem()</span>
        <span class="c1">###self.annotation.setupPeakAnnotationItem(self)</span>
        <span class="c1"># r, w, box = self.drawData</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span>

        <span class="c1"># if self.hover:</span>
        <span class="c1"># self.setZValue(10)</span>
        <span class="c1">#painter.setBrush(NULL_COLOR)</span>

        <span class="c1"># painter.setPen(QtGui.QColor(&#39;white&#39;))</span>
        <span class="c1"># if self.press:</span>
        <span class="c1">#   painter.drawRect(self.bbox)</span>
        <span class="c1">###strip = self.strip</span>
        <span class="c1">###peak = self.peak</span>
        <span class="c1">###xDim = strip.spectrumViews[0].dimensionOrdering[0] - 1</span>
        <span class="c1">###yDim = strip.spectrumViews[0].dimensionOrdering[1] - 1</span>
        <span class="c1">###xPpm = peak.position[xDim] # TBD: does a peak have to have a position??</span>
        <span class="c1">###yPpm = peak.position[yDim]</span>
        <span class="c1">###self.setPos(xPpm, yPpm)</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span><span class="o">.</span><span class="n">symbolColour</span>
        <span class="k">if</span> <span class="n">widget</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="n">colour</span><span class="p">))</span>
          <span class="c1"># if self.colourScheme == &#39;light&#39;:</span>
          <span class="c1">#   painter.setPen(QtGui.QColor(&#39;#080000&#39;))</span>
          <span class="c1"># else:</span>
          <span class="c1">#   painter.setPen(QtGui.QColor(&#39;#f7ffff&#39;))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
        <span class="c1"># painter.drawEllipse(box)</span>

        <span class="c1"># else:</span>
        <span class="c1">#   painter.setPen(self.color)</span>
        <span class="c1">#   self.setZValue(0)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
        <span class="c1">###painter.drawLine(xPpm-r,yPpm-r,xPpm+r,yPpm+r)</span>
        <span class="c1">###painter.drawLine(xPpm-r,yPpm+r,xPpm+r,yPpm-r)</span>

        <span class="c1">#if self.peak in self.application.current.peaks:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">_isSelected</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># if self.isSelected:</span>
        <span class="c1">#   painter.setPen(QtGui.QColor(&#39;white&#39;))</span>
        <span class="c1">#   painter.drawRect(-r,-r,w,w)</span>

      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isInFlankingPlane</span><span class="p">:</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakListView</span><span class="o">.</span><span class="n">symbolColour</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="n">colour</span><span class="p">))</span>
        <span class="n">pen</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DotLine</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
        <span class="c1"># do not ever do the below in paint(), see comment at setupPeakAnnotationItem()</span>
        <span class="c1">###self.annotation.setupPeakAnnotationItem(self)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawData</span>

        <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>

        <span class="c1">#if self.peak in self.application.current.peaks:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">_isSelected</span><span class="p">:</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
          <span class="n">painter</span><span class="o">.</span><span class="n">drawLine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">)</span></div></div>


<span class="c1">###FONT = QtGui.QFont(&quot;DejaVu Sans Mono&quot;, 9)</span>
<span class="c1">###FONT_METRIC = QtGui.QFontMetricsF(FONT)</span>
<span class="c1">###NULL_COLOR = QtGui.QColor()</span>
<span class="c1">###NULL_RECT = QtCore.QRectF()</span>

<div class="viewcode-block" id="PeakNdAnnotation"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.PeakNdAnnotation">[docs]</a><span class="k">class</span> <span class="nc">PeakNdAnnotation</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; A text annotation of a peak.</span>
<span class="sd">      The text rotation is currently always +-45 degrees (depending on peak height). &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakItem</span><span class="p">,</span> <span class="n">scene</span><span class="p">):</span>

    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGraphicsSimpleTextItem</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">)</span>

    <span class="c1">###self.setParentItem(peakItem)</span>
    <span class="c1">###self.peakItem = peakItem # When exporting to e.g. PDF the parentItem is temporarily set to None, which means that there must be a separate link to the PeakItem.</span>
    <span class="c1">###self.setText(text)</span>
    <span class="c1">###self.scene = scene</span>
    <span class="c1">###self.setColor()</span>
    <span class="c1"># self.analysisLayout = parent.glWidget.analysisLayout</span>
    <span class="n">font</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
    <span class="n">font</span><span class="o">.</span><span class="n">setPointSize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
    <span class="c1"># self.setCacheMode(self.DeviceCoordinateCache)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ItemIgnoresTransformations</span><span class="p">)</span><span class="c1">#+self.ItemIsMovable+self.ItemIsSelectable)</span>
    <span class="c1"># self.setFlag(self.ItemSendsScenePositionChanges, True)</span>

    <span class="c1"># self.text = (&#39; , &#39;).join(&#39;-&#39; * peakItem.peak.peakList.spectrum.dimensionCount)</span>
    <span class="c1"># if self.isSelected():</span>
    <span class="c1">#   print(self)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">colourScheme</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">colourScheme</span>
    <span class="n">colour</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peakListView</span><span class="o">.</span><span class="n">textColour</span>
    <span class="c1"># if self.colourScheme == &#39;light&#39;:</span>
    <span class="c1">#   colour = QtGui.QColor(&#39;#080000&#39;)</span>
    <span class="c1"># else:</span>
    <span class="c1">#   colour = QtGui.QColor(&#39;#f7ffff&#39;)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="n">colour</span><span class="p">))</span>
    <span class="c1">###self.setColor()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1"># self.updatePos()</span>

  <span class="c1"># @profile</span>
  <span class="c1"># should not ever call setupPeakAnnotationItem in paint()</span>
  <span class="c1"># instead make sure that you have appropriate notifiers call _refreshPeakAnnotation()</span>
<div class="viewcode-block" id="PeakNdAnnotation.setupPeakAnnotationItem"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.PeakNdAnnotation.setupPeakAnnotationItem">[docs]</a>  <span class="k">def</span> <span class="nf">setupPeakAnnotationItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakItem</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">peakItem</span> <span class="o">=</span> <span class="n">peakItem</span> <span class="c1"># When exporting to e.g. PDF the parentItem is temporarily set to None, which means that there must be a separate link to the PeakItem.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span>
    <span class="n">colour</span> <span class="o">=</span> <span class="n">peakItem</span><span class="o">.</span><span class="n">peakListView</span><span class="o">.</span><span class="n">textColour</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="n">colour</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">_getPeakAnnotation</span><span class="p">(</span><span class="n">peakItem</span><span class="o">.</span><span class="n">peak</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>
  
<div class="viewcode-block" id="PeakNdAnnotation.mousePressEvent"><a class="viewcode-back" href="../../../../../ccpn/ccpn.ui.gui.modules.html#ccpn.ui.gui.modules.GuiPeakListView.PeakNdAnnotation.mousePressEvent">[docs]</a>  <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">):</span><span class="c1"># and (</span>
              <span class="c1"># event.modifiers() &amp; QtCore.Qt.ControlModifier) and not (</span>
              <span class="c1"># event.modifiers() &amp; QtCore.Qt.ShiftModifier):</span>
      <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div></div>
      <span class="c1"># self.scene.clearSelection()</span>
      <span class="c1"># self.setFlag(QtGui.QGraphicsSimpleTextItem.ItemIsMovable)</span>
      <span class="c1"># QtGui.QGraphicsSimpleTextItem.mousePressEvent(self, event)</span>
      <span class="c1"># self.setSelected(True)</span>
      <span class="c1"># print(self.peakItem)</span>
      <span class="c1"># self.update()</span>

<span class="c1"># Notifiers for assignment annotation change</span>
<span class="c1"># Needed for:</span>
<span class="c1"># AbstractPeakDimContrib init and delete</span>
<span class="c1"># Resonance.setImplName, setResonanceGroup</span>
<span class="c1"># ResonanceGroup.setResonances, .setAssignedResidue, .setSequenceCode, .setResidueType</span>
<span class="c1">#   .setNmrChain</span>
<span class="c1"># NmrChain.setCode - NOT setResonanceGroups, as this calls setNmrChain on the other side.</span>

<span class="k">def</span> <span class="nf">_refreshPeakAnnotation</span><span class="p">(</span><span class="n">peak</span><span class="p">:</span><span class="n">Peak</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">peakListView</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">peakListViews</span><span class="p">:</span>
      <span class="n">peakItem</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">peakItems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">peakItem</span><span class="p">:</span>
        <span class="n">peakItem</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">setupPeakAnnotationItem</span><span class="p">(</span><span class="n">peakItem</span><span class="p">)</span>

<span class="n">Peak</span><span class="o">.</span><span class="n">_refreshPeakAnnotation</span> <span class="o">=</span> <span class="n">_refreshPeakAnnotation</span>

<span class="k">def</span> <span class="nf">_updateAssignmentsNmrAtom</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">,</span> <span class="n">oldPid</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Update Peak assignments when NmrAtom is reassigned&quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignedPeaks</span><span class="p">:</span>
    <span class="n">peak</span><span class="o">.</span><span class="n">_refreshPeakAnnotation</span><span class="p">()</span>

<span class="c1"># NB We could replace this with something like the following line,</span>
<span class="c1"># But that would trigger _refreshPeakAnnotation also when the position changes</span>
<span class="c1"># Better to keep it like this.</span>
<span class="c1"># Peak.setupCoreNotifier(&#39;change&#39;, _refreshPeakAnnotation)</span>
<span class="k">def</span> <span class="nf">_upDateAssignmentsPeakDimContrib</span><span class="p">(</span><span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span>
                                     <span class="n">apiPeakDimContrib</span><span class="p">:</span><span class="n">Nmr</span><span class="o">.</span><span class="n">AbstractPeakDimContrib</span><span class="p">):</span>
  <span class="n">peak</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">apiPeakDimContrib</span><span class="o">.</span><span class="n">peakDim</span><span class="o">.</span><span class="n">peak</span><span class="p">]</span>
  <span class="n">peak</span><span class="o">.</span><span class="n">_refreshPeakAnnotation</span><span class="p">()</span>


<span class="c1"># NB, This will be triggered whenever anything about the peak (assignment or position) changes</span>
<span class="k">def</span> <span class="nf">_refreshPeakPosition</span><span class="p">(</span><span class="n">peak</span><span class="p">:</span><span class="n">Peak</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">peakListView</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">peakListViews</span><span class="p">:</span>
    <span class="n">peakItem</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">peakItems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">peakItem</span><span class="p">:</span>
      <span class="n">spectrumIndices</span> <span class="o">=</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">_displayOrderSpectrumDimensionIndices</span>
      <span class="n">xAxisIndex</span> <span class="o">=</span> <span class="n">spectrumIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">yAxisIndex</span> <span class="o">=</span> <span class="n">spectrumIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="c1"># dataDims = peakListView.spectrumView._wrappedData.spectrumView.orderedDataDims</span>
      <span class="c1"># xPpm = peak.position[dataDims[0].dimensionIndex]</span>
      <span class="n">xPpm</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">xAxisIndex</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">peakListView</span><span class="o">.</span><span class="n">spectrumView</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># yPpm = peak.position[dataDims[1].dimensionIndex]</span>
        <span class="n">yPpm</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">yAxisIndex</span><span class="p">]</span>
        <span class="n">peakItem</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">xPpm</span><span class="p">,</span> <span class="n">yPpm</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">peakItem</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">xPpm</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">height</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Peak</span><span class="o">.</span><span class="n">_refreshPeakPosition</span> <span class="o">=</span> <span class="n">_refreshPeakPosition</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>