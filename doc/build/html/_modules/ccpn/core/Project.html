<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.core.Project &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.core.Project</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:32:29 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b2 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:41 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">ccpn.core._implementation.AbstractWrapperObject</span> <span class="kn">import</span> <span class="n">AbstractWrapperObject</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">Pid</span>
<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">Undo</span>
<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">Logging</span>
<span class="kn">from</span> <span class="nn">ccpn.util.ExcelReader</span> <span class="kn">import</span> <span class="n">ExcelReader</span>

<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.api.ccp.nmr.Nmr</span> <span class="kn">import</span> <span class="n">NmrProject</span> <span class="k">as</span> <span class="n">ApiNmrProject</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops</span> <span class="kn">import</span> <span class="n">Notifiers</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.memops.ApiError</span> <span class="kn">import</span> <span class="n">ApiError</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.molecule</span> <span class="kn">import</span> <span class="n">MoleculeQuery</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.spectrum</span> <span class="kn">import</span> <span class="n">NmrExpPrototype</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib</span> <span class="kn">import</span> <span class="n">Constants</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.Io</span> <span class="kn">import</span> <span class="n">Api</span> <span class="k">as</span> <span class="n">apiIo</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.Io</span> <span class="kn">import</span> <span class="n">Formats</span> <span class="k">as</span> <span class="n">ioFormats</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.Io</span> <span class="kn">import</span> <span class="n">Fasta</span> <span class="k">as</span> <span class="n">fastaIo</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.Io</span> <span class="kn">import</span> <span class="n">Pdb</span> <span class="k">as</span> <span class="n">pdbIo</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Logging</span> <span class="kn">import</span> <span class="n">getLogger</span>

<span class="c1"># TODO These should be merged with the sams constants in CcpnNefIo</span>
<span class="c1"># (and likely those in ExportNefPopup) and moved elsewhere</span>
<span class="n">CHAINS</span> <span class="o">=</span> <span class="s1">&#39;chains&#39;</span>
<span class="n">CHEMICALSHIFTLISTS</span> <span class="o">=</span> <span class="s1">&#39;chemicalShiftLists&#39;</span>
<span class="n">RESTRAINTLISTS</span> <span class="o">=</span> <span class="s1">&#39;restraintLists&#39;</span>
<span class="n">PEAKLISTS</span> <span class="o">=</span> <span class="s1">&#39;peakLists&#39;</span>
<span class="n">SAMPLES</span> <span class="o">=</span> <span class="s1">&#39;samples&#39;</span>
<span class="n">SUBSTANCES</span> <span class="o">=</span> <span class="s1">&#39;substances&#39;</span>
<span class="n">NMRCHAINS</span> <span class="o">=</span> <span class="s1">&#39;nmrChains&#39;</span>
<span class="n">DATASETS</span> <span class="o">=</span> <span class="s1">&#39;dataSets&#39;</span>
<span class="n">COMPLEXES</span> <span class="o">=</span> <span class="s1">&#39;complexes&#39;</span>
<span class="n">SPECTRUMGROUPS</span> <span class="o">=</span> <span class="s1">&#39;spectrumGroups&#39;</span>
<span class="n">NOTES</span> <span class="o">=</span> <span class="s1">&#39;notes&#39;</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="n">AbstractWrapperObject</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; The Project is the object that contains all data objects and serves as the hub for</span>
<span class="sd">  navigating between them.</span>

<span class="sd">  There are eleven top-level data objects directly within a project, of which seven have child</span>
<span class="sd">  objects of their own, namely Spectrum, Sample, Chain, NmrChain, ChemicalShiftList, DataSet</span>
<span class="sd">  and StructureEnsemble. The child data objects are organised in a logical hierarchy; for example,</span>
<span class="sd">  a Spectrum has PeakLists, which in turn, are made up of Peaks, whereas a Chain is made up of</span>
<span class="sd">  -Residues, which are made up of Atoms. &quot;&quot;&quot;</span>
  
  <span class="c1">#: Short class name, for PID.</span>
  <span class="n">shortClassName</span> <span class="o">=</span> <span class="s1">&#39;PR&#39;</span>
  <span class="c1"># Attribute it necessary as subclasses must use superclass className</span>
  <span class="n">className</span> <span class="o">=</span> <span class="s1">&#39;Project&#39;</span>

  <span class="c1">#: Name of plural link to instances of class</span>
  <span class="n">_pluralLinkName</span> <span class="o">=</span> <span class="s1">&#39;projects&#39;</span>
  
  <span class="c1">#: List of child classes.</span>
  <span class="n">_childClasses</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># All non-abstractWrapperClasses - filled in by</span>
  <span class="n">_allLinkedWrapperClasses</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># Utility map - class shortName and longName to class.</span>
  <span class="n">_className2Class</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="c1"># List of CCPN pre-registered api notifiers</span>
  <span class="c1"># Format is (wrapperFuncName, parameterDict, apiClassName, apiFuncName</span>
  <span class="c1"># The function self.wrapperFuncName(**parameterDict) will be registered</span>
  <span class="c1"># in the CCPN api notifier system</span>
  <span class="c1"># api notifiers are set automatically,</span>
  <span class="c1"># and are cleared by self._clearAllApiNotifiers and by self.delete()</span>
  <span class="c1"># RESTRICTED. Direct access in core classes ONLY</span>
  <span class="n">_apiNotifiers</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># Actions you can notify</span>
  <span class="n">_notifierActions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;rename&#39;</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">)</span>

  <span class="c1"># Qualified name of matching API class</span>
  <span class="n">_apiClassQualifiedName</span> <span class="o">=</span> <span class="n">ApiNmrProject</span><span class="o">.</span><span class="n">_metaclass</span><span class="o">.</span><span class="n">qualifiedName</span><span class="p">()</span>
  
  <span class="c1"># Top level mapping dictionaries:</span>
  <span class="c1"># pid to object and ccpnData to object</span>
  <span class="c1">#__slots__ = [&#39;_pid2Obj&#39;, &#39;_data2Obj&#39;]</span>

  <span class="c1"># Implementation methods</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">:</span> <span class="n">ApiNmrProject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Special init for root (Project) object</span>

<span class="sd">    NB Project is NOT complete before the _initProject function is run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">,</span> <span class="n">ApiNmrProject</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Project initialised with </span><span class="si">%s</span><span class="s2">, should be ccp.nmr.Nmr.NmrProject.&quot;</span>
                       <span class="o">%</span> <span class="n">wrappedData</span><span class="p">)</span>

    <span class="c1"># set up attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="o">=</span> <span class="n">wrappedData</span>
    <span class="c1"># self._id = _id = &#39;&#39;</span>
    
    <span class="c1"># setup object handling dictionaries</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span> <span class="o">=</span> <span class="p">{</span><span class="n">wrappedData</span><span class="p">:</span><span class="bp">self</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># self._pid2Obj[self.className] =  dd = {}</span>
    <span class="c1"># self._pid2Obj[self.shortClassName] = dd</span>
    <span class="c1"># dd[_id] = self</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>

    <span class="c1"># Set up notification machinery</span>

    <span class="c1"># Active notifiers - saved for later cleanup. CORER APPLICAATION ONLY</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># list or None. When set used to accumulate pending notifiers</span>
    <span class="c1"># Optional list. Elements are (func, onceOnly, wrapperObject, optional oldPid)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pendingNotifications</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Notification suspension level - to allow for nested notification suspension</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Notification blanking level - to allow for nested notification disabling</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Wrapper level notifier tracking.  APPLICATION ONLY</span>
    <span class="c1"># {(className,action):OrderedDict(notifier:onceOnly)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Special attributes:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_implExperimentTypeMap</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Set for Pre-May-2016 version. NBNB TODO remove when no longer needed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span> <span class="o">=</span> <span class="bp">None</span>


  <span class="k">def</span> <span class="nf">_initialiseProject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Complete initialisation of project,</span>

<span class="sd">    set up logger and notifiers, and wrap underlying data&quot;&quot;&quot;</span>

    <span class="c1"># The logger has already been set up when creating/loading the API project</span>
    <span class="c1"># so just get it</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">Logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="c1"># Set up notifiers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_registerPresetApiNotifiers</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coreNotifiers</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">registerNotifier</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">)</span>

    <span class="c1"># initialise, creating the wrapped objects</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_initializeAll</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clean up the wrapper project previous to deleting or replacing</span>

<span class="sd">    Cleanup includes wrapped data graphics objects (e.g. Window, Strip, ...)&quot;&quot;&quot;</span>
    <span class="c1"># Remove undo stack:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_resetUndo</span><span class="p">(</span><span class="n">maxWaypoints</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">apiIo</span><span class="o">.</span><span class="n">cleanupProject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_clearAllApiNotifiers</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;_data2Obj&#39;</span><span class="p">,</span><span class="s1">&#39;_pid2Obj&#39;</span><span class="p">):</span>
      <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
      <span class="c1"># delattr(self,tag)</span>
    <span class="c1"># del self._wrappedData</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

  <span class="c1"># This is all we want to happen</span>
  <span class="n">delete</span> <span class="o">=</span> <span class="n">_close</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;&lt;ccpn.core.Project:</span><span class="si">%s</span><span class="s2">, isDeleted=True&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;&lt;ccpn.core.Project:</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;&lt;PR:</span><span class="si">%s</span><span class="s2">, isDeleted=True&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;&lt;PR:</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


  <span class="c1"># CCPN properties  </span>
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Project id: Globally unique identifier (guid)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">guid</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">remapSeparators</span><span class="p">)</span>
    
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractWrapperObject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parent (containing) object.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="Project.save"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.save">[docs]</a>  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPath</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">changeBackup</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">createFallback</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">checkValid</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">changeDataLocations</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Save project with all data, optionally to new location or with new name.</span>
<span class="sd">    Unlike lower-level functions, this function ensures that data in high level caches are saved.</span>
<span class="sd">    Return True if save succeeded otherwise return False (or throw error)&quot;&quot;&quot;</span>
    <span class="c1"># self._flushCachedData()</span>
    <span class="n">savedOk</span> <span class="o">=</span>  <span class="n">apiIo</span><span class="o">.</span><span class="n">saveProject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">newPath</span><span class="o">=</span><span class="n">newPath</span><span class="p">,</span>
                                 <span class="n">changeBackup</span><span class="o">=</span><span class="n">changeBackup</span><span class="p">,</span> <span class="n">createFallback</span><span class="o">=</span><span class="n">createFallback</span><span class="p">,</span>
                                 <span class="n">overwriteExisting</span><span class="o">=</span><span class="n">overwriteExisting</span><span class="p">,</span> <span class="n">checkValid</span><span class="o">=</span><span class="n">checkValid</span><span class="p">,</span>
                                 <span class="n">changeDataLocations</span><span class="o">=</span><span class="n">changeDataLocations</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">savedOk</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>
      <span class="n">application</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span>
      <span class="k">if</span> <span class="n">application</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">_refreshAfterSave</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">savedOk</span></div>

  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;name of Project&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span>
    <span class="c1"># apiNmrProject = self._wrappedData</span>
    <span class="c1"># if len(apiNmrProject.root.nmrProjects) == 1:</span>
    <span class="c1">#   return apiNmrProject.root.name</span>
    <span class="c1"># else:</span>
    <span class="c1">#   return apiNmrProject.name</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;path to directory containing Project&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">apiIo</span><span class="o">.</span><span class="n">getRepositoryPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;userData&#39;</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">programName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Name of running program - defaults to &#39;CcpNmr&#39;&quot;&quot;&quot;</span>
    <span class="n">appBase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_appBase&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="s1">&#39;CcpNmr&#39;</span> <span class="k">if</span> <span class="n">appBase</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">appBase</span><span class="o">.</span><span class="n">applicationName</span>


<div class="viewcode-block" id="Project.deleteObjects"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.deleteObjects">[docs]</a>  <span class="k">def</span> <span class="nf">deleteObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objects</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Pid</span><span class="o">.</span><span class="n">Pid</span><span class="p">,</span> <span class="n">AbstractWrapperObject</span><span class="p">]]):</span>
    <span class="sd">&quot;&quot;&quot;Delete one or more objects, given as either objects or Pids&quot;&quot;&quot;</span>

    <span class="n">getByPid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getByPid</span>

    <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">getByPid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>
    <span class="n">apiObjs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_startDeleteCommandBlock</span><span class="p">(</span><span class="o">*</span><span class="n">apiObjs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
          <span class="c1"># If statement in case deleting one obj triggers the deletion of another</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_endDeleteCommandBlock</span><span class="p">(</span><span class="o">*</span><span class="n">apiObjs</span><span class="p">)</span></div>

  <span class="c1"># def renameObject(self, objectOrPid:typing.Union[str,AbstractWrapperObject], newName:str):</span>
  <span class="c1">#   &quot;&quot;&quot;Rename object indicated by objectOrPid to name newName</span>
  <span class="c1">#   NB at last one class (Substance) has a two-part name - these are passed as one,</span>
  <span class="c1">#   dot-separated string (e.g. &#39;Lysozyme.U13C&#39;&quot;&quot;&quot;</span>
  <span class="c1">#   obj = self._data2Obj.get(objectOrPid) if isinstance(objectOrPid, str) else objectOrPid</span>
  <span class="c1">#   names = newName.split(&#39;.&#39;)</span>
  <span class="c1">#   obj.rename(*names)</span>

<div class="viewcode-block" id="Project.execute"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.execute">[docs]</a>  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">funcName</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwparams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the object identified by pid, execute object.funcName(\*params, \*\*kwparams)</span>
<span class="sd">    and return the result&quot;&quot;&quot;</span>

    <span class="c1"># NBNB TODO - probably not useful - remove?</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No objet found with pid </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">funcName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Object *s has no method named </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">funcName</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwparams</span><span class="p">)</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_apiNmrProject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiNmrProject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;API equivalent to object: NmrProject&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span>

  <span class="c1"># Undo machinery</span>
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;undo stack for Project. Implementation attribute&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>

  <span class="k">def</span> <span class="nf">_resetUndo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxWaypoints</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">maxOperations</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="n">debug</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reset undo stack, using passed-in parameters.</span>
<span class="sd">    NB setting either parameter to 0 removes the undo stack.&quot;&quot;&quot;</span>
    <span class="n">Undo</span><span class="o">.</span><span class="n">resetUndo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">maxWaypoints</span><span class="o">=</span><span class="n">maxWaypoints</span><span class="p">,</span>
                   <span class="n">maxOperations</span><span class="o">=</span><span class="n">maxOperations</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

<div class="viewcode-block" id="Project.newUndoPoint"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.newUndoPoint">[docs]</a>  <span class="k">def</span> <span class="nf">newUndoPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set a point in the undo stack, you can undo/redo to &quot;&quot;&quot;</span>
    <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>
    <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to add undoPoint but undo is not initialised&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">undo</span><span class="o">.</span><span class="n">newWaypoint</span><span class="p">()</span>                      <span class="c1"># DO NOT CHANGE THIS ONE newWaypoint</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added undoPoint&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.blockWaypoints"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.blockWaypoints">[docs]</a>  <span class="k">def</span> <span class="nf">blockWaypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Block the setting of undo waypoints,</span>
<span class="sd">    so that command echoing (_startCommandBLock) does not set waypoints</span>

<span class="sd">    NB The programmer must GUARANTEE (try: ... finally) that waypoints are unblocked again&quot;&quot;&quot;</span>
    <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>
    <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to block waypoints but undo is not initialised&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">undo</span><span class="o">.</span><span class="n">increaseWaypointBlocking</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waypoint setting blocked&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.unblockWaypoints"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.unblockWaypoints">[docs]</a>  <span class="k">def</span> <span class="nf">unblockWaypoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Block the setting of undo waypoints,</span>
<span class="sd">    so that command echoing (_startCommandBLock) does not set waypoints</span>

<span class="sd">    NB The programmer must GUARANTEE (try: ... finally) that waypoints are unblocked again&quot;&quot;&quot;</span>
    <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_undo</span>
    <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Trying to unblock waypoints but undo is not initialised&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">undo</span><span class="o">.</span><span class="n">decreaseWaypointBlocking</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waypoint setting unblocked&quot;</span><span class="p">)</span></div>


  <span class="c1"># Should be removed:</span>
  <span class="nd">@property</span>
  <span class="k">def</span>  <span class="nf">_residueName2chemCompId</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;dict of {residueName:(molType,ccpCode)}&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">MoleculeQuery</span><span class="o">.</span><span class="n">fetchStdResNameMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_experimentTypeMap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;{dimensionCount : {sortedNucleusCodeTuple :</span>
<span class="sd">                          OrderedDict(experimentTypeSynonym : experimentTypeName)}}</span>
<span class="sd">    dictionary</span>

<span class="sd">    NB The OrderedDicts are ordered ad-hoc, with the most common experiments (hopefully) first</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># NB This is a hack, in order to rename experiments that we care particularly about</span>
    <span class="c1"># This should disappear under refactoring</span>
    <span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.spectrum.NmrExpPrototype</span> <span class="kn">import</span> <span class="n">priorityNameRemapping</span>

    <span class="c1"># NBNB TODO FIXME fetchIsotopeRefExperimentMap should be merged with</span>
    <span class="c1"># getExpClassificationDict output - we should NOT have two parallel dictionaries</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implExperimentTypeMap</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
      <span class="n">refExperimentMap</span> <span class="o">=</span> <span class="n">NmrExpPrototype</span><span class="o">.</span><span class="n">fetchIsotopeRefExperimentMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apiNmrProject</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">nucleusCodes</span><span class="p">,</span> <span class="n">refExperiments</span> <span class="ow">in</span> <span class="n">refExperimentMap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nucleusCodes</span><span class="p">)</span>
        <span class="n">dd1</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">result</span><span class="p">[</span><span class="n">ndim</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd1</span>

        <span class="n">dd2</span> <span class="o">=</span> <span class="n">dd1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nucleusCodes</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
        <span class="n">dd1</span><span class="p">[</span><span class="n">nucleusCodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd2</span>
        <span class="k">for</span> <span class="n">refExperiment</span> <span class="ow">in</span> <span class="n">refExperiments</span><span class="p">:</span>
          <span class="n">name</span> <span class="o">=</span> <span class="n">refExperiment</span><span class="o">.</span><span class="n">name</span>
          <span class="n">key</span> <span class="o">=</span> <span class="n">refExperiment</span><span class="o">.</span><span class="n">synonym</span> <span class="ow">or</span> <span class="n">name</span>
          <span class="n">key</span> <span class="o">=</span> <span class="n">priorityNameRemapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
          <span class="n">dd2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_implExperimentTypeMap</span> <span class="o">=</span> <span class="n">result</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span>


  <span class="c1">#</span>
  <span class="c1">#  Notifiers system</span>
  <span class="c1">#</span>

  <span class="c1"># Old, API-level functions:</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_setupApiNotifier</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setting up API notifiers for subsequent registration on each new project</span>
<span class="sd">       RESTRICTED. Use in core classes ONLY&quot;&quot;&quot;</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_apiNotifierParameters</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span>
                                <span class="n">parameterDict</span><span class="o">=</span><span class="n">parameterDict</span><span class="p">)</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_apiNotifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_apiNotifierParameters</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define func as method of project and return API parameters for notifier setup</span>
<span class="sd">    APPLICATION ONLY&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parameterDict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">parameterDict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">apiClassName</span> <span class="o">=</span> <span class="p">(</span><span class="n">apiClassOrName</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">apiClassOrName</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">apiClassOrName</span><span class="o">.</span><span class="n">_metaclass</span><span class="o">.</span><span class="n">qualifiedName</span><span class="p">())</span>

    <span class="n">dot</span> <span class="o">=</span> <span class="s1">&#39;_dot_&#39;</span>
    <span class="n">wrapperFuncName</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">dot</span><span class="p">),</span> <span class="n">dot</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">Project</span><span class="p">,</span> <span class="n">wrapperFuncName</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wrapperFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="p">,</span> <span class="n">apiClassName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_registerApiNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register notifier for immediate action on current project (only)</span>

<span class="sd">    func must be a function taking two parameters: the ccpn.core.Project and an Api object</span>
<span class="sd">    matching apiClassOrName.</span>

<span class="sd">    &#39;apiFuncName&#39; is either the name of an API modifier function (a setter, adder, remover),</span>
<span class="sd">    in which case the notifier is triggered by this function</span>
<span class="sd">    Or it is one of the following tags:</span>
<span class="sd">    (&#39;&#39;, &#39;__init__&#39;, &#39;postInit&#39;, &#39;preDelete&#39;, &#39;delete&#39;, &#39;startDeleteBlock&#39;, &#39;endDeleteBlock&#39;).</span>
<span class="sd">    &#39;&#39; registers the notifier to any modifier function call ( setter, adder, remover),</span>
<span class="sd">    __init__ and postInit triggers the notifier at the end of object creation, before resp.</span>
<span class="sd">    after execution of postConstructorCode, the four delete-related tags</span>
<span class="sd">    trigger notifiers at four different points in the deletion process</span>
<span class="sd">    (see memops.Implementation.DataObject.delete() code for details).</span>


<span class="sd">    ADVANCED, but free to use. Must be unregistered when any object referenced is deleted.</span>
<span class="sd">    Use return value as input parameter for _unregisterApiNotifier (if desired)&quot;&quot;&quot;</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_apiNotifierParameters</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">apiClassOrName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">,</span>
                                               <span class="n">parameterDict</span><span class="o">=</span><span class="n">parameterDict</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activateApiNotifier</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_unregisterApiNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notifierTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove acxtive notifier from project. ADVANVED but free to use.</span>
<span class="sd">    Use return value of _registerApiNotifier to identify the relevant notiifier&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">notifierTuple</span><span class="p">)</span>
    <span class="n">Notifiers</span><span class="o">.</span><span class="n">unregisterNotify</span><span class="p">(</span><span class="o">*</span><span class="n">notifierTuple</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">_registerPresetApiNotifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register preset API notifiers. APPLCATION ONLY&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apiNotifiers</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_activateApiNotifier</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_activateApiNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapperFuncName</span><span class="p">,</span> <span class="n">parameterDict</span><span class="p">,</span> <span class="n">apiClassName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Activate API notifier. APPLICATION ONLY&quot;&quot;&quot;</span>

    <span class="n">notify</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wrapperFuncName</span><span class="p">),</span> <span class="o">**</span><span class="n">parameterDict</span><span class="p">)</span>
    <span class="n">notifierTuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">apiClassName</span><span class="p">,</span> <span class="n">apiFuncName</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notifierTuple</span><span class="p">)</span>
    <span class="n">Notifiers</span><span class="o">.</span><span class="n">registerNotify</span><span class="p">(</span><span class="o">*</span><span class="n">notifierTuple</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">notifierTuple</span>



  <span class="k">def</span> <span class="nf">_clearAllApiNotifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CLear all notifiers, previous to closing or deleting Project</span>
<span class="sd">    APPLICATION ONLY</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="p">:</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeNotifiers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
      <span class="n">Notifiers</span><span class="o">.</span><span class="n">unregisterNotify</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">)</span>


  <span class="c1"># New notifier system (Free for use in application code):</span>

<div class="viewcode-block" id="Project.registerNotifier"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.registerNotifier">[docs]</a>  <span class="k">def</span> <span class="nf">registerNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
                       <span class="n">parameterDict</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">onceOnly</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register notifiers to be triggered when data change</span>

<span class="sd">    :param str className: className of wrapper class to monitor (AbstractWrapperObject for &#39;all&#39;)</span>

<span class="sd">    :param str target: can have the following values</span>

<span class="sd">      *&#39;create&#39;* is called after the creation (or undeletion) of the object and its wrapper.</span>
<span class="sd">      Notifier functions are called with the created wrapper object as the only parameter.</span>

<span class="sd">      *&#39;delete&#39;* is called after the object is deleted, but before the .id and .pid attributes</span>
<span class="sd">      are modified. Notifier functions are called with the deleted wrapper object as the only</span>
<span class="sd">      parameter.</span>

<span class="sd">      *&#39;rename&#39;* is called after the id and pid of an object has changed</span>
<span class="sd">      Notifier functions are called with the renamed wrapper object and the old pid as parameters.</span>

<span class="sd">      *&#39;change&#39;* when any object attribute changes value.</span>
<span class="sd">      Notifier functions are called with the created wrapper object as the only parameter.</span>
<span class="sd">      rename and crosslink notifiers (see below) may also trigger change notifiers.</span>

<span class="sd">      Any other value is interpreted as the name of a wrapper class, and the notifier</span>
<span class="sd">      is triggered when a cross link (NOT a parent-child link) between the className and</span>
<span class="sd">      the target class is modified</span>

<span class="sd">    :param Callable func: The function to call when the notifier is triggered.</span>

<span class="sd">      for actions &#39;create&#39;, &#39;delete&#39; and &#39;change&#39; the function is called with the object</span>
<span class="sd">      created (deleted, undeleted, changed) as the only parameter</span>

<span class="sd">      For action &#39;rename&#39; the function is called with an additional parameter: oldPid,</span>
<span class="sd">      the value of the pid before renaming.</span>

<span class="sd">      If target is a second className, the function is called with the project as the only</span>
<span class="sd">      parameter.</span>

<span class="sd">    param: dict parameterDict: Parameters passed to the notifier function before execution.</span>

<span class="sd">      This allows you to use the same function with different parameters in different contexts</span>

<span class="sd">    param: bool onceOnly: If True, only one of multiple copies is executed</span>

<span class="sd">      when notifiers are resumed after a suspension.</span>

<span class="sd">    return: The registered notifier (which can be passed to removeNotifier or duplicateNotifier)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifierActions</span><span class="p">:</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># This is right, it just looks strange. But if target is not an action it is</span>
      <span class="c1"># another className, and if so the names must be sorted.</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">]))</span>

    <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">parameterDict</span><span class="p">:</span>
      <span class="n">notifier</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">parameterDict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">notifier</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">if</span> <span class="n">od</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">od</span><span class="p">[</span><span class="n">notifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">onceOnly</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Coding error - notifier </span><span class="si">%s</span><span class="s2"> set twice for </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2"> &quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">notifier</span></div>

<div class="viewcode-block" id="Project.duplicateNotifier"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.duplicateNotifier">[docs]</a>  <span class="k">def</span> <span class="nf">duplicateNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">className</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">notifier</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">None</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;register copy of notifier for a new className and target.</span>
<span class="sd">    Intended for onceOnly=True notifiers. It is up to the user to make sure the calling</span>
<span class="sd">    interface matches the action&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifierActions</span><span class="p">:</span>

      <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># This is right, it just looks strange. But if target is not an action it is</span>
      <span class="c1"># another className, and if so the names must be sorted.</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">od</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="n">onceOnly</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">onceOnly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())[</span><span class="n">notifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">onceOnly</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown notifier: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">notifier</span><span class="p">)</span></div>


<div class="viewcode-block" id="Project.unRegisterNotifier"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.unRegisterNotifier">[docs]</a>  <span class="k">def</span> <span class="nf">unRegisterNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">className</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">notifier</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">None</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Unregister the notifier from this className, and target&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifierActions</span><span class="p">:</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># This is right, it just looks strange. But if target is not an action it is</span>
      <span class="c1"># another className, and if so the names must be sorted.</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">]))</span>
    <span class="n">od</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">tt</span><span class="p">),</span> <span class="p">{})</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">od</span><span class="p">[</span><span class="n">notifier</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempt to unregister unknown notifier </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">notifier</span><span class="p">,</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Project.removeNotifier"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.removeNotifier">[docs]</a>  <span class="k">def</span> <span class="nf">removeNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notifier</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">None</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Unregister the the notifier from all places where it appears.&quot;&quot;&quot;</span>
    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">od</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">od</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">od</span><span class="p">[</span><span class="n">notifier</span><span class="p">]</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempt to remove unknown notifier: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">notifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.blankNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.blankNotification">[docs]</a>  <span class="k">def</span> <span class="nf">blankNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disable notifiers temporarily</span>
<span class="sd">    e.g. to disable &#39;object modified&#39; notifiers during object creation</span>

<span class="sd">    Caller is responsible to make sure necessary notifiers are called, and to unblank after use&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Project.unblankNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.unblankNotification">[docs]</a>  <span class="k">def</span> <span class="nf">unblankNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resume notifier execution after blanking&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Code Error: _notificationBlanking below zero!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.suspendNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.suspendNotification">[docs]</a>  <span class="k">def</span> <span class="nf">suspendNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Suspend notifier execution and accumulate notifiers for later execution&quot;&quot;&quot;</span>
    <span class="k">return</span>
    <span class="c1"># TODO suspension temporarily disabled</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Project.resumeNotification"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.resumeNotification">[docs]</a>  <span class="k">def</span> <span class="nf">resumeNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute accumulated notifiers and resume immediate notifier execution&quot;&quot;&quot;</span>
    <span class="k">return</span>
    <span class="c1"># TODO suspension temporarily disabled</span>
    <span class="c1"># This was broken at one point, and we never found time to fix it</span>
    <span class="c1"># It is a time-saving measure, allowing you to e.g. execute a</span>
    <span class="c1"># peak-created notifier only once when creating hundreds of peaks in one operation</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Should not be necessary, but in this way we never get below 0 no matter what errors happen</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">scheduledNotifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">executeNotifications</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">pendingNotifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pendingNotifications</span>
      <span class="k">while</span> <span class="n">pendingNotifications</span><span class="p">:</span>
        <span class="n">notification</span> <span class="o">=</span> <span class="n">pendingNotifications</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">notifier</span> <span class="o">=</span> <span class="n">notification</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">onceOnly</span> <span class="o">=</span> <span class="n">notification</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">onceOnly</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">notifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scheduledNotifiers</span><span class="p">:</span>
            <span class="n">scheduledNotifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
            <span class="n">executeNotifications</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">notifier</span><span class="p">,</span> <span class="n">notification</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">executeNotifications</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">notifier</span><span class="p">,</span> <span class="n">notification</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
      <span class="c1">#</span>
      <span class="k">for</span> <span class="n">notifier</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">executeNotifications</span><span class="p">):</span>
        <span class="n">notifier</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span></div>


  <span class="c1"># Standard notified functions.</span>
  <span class="c1"># RESTRICTED. Use in core classes ONLY</span>

  <span class="k">def</span> <span class="nf">_startDeleteCommandBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">allWrappedData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call startCommandBlock for wrapper object delete. Implementation only&quot;&quot;&quot;</span>

    <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo</span>
    <span class="k">if</span> <span class="n">undo</span><span class="p">:</span>
      <span class="c1"># set undo step</span>
      <span class="n">undo</span><span class="o">.</span><span class="n">newWaypoint</span><span class="p">()</span>                      <span class="c1"># DO NOT CHANGE TH</span>
      <span class="n">undo</span><span class="o">.</span><span class="n">increaseWaypointBlocking</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span><span class="p">:</span>

      <span class="n">getDataObj</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">getDataObj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">allWrappedData</span><span class="p">]</span>
      <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">ss</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No object for deletion recognised among API objects: </span><span class="si">%s</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="n">allWrappedData</span><span class="p">)</span>
      <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;project.deleteObjects(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">ss</span>
      <span class="c1"># echo command strings</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">echoCommands</span><span class="p">((</span><span class="n">command</span><span class="p">,))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">+=</span> <span class="mi">1</span>


  <span class="k">def</span> <span class="nf">_endDeleteCommandBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">dummyWrappedData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;End block for delete command echoing</span>

<span class="sd">    MUST be paired with _startDeleteCommandBlock call - use try ... finally to ensure both are called&quot;&quot;&quot;</span>
    <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo</span>
    <span class="k">if</span> <span class="n">undo</span><span class="p">:</span>
      <span class="n">undo</span><span class="o">.</span><span class="n">decreaseWaypointBlocking</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># If statement should always be True, but to avoid weird behaviour in error situations we check</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">-=</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">_newApiObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">,</span> <span class="n">cls</span><span class="p">:</span><span class="n">AbstractWrapperObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create new wrapper object of class cls, associated with wrappedData.</span>
<span class="sd">    and call creation notifiers&quot;&quot;&quot;</span>

    <span class="n">factoryFunction</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_factoryFunction</span>
    <span class="k">if</span> <span class="n">factoryFunction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Necessary for classes where you need to instantiate a subclass instead</span>

      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">)</span>
      <span class="c1"># There are cases where _newApiObject is registered twice,</span>
      <span class="c1"># when two wrapper classes share the same API class</span>
      <span class="c1"># (Peak,Integral; PeakList, IntegralList)</span>
      <span class="c1"># In those cases only the notifiers are done the second time</span>
      <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">factoryFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">_modifiedApiObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; call object-has-changed notifiers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">wrappedData</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_finaliseApiDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clean up after object deletion - and call deletion notifiers</span>
<span class="sd">    Notifiers are called AFTER wrappedData are deleted, but BEFORE  wrapper objects are modified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_finaliseApiDelete called before wrapped data are deleted: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wrappedData</span><span class="p">)</span>

    <span class="c1"># get object</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span>

    <span class="c1"># remove from wrapped2Obj</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">wrappedData</span><span class="p">]</span>

    <span class="c1"># remove from pid2Obj</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">][</span><span class="n">obj</span><span class="o">.</span><span class="n">_id</span><span class="p">]</span>

    <span class="c1"># Mark object as obviously deleted, and set up for undeletion</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">_id</span> <span class="o">+=</span> <span class="s1">&#39;-Deleted&#39;</span>
    <span class="n">wrappedData</span><span class="o">.</span><span class="n">_oldWrapperObject</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">_finaliseApiUnDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;restore undeleted wrapper object, and call creation notifiers,</span>
<span class="sd">    same as _newObject&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_finaliseApiUnDelete called before wrapped data are deleted: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wrappedData</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">oldWrapperObject</span> <span class="o">=</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">_oldWrapperObject</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">ApiError</span><span class="p">(</span><span class="s2">&quot;Wrapper object to undelete wrongly set up - lacks _oldWrapperObject attribute&quot;</span><span class="p">)</span>

    <span class="c1"># put back in from wrapped2Obj</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">wrappedData</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldWrapperObject</span>

    <span class="k">if</span> <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-Deleted&#39;</span><span class="p">):</span>
      <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>

    <span class="c1"># put back in pid2Obj</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="p">[</span><span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">][</span><span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldWrapperObject</span>

    <span class="c1"># Restore object to pre-undeletion state</span>
    <span class="k">del</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">_oldWrapperObject</span>
    <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="o">=</span> <span class="n">wrappedData</span>

    <span class="n">oldWrapperObject</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">_notifyRelatedApiObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">,</span> <span class="n">pathToObject</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; call &#39;action&#39; type notifiers for getattribute(pathToObject)(wrappedData)</span>
<span class="sd">    pathToObject is a navigation path (may contain dots) and must yield an API object</span>
<span class="sd">    or an iterable of API objects&quot;&quot;&quot;</span>

    <span class="n">getDataObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">pathToObject</span><span class="p">)(</span><span class="n">wrappedData</span><span class="p">)</span>

    <span class="c1"># GWV: a bit too much for now; should be the highest debug level only</span>
    <span class="c1">#self._project._logger.debug(&#39;%s: %s.%s = %s&#39;</span>
    <span class="c1">#                            % (action, wrappedData, pathToObject, target))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;_metaclass&#39;</span><span class="p">):</span>
      <span class="c1"># Hack. This is an API object</span>
      <span class="n">getDataObj</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># This must be an iterable</span>
      <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
        <span class="n">getDataObj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_finaliseApiRename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reset Finalise rename - called from APi object (for API notifiers)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;rename&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_modifiedLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">classNames</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; call link-has-changed notifiers</span>
<span class="sd">    The notifier function called must have the signature</span>
<span class="sd">    func(project, **parameterDict)</span>

<span class="sd">    NB</span>
<span class="sd">    1) calls to this function must be set up explicitly in the wrapper for each crosslink</span>
<span class="sd">    2) This function is only called when the link is changed explicitly, not when</span>
<span class="sd">    a linked object is created or deleted&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notificationBlanking</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="c1"># get object</span>
    <span class="n">className</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">classNames</span><span class="p">))</span>
    <span class="c1"># self._doNotification(classNames[0], classNames[1], self)</span>
    <span class="c1"># NB &#39;AbstractWrapperObject&#39; not currently in use (Sep 2016), but kept for future needs</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="n">OrderedDict</span><span class="p">())</span>
               <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="s1">&#39;AbstractWrapperObject&#39;</span><span class="p">))</span>
    <span class="c1"># Notification suspension postpones notifications (and removes duplicates)</span>
    <span class="c1"># It is broken and has been disabled for a long time.</span>
    <span class="c1"># There may be some accumulated bugs when (if)it is turned back on.</span>
    <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notificationSuspension</span><span class="p">:</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pendingNotifications</span>
      <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">notifier</span><span class="p">,</span> <span class="n">onceOnly</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
          <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">notifier</span><span class="p">,</span> <span class="n">onceOnly</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
          <span class="n">notifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="c1"># Library functions</span>

<div class="viewcode-block" id="Project.exportNef"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.exportNef">[docs]</a>  <span class="k">def</span> <span class="nf">exportNef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span>
                <span class="p">,</span> <span class="n">overwriteExisting</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span>
                <span class="p">,</span> <span class="n">skipPrefixes</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Sequence</span><span class="o">=</span><span class="p">()</span>
                <span class="p">,</span> <span class="n">expandSelection</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">True</span>
                <span class="p">,</span> <span class="n">pidList</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export selected contents of the project to a Nef file.</span>

<span class="sd">      skipPrefixes: ( &#39;ccpn&#39;, ..., &lt;str&gt; )</span>
<span class="sd">      expandSelection: &lt;bool&gt; }</span>

<span class="sd">      Include &#39;ccpn&#39; in the skipPrefixes list will exclude ccpn specific items from the file</span>
<span class="sd">      expandSelection = True  will include all data from the project, this may not be data that</span>
<span class="sd">                              is not defined in the Nef standard.</span>

<span class="sd">    PidList is a list of &lt;str&gt;, e.g. &#39;NC:@-&#39;, obtained from the objects to be included.</span>
<span class="sd">    The Nef file may also contain further dependent items associated with the pidList.</span>

<span class="sd">    :param path: output path and filename</span>
<span class="sd">    :param skipPrefixes: items to skip</span>
<span class="sd">    :param expandSelection: expand the selection</span>
<span class="sd">    :param pidList: a list of pids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">CcpnNefIo</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

    <span class="n">defaults</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                            <span class="p">,</span> <span class="p">(</span><span class="s1">&#39;overwriteExisting&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                            <span class="p">,</span> <span class="p">(</span><span class="s1">&#39;skipPrefixes&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                            <span class="p">,</span> <span class="p">(</span><span class="s1">&#39;expandSelection&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                            <span class="p">,</span> <span class="p">(</span><span class="s1">&#39;pidList&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_startCommandEchoBlock</span><span class="p">(</span><span class="s1">&#39;exportNef&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo</span>
    <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">undo</span><span class="o">.</span><span class="n">increaseBlocking</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">blankNotification</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
      <span class="n">CcpnNefIo</span><span class="o">.</span><span class="n">exportNef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span>
                          <span class="p">,</span> <span class="n">overwriteExisting</span><span class="o">=</span><span class="n">overwriteExisting</span>
                          <span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="n">skipPrefixes</span>
                          <span class="p">,</span> <span class="n">expandSelection</span><span class="o">=</span><span class="n">expandSelection</span>
                          <span class="p">,</span> <span class="n">pidList</span><span class="o">=</span><span class="n">pidList</span><span class="p">)</span>
      <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
      <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exported NEF file, time = </span><span class="si">%.2f</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

    <span class="k">finally</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_endCommandEchoBlock</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unblankNotification</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">undo</span><span class="o">.</span><span class="n">decreaseBlocking</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.loadData"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.loadData">[docs]</a>  <span class="k">def</span> <span class="nf">loadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load data from path, determining type first.</span>
<span class="sd">    Return None for Un-recognised or un-parsable files; return empty list for ???</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: RASMUS:</span>
    <span class="c1"># RASMUS EXPLANATION (to my successor)</span>
    <span class="c1"># loadData does too many things: it is used for handling dropped files,</span>
    <span class="c1"># which includes a system for deciding what actions are taken where for what file types,</span>
    <span class="c1"># and it is called directly for loading e.g. a spectrum.</span>
    <span class="c1">#</span>
    <span class="c1"># Part of the idea was that a file of type &#39;Xyz&#39; being dropped would trigger</span>
    <span class="c1"># a call to &#39;_loadXyz&#39; if, and only if, _loadXyz was defined for the object</span>
    <span class="c1"># in question. That allowed you to control which drops were allowed where, and what</span>
    <span class="c1"># specific actions should be triggered.</span>
    <span class="c1">#</span>
    <span class="c1"># The entire system has been (partially??) refactored by GV, so it is necessary to rethink this.</span>
    <span class="c1"># My proposal (hopefully consistent with GV&#39;s (?)) would be to use this function</span>
    <span class="c1"># ONLY to handle drops and other files of unknown type (and likely rename it _loadData&#39;)</span>
    <span class="c1"># and to call specific functions (like loadSpectrum) when you know that you are loading e.g. a</span>
    <span class="c1"># spectrum or a project (currently loadData is (too) widely used.</span>
    <span class="c1"># Some of these functions may or may not need to be written first.</span>
    <span class="c1"># That still leaves the question of how to handle a case where e.g. a text</span>
    <span class="c1"># file should trigger a specific action when loaded e.g. on a Note editor popup and oNLY there,</span>
    <span class="c1"># but that must be thought out and decided.</span>
    <span class="c1"># Anyway, this function should have a proper and consistent return type (as GV says)</span>
    <span class="c1"># Maybe we should consider returning a dictionary rather than a list of tuples??</span>

    <span class="c1"># urlInfo is list of triplets of (type, subType, modifiedUrl),</span>
    <span class="c1"># e.g. (&#39;Spectrum&#39;, &#39;Bruker&#39;, newUrl)</span>
    <span class="n">dataType</span><span class="p">,</span> <span class="n">subType</span><span class="p">,</span> <span class="n">usePath</span> <span class="o">=</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">analyseUrl</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1">#TODO:RASMUS: Replace prints by logger calls</span>
    <span class="c1">#TODO:RASMUS: Fix all return types; define properly first</span>
    <span class="k">if</span> <span class="n">dataType</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skipping: file data type not recognised for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">usePath</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="k">elif</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;Dirs&#39;</span><span class="p">:</span>
      <span class="c1"># special case - usePath is a list of paths from a top dir with enumerate subDirs and paths.</span>
      <span class="n">paths</span> <span class="o">=</span> <span class="n">usePath</span>
      <span class="c1">#TODO:RASMUS: Undefined return type</span>
      <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">usePath</span><span class="p">):</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skipping: no file found at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">usePath</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[]</span>

    <span class="k">elif</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;Text&#39;</span><span class="p">:</span>
      <span class="c1"># Special case - you return the text instead of a list of Pids</span>
      <span class="c1"># GWV: Can&#39;t do this!! -&gt; have to return a list of tuples: [(dataType, pid or data)]</span>
      <span class="c1"># need to define these dataTypes as CONSTANTS in the ioFormats.analyseUrl routine!</span>
      <span class="c1">#TODO:RASMUS: return type is not a list</span>
      <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">usePath</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;Macro&#39;</span> <span class="ow">and</span> <span class="n">subType</span> <span class="o">==</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">PYTHON</span><span class="p">:</span>
      <span class="c1"># GWV: Can&#39;t do this: have to call the routine with a flag: autoExecute=True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">runMacro</span><span class="p">(</span><span class="n">usePath</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;Project&#39;</span> <span class="ow">and</span> <span class="n">subType</span> <span class="o">==</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">CCPNTARFILE</span><span class="p">:</span>
      <span class="n">projectPath</span><span class="p">,</span> <span class="n">temporaryDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_unpackCcpnTarfile</span><span class="p">(</span><span class="n">usePath</span><span class="p">)</span>
      <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">projectPath</span><span class="p">,</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">CCPN</span><span class="p">)</span>
      <span class="c1">#TODO:RASMUS: use python tmpdir or V3 calss</span>
      <span class="c1"># NBNB _unpackCcpnTarfile *does* use the Python tempfile module</span>
      <span class="n">project</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_temporaryDirectory</span> <span class="o">=</span> <span class="n">temporaryDirectory</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">project</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># No idea what is going on here</span>
      <span class="c1">#TODO: use a dictionary to define</span>
      <span class="n">funcname</span> <span class="o">=</span> <span class="s1">&#39;_load&#39;</span> <span class="o">+</span> <span class="n">dataType</span>
      <span class="k">if</span> <span class="n">funcname</span> <span class="o">==</span> <span class="s1">&#39;_loadProject&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">usePath</span><span class="p">,</span> <span class="n">subType</span><span class="p">)]</span>

      <span class="k">elif</span> <span class="n">funcname</span> <span class="o">==</span> <span class="s1">&#39;_loadSpectrum&#39;</span><span class="p">:</span>
        <span class="c1"># NBNB TBD #TODO:RASMUS:FIXME check if loadSpectrum should start with underscore</span>
        <span class="c1"># (NB referred to elsewhere</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadSpectrum</span><span class="p">(</span><span class="n">usePath</span><span class="p">,</span> <span class="n">subType</span><span class="p">)</span>

      <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)(</span><span class="n">usePath</span><span class="p">,</span> <span class="n">subType</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pids</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skipping: project has no function </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">funcname</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[]</span></div>

  <span class="c1"># Data loaders and dispatchers</span>
  <span class="k">def</span> <span class="nf">_loadSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">subType</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load sequence(s) from file into Wrapper project&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">subType</span> <span class="o">==</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">FASTA</span><span class="p">:</span>
      <span class="n">sequences</span> <span class="o">=</span> <span class="n">fastaIo</span><span class="o">.</span><span class="n">parseFastaFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sequence file type </span><span class="si">%s</span><span class="s2"> is not recognised&quot;</span> <span class="o">%</span> <span class="n">subType</span><span class="p">)</span>

    <span class="n">chains</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
      <span class="n">chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">createChain</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">compoundName</span><span class="o">=</span><span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">molType</span><span class="o">=</span><span class="s1">&#39;protein&#39;</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">chains</span>


  <span class="k">def</span> <span class="nf">_loadStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">subType</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load Structure ensemble(s) from file into Wrapper project</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">ccpn.util.StructureData</span> <span class="kn">import</span> <span class="n">averageStructure</span>
    <span class="k">if</span> <span class="n">subType</span> <span class="o">==</span> <span class="s1">&#39;PDB&#39;</span><span class="p">:</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadPdbStructure</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;{} type structures cannot be loaded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subType</span><span class="p">))</span>
    <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newStructureEnsemble</span><span class="p">()</span>
    <span class="n">se</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ensemble</span>
    <span class="n">se</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newDataSet</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">newData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Derived&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">setParameter</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">averageStructure</span><span class="p">(</span><span class="n">ensemble</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">se</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">_loadPdbStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">ccpn.util.StructureData</span> <span class="kn">import</span> <span class="n">EnsembleData</span>

    <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleData</span><span class="o">.</span><span class="n">from_pdb</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">label</span><span class="p">,</span> <span class="n">ensemble</span>

  <span class="k">def</span> <span class="nf">_loadNefFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">subType</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a Nef file into an existing project</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ejb - 24/6/17</span>
    <span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">CcpnNefIo</span>

    <span class="k">if</span> <span class="n">subType</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ioFormats</span><span class="o">.</span><span class="n">NEF</span><span class="p">):</span>

      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

      <span class="c1"># # load Nef File here</span>
      <span class="c1"># nefReader = CcpnNefIo.CcpnNefReader(self)</span>
      <span class="c1">#</span>
      <span class="c1"># dataBlock = nefReader.getNefData(path)</span>
      <span class="c1"># # project = self.newProject(dataBlock.name)</span>
      <span class="c1"># # self._echoBlocking += 1</span>
      <span class="c1"># self._undo.increaseBlocking()</span>
      <span class="c1"># self._wrappedData.shiftAveraging = False</span>
      <span class="c1">#</span>
      <span class="c1"># nefReader.importNewProject(self, dataBlock)</span>
      <span class="c1">#</span>
      <span class="c1"># self._wrappedData.shiftAveraging = True</span>
      <span class="c1"># # self._echoBlocking -= 1</span>
      <span class="c1"># self._undo.decreaseBlocking()</span>
      <span class="c1">#</span>
      <span class="c1"># return True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Project file type </span><span class="si">%s</span><span class="s2"> is not recognised&quot;</span> <span class="o">%</span> <span class="n">subType</span><span class="p">)</span>

<div class="viewcode-block" id="Project.loadProject"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.loadProject">[docs]</a>  <span class="k">def</span> <span class="nf">loadProject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">subType</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Project&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load project from file into application and return the new project&quot;&quot;&quot;</span>

    <span class="c1"># if subType == ioFormats.CCPN:</span>
    <span class="k">if</span> <span class="n">subType</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ioFormats</span><span class="o">.</span><span class="n">CCPN</span><span class="p">,</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">NEF</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Project file type </span><span class="si">%s</span><span class="s2"> is not recognised&quot;</span> <span class="o">%</span> <span class="n">subType</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.loadSpectrum"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.loadSpectrum">[docs]</a>  <span class="k">def</span> <span class="nf">loadSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">subType</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load spectrum from file into application&quot;&quot;&quot;</span>

    <span class="c1"># #TODO:RASMUS FIXME check for rename</span>

    <span class="n">apiDataSource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">loadDataSource</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subType</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apiDataSource</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">apiDataSource</span><span class="p">]</span>
      <span class="n">spectrum</span><span class="o">.</span><span class="n">assignmentTolerances</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">defaultAssignmentTolerances</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">spectrum</span><span class="p">]</span></div>

  <span class="k">def</span> <span class="nf">_loadLookupFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">subType</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data from a look-up file, csv or xls .&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">subType</span> <span class="o">==</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">CSV</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This function has not been implemented yet&quot;</span><span class="p">)</span>
      <span class="c1"># readCsv(self, path=path)</span>

    <span class="k">elif</span> <span class="n">subType</span> <span class="o">==</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">EXCEL</span><span class="p">:</span>
      <span class="n">ExcelReader</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">excelPath</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">_uniqueSubstanceName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">defaultName</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span> <span class="s1">&#39;Molecule&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;add integer suffixed to name till it is unique&quot;&quot;&quot;</span>

    <span class="n">apiComponentStore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">sampleStore</span><span class="o">.</span><span class="n">refSampleComponentStore</span>
    <span class="n">apiProject</span> <span class="o">=</span><span class="n">apiComponentStore</span><span class="o">.</span><span class="n">root</span>

    <span class="c1"># ensure substance name is unique</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">name</span>
      <span class="n">formstring</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">formstring</span> <span class="o">=</span> <span class="n">defaultName</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span>
      <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">result</span> <span class="o">=</span>  <span class="n">formstring</span> <span class="o">%</span> <span class="n">i</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">apiProject</span><span class="o">.</span><span class="n">findFirstMolecule</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">result</span><span class="p">)</span> <span class="ow">or</span>
           <span class="n">apiComponentStore</span><span class="o">.</span><span class="n">findFirstComponent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">result</span><span class="p">)):</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">formstring</span> <span class="o">%</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">defaultName</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
      <span class="s2">&quot;CCPN molecule named </span><span class="si">%s</span><span class="s2"> already exists. New molecule has been named </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
      <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">result</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="Project.getObjectsByPartialId"><a class="viewcode-back" href="../../../ccpn/ccpn.core.html#ccpn.core.Project.Project.getObjectsByPartialId">[docs]</a>  <span class="k">def</span> <span class="nf">getObjectsByPartialId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">className</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                            <span class="n">idStartsWith</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">AbstractWrapperObject</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;get objects from class name / shortName and the start of the ID.</span>

<span class="sd">    The function does NOT interrogate the API level, which makes it faster in a</span>
<span class="sd">    number fo cases, e.g. for NmrResidues&quot;&quot;&quot;</span>

    <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
      <span class="c1"># NB the _pid2Obj entry is set in the object init.</span>
      <span class="c1"># The relevant dictionary may therefore be missing if no object has yet been created</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">idStartsWith</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>