<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.core._implementation.AbstractWrapperObject &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.core._implementation.AbstractWrapperObject</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:32:31 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b3 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:41 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">ccpn.core</span> <span class="kn">import</span> <span class="n">_importOrder</span>
<span class="c1"># from ccpn.core.lib import CcpnSorting</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">Util</span> <span class="k">as</span> <span class="n">coreUtil</span>
<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">Common</span> <span class="k">as</span> <span class="n">commonUtil</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">Pid</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.api.memops</span> <span class="kn">import</span> <span class="n">Implementation</span> <span class="k">as</span> <span class="n">ApiImplementation</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.ContextManagers</span> <span class="kn">import</span> <span class="n">deleteObject</span>


<span class="nd">@functools.total_ordering</span>
<span class="k">class</span> <span class="nc">AbstractWrapperObject</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Abstract class containing common functionality for subclasses.</span>

<span class="sd">    ADVANCED. Core programmers only.</span>


<span class="sd">    **Rules for subclasses:**</span>

<span class="sd">    All collection attributes are tuples. For objects these are sorted by pid;</span>
<span class="sd">    for simple values they are ordered.</span>

<span class="sd">    Non-child collection attributes must have addElement() and removeElement</span>
<span class="sd">    functions as appropriate.</span>

<span class="sd">    For each child class there will be a newChild factory function, to crate</span>
<span class="sd">    the child object. There will be a collection attribute for each child,</span>
<span class="sd">    grandchild, and generally descendant.</span>

<span class="sd">    The object pid is given as NM:key1.key2.key3 ... where NM is the shortClassName,</span>
<span class="sd">    and the combination of key1, key2, etc. forms the id, which is the keys of the parent</span>
<span class="sd">    classes starting at the top.</span>
<span class="sd">    The pid is the object id relative to the project; keys relative to objects lower</span>
<span class="sd">    in the hierarchy will omit successively more keys.</span>


<span class="sd">    **Code organisation:**</span>

<span class="sd">    All code related to a given class lives in the file for the class.</span>
<span class="sd">    On importing it, it will insert relevant functions in the parent class.</span>
<span class="sd">    All import must be through the ccpn module, where it is guaranteed that</span>
<span class="sd">    all modules are imported in the right order.</span>

<span class="sd">    All actual data live</span>
<span class="sd">    in the data layer underneath these (wrapper) classes and are derived where needed.</span>
<span class="sd">    All data storage is done</span>
<span class="sd">    at the lower level, not at the wrapper level, and there is no mechanism for</span>
<span class="sd">    storing attributes that have been added at the wrapper level. Key and uniqueness</span>
<span class="sd">    checking, type checking etc.  is also done at teh lower level.</span>

<span class="sd">    Initialising happens by passing in a (lower-level) NmrProject instance to the Project</span>
<span class="sd">     __init__;</span>
<span class="sd">    all wrapper instances are created automatically starting from there. Unless we change this,</span>
<span class="sd">    this means we assume that all data can be found by navigating from an</span>
<span class="sd">    NmrProject.</span>

<span class="sd">    New classes can be added, provided they match the requirements. All classes</span>
<span class="sd">    must form a parent-child tree with the root at Project. All classes must</span>
<span class="sd">    must have teh standard class-level attributes, such as  shortClassName, _childClasses,</span>
<span class="sd">    and _pluralLinkName.</span>
<span class="sd">    Each class must implement the properties id and _parent, and the methods</span>
<span class="sd">    _getAllWrappedData,  and rename. Note that the</span>
<span class="sd">    properties and the _getAllWrappedData function</span>
<span class="sd">    must work from the underlying data, as they will be called before the pid</span>
<span class="sd">    and object dictionary data are set up.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Short class name, for PID. Must be overridden for each subclass</span>
    <span class="n">shortClassName</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Class name - necessary since the actual objects may be of a subclass.</span>
    <span class="n">className</span> <span class="o">=</span> <span class="s1">&#39;AbstractWrapperObject&#39;</span>

    <span class="n">_parentClass</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">#: Name of plural link to instances of class</span>
    <span class="n">_pluralLinkName</span> <span class="o">=</span> <span class="s1">&#39;abstractWrapperClasses&#39;</span>

    <span class="c1">#: List of child classes. Must be overridden for each subclass.</span>
    <span class="n">_childClasses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># GWV 20181123: deactivated</span>
    <span class="c1"># Wrapper-level notifiers that are set up on code import and</span>
    <span class="c1"># registered afresh for every new project</span>
    <span class="c1"># _coreNotifiers = []</span>

    <span class="c1"># Should notifiers be registered separately for this class?</span>
    <span class="c1"># Set to False if multiple wrapper classes wrap the same API class (e.g. PeakList, IntegralList;</span>
    <span class="c1"># Peak, Integral) so that API level notifiers are only registered once.</span>
    <span class="n">_registerClassNotifiers</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># Function to generate custom subclass instances -= overridden in some subclasses</span>
    <span class="n">_factoryFunction</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Default values for paraeters to &#39;new&#39; function. Overridden in subclasses</span>
    <span class="n">_defaultInitValues</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Implementation methods</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="s1">&#39;Project&#39;</span><span class="p">,</span> <span class="n">wrappedData</span><span class="p">:</span> <span class="n">ApiImplementation</span><span class="o">.</span><span class="n">DataObject</span><span class="p">):</span>

        <span class="c1"># NB project parameter type is Project. Set in Project.py</span>

        <span class="c1"># NB wrappedData must be globally unique. CCPN objects all are,</span>
        <span class="c1"># but for non-CCPN objects this must be ensured.</span>

        <span class="c1"># Check if object is already wrapped</span>
        <span class="n">data2Obj</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_data2Obj</span>
        <span class="k">if</span> <span class="n">wrappedData</span> <span class="ow">in</span> <span class="n">data2Obj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot create new object for underlying </span><span class="si">%s</span><span class="s2">: One  already exists&quot;</span>
                             <span class="o">%</span> <span class="n">wrappedData</span><span class="p">)</span>

        <span class="c1"># initialise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="o">=</span> <span class="n">wrappedData</span>
        <span class="n">data2Obj</span><span class="p">[</span><span class="n">wrappedData</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_resetIds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># reset id</span>
        <span class="n">oldId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
        <span class="n">className</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">className</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># This is the project</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">name</span>
            <span class="n">sortKey</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="n">project</span><span class="p">:</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>
            <span class="n">sortKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_localCcpnSortKey</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">Pid</span><span class="o">.</span><span class="n">IDSEP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>
            <span class="n">sortKey</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_ccpnSortKey</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_localCcpnSortKey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">_id</span>

        <span class="c1"># A bit inelegant, but Nmrresidue is handled specially,</span>
        <span class="c1"># with a _ccpnSortKey property</span>
        <span class="k">if</span> <span class="n">className</span> <span class="o">!=</span> <span class="s1">&#39;NmrResidue&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ccpnSortKey</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">project</span><span class="p">),</span> <span class="n">_importOrder</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">className</span><span class="p">))</span> <span class="o">+</span> <span class="n">sortKey</span>

        <span class="c1"># update pid:object mapping dictionary</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">project</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="p">[</span><span class="n">className</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span>
            <span class="n">project</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span>
        <span class="c1"># assert oldId is not None</span>
        <span class="k">if</span> <span class="n">oldId</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">dd</span><span class="p">[</span><span class="n">oldId</span><span class="p">]</span>
        <span class="n">dd</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Truth value: true - wrapper classes are never empty&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ordering implementation function, necessary for making lists sortable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;_ccpnSortKey&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ccpnSortKey</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">_ccpnSortKey</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;ccpn.core.</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">longPid</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Readable string representation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Python 2 behaviour - objects equal only to themselves.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Python 2 behaviour - objects equal only to themselves.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">other</span>

    <span class="n">__hash__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__hash__</span>

    <span class="c1">#--------------------------------------------------------------------------------------------</span>
    <span class="c1"># CCPN properties</span>
    <span class="c1">#--------------------------------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">className</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Class name - necessary since the actual objects may be of a subclass..&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">className</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shortClassName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Short class name, for PID. Must be overridden for each subclass.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">shortClassName</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Project&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The Project (root)containing the object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pid</span><span class="o">.</span><span class="n">Pid</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Identifier for the object, unique within the project.</span>
<span class="sd">        Set automatically from the short class name and object.id</span>
<span class="sd">        E.g. &#39;NA:A.102.ALA.CA&#39; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Pid</span><span class="o">.</span><span class="n">Pid</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">PREFIXSEP</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">longPid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pid</span><span class="o">.</span><span class="n">Pid</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Identifier for the object, unique within the project.</span>
<span class="sd">        Set automatically from the full class name and object.id</span>
<span class="sd">        E.g. &#39;NmrAtom:A.102.ALA.CA&#39; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Pid</span><span class="o">.</span><span class="n">Pid</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">PREFIXSEP</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">className</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_longName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;long name generated form the name and the object id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Pid</span><span class="o">.</span><span class="n">Pid</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">PREFIXSEP</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isDeleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;True if this object is deleted.&quot;&quot;&quot;</span>
        <span class="c1"># The many variants are to make sure this catches deleted objects</span>
        <span class="c1"># also during the deletion process, for filtering</span>
        <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_wrappedData&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span> <span class="ow">is</span> <span class="bp">None</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">,</span> <span class="s1">&#39;_data2Obj&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_ccpnInternalData</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dictionary containing arbitrary type data for internal use.</span>

<span class="sd">        Data can be nested strings, numbers, lists, tuples, (ordered) dicts,</span>
<span class="sd">        numpy arrays, pandas structures, CCPN Tensor objects, and any</span>
<span class="sd">        object that can be serialised to JSON. This does NOT include CCPN or</span>
<span class="sd">        CCPN API objects.</span>

<span class="sd">        NB This returns the INTERNAL dictionary. There is NO encapsulation</span>

<span class="sd">        Data are kept on save and reload, but there is NO guarantee against</span>
<span class="sd">        trampling by other code&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">ccpnInternalData</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">ccpnInternalData</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@_ccpnInternalData.setter</span>
    <span class="k">def</span> <span class="nf">_ccpnInternalData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_ccpnInternalData must be a dictionary, was </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">ccpnInternalData</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># CCPN abstract properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Object local identifier, unique for a given type with a given parent.</span>

<span class="sd">        Set automatically from other (immutable) object attributes.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Code error: function not implemented&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parent (containing) object.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Code error: function not implemented&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Identifier for the object, used to generate the pid and longPid.</span>

<span class="sd">        Generated by combining the id of the containing object,</span>
<span class="sd">        with the value of one or more key attributes that uniquely identify the object in context.::</span>

<span class="sd">          E.g. the id for an Atom, &#39;A.55.VAL.HA&#39; is generated from:</span>

<span class="sd">          - &#39;A&#39; *Chain.shortName*</span>

<span class="sd">          - &#39;55&#39; *Residue.sequenceCode*</span>

<span class="sd">          - &#39;VAL&#39; *Residue.residueType*</span>

<span class="sd">          - &#39;HA&#39; *Atom.name*&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_localCcpnSortKey</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Local sorting key, in context of parent.</span>
<span class="sd">        NBNB Must be overridden is some subclasses to get proper sorting order&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">,</span> <span class="s1">&#39;serial&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">serial</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">_newInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Intialiate a new instance, including the wrappedData</span>
<span class="sd">        Shoudl be subclassed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1">#--------------------------------------------------------------------------------------------</span>
    <span class="c1"># Abstract /Api methods</span>
    <span class="c1">#--------------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_printClassTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple Class-tree printing method</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">tabs</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">className</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_isGuiClass</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  (GuiClass)&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_printClassTree</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="n">tabs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;GWV; Return a dict of (className, ChildrenList) pairs</span>
<span class="sd">        classes is either &#39;gui&#39; or &#39;nonGui&#39; or &#39;all&#39; or explicit enumeration of classNames</span>
<span class="sd">        CCPNINTERNAL: used throughout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">className</span><span class="p">,</span> <span class="n">apiChildren</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getApiChildren</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">apiChild</span> <span class="ow">in</span> <span class="n">apiChildren</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">_get</span><span class="p">(</span><span class="n">apiChild</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_getApiChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;GWV; Return a dict of (className, apiChildrenList) pairs</span>
<span class="sd">         classes is either &#39;gui&#39; or &#39;nonGui&#39; or &#39;all&#39; or explicit enumeration of classNames</span>
<span class="sd">         CCPNINTERNAL: used throughout</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">childClass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">childClass</span><span class="o">.</span><span class="n">_isGuiClass</span> <span class="ow">and</span> <span class="s1">&#39;gui&#39;</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="ow">not</span> <span class="n">childClass</span><span class="o">.</span><span class="n">_isGuiClass</span> <span class="ow">and</span> <span class="s1">&#39;nonGui&#39;</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="n">childClass</span><span class="o">.</span><span class="n">className</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>

                <span class="n">childApis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">childClass</span><span class="o">.</span><span class="n">className</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">apiObj</span> <span class="ow">in</span> <span class="n">childClass</span><span class="o">.</span><span class="n">_getAllWrappedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">childApis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apiObj</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_getApiSiblings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;GWV; Return a list of apiSiblings of self</span>
<span class="sd">         CCPNINTERNAL: used throughout</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># We are at the root (i.e. Project), no siblings</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_getApiChildren</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">className</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getSiblings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;GWV; Return a list of siblings of self</span>
<span class="sd">         CCPNINTERNAL: used throughout</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># We are at the root (i.e. Project), no siblings</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_getChildren</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">className</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getDirectChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;RF; Get list of all objects that have self as a parent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getDataObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">getDataObj</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childClasses</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">_getAllWrappedData</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_restoreChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;GWV: A method to restore the children of self</span>
<span class="sd">        classes is either &#39;gui&#39; or &#39;nonGui&#39; or &#39;all&#39; or explicit enumeration of classNames</span>
<span class="sd">        For restore 3.1 branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_classMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">cls</span><span class="o">.</span><span class="n">className</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span> <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">])</span>

        <span class="c1"># loop over all the child-classses</span>
        <span class="k">for</span> <span class="n">clsName</span><span class="p">,</span> <span class="n">apiChildren</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getApiChildren</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">cls</span> <span class="o">=</span> <span class="n">_classMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">clsName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Undefined class &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">clsName</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">apiChild</span> <span class="ow">in</span> <span class="n">apiChildren</span><span class="p">:</span>

                <span class="n">newInstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newInstanceWithApiData</span><span class="p">(</span><span class="n">cls</span><span class="o">=</span><span class="n">cls</span><span class="p">,</span> <span class="n">apiData</span><span class="o">=</span><span class="n">apiChild</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newInstance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error creating new instance of class &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">clsName</span><span class="p">)</span>

                <span class="c1"># add the newInstance to the appropriate mapping dictionaries</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">apiChild</span><span class="p">]</span> <span class="o">=</span> <span class="n">newInstance</span>
                <span class="n">_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">clsName</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">_d</span><span class="p">[</span><span class="n">newInstance</span><span class="o">.</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">newInstance</span>

                <span class="c1"># recursively do the children of newInstance</span>
                <span class="n">newInstance</span><span class="o">.</span><span class="n">_restoreChildren</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_newInstanceWithApiData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">apiData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new instance of cls, initialised with apiData</span>
<span class="sd">        For restore 3.1 branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">apiData</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">:</span>
            <span class="c1"># This happens with Window, as it get initialised by the Windowstore and then once</span>
            <span class="c1"># more as child of Project</span>
            <span class="n">newInstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">apiData</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;_factoryFunction&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;_factoryFunction&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">newInstance</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_factoryFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">,</span> <span class="n">apiData</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">newInstance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">,</span> <span class="n">apiData</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newInstance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error creating new instance of class &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newInstance</span>

    <span class="k">def</span> <span class="nf">_getApiObjectTree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the apiObject tree contained by this object</span>

<span class="sd">        CCPNINTERNAL   used for undo&#39;s, redo&#39;s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#EJB 20181127: taken from memops.Implementation.DataObject.delete</span>
        <span class="c1">#                   should be in the model??</span>

        <span class="kn">from</span> <span class="nn">ccpn.util.OrderedSet</span> <span class="kn">import</span> <span class="n">OrderedSet</span>

        <span class="n">apiObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span>

        <span class="n">apiObjectlist</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
        <span class="c1"># objects still to be checked</span>
        <span class="n">objsToBeChecked</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># counter keyed on (obj, roleName) for how many objects at other end of link</span>
        <span class="n">linkCounter</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># topObjects to check if modifiable</span>
        <span class="n">topObjectsToCheck</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">objsToBeChecked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apiObject</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">objsToBeChecked</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">objsToBeChecked</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_checkDelete</span><span class="p">(</span><span class="n">apiObjectlist</span><span class="p">,</span> <span class="n">objsToBeChecked</span><span class="p">,</span> <span class="n">linkCounter</span><span class="p">,</span> <span class="n">topObjectsToCheck</span><span class="p">)</span>  <span class="c1"># This builds the list/set</span>

        <span class="k">for</span> <span class="n">topObjectToCheck</span> <span class="ow">in</span> <span class="n">topObjectsToCheck</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">topObjectToCheck</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isModifiable&#39;</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s2">.delete:</span>
<span class="s2">           Storage not modifiable&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">apiObject</span><span class="o">.</span><span class="n">qualifiedName</span>
                                 <span class="o">+</span> <span class="s2">&quot;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">topObjectToCheck</span><span class="p">,)</span>
                                 <span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">apiObjectlist</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_getAllWrappedData</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;get list of wrapped data objects for each class that is a child of parent</span>

<span class="sd">        List must be sorted at the API level 1) to give a reproducible order,</span>
<span class="sd">        2) using serial (if present) and otherwise a natural (i.e.NON-object) key.</span>
<span class="sd">        Wrapper level sorting may be (and sometimes is) different.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Code error: function not implemented&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the object name or other key attribute(s), changing the object pid,</span>
<span class="sd">           and all internal references to maintain consistency.</span>
<span class="sd">           Some Objects (Chain, Residue, Atom) cannot be renamed&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> objects cannot be renamed&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c1"># In addition each class (except for Project) must define a  newClass method</span>
    <span class="c1"># The function (e.g. Project.newMolecule), ... must create a new child object</span>
    <span class="c1"># AND ALL UNDERLYING DATA, taking in all parameters necessary to do so.</span>
    <span class="c1"># This can be done by defining a function (not a method)</span>
    <span class="c1"># def newMolecule( self, *args, **kwds):</span>
    <span class="c1"># and then doing Project.newMolecule = newMolecule</span>

    <span class="c1"># CCPN functions</span>

    <span class="nd">@deleteObject</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete object, with all contained objects and underlying data.&quot;&quot;&quot;</span>

        <span class="c1"># NBNB clean-up of wrapper structure is done via notifiers.</span>
        <span class="c1"># NBNB some child classes must override this function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getByPid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pidstring</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an arbitrary data object from either its pid (e.g. &#39;SP:HSQC2&#39;) or its longPid</span>
<span class="sd">        (e.g. &#39;Spectrum:HSQC2&#39;</span>

<span class="sd">        Returns None for invalid or unrecognised input strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO:RASMUS: Raise exception when this is a deleted project</span>
        <span class="k">if</span> <span class="n">pidstring</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">tt</span> <span class="o">=</span> <span class="n">pidstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">PREFIXSEP</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;GM&#39;</span><span class="p">,</span> <span class="s1">&#39;Mark&#39;</span><span class="p">,</span> <span class="s1">&#39;GA&#39;</span><span class="p">,</span> <span class="s1">&#39;Axis&#39;</span><span class="p">,</span> <span class="s1">&#39;GO&#39;</span><span class="p">,</span> <span class="s1">&#39;Module&#39;</span><span class="p">,</span> <span class="s1">&#39;GS&#39;</span><span class="p">,</span> <span class="s1">&#39;Strip&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;GL&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakListView&#39;</span><span class="p">,</span> <span class="s1">&#39;GI&#39;</span><span class="p">,</span> <span class="s1">&#39;IntegralListView&#39;</span><span class="p">,</span> <span class="s1">&#39;GU&#39;</span><span class="p">,</span> <span class="s1">&#39;MultipletListView&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;GD&#39;</span><span class="p">,</span> <span class="s1">&#39;SpectrumDisplay&#39;</span><span class="p">,</span> <span class="s1">&#39;GW&#39;</span><span class="p">,</span> <span class="s1">&#39;Window&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;GV&#39;</span><span class="p">,</span> <span class="s1">&#39;SpectrumView&#39;</span><span class="p">,</span> <span class="s1">&#39;GT&#39;</span><span class="p">,</span> <span class="s1">&#39;Task&#39;</span><span class="p">):</span>
                <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ui.getByGid should be used for getting graphics ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pidstring</span><span class="p">),</span>
                     <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># CCPN Implementation methods</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_linkWrapperClasses</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">ancestors</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">Project</span><span class="p">:</span> <span class="s1">&#39;Project&#39;</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively set up links and functions involving children for wrapper classes</span>

<span class="sd">        NB classes that have already been linked are ignored, but their children are still processed&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">Project</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ancestors</span><span class="p">,</span> <span class="s2">&quot;Code errors, _linkWrapperClasses called with Project but no ancestors&quot;</span>
            <span class="n">newAncestors</span> <span class="o">=</span> <span class="n">ancestors</span> <span class="o">+</span> <span class="p">[</span><span class="n">cls</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Project</span><span class="o">.</span><span class="n">_allLinkedWrapperClasses</span><span class="p">:</span>
                <span class="n">Project</span><span class="o">.</span><span class="n">_allLinkedWrapperClasses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

                <span class="n">classFullName</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">cls</span><span class="p">)[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

                <span class="c1"># add getCls in all ancestors</span>
                <span class="n">funcName</span> <span class="o">=</span> <span class="s1">&#39;get&#39;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span>
                <span class="c1">#  NB Ancestors is never None at this point</span>
                <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
                    <span class="c1"># Add getDescendant function</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relativeId</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cls</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_getDescendant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relativeId</span><span class="p">)</span>

                    <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s2">&quot;Get contained </span><span class="si">%s</span><span class="s2"> object by relative ID&quot;</span> <span class="o">%</span> <span class="n">classFullName</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">funcName</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

                <span class="c1"># Add descendant links</span>
                <span class="n">linkName</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_pluralLinkName</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newAncestors</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">ancestor</span> <span class="o">=</span> <span class="n">newAncestors</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">AbstractWrapperObject</span><span class="o">.</span><span class="n">_allDescendants</span><span class="p">,</span>
                                             <span class="n">descendantClasses</span><span class="o">=</span><span class="n">newAncestors</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
                    <span class="c1"># func.__annotations__[&#39;return&#39;] = typing.Tuple[cls, ...]</span>
                    <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="s1">&#39;NmrResidue&#39;</span><span class="p">:</span>
                        <span class="n">docTemplate</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;\- *(</span><span class="si">%s</span><span class="s2">,)*  - contained </span><span class="si">%s</span><span class="s2"> objects in sequential order &quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;(for assigned or connected NmrChains), otherwise in creation order. &quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;This is identical to the standard sorting order.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="s1">&#39;ChemicalShift&#39;</span><span class="p">:</span>
                        <span class="n">docTemplate</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;\- *(</span><span class="si">%s</span><span class="s2">,)*  - contained </span><span class="si">%s</span><span class="s2"> objects in NmrAtom creation order &quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;This is different from the standard sorting order&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="s1">&#39;Spectrum&#39;</span><span class="p">:</span>
                        <span class="n">docTemplate</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;\- *(</span><span class="si">%s</span><span class="s2">,)*  - contained </span><span class="si">%s</span><span class="s2"> objects in approximate creation order &quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;This is different from the standard sorting order&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="s1">&#39;Residue&#39;</span><span class="p">:</span>
                        <span class="n">docTemplate</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;\- *(</span><span class="si">%s</span><span class="s2">,)*  - contained </span><span class="si">%s</span><span class="s2"> objects in sequential order &quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;This is identical to the standard sorting order&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;serial&#39;</span><span class="p">):</span>
                        <span class="n">docTemplate</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;\- *(</span><span class="si">%s</span><span class="s2">,)*  - contained </span><span class="si">%s</span><span class="s2"> objects in creation order. &quot;</span>
                                       <span class="o">+</span> <span class="s2">&quot;This may differ from the standard sorting order&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom&#39;</span><span class="p">,</span> <span class="s1">&#39;Chain&#39;</span><span class="p">,</span> <span class="s1">&#39;Substance&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleComponent&#39;</span><span class="p">):</span>
                        <span class="n">docTemplate</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s2">&quot;\- *(</span><span class="si">%s</span><span class="s2">,)*  - contained </span><span class="si">%s</span><span class="s2"> objects in name order &quot;</span>
                                <span class="o">+</span> <span class="s2">&quot;This is identical to the standard sorting order.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">docTemplate</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;\- *(</span><span class="si">%s</span><span class="s2">,)*  - contained </span><span class="si">%s</span><span class="s2"> objects in order of underlying key. &quot;</span>
                                       <span class="o">+</span> <span class="s2">&quot;This may differ from the standard sorting order&quot;</span><span class="p">)</span>

                    <span class="n">prop</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">docTemplate</span> <span class="o">%</span> <span class="p">(</span><span class="n">classFullName</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">linkName</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>

                <span class="c1"># Add standard Notifiers:</span>
                <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">_registerClassNotifiers</span><span class="p">:</span>
                    <span class="n">className</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_apiClassQualifiedName</span>
                    <span class="n">Project</span><span class="o">.</span><span class="n">_apiNotifiers</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;_newApiObject&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;cls&#39;</span><span class="p">:</span> <span class="n">cls</span><span class="p">},</span> <span class="n">className</span><span class="p">,</span> <span class="s1">&#39;__init__&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;_startDeleteCommandBlock&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">className</span><span class="p">,</span> <span class="s1">&#39;startDeleteBlock&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;_finaliseApiDelete&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">className</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;_endDeleteCommandBlock&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">className</span><span class="p">,</span> <span class="s1">&#39;endDeleteBlock&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;_finaliseApiUnDelete&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">className</span><span class="p">,</span> <span class="s1">&#39;undelete&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;_modifiedApiObject&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">className</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Project class. Start generation here</span>
            <span class="n">Project</span> <span class="o">=</span> <span class="n">cls</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">_allLinkedWrapperClasses</span>
            <span class="k">if</span> <span class="n">ll</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;DEBUG initialisation attempted more than once&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">newAncestors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cls</span><span class="p">]</span>
            <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Project</span><span class="p">)</span>

        <span class="c1"># Fill in Project._className2Class map</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">Project</span><span class="o">.</span><span class="n">_className2Class</span>
        <span class="n">dd</span><span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">className</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>

        <span class="c1"># recursively call next level down the tree</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">_linkWrapperClasses</span><span class="p">(</span><span class="n">newAncestors</span><span class="p">,</span> <span class="n">Project</span><span class="o">=</span><span class="n">Project</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_getChildClasses</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">recursion</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param recursion: use recursion to also add child objects</span>
<span class="sd">        :return: list of valid child classes of cls</span>

<span class="sd">        NB: Depth-first ordering</span>

<span class="sd">        CCPNINTERNAL: Notifier class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">recursion</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">klass</span><span class="o">.</span><span class="n">_getChildClasses</span><span class="p">(</span><span class="n">recursion</span><span class="o">=</span><span class="n">recursion</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_getDescendant</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">relativeId</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get descendant of class cls with relative key relativeId</span>
<span class="sd">         Implementation function, used to generate getCls functions</span>
<span class="sd">         &quot;&quot;&quot;</span>

        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">className</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">relativeId</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">Pid</span><span class="o">.</span><span class="n">IDSEP</span><span class="p">,</span> <span class="n">relativeId</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_allDescendants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descendantClasses</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get all descendants of a given class , following descendantClasses down the data tree</span>
<span class="sd">        Implementation function, used to generate child and descendant links</span>
<span class="sd">        descendantClasses is a list of classes going down from the class of self down the data tree.</span>
<span class="sd">        E.g. if called on a chain with descendantClass == [Residue,Atom] the function returns</span>
<span class="sd">        a sorted list of all Atoms in a Chain&quot;&quot;&quot;</span>
        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>
        <span class="n">data2Obj</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_data2Obj</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">descendantClasses</span><span class="p">:</span>

            <span class="c1"># function gets wrapped data for all children starting from parent</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_getAllWrappedData</span>
            <span class="c1"># data is iterator of wrapped data for children starting from all parents</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">))</span>
            <span class="c1"># objects is all wrapper objects for next child level down</span>
            <span class="c1"># NB this may sometimes (during undo/redo) get called when not all objects</span>
            <span class="c1"># are finalised - hence the test if y is None</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">)</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="s1">&#39;NmrResidue&#39;</span><span class="p">:</span>
                <span class="c1"># These must always be sorted</span>
                <span class="n">objects</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">objects</span>

    <span class="k">def</span> <span class="nf">_initializeAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize children, using existing objects in data model&quot;&quot;&quot;</span>

        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>
        <span class="n">data2Obj</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_data2Obj</span>

        <span class="k">for</span> <span class="n">childClass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>
            <span class="c1"># recursively create children</span>
            <span class="k">for</span> <span class="n">apiObj</span> <span class="ow">in</span> <span class="n">childClass</span><span class="o">.</span><span class="n">_getAllWrappedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">apiObj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">factoryFunction</span> <span class="o">=</span> <span class="n">childClass</span><span class="o">.</span><span class="n">_factoryFunction</span>
                    <span class="k">if</span> <span class="n">factoryFunction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">childClass</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">apiObj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">factoryFunction</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">apiObj</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_initializeAll</span><span class="p">()</span>
                <span class="c1"># getLogger().info(str(obj))   # ejb - temp</span>

    <span class="k">def</span> <span class="nf">_unwrapAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove wrapper from object and child objects</span>
<span class="sd">        For special case where wrapper objects are removed without deleting wrappedData&quot;&quot;&quot;</span>
        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>
        <span class="n">data2Obj</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_data2Obj</span>

        <span class="k">for</span> <span class="n">childClass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childClasses</span><span class="p">:</span>

            <span class="c1"># recursively unwrap children</span>
            <span class="k">for</span> <span class="n">apiObj</span> <span class="ow">in</span> <span class="n">childClass</span><span class="o">.</span><span class="n">_getAllWrappedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">data2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">apiObj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_unwrapAll</span><span class="p">()</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid2Obj</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">shortClassName</span><span class="p">][</span><span class="n">obj</span><span class="o">.</span><span class="n">_id</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">data2Obj</span><span class="p">[</span><span class="n">apiObj</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_setUniqueStringKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defaultValue</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keyTag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;(re)set self._wrappedData.keyTag to make it a unique key, using defaultValue</span>
<span class="sd">        if not set NB - is called BEFORE data2obj etc. dictionaries are set&quot;&quot;&quot;</span>

        <span class="n">wrappedData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">,</span> <span class="n">keyTag</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set unique </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> object has no attribute </span><span class="si">%s</span><span class="s2">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">keyTag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">className</span><span class="p">,</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">keyTag</span><span class="p">))</span>

        <span class="n">undo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_undo</span>
        <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">increaseBlocking</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wrappedData</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">:</span>
                <span class="c1"># Necessary because otherwise we likely will have notifiers - that would then break</span>
                <span class="n">wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">override</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c1"># Set default value if present value is None</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">,</span> <span class="n">keyTag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">defaultValue</span>

            <span class="c1"># Set to new, unique value if present value is a duplicate</span>
            <span class="n">competitorDict</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keyTag</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getAllWrappedData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">wrappedData</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">competitorDict</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">,</span> <span class="s1">&#39;serial&#39;</span><span class="p">):</span>
                <span class="c1"># First try appending serial</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">wrappedData</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">competitorDict</span><span class="p">:</span>
                <span class="c1"># Keep incrementing suffix till value is unique</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">commonUtil</span><span class="o">.</span><span class="n">incrementName</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># Set the unique result</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">wrappedData</span><span class="p">,</span> <span class="n">keyTag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wrappedData</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">:</span>
                <span class="n">wrappedData</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">override</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">undo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">undo</span><span class="o">.</span><span class="n">decreaseBlocking</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_getDirectChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get list of all objects that have self as a parent&quot;&quot;&quot;</span>

        <span class="n">getDataObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="o">.</span><span class="n">get</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">getDataObj</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childClasses</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">_getAllWrappedData</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c1"># Removed: Sorting is irrelevant for this function, thaat gives children of ALL classes</span>
        <span class="c1"># if self.className == &#39;NmrChain&#39;:</span>
        <span class="c1">#   # Special case - NmrResidues must always be sorted</span>
        <span class="c1">#   result.sort()</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Notifiers and related functions:</span>

    <span class="c1">#GWV 20181123:</span>
    <span class="c1"># @classmethod</span>
    <span class="c1"># def _setupCoreNotifier(cls, target: str, func: typing.Callable,</span>
    <span class="c1">#                        parameterDict: dict = {}, onceOnly: bool = False):</span>
    <span class="c1">#     &quot;&quot;&quot;Set up notifiers for class cls that do not depend on individual objects -</span>
    <span class="c1">#     These will be registered whenever a new project is initialised.</span>
    <span class="c1">#     Parameters are eventually passed to the project.registerNotifier() function</span>
    <span class="c1">#     (with cls converted to cls.className). Please see the Project.registerNotifier</span>
    <span class="c1">#     documentation for a precise parameter description</span>
    <span class="c1">#</span>
    <span class="c1">#     Note that these notifiers are NOT cleared once set up.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     # CCPNINTERNAL - used in top level class definitions, Current (ONLY)</span>
    <span class="c1">#</span>
    <span class="c1">#     # NB _coreNotifiers is a class attribute of AbstractWrapperObject</span>
    <span class="c1">#     # So all tuples are appended to the same list, living in AbstractWrapperObject</span>
    <span class="c1">#     cls._coreNotifiers.append((cls.className, target, func, parameterDict, onceOnly))</span>

    <span class="c1"># def _finaliseRename(self):</span>
    <span class="c1">#   &quot;&quot;&quot;Reset internal attributes after values determining PID have changed</span>
    <span class="c1">#   &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#   # reset id</span>
    <span class="c1">#   project = self._project</span>
    <span class="c1">#   oldId = self._id</span>
    <span class="c1">#   parent = self._parent</span>
    <span class="c1">#   if parent is None:</span>
    <span class="c1">#     _id = &#39;&#39;</span>
    <span class="c1">#   elif parent is project:</span>
    <span class="c1">#     _id = str(self._key)</span>
    <span class="c1">#   else:</span>
    <span class="c1">#     _id = &#39;%s%s%s&#39;% (parent._id, Pid.IDSEP, self._key)</span>
    <span class="c1">#   self._id = _id</span>
    <span class="c1">#</span>
    <span class="c1">#   # update pid:object mapping dictionary</span>
    <span class="c1">#   dd = project._pid2Obj[self.className]</span>
    <span class="c1">#   del dd[oldId]</span>
    <span class="c1">#   dd[_id] = self</span>

    <span class="c1"># def _finaliseRelatedObjectFromRename(self, oldPid, pathToObject: str, action: str):</span>
    <span class="c1">#     &quot;&quot;&quot;Finalise related objects after rename</span>
    <span class="c1">#     Alternative to _finaliseRelatedObject for calling from rename notifier.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     target = operator.attrgetter(pathToObject)(self)</span>
    <span class="c1">#     if not target:</span>
    <span class="c1">#         pass</span>
    <span class="c1">#     elif isinstance(target, AbstractWrapperObject):</span>
    <span class="c1">#         target._finaliseAction(action)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         # This must be an iterable</span>
    <span class="c1">#         for obj in target:</span>
    <span class="c1">#             obj._finaliseAction(action)</span>
    <span class="c1">#</span>
    <span class="c1"># def _finaliseRelatedObject(self, pathToObject: str, action: str):</span>
    <span class="c1">#     &quot;&quot;&quot; Finalise &#39;action&#39; type notifiers for getattribute(pathToObject)(self)</span>
    <span class="c1">#     pathToObject is a navigation path (may contain dots) and must yield an object</span>
    <span class="c1">#     or an iterable of objects. Can NOT be called from a rename notifier&quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     target = operator.attrgetter(pathToObject)(self)</span>
    <span class="c1">#     if not target:</span>
    <span class="c1">#         pass</span>
    <span class="c1">#     elif isinstance(target, AbstractWrapperObject):</span>
    <span class="c1">#         target._finaliseAction(action)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         # This must be an iterable</span>
    <span class="c1">#         for obj in target:</span>
    <span class="c1">#             obj._finaliseAction(action)</span>

    <span class="k">def</span> <span class="nf">_finaliseAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do wrapper level finalisation, and execute all notifiers</span>

<span class="sd">        action is one of: &#39;create&#39;, &#39;delete&#39;, &#39;change&#39;, &#39;rename&#39;&quot;&quot;&quot;</span>

        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>
        <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">_notificationBlanking</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">className</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">className</span>
        <span class="c1"># NB &#39;AbstractWrapperObject&#39; not currently in use (Sep 2016), but kept for future needs</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">_context2Notifiers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">action</span><span class="p">),</span> <span class="n">OrderedDict</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="s1">&#39;AbstractWrapperObject&#39;</span><span class="p">))</span>
        <span class="n">pendingNotifications</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_pendingNotifications</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;rename&#39;</span><span class="p">:</span>
            <span class="c1"># Special case</span>

            <span class="n">oldPid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>

            <span class="c1"># Wrapper-level processing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>

            <span class="c1"># Call notifiers with special signature</span>
            <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">_notificationSuspension</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">notifier</span><span class="p">,</span> <span class="n">onceOnly</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">pendingNotifications</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">notifier</span><span class="p">,</span> <span class="n">onceOnly</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">oldPid</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
                        <span class="n">notifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldPid</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDirectChildren</span><span class="p">():</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;rename&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normal case - just call notifiers</span>
            <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">_notificationSuspension</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">!=</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                <span class="c1"># NB Deletion notifiers must currently be executed immediately</span>
                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">notifier</span><span class="p">,</span> <span class="n">onceOnly</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">pendingNotifications</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">notifier</span><span class="p">,</span> <span class="n">onceOnly</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
                        <span class="c1"># GWV: Maybe only at the highest debug level</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Notifier: </span><span class="si">%s</span><span class="s1">; </span><span class="si">%s</span><span class="s1">; </span><span class="si">%s</span><span class="s1">&#39;</span>
                                                    <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">notifier</span><span class="p">))</span>
                        <span class="n">notifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resetSerial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newSerial</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ADVANCED Reset serial of object to newSerial, resetting parent link</span>
<span class="sd">        and the nextSerial of the parent.</span>

<span class="sd">        Raises ValueError for objects that do not have a serial</span>
<span class="sd">        (or, more precisely, where the _wrappedData does not have a serial).&quot;&quot;&quot;</span>

        <span class="n">commonUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">,</span> <span class="n">newSerial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_startCommandEchoBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcName</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">propertySetter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start block for command echoing, set undo waypoint, and echo command to ui and logger</span>

<span class="sd">        *params, values, and defaults are used by coreUtil.commandParameterString to set the function</span>
<span class="sd">        parameter string - see the documentation of commandParameterString for details</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if not hasattr(self, &#39;blockindent&#39;):</span>
        <span class="c1">#   self.blockindent = 1</span>
        <span class="c1"># getLogger().info(&#39;.&#39;*self.blockindent+&#39;&gt;&gt;&gt;start_&#39;+str(funcName))</span>
        <span class="c1"># self.blockindent+=4</span>

        <span class="c1">#CCPNINTERNAL</span>

        <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>

        <span class="n">parameterString</span> <span class="o">=</span> <span class="n">coreUtil</span><span class="o">.</span><span class="n">commandParameterString</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">project</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">propertySetter</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parameterString</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;project.</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcName</span><span class="p">,</span> <span class="n">parameterString</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;project.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">funcName</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;project.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcName</span><span class="p">,</span> <span class="n">parameterString</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">propertySetter</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parameterString</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;project.getByPid(&#39;</span><span class="si">%s</span><span class="s2">&#39;).</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">funcName</span><span class="p">,</span> <span class="n">parameterString</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;project.getByPid(&#39;</span><span class="si">%s</span><span class="s2">&#39;).</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">funcName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;project.getByPid(&#39;</span><span class="si">%s</span><span class="s2">&#39;).</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">funcName</span><span class="p">,</span> <span class="n">parameterString</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parName</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">parName</span><span class="p">,</span> <span class="s1">&#39; = &#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>

        <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_startCommandBlock</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_endCommandEchoBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End block for command echoing&quot;&quot;&quot;</span>
        <span class="c1"># self.blockindent-=4</span>
        <span class="c1"># if self.blockindent&lt;0:</span>
        <span class="c1">#   print (&#39;****&#39;)</span>
        <span class="c1">#   self.blockindent=0</span>
        <span class="c1"># getLogger().info(&#39;..&#39;+&#39;.&#39;*self.blockindent+&#39;&gt;&gt;&gt;end_&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_endCommandBlock</span><span class="p">()</span>


<span class="n">AbstractWrapperObject</span><span class="o">.</span><span class="n">getByPid</span><span class="o">.</span><span class="n">__annotations__</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AbstractWrapperObject</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>