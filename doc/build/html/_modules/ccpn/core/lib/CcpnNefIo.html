<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.core.lib.CcpnNefIo &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.core.lib.CcpnNefIo</h1><div class="highlight"><pre>
<span></span>
<span class="sd">&quot;&quot;&quot;Code for CCPN-specific NEF I/O</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>

<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (www.ccpn.ac.uk) 2014 - $Date: 2016-11-28 14:51:44 +0000 (Mon, 28 Nov 2016) $&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="s2">&quot;Wayne Boucher, Rasmus H Fogh, Simon Skinner, Geerten Vuister&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN license. See www.ccpn.ac.uk/license&quot;</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for license text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from www.ccpn.ac.uk/license&quot;</span>
                 <span class="s2">&quot; or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>

<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification:</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: rhfogh $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2016-11-28 14:51:44 +0000 (Mon, 28 Nov 2016) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 10027 $&quot;</span>

<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span> <span class="k">as</span> <span class="n">OD</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span><span class="p">,</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">Pid</span>
<span class="kn">from</span> <span class="nn">ccpn.core</span> <span class="kn">import</span> <span class="n">_coreImportOrder</span>
<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">Common</span> <span class="k">as</span> <span class="n">commonUtil</span>
<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">Constants</span>
<span class="kn">from</span> <span class="nn">ccpn.util</span> <span class="kn">import</span> <span class="n">jsonIo</span>
<span class="kn">from</span> <span class="nn">ccpn.util.nef</span> <span class="kn">import</span> <span class="n">Specification</span>
<span class="kn">from</span> <span class="nn">ccpn.util.nef</span> <span class="kn">import</span> <span class="n">StarIo</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib</span> <span class="kn">import</span> <span class="n">Constants</span> <span class="k">as</span> <span class="n">coreConstants</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib</span> <span class="kn">import</span> <span class="n">Util</span> <span class="k">as</span> <span class="n">modelUtil</span>
<span class="kn">from</span> <span class="nn">ccpn.core._implementation.AbstractWrapperObject</span> <span class="kn">import</span> <span class="n">AbstractWrapperObject</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Project</span> <span class="kn">import</span> <span class="n">Project</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Spectrum</span> <span class="kn">import</span> <span class="n">Spectrum</span>
<span class="kn">from</span> <span class="nn">ccpn.core.SpectrumGroup</span> <span class="kn">import</span> <span class="n">SpectrumGroup</span>
<span class="kn">from</span> <span class="nn">ccpn.core.PeakList</span> <span class="kn">import</span> <span class="n">PeakList</span>
<span class="kn">from</span> <span class="nn">ccpn.core.IntegralList</span> <span class="kn">import</span> <span class="n">IntegralList</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Integral</span> <span class="kn">import</span> <span class="n">Integral</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Peak</span> <span class="kn">import</span> <span class="n">Peak</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Sample</span> <span class="kn">import</span> <span class="n">Sample</span>
<span class="kn">from</span> <span class="nn">ccpn.core.SampleComponent</span> <span class="kn">import</span> <span class="n">SampleComponent</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Substance</span> <span class="kn">import</span> <span class="n">Substance</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Chain</span> <span class="kn">import</span> <span class="n">Chain</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Residue</span> <span class="kn">import</span> <span class="n">Residue</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Atom</span> <span class="kn">import</span> <span class="n">Atom</span>
<span class="kn">from</span> <span class="nn">ccpn.core.NmrChain</span> <span class="kn">import</span> <span class="n">NmrChain</span>
<span class="kn">from</span> <span class="nn">ccpn.core.NmrResidue</span> <span class="kn">import</span> <span class="n">NmrResidue</span>
<span class="kn">from</span> <span class="nn">ccpn.core.NmrAtom</span> <span class="kn">import</span> <span class="n">NmrAtom</span>
<span class="kn">from</span> <span class="nn">ccpn.core.ChemicalShiftList</span> <span class="kn">import</span> <span class="n">ChemicalShiftList</span>
<span class="kn">from</span> <span class="nn">ccpn.core.ChemicalShift</span> <span class="kn">import</span> <span class="n">ChemicalShift</span>
<span class="kn">from</span> <span class="nn">ccpn.core.DataSet</span> <span class="kn">import</span> <span class="n">DataSet</span>
<span class="kn">from</span> <span class="nn">ccpn.core.RestraintList</span> <span class="kn">import</span> <span class="n">RestraintList</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Note</span> <span class="kn">import</span> <span class="n">Note</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">SpectrumLib</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.MoleculeLib</span> <span class="kn">import</span> <span class="n">extraBoundAtomPairs</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">RestraintLib</span>
<span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.Io</span> <span class="kn">import</span> <span class="n">Formats</span> <span class="k">as</span> <span class="n">ioFormats</span>

<span class="c1"># Max value used for random integer. Set to be expressible as a signed 32-bit integer.</span>
<span class="n">maxRandomInt</span> <span class="o">=</span>  <span class="mi">2000000000</span>

<span class="c1">#  - saveframe category names in reading order</span>
<span class="c1"># The order is significant, because setting of crosslinks relies on the order frames are read</span>
<span class="c1"># Frames are read in correct order regardless of how they are in the file</span>
<span class="n">saveFrameReadingOrder</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;nef_nmr_meta_data&#39;</span><span class="p">,</span>
  <span class="s1">&#39;nef_molecular_system&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_sample&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_substance&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_assignments&#39;</span><span class="p">,</span>
  <span class="s1">&#39;nef_chemical_shift_list&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_dataset&#39;</span><span class="p">,</span>
  <span class="s1">&#39;nef_distance_restraint_list&#39;</span><span class="p">,</span>
  <span class="s1">&#39;nef_dihedral_restraint_list&#39;</span><span class="p">,</span>
  <span class="s1">&#39;nef_rdc_restraint_list&#39;</span><span class="p">,</span>
  <span class="s1">&#39;nef_nmr_spectrum&#39;</span><span class="p">,</span>
  <span class="s1">&#39;nef_peak_restraint_links&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_spectrum_group&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_restraint_list&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_notes&#39;</span><span class="p">,</span>
  <span class="s1">&#39;ccpn_additional_data&#39;</span>
<span class="p">]</span>

<span class="c1"># Saveframe writing order - must start with official &#39;nef_&#39; frames</span>
<span class="n">saveFrameWritingOrder</span> <span class="o">=</span> <span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saveFrameReadingOrder</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;nef_&#39;</span><span class="p">)]</span> <span class="o">+</span>
                         <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saveFrameReadingOrder</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;nef_&#39;</span><span class="p">)])</span>


<span class="c1"># NEf to CCPN tag mapping (and tag order)</span>
<span class="c1">#</span>
<span class="c1"># Contents are:</span>
<span class="c1"># Nef2CcpnMap = {saveframe_or_loop_category:contents}</span>
<span class="c1"># contents = {tag:ccpn_tag_or_None}</span>
<span class="c1"># loopMap = {tag:ccpn_tag}</span>
<span class="c1">#</span>
<span class="c1"># Loops are entered as saveFrame contents with their category as tag and &#39;ccpn_tag&#39; None</span>
<span class="c1"># and at the top level under their category name</span>
<span class="c1"># This relies on loop categories being unique, both at teh top level, and among the item</span>
<span class="c1"># names within a saveframe</span>

<span class="c1"># Sentinel value - MUST evaluate as False</span>
<span class="n">_isALoop</span> <span class="o">=</span> <span class="p">()</span>
<span class="n">nef2CcpnMap</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;nef_nmr_meta_data&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;format_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;format_version&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_version&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;creation_date&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;coordinate_file_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_dataset_serial&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_dataset_comment&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_related_entries&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_program_script&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_run_history&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_related_entries&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;database_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;database_accession_code&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_program_script&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;program_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;script_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_run_history&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;run_number&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_name&#39;</span><span class="p">,</span><span class="s1">&#39;programName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_version&#39;</span><span class="p">,</span><span class="s1">&#39;programVersion&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;script_name&#39;</span><span class="p">,</span><span class="s1">&#39;scriptName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span><span class="s1">&#39;script&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_input_uuid&#39;</span><span class="p">,</span><span class="s1">&#39;inputDataUuid&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_output_uuid&#39;</span><span class="p">,</span><span class="s1">&#39;outputDataUuid&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nef_molecular_system&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;nef_sequence&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_covalent_links&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_sequence&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code&#39;</span><span class="p">,</span><span class="s1">&#39;chain.shortName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code&#39;</span><span class="p">,</span><span class="s1">&#39;sequenceCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name&#39;</span><span class="p">,</span><span class="s1">&#39;residueType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;linking&#39;</span><span class="p">,</span><span class="s1">&#39;linking&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_variant&#39;</span><span class="p">,</span><span class="s1">&#39;residueVariant&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cis_peptide&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_chain_role&#39;</span><span class="p">,</span><span class="s1">&#39;chain.role&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_compound_name&#39;</span><span class="p">,</span><span class="s1">&#39;chain.compoundName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_chain_comment&#39;</span><span class="p">,</span><span class="s1">&#39;chain.comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_covalent_links&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nef_chemical_shift_list&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_serial&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_auto_update&#39;</span><span class="p">,</span><span class="s1">&#39;autoUpdate&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_is_simulated&#39;</span><span class="p">,</span><span class="s1">&#39;isSimulated&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_chemical_shift&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_chemical_shift&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;chain_code&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;value_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;valueError&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;element&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;isotope_number&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nef_distance_restraint_list&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;potential_type&#39;</span><span class="p">,</span><span class="s1">&#39;potentialType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_origin&#39;</span><span class="p">,</span><span class="s1">&#39;origin&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_chain_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorChainCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_sequence_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorSequenceCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_residue_name&#39;</span><span class="p">,</span><span class="s1">&#39;tensorResidueType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_magnitude&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorMagnitude&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_rhombicity&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorRhombicity&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_isotropic_value&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorIsotropicValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_serial&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_dataset_serial&#39;</span><span class="p">,</span><span class="s1">&#39;dataSet.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_unit&#39;</span><span class="p">,</span><span class="s1">&#39;unit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_distance_restraint&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_distance_restraint&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_combination_id&#39;</span><span class="p">,</span><span class="s1">&#39;combinationId&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value&#39;</span><span class="p">,</span><span class="s1">&#39;targetValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalLowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limit&#39;</span><span class="p">,</span><span class="s1">&#39;lowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limit&#39;</span><span class="p">,</span><span class="s1">&#39;upperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalUpperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nef_dihedral_restraint_list&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;potential_type&#39;</span><span class="p">,</span><span class="s1">&#39;potentialType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_origin&#39;</span><span class="p">,</span><span class="s1">&#39;origin&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_chain_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorChainCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_sequence_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorSequenceCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_residue_name&#39;</span><span class="p">,</span><span class="s1">&#39;tensorResidueType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_magnitude&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorMagnitude&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_rhombicity&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorRhombicity&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_isotropic_value&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorIsotropicValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_serial&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_dataset_serial&#39;</span><span class="p">,</span><span class="s1">&#39;dataSet.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_unit&#39;</span><span class="p">,</span><span class="s1">&#39;unit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_dihedral_restraint&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_dihedral_restraint&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_combination_id&#39;</span><span class="p">,</span><span class="s1">&#39;combinationId&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value&#39;</span><span class="p">,</span><span class="s1">&#39;targetValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalLowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limit&#39;</span><span class="p">,</span><span class="s1">&#39;lowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limit&#39;</span><span class="p">,</span><span class="s1">&#39;upperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalUpperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nef_rdc_restraint_list&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;potential_type&#39;</span><span class="p">,</span><span class="s1">&#39;potentialType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_origin&#39;</span><span class="p">,</span><span class="s1">&#39;origin&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_magnitude&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorMagnitude&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_rhombicity&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorRhombicity&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_chain_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorChainCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_sequence_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorSequenceCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_residue_name&#39;</span><span class="p">,</span><span class="s1">&#39;tensorResidueType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_tensor_isotropic_value&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorIsotropicValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_serial&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_dataset_serial&#39;</span><span class="p">,</span><span class="s1">&#39;dataSet.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_unit&#39;</span><span class="p">,</span><span class="s1">&#39;unit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_rdc_restraint&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_rdc_restraint&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_combination_id&#39;</span><span class="p">,</span><span class="s1">&#39;combinationId&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value&#39;</span><span class="p">,</span><span class="s1">&#39;targetValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalLowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limit&#39;</span><span class="p">,</span><span class="s1">&#39;lowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limit&#39;</span><span class="p">,</span><span class="s1">&#39;upperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalUpperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;distance_dependent&#39;</span><span class="p">,</span><span class="s1">&#39;isDistanceDependent&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_vector_length&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.vectorLength&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nef_nmr_spectrum&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;num_dimensions&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.dimensionCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chemical_shift_list&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;experiment_classification&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.experimentType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;experiment_type&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.experimentName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_positive_contour_count&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.positiveContourCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_positive_contour_base&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.positiveContourBase&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_positive_contour_factor&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.positiveContourFactor&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_positive_contour_colour&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.positiveContourColour&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_negative_contour_count&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.negativeContourCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_negative_contour_base&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.negativeContourBase&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_negative_contour_factor&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.negativeContourFactor&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_negative_contour_colour&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.negativeContourColour&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_slice_colour&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.sliceColour&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_spectrum_scale&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.scale&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_spinning_rate&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.spinningRate&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_spectrum_comment&#39;</span><span class="p">,</span><span class="s1">&#39;spectrum.comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_spectrum_file_path&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_sample&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_header_size&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.headerSize&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_number_type&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.numberType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_complex_stored_by&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.complexStoredBy&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_scale_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.scaleFactor&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_is_big_endian&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.isBigEndian&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_byte_number&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.nByte&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_has_block_padding&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.hasBlockPadding&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_block_header_size&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.blockHeaderSize&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrum._wrappedData.dataStore.fileType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_peaklist_serial&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_peaklist_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_peaklist_name&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_peaklist_is_simulated&#39;</span><span class="p">,</span><span class="s1">&#39;isSimulated&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_peaklist_symbol_colour&#39;</span><span class="p">,</span><span class="s1">&#39;symbolColour&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_peaklist_symbol_style&#39;</span><span class="p">,</span><span class="s1">&#39;symbolStyle&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_peaklist_text_colour&#39;</span><span class="p">,</span><span class="s1">&#39;textColour&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_spectrum_dimension&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_spectrum_dimension&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_spectrum_dimension_transfer&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nef_peak&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_integral_list&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_integral&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_spectrum_hit&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_spectrum_dimension&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;axis_unit&#39;</span><span class="p">,</span><span class="s1">&#39;axisUnits&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;axis_code&#39;</span><span class="p">,</span><span class="s1">&#39;isotopeCodes&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;spectrometer_frequency&#39;</span><span class="p">,</span><span class="s1">&#39;spectrometerFrequencies&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">,</span><span class="s1">&#39;spectralWidths&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;value_first_point&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;folding&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;absolute_peak_positions&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;is_acquisition&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_axis_code&#39;</span><span class="p">,</span><span class="s1">&#39;axisCodes&#39;</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="c1"># NB PseudoDimensions are not yet supported</span>
  <span class="s1">&#39;ccpn_spectrum_dimension&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;point_count&#39;</span><span class="p">,</span><span class="s1">&#39;pointCounts&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;reference_point&#39;</span><span class="p">,</span><span class="s1">&#39;referencePoints&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;total_point_count&#39;</span><span class="p">,</span><span class="s1">&#39;totalPointCounts&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;point_offset&#39;</span><span class="p">,</span><span class="s1">&#39;pointOffsets&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;assignment_tolerance&#39;</span><span class="p">,</span><span class="s1">&#39;assignmentTolerances&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_aliasing_limit&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;higher_aliasing_limit&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;measurement_type&#39;</span><span class="p">,</span><span class="s1">&#39;measurementTypes&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;phase_0&#39;</span><span class="p">,</span><span class="s1">&#39;phases0&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;phase_1&#39;</span><span class="p">,</span><span class="s1">&#39;phases1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;window_function&#39;</span><span class="p">,</span><span class="s1">&#39;windowFunctions&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lorentzian_broadening&#39;</span><span class="p">,</span><span class="s1">&#39;lorentzianBroadenings&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;gaussian_broadening&#39;</span><span class="p">,</span><span class="s1">&#39;gaussianBroadenings&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sine_window_shift&#39;</span><span class="p">,</span><span class="s1">&#39;sineWindowShifts&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;dimension_is_complex&#39;</span><span class="p">,</span> <span class="s1">&#39;_wrappedData.dataStore.isComplex&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;dimension_block_size&#39;</span><span class="p">,</span> <span class="s1">&#39;_wrappedData.dataStore.blockSizes&#39;</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_spectrum_dimension_transfer&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;dimension_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;dimension_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;transfer_type&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;is_indirect&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="c1"># NB TODO boxWidths and lineWidths are NOT included.</span>
  <span class="s1">&#39;nef_peak&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;peak_id&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;volume_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;volumeError&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="s1">&#39;height&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;height_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;heightError&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_5&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_5&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_6&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_6&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_7&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_7&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_8&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_8&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_9&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_9&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_10&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_10&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_11&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_11&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_12&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_12&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_13&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_13&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_14&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_14&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_15&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;position_uncertainty_15&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_5&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_5&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_5&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_5&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_6&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_6&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_6&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_6&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_7&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_7&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_7&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_7&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_8&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_8&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_8&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_8&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_9&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_9&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_9&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_9&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_10&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_10&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_10&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_10&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_11&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_11&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_11&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_11&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_12&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_12&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_12&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_12&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_13&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_13&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_13&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_13&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_14&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_14&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_14&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_14&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_15&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_15&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_15&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_15&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_annotation&#39;</span><span class="p">,</span><span class="s1">&#39;annotation&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="c1"># NB SpectrumHit crosslink to sample and sampleComponent are derived</span>
  <span class="c1"># And need not be stored here.</span>
  <span class="s1">&#39;ccpn_spectrum_hit&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_substance_name&#39;</span><span class="p">,</span><span class="s1">&#39;substanceName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_pseudo_dimension_number&#39;</span><span class="p">,</span><span class="s1">&#39;pseudoDimensionNumber&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_point_number&#39;</span><span class="p">,</span><span class="s1">&#39;pointNumber&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_merit_code&#39;</span><span class="p">,</span><span class="s1">&#39;meritCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_normalised_change&#39;</span><span class="p">,</span><span class="s1">&#39;normalisedChange&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_is_confirmed_&#39;</span><span class="p">,</span><span class="s1">&#39;isConfirmed&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_concentration&#39;</span><span class="p">,</span><span class="s1">&#39;concentration&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_&#39;</span><span class="p">,</span><span class="s1">&#39;concentrationError&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_concentration_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;concentrationUnit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nef_peak_restraint_links&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;nef_peak_restraint_link&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;nef_peak_restraint_link&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;peak_id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_list_id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_spectrum_group&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_group_spectrum&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;ccpn_group_spectrum&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_integral_list&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;symbol_colour&#39;</span><span class="p">,</span><span class="s1">&#39;symbolColour&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;text_colour&#39;</span><span class="p">,</span><span class="s1">&#39;textColour&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_integral&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;integral_list_serial&#39;</span><span class="p">,</span><span class="s1">&#39;integralList.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;integral_serial&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;value_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;valueError&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span><span class="s1">&#39;bias&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;slopes_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;slopes_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;slopes_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;slopes_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limits_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limits_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limits_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limits_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limits_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limits_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limits_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limits_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;annotation&#39;</span><span class="p">,</span><span class="s1">&#39;annotation&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;details&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="c1"># NB Sample crosslink to spectrum is handled on the spectrum side</span>
  <span class="s1">&#39;ccpn_sample&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;pH&#39;</span><span class="p">,</span><span class="s1">&#39;ph&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ionic_strength&#39;</span><span class="p">,</span><span class="s1">&#39;ionicStrength&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;amount_unit&#39;</span><span class="p">,</span><span class="s1">&#39;amountUnit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;is_hazardous&#39;</span><span class="p">,</span><span class="s1">&#39;isHazardous&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;is_virtual&#39;</span><span class="p">,</span><span class="s1">&#39;isVirtual&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;creation_date&#39;</span><span class="p">,</span><span class="s1">&#39;creationDate&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;batch_identifier&#39;</span><span class="p">,</span><span class="s1">&#39;batchIdentifier&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;plate_identifier&#39;</span><span class="p">,</span><span class="s1">&#39;plateIdentifier&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;row_number&#39;</span><span class="p">,</span><span class="s1">&#39;rowNumber&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;column_number&#39;</span><span class="p">,</span><span class="s1">&#39;columnNumber&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_sample_component&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;ccpn_sample_component&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;labelling&#39;</span><span class="p">,</span><span class="s1">&#39;labelling&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span><span class="s1">&#39;role&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;concentration&#39;</span><span class="p">,</span><span class="s1">&#39;concentration&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;concentration_error&#39;</span><span class="p">,</span><span class="s1">&#39;concentrationError&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;concentration_unit&#39;</span><span class="p">,</span><span class="s1">&#39;concentrationUnit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;purity&#39;</span><span class="p">,</span><span class="s1">&#39;purity&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_substance&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;labelling&#39;</span><span class="p">,</span><span class="s1">&#39;labelling&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;substance_type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;user_code&#39;</span><span class="p">,</span><span class="s1">&#39;userCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smiles&#39;</span><span class="p">,</span><span class="s1">&#39;smiles&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;inchi&#39;</span><span class="p">,</span><span class="s1">&#39;inChi&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cas_number&#39;</span><span class="p">,</span><span class="s1">&#39;casNumber&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;empirical_formula&#39;</span><span class="p">,</span><span class="s1">&#39;empiricalFormula&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_string&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;mol_type&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;start_number&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;is_cyclic&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;molecular_mass&#39;</span><span class="p">,</span><span class="s1">&#39;molecularMass&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_count&#39;</span><span class="p">,</span><span class="s1">&#39;atomCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;bond_count&#39;</span><span class="p">,</span><span class="s1">&#39;bondCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ring_count&#39;</span><span class="p">,</span><span class="s1">&#39;ringCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;h_bond_donor_count&#39;</span><span class="p">,</span><span class="s1">&#39;hBondDonorCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;h_bond_acceptor_count&#39;</span><span class="p">,</span><span class="s1">&#39;hBondAcceptorCount&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;polar_surface_area&#39;</span><span class="p">,</span><span class="s1">&#39;polarSurfaceArea&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;log_partition_coefficient&#39;</span><span class="p">,</span><span class="s1">&#39;logPartitionCoefficient&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_substance_synonym&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;ccpn_substance_synonym&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;synonym&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_assignments&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;nmr_chain&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nmr_residue&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;nmr_atom&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nmr_chain&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;short_name&#39;</span><span class="p">,</span><span class="s1">&#39;shortName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;is_connected&#39;</span><span class="p">,</span><span class="s1">&#39;isConnected&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;details&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nmr_residue&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;chain_code&#39;</span><span class="p">,</span> <span class="s1">&#39;nmrChain.shortName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code&#39;</span><span class="p">,</span><span class="s1">&#39;sequenceCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name&#39;</span><span class="p">,</span><span class="s1">&#39;residueType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;details&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;nmr_atom&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;chain_code&#39;</span><span class="p">,</span><span class="s1">&#39;nmrResidue.nmrChain.shortName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code&#39;</span><span class="p">,</span><span class="s1">&#39;nmrResidue.sequenceCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;isotopeCode&#39;</span><span class="p">,</span><span class="s1">&#39;isotopeCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;details&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_dataset&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_name&#39;</span><span class="p">,</span><span class="s1">&#39;programName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_version&#39;</span><span class="p">,</span><span class="s1">&#39;programVersion&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data_path&#39;</span><span class="p">,</span><span class="s1">&#39;dataPath&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;creation_date&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span><span class="s1">&#39;uuid&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_calculation_step&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_calculation_data&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_calculation_step&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_name&#39;</span><span class="p">,</span><span class="s1">&#39;programName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;program_version&#39;</span><span class="p">,</span><span class="s1">&#39;programVersion&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;script_name&#39;</span><span class="p">,</span><span class="s1">&#39;scriptName&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span><span class="s1">&#39;script&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;input_data_uuid&#39;</span><span class="p">,</span><span class="s1">&#39;inputDataUuid&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;output_data_uuid&#39;</span><span class="p">,</span><span class="s1">&#39;outputDataUuid&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_calculation_data&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;data_name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;attached_object_pid&#39;</span><span class="p">,</span><span class="s1">&#39;attachedObjectPid&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;parameter_name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;parameter_value&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_restraint_list&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;potential_type&#39;</span><span class="p">,</span><span class="s1">&#39;potentialType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_origin&#39;</span><span class="p">,</span><span class="s1">&#39;origin&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_chain_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorChainCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_sequence_code&#39;</span><span class="p">,</span><span class="s1">&#39;tensorSequenceCode&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_residue_name&#39;</span><span class="p">,</span><span class="s1">&#39;tensorResidueType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_magnitude&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorMagnitude&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_rhombicity&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorRhombicity&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;tensor_isotropic_value&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorIsotropicValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_serial&#39;</span><span class="p">,</span><span class="s1">&#39;serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;dataset_serial&#39;</span><span class="p">,</span><span class="s1">&#39;dataSet.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_type&#39;</span><span class="p">,</span><span class="s1">&#39;restraintType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_item_length&#39;</span><span class="p">,</span><span class="s1">&#39;restraintItemLength&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span><span class="s1">&#39;unit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;measurement_type&#39;</span><span class="p">,</span><span class="s1">&#39;measurementType&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_restraint&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;ccpn_restraint&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.serial&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;restraint_combination_id&#39;</span><span class="p">,</span><span class="s1">&#39;combinationId&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_2&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_3&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;chain_code_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;sequence_code_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;residue_name_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;atom_name_4&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value&#39;</span><span class="p">,</span><span class="s1">&#39;targetValue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;target_value_uncertainty&#39;</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalLowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;lower_limit&#39;</span><span class="p">,</span><span class="s1">&#39;lowerLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_limit&#39;</span><span class="p">,</span><span class="s1">&#39;upperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;upper_linear_limit&#39;</span><span class="p">,</span><span class="s1">&#39;additionalUpperLimit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;distance_dependent&#39;</span><span class="p">,</span><span class="s1">&#39;isDistanceDependent&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;vector_length&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.vectorLength&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;figure_of_merit&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.figureOfMerit&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">,</span><span class="s1">&#39;restraint.comment&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_notes&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_note&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;ccpn_note&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;last_modified&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="s1">&#39;text&#39;</span><span class="p">),</span>
  <span class="p">)),</span>

  <span class="s1">&#39;ccpn_additional_data&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_internal_data&#39;</span><span class="p">,</span><span class="n">_isALoop</span><span class="p">),</span>
  <span class="p">)),</span>
  <span class="s1">&#39;ccpn_internal_data&#39;</span><span class="p">:</span><span class="n">OD</span><span class="p">((</span>
    <span class="p">(</span><span class="s1">&#39;ccpn_object_pid&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;internal_data_string&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
  <span class="p">)),</span>

<span class="p">}</span>

  <span class="c1"># TODO add function to get NefReader to load multiple projects, settings</span>

<div class="viewcode-block" id="saveNefProject"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.saveNefProject">[docs]</a><span class="k">def</span> <span class="nf">saveNefProject</span><span class="p">(</span><span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">skipPrefixes</span><span class="o">=</span><span class="p">()):</span>
  <span class="sd">&quot;&quot;&quot;Save project NEF file to path&quot;&quot;&quot;</span>

  <span class="n">dirPath</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span>
    <span class="c1"># we got a directory - derive filename from project</span>
    <span class="n">fileName</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.nef&#39;</span>

  <span class="n">filePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirPath</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwriteExisting</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> already exists&quot;</span> <span class="o">%</span> <span class="n">filePath</span><span class="p">)</span>

  <span class="n">text</span> <span class="o">=</span> <span class="n">convert2NefString</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="n">skipPrefixes</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">dirPath</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirPath</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirPath</span><span class="p">)</span>

  <span class="nb">open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert2NefString"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.convert2NefString">[docs]</a><span class="k">def</span> <span class="nf">convert2NefString</span><span class="p">(</span><span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="p">:</span><span class="n">Sequence</span><span class="o">=</span><span class="p">()):</span>
  <span class="sd">&quot;&quot;&quot;Convert project to NEF string&quot;&quot;&quot;</span>
  <span class="n">converter</span> <span class="o">=</span> <span class="n">CcpnNefWriter</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
  <span class="n">dataBlock</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">exportProject</span><span class="p">()</span>

  <span class="c1"># Delete tags starting with certain prefixes.</span>
  <span class="c1"># NB designed to strip out &#39;ccpn&#39; tags to make output comparison easier</span>
  <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">skipPrefixes</span><span class="p">:</span>
    <span class="c1"># Could be done faster, but this is a rare operation</span>
    <span class="k">for</span> <span class="n">sftag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataBlock</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
      <span class="k">if</span> <span class="n">sftag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">dataBlock</span><span class="p">[</span><span class="n">sftag</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">dataBlock</span><span class="p">[</span><span class="n">sftag</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">sf</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">sf</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
              <span class="c1"># This is a loop:</span>
              <span class="k">for</span> <span class="n">looptag</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># NB val.columns is a tuple (encapsulation) and will not change during the loop</span>
                <span class="k">if</span> <span class="n">looptag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                  <span class="n">val</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">looptag</span><span class="p">,</span> <span class="n">removeData</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">dataBlock</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span></div>

<div class="viewcode-block" id="CcpnNefWriter"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter">[docs]</a><span class="k">class</span> <span class="nc">CcpnNefWriter</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;CCPN NEF reader/writer&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">specificationFile</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span>
               <span class="n">programName</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">programVersion</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span>
    <span class="k">if</span> <span class="n">specificationFile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">specification</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># NBNB TBD reconsider whether we want the spec summary or something else</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">specification</span> <span class="o">=</span> <span class="n">Specification</span><span class="o">.</span><span class="n">getCcpnSpecification</span><span class="p">(</span><span class="n">specificationFile</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">programName</span> <span class="o">=</span> <span class="n">programName</span> <span class="ow">or</span> <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">applicationName</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">programVersion</span> <span class="o">=</span> <span class="n">programVersion</span> <span class="ow">or</span> <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">applicationVersion</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="CcpnNefWriter.exportDataSet"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.exportDataSet">[docs]</a>  <span class="k">def</span> <span class="nf">exportDataSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataSet</span><span class="p">:</span><span class="n">DataSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrDataBlock</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get dataSet and all objects linked to therein as NEF object tree for export&quot;&quot;&quot;</span>

    <span class="n">saveFrames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">makeNefMetaData</span><span class="p">(</span><span class="n">dataSet</span><span class="p">))</span>

    <span class="c1"># etc.</span>

    <span class="c1"># make and return dataBlock with saveframes in export order</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrDataBlock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dataSet</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">saveFrame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saveFrameNefOrder</span><span class="p">(</span><span class="n">saveFrames</span><span class="p">):</span>
      <span class="n">result</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">],</span> <span class="n">saveFrame</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CcpnNefWriter.exportProject"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.exportProject">[docs]</a>  <span class="k">def</span> <span class="nf">exportProject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrDataBlock</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get project and all contents as NEF object tree for export&quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">saveFrames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>

    <span class="c1"># MetaData</span>
    <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">makeNefMetaData</span><span class="p">(</span><span class="n">project</span><span class="p">))</span>

    <span class="c1"># Chains</span>
    <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains2Nef</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">chains</span><span class="p">))</span>

    <span class="c1"># ChemicalShiftLists</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">chemicalShiftLists</span><span class="p">:</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chemicalShiftList2Nef</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

    <span class="c1"># RestraintLists and</span>
    <span class="n">restraintLists</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">restraintLists</span><span class="p">,</span>
                            <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;restraintType&#39;</span><span class="p">,</span> <span class="s1">&#39;serial&#39;</span><span class="p">))</span>
    <span class="n">singleDataSet</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">restraintLists</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dataSet</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">restraintLists</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">restraintLists</span><span class="p">:</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restraintList2Nef</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">singleDataSet</span><span class="o">=</span><span class="n">singleDataSet</span><span class="p">))</span>

    <span class="c1"># Spectra</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
      <span class="c1"># NB we get multiple saveframes, one per peakList</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum2Nef</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

    <span class="c1"># restraint-peak links</span>
    <span class="n">saveFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peakRestraintLinks2Nef</span><span class="p">(</span><span class="n">restraintLists</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">saveFrame</span><span class="p">:</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">)</span>

    <span class="c1"># Now add CCPN-specific data:</span>
    <span class="c1"># # SpectrumGroups</span>
    <span class="c1"># for obj in project.spectrumGroups:</span>
    <span class="c1">#   saveFrames.append(self.spectrumGroup2Nef(obj))</span>

    <span class="c1"># Samples</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">samples</span><span class="p">:</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample2Nef</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

    <span class="c1"># Substances</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">substances</span><span class="p">:</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">substance2Nef</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

    <span class="c1"># # NmrChains</span>
    <span class="c1"># saveFrames.append(self.nmrChains2Nef(project.nmrChains))</span>

    <span class="c1"># # DataSets - NB does not include RestraintLists, which are given above</span>
    <span class="c1"># for obj in project.dataSets:</span>
    <span class="c1">#   saveFrames.append(self.dataSet2Nef(obj))</span>

    <span class="c1"># Notes</span>
    <span class="n">saveFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes2Nef</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">notes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">saveFrame</span><span class="p">:</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">)</span>

    <span class="c1"># Additional data</span>
    <span class="n">saveFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">additionalData2Nef</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">saveFrame</span><span class="p">:</span>
      <span class="n">saveFrames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">)</span>

    <span class="c1"># make and return dataBlock with sameframes in export order</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrDataBlock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">saveFrame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saveFrameNefOrder</span><span class="p">(</span><span class="n">saveFrames</span><span class="p">):</span>
      <span class="n">result</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">],</span> <span class="n">saveFrame</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefWriter.makeNefMetaData"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.makeNefMetaData">[docs]</a>  <span class="k">def</span> <span class="nf">makeNefMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headObject</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Project</span><span class="p">,</span> <span class="n">DataSet</span><span class="p">],</span>
                          <span class="n">coordinateFileName</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;make NEF metadata saveframe from Project&quot;&quot;&quot;</span>

    <span class="c1"># NB No attributes can be set from map here, so we do not try</span>

    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_nmr_meta_data&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">headObject</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>

    <span class="c1"># NBNB TBD FIXME add proper values for format version from specification file</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;format_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nmr_exchange_format&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;format_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
    <span class="c1"># format_version=None</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;coordinate_file_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinateFileName</span>
    <span class="k">if</span> <span class="n">headObject</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="s1">&#39;Project&#39;</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;program_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">programName</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;program_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">programVersion</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;creation_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">commonUtil</span><span class="o">.</span><span class="n">getTimeStamp</span><span class="p">()</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">programName</span><span class="p">,</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxRandomInt</span><span class="p">))</span>


      <span class="c1"># TODO NBNB now set automatically</span>


      <span class="c1"># This attribute is only present when exporting DataSets</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ccpn_dataset_comment&#39;</span><span class="p">]</span>
      <span class="c1"># This loop is only set when exporting DataSets</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_related_entries&#39;</span><span class="p">]</span>
      <span class="c1"># This loop is only set when exporting DataSets</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_run_history&#39;</span><span class="p">]</span>

      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_program_script&#39;</span><span class="p">]</span>
      <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">program_name</span><span class="o">=</span><span class="s1">&#39;CcpNmr&#39;</span><span class="p">,</span> <span class="n">script_name</span><span class="o">=</span><span class="s1">&#39;exportProject&#39;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">assert</span> <span class="n">headObject</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="s1">&#39;DataSet&#39;</span><span class="p">,</span> <span class="s2">&quot;Parameter must be a Project or DataSet&quot;</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;program_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headObject</span><span class="o">.</span><span class="n">programName</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;program_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headObject</span><span class="o">.</span><span class="n">programVersion</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;creation_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headObject</span><span class="o">.</span><span class="n">creationDate</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headObject</span><span class="o">.</span><span class="n">uuid</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ccpn_dataset_comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headObject</span><span class="o">.</span><span class="n">comment</span>

      <span class="c1"># NBNB TBD FIXME nef_related_entries is still to be implemented</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_related_entries&#39;</span><span class="p">]</span>

      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_run_history&#39;</span><span class="p">]</span>
      <span class="c1"># NBNB TBD FIXME nef_run_history is still to be wrapped</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_run_history&#39;</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefWriter.chains2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.chains2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">chains2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chains</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Chain</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert selected Chains to CCPN NEF saveframe&quot;&quot;&quot;</span>

    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_molecular_system&#39;</span>
    <span class="k">if</span> <span class="n">chains</span><span class="p">:</span>
      <span class="n">project</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">project</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>

      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_sequence&#39;</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>

      <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
          <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">rowdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">residue</span><span class="p">)</span>
          <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
          <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>

      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_covalent_links&#39;</span><span class="p">]</span>
      <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span> <span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span> <span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span> <span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span> <span class="s1">&#39;atom_name_2&#39;</span>
                 <span class="p">)</span>

      <span class="n">boundAtomPairs</span> <span class="o">=</span> <span class="n">extraBoundAtomPairs</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">selectSequential</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">boundAtomPairs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">boundAtomPairs</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">_idTuple</span> <span class="o">+</span> <span class="n">atom2</span><span class="o">.</span><span class="n">_idTuple</span><span class="p">))))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nef_covalent_links&#39;</span><span class="p">]</span>
      <span class="c1">#</span>
      <span class="k">return</span> <span class="n">result</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span></div>

<div class="viewcode-block" id="CcpnNefWriter.assignments2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.assignments2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">assignments2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert NmrChains, NmrResidues and NmrAtoms to saveframe&quot;&quot;&quot;</span>

    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;ccpn_assignment&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>

    <span class="n">nmrChainLoopName</span> <span class="o">=</span> <span class="s1">&#39;nmr_chain&#39;</span>
    <span class="n">nmrChainLoop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">nmrChainLoopName</span><span class="p">]</span>
    <span class="n">nmrResidueLoopName</span> <span class="o">=</span> <span class="s1">&#39;nmr_residue&#39;</span>
    <span class="n">nmrResidueLoop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">nmrResidueLoopName</span><span class="p">]</span>
    <span class="n">nmrAtomLoopName</span> <span class="o">=</span> <span class="s1">&#39;nmr_atom&#39;</span>
    <span class="n">nmrAtomLoop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">nmrAtomLoopName</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">nmrChain</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">:</span>
      <span class="n">rowdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">nmrChainLoopName</span><span class="p">,</span> <span class="n">nmrChain</span><span class="p">)</span>
      <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">serial</span>
      <span class="n">nmrChainLoop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>

      <span class="c1"># NB this makes sure that connected stretches are given in order.</span>
      <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">mainNmrResidues</span>
      <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span><span class="p">:</span>
        <span class="n">rowdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">nmrResidueLoopName</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">)</span>
        <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">serial</span>
        <span class="n">nmrResidueLoop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>

        <span class="n">nmrResidues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">offsetNmrResidues</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>
          <span class="n">rowdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">nmrAtomLoopName</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">)</span>
          <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">serial</span>
          <span class="n">nmrAtomLoop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CcpnNefWriter.chemicalShiftList2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.chemicalShiftList2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">chemicalShiftList2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chemicalShiftList</span><span class="p">:</span><span class="n">ChemicalShiftList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert ChemicalShiftList to CCPN NEF saveframe&quot;&quot;&quot;</span>

    <span class="c1"># Set up frame</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_chemical_shift_list&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">chemicalShiftList</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">chemicalShiftList</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="p">[</span><span class="n">chemicalShiftList</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>

    <span class="c1"># Fill in loop - use dictionary rather than list as this is more robust against reorderings</span>
    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_chemical_shift&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">atomCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chain_code&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence_code&#39;</span><span class="p">,</span> <span class="s1">&#39;residue_name&#39;</span><span class="p">,</span> <span class="s1">&#39;atom_name&#39;</span><span class="p">,]</span>
    <span class="c1"># NB We cannot use nmrAtom.id.split(&#39;.&#39;), since the id has reserved characters remapped</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">chemicalShiftList</span><span class="o">.</span><span class="n">chemicalShifts</span>
    <span class="k">if</span> <span class="n">shifts</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">:</span>
        <span class="n">rowdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">shift</span><span class="o">.</span><span class="n">nmrAtom</span>
        <span class="n">rowdata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">atomCols</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">_idTuple</span><span class="p">))</span>
        <span class="n">isotopeCode</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">isotopeCode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">isotope</span><span class="p">,</span><span class="n">element</span> <span class="o">=</span> <span class="n">commonUtil</span><span class="o">.</span><span class="n">splitIntFromChars</span><span class="p">(</span><span class="n">isotopeCode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isotope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>
          <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;isotope_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isotope</span>

        <span class="c1"># Correct for atom names starting with the isotopeCode (e.g. 2HA, 111CD)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;atom_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">isotopeCode</span><span class="p">):</span>
          <span class="n">plainName</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">isotope</span><span class="p">)):]</span>
          <span class="k">if</span> <span class="n">chemicalShiftList</span><span class="o">.</span><span class="n">getChemicalShift</span><span class="p">(</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">_id</span> <span class="o">+</span> <span class="n">Pid</span><span class="o">.</span><span class="n">IDSEP</span> <span class="o">+</span> <span class="n">plainName</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># There is no shift in this list that has the corresponding name without the</span>
            <span class="c1"># isotope number prefix. Remove the prefix for writing</span>
            <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;atom_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plainName</span>

        <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


  <span class="c1"># def dataSet2Nef(self, dataSet:DataSet) -&gt; StarIo.NmrSaveFrame:</span>
  <span class="c1">#   &quot;&quot;&quot;Convert DataSet to CCPN NEF saveframe&quot;&quot;&quot;</span>
  <span class="c1">#</span>
  <span class="c1">#   # Set up frame</span>
  <span class="c1">#   category = &#39;ccpn_dataset&#39;</span>
  <span class="c1">#   result = self._newNefSaveFrame(dataSet, category, str(dataSet.serial))</span>
  <span class="c1">#   result[&#39;creation_date&#39;] =</span>
  <span class="c1">#</span>
  <span class="c1">#   self.ccpn2SaveFrameName[dataSet] = result[&#39;sf_framecode&#39;]</span>
  <span class="c1">#</span>
  <span class="c1">#   # Fill in loop</span>
  <span class="c1">#   loopName = &#39;ccpn_sample_component&#39;</span>
  <span class="c1">#   loop = result[loopName]</span>
  <span class="c1">#   components = sample.sampleComponents</span>
  <span class="c1">#   if components:</span>
  <span class="c1">#     for sampleComponent in components:</span>
  <span class="c1">#       loop.newRow(self._loopRowData(loopName, sampleComponent))</span>
  <span class="c1">#   else:</span>
  <span class="c1">#     del result[loopName]</span>
  <span class="c1">#   #</span>
  <span class="c1">#   return result</span>


  <span class="c1"># &#39;ccpn_dataset&#39;:OD((</span>
  <span class="c1">#   (&#39;serial&#39;,&#39;serial&#39;),</span>
  <span class="c1">#   (&#39;title&#39;,&#39;title&#39;),</span>
  <span class="c1">#   (&#39;program_name&#39;,&#39;programName&#39;),</span>
  <span class="c1">#   (&#39;program_version&#39;,&#39;programVersion&#39;),</span>
  <span class="c1">#   (&#39;data_path&#39;,&#39;dataPath&#39;),</span>
  <span class="c1">#   (&#39;creation_date&#39;,None),</span>
  <span class="c1">#   (&#39;uuid&#39;,&#39;uuid&#39;),</span>
  <span class="c1">#   (&#39;comment&#39;,&#39;comment&#39;),</span>
  <span class="c1">#   (&#39;ccpn_calculation_step&#39;,_isALoop),</span>
  <span class="c1">#   (&#39;ccpn_data&#39;,_isALoop),</span>
  <span class="c1"># )),</span>
  <span class="c1">#</span>
  <span class="c1"># &#39;ccpn_calculation_step&#39;:OD((</span>
  <span class="c1">#   (&#39;serial&#39;, None),</span>
  <span class="c1">#   (&#39;program_name&#39;,&#39;programName&#39;),</span>
  <span class="c1">#   (&#39;program_version&#39;,&#39;programVersion&#39;),</span>
  <span class="c1">#   (&#39;script_name&#39;,&#39;scriptName&#39;),</span>
  <span class="c1">#   (&#39;script&#39;,&#39;script&#39;),</span>
  <span class="c1">#   (&#39;input_data_uuid&#39;,&#39;inputDataUuid&#39;),</span>
  <span class="c1">#   (&#39;output_data_uuid&#39;,&#39;outputDataUuid&#39;),</span>
  <span class="c1"># )),</span>
  <span class="c1">#</span>
  <span class="c1"># &#39;ccpn_calculation_data&#39;:OD((</span>
  <span class="c1">#   (&#39;data_name&#39;,&#39;name&#39;),</span>
  <span class="c1">#   (&#39;attached_object_pid&#39;,&#39;attachedObjectPid&#39;),</span>
  <span class="c1">#   (&#39;parameter_name&#39;, None),</span>
  <span class="c1">#   (&#39;parameter_value&#39;, None),</span>
  <span class="c1"># )),</span>


<div class="viewcode-block" id="CcpnNefWriter.restraintList2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.restraintList2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">restraintList2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restraintList</span><span class="p">:</span><span class="n">RestraintList</span><span class="p">,</span> <span class="n">singleDataSet</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert RestraintList to CCPN NEF saveframe&quot;&quot;&quot;</span>

    <span class="n">project</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">_project</span>

    <span class="c1"># Set up frame</span>
    <span class="n">restraintType</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">restraintType</span>
    <span class="n">itemLength</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">restraintItemLength</span>

    <span class="k">if</span> <span class="n">restraintType</span> <span class="o">==</span> <span class="s1">&#39;Distance&#39;</span><span class="p">:</span>
      <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_distance_restraint_list&#39;</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_distance_restraint&#39;</span>
    <span class="k">elif</span> <span class="n">restraintType</span> <span class="o">==</span> <span class="s1">&#39;Dihedral&#39;</span><span class="p">:</span>
      <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_dihedral_restraint_list&#39;</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_dihedral_restraint&#39;</span>
    <span class="k">elif</span> <span class="n">restraintType</span> <span class="o">==</span> <span class="s1">&#39;Rdc&#39;</span><span class="p">:</span>
      <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_rdc_restraint_list&#39;</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_rdc_restraint&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;ccpn_restraint_list&#39;</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_restraint&#39;</span>


    <span class="nb">max</span> <span class="o">=</span> <span class="n">itemLength</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">multipleAttributes</span> <span class="o">=</span> <span class="n">OD</span><span class="p">((</span>
      <span class="p">(</span><span class="s1">&#39;chainCodes&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;chain_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
      <span class="p">(</span><span class="s1">&#39;sequenceCodes&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;sequence_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
      <span class="p">(</span><span class="s1">&#39;residueTypes&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;residue_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
      <span class="p">(</span><span class="s1">&#39;atomNames&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;atom_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
    <span class="p">))</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">singleDataSet</span><span class="p">:</span>
      <span class="c1"># If there are multiple DataSets, add the dataSet serial for disambiguation</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">`</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">restraintList</span><span class="o">.</span><span class="n">dataSet</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">restraintList</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="p">[</span><span class="n">restraintList</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>

    <span class="c1"># for tag in (&#39;tensor_magnitude&#39;, &#39;tensor_rhombicity&#39;, &#39;tensor_isotropic_value&#39;,</span>
    <span class="c1">#             &#39;ccpn_tensor_magnitude&#39;, &#39;ccpn_tensor_rhombicity&#39;, &#39;ccpn_tensor_isotropic_value&#39;):</span>
    <span class="c1">#   if result.get(tag) == 0:</span>
    <span class="c1">#     # Tensor components default to 0</span>
    <span class="c1">#     result[tag] = None</span>
    <span class="c1">#</span>
    <span class="c1"># tensor = restraintList.tensor</span>
    <span class="c1"># if tensor is not None:</span>
    <span class="c1">#   result[&#39;tensor_magnitude&#39;] = tensor.axial or None</span>
    <span class="c1">#   result[&#39;tensor_rhombicity&#39;] = tensor.rhombic or None</span>
    <span class="c1">#   if category == &#39;ccpn_restraint_list&#39;:</span>
    <span class="c1">#     result[&#39;tensor_isotropic_value&#39;] = tensor.isotropic or None</span>
    <span class="c1">#   else:</span>
    <span class="c1">#     result[&#39;ccpn_tensor_isotropic_value&#39;] = tensor.isotropic or None</span>


    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">itemLength</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
      <span class="c1"># Remove unnecessary columns</span>
      <span class="n">removeNameEndings</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="s1">&#39;_2&#39;</span><span class="p">,</span> <span class="s1">&#39;_3&#39;</span><span class="p">,</span> <span class="s1">&#39;_4&#39;</span><span class="p">)[</span><span class="n">itemLength</span><span class="p">:]</span>
      <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">removeNameEndings</span><span class="p">:</span>
          <span class="n">loop</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">removeData</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">restraintContributions</span><span class="p">:</span>
      <span class="n">rowdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">contribution</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contribution</span><span class="o">.</span><span class="n">restraintItems</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

        <span class="c1"># NBNB TBD FIXME Using the PID, as we do here, you are remapping &#39;.&#39; to &#39;^&#39;</span>
        <span class="c1"># NBNB reconsider!!!</span>

        <span class="c1"># Set individual parts of assignment one by one.</span>
        <span class="c1"># NB _set command takes care of varying number of items</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">attrName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="s1">&#39;chainCodes&#39;</span><span class="p">,</span> <span class="s1">&#39;sequenceCodes&#39;</span><span class="p">,</span> <span class="s1">&#39;residueTypes&#39;</span><span class="p">,</span> <span class="s1">&#39;atomNames&#39;</span><span class="p">,)):</span>
          <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="n">attrName</span><span class="p">]):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;nef_dihedral_restraint_list&#39;</span><span class="p">:</span>
          <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RestraintLib</span><span class="o">.</span><span class="n">dihedralName</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefWriter.spectrum2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.spectrum2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">spectrum2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span><span class="n">Spectrum</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert spectrum to NEF saveframes - one per peaklist</span>

<span class="sd">    Will crate a peakList if none are present&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">peakLists</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">peakLists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">peakLists</span><span class="p">:</span>
      <span class="n">peakLists</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">newPeakList</span><span class="p">()]</span>

    <span class="k">for</span> <span class="n">peakList</span> <span class="ow">in</span> <span class="n">peakLists</span><span class="p">:</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peakList2Nef</span><span class="p">(</span><span class="n">peakList</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefWriter.peakList2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.peakList2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">peakList2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakList</span><span class="p">:</span><span class="n">PeakList</span><span class="p">,</span> <span class="n">exportCompleteSpectrum</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert PeakList to CCPN NEF saveframe.</span>
<span class="sd">    Used for all spectrum export, as there is one frame per PeakList</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span>

    <span class="c1"># frameCode for saveFrame that holds spectrum adn first peaklist.</span>
    <span class="c1"># If not None, the peakList will be read into that specttum</span>
    <span class="n">spectrumAlreadySaved</span> <span class="o">=</span>  <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>

    <span class="c1"># We do not support sampled or unprocessed dimensions yet. NBNB TBD.</span>
    <span class="k">if</span> <span class="nb">any</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;Frequency&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionTypes</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;NEF only implemented for processed frequency spectra, dimension types were: </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionTypes</span><span class="p">,)</span>
      <span class="p">)</span>

    <span class="c1"># Get unique frame name</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="n">spectrumAlreadySaved</span><span class="p">:</span>
      <span class="c1"># not the first time this spectrum appears.</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">peakList</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>
      <span class="k">while</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getSpectrum</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="c1"># Realistically this should never happen,</span>
        <span class="c1"># but it is a further (if imperfect) guard against clashes</span>
        <span class="c1"># This name is taken - modify it</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">peakList</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>

    <span class="c1"># Set up frame</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_nmr_spectrum&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">peakList</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">filePath</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ccpn_spectrum_file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="p">[</span><span class="n">peakList</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spectrumAlreadySaved</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="p">[</span><span class="n">spectrum</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>

    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;chemical_shift_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">peakList</span><span class="o">.</span><span class="n">chemicalShiftList</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ccpn_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>


    <span class="c1"># Will give wrong values for Hz or pointNumber units, and</span>
    <span class="c1"># Will fill in all None for non-Frequency dimensions</span>
    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_spectrum_dimension&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">OD</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">neftag</span><span class="p">,</span><span class="n">attrstring</span> <span class="ow">in</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">attrstring</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># to fill in later</span>
        <span class="n">data</span><span class="p">[</span><span class="n">neftag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">neftag</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">attrstring</span><span class="p">)(</span><span class="n">spectrum</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;folding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">foldingModes</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;value_first_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrumLimits</span><span class="p">]</span>
    <span class="c1"># NBNB All CCPN peaks are in principle at the correct unaliased positions</span>
    <span class="c1"># Whether they are set correctly is another matter.</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;absolute_peak_positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span> <span class="o">*</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span>
    <span class="n">acquisitionAxisCode</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">acquisitionAxisCode</span>
    <span class="k">if</span> <span class="n">acquisitionAxisCode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_acquisition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_acquisition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">==</span> <span class="n">acquisitionAxisCode</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">axisCodes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span><span class="p">):</span>
      <span class="n">rowdata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
      <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>
      <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>


    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_spectrum_dimension&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">OD</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">neftag</span><span class="p">,</span><span class="n">attrstring</span> <span class="ow">in</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">attrstring</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># to fill in later</span>
        <span class="n">data</span><span class="p">[</span><span class="n">neftag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">data</span><span class="p">[</span><span class="n">neftag</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">attrstring</span><span class="p">)(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
          <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Could not get </span><span class="si">%s</span><span class="s2"> from Spectrum </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attrstring</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">))</span>

    <span class="n">aliasingLimits</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">aliasingLimits</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span><span class="p">):</span>
      <span class="n">rowdata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
      <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;lower_aliasing_limit&#39;</span><span class="p">],</span> <span class="n">rowdata</span><span class="p">[</span><span class="s1">&#39;higher_aliasing_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aliasingLimits</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
      <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>
      <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>


    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_spectrum_dimension_transfer&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">transfers</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">magnetisationTransfers</span>
    <span class="k">if</span> <span class="n">transfers</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">transfers</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;dimension_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dimension_2&#39;</span><span class="p">,</span> <span class="s1">&#39;transfer_type&#39;</span><span class="p">,</span> <span class="s1">&#39;is_indirect&#39;</span><span class="p">],</span> <span class="n">tt</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>

    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_peak&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>

    <span class="c1"># Remove superfluous tags</span>
    <span class="n">removeNameEndings</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="s1">&#39;_2&#39;</span><span class="p">,</span> <span class="s1">&#39;_3&#39;</span><span class="p">,</span> <span class="s1">&#39;_4&#39;</span><span class="p">,</span> <span class="s1">&#39;_5&#39;</span><span class="p">,</span> <span class="s1">&#39;_6&#39;</span><span class="p">,</span> <span class="s1">&#39;_7&#39;</span><span class="p">,</span> <span class="s1">&#39;_8&#39;</span><span class="p">,</span> <span class="s1">&#39;_9&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;_10&#39;</span><span class="p">,</span> <span class="s1">&#39;_11&#39;</span><span class="p">,</span> <span class="s1">&#39;_12&#39;</span><span class="p">,</span> <span class="s1">&#39;_13&#39;</span><span class="p">,</span> <span class="s1">&#39;_14&#39;</span><span class="p">,</span> <span class="s1">&#39;_15&#39;</span><span class="p">,)[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">removeNameEndings</span><span class="p">):</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

    <span class="c1"># Get name map for per-dimension attributes</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">multipleAttributes</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;position&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;position_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;positionError&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;position_uncertainty_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;chainCodes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;chain_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;sequenceCodes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;sequence_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;residueTypes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;residue_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;atomNames&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;atom_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;slopes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;slopes_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;lowerLimits&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;lower_limits_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;upperLimits&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;upper_limits_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
    <span class="p">}</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peakList</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span>
      <span class="n">rowdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span>

      <span class="n">assignments</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">assignedNmrAtoms</span>
      <span class="k">if</span> <span class="n">assignments</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
          <span class="c1"># Make one row per assignment</span>
          <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>
          <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
          <span class="n">values</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span>
          <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
          <span class="n">values</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">positionError</span>
          <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;positionError&#39;</span><span class="p">]):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
          <span class="c1"># NB the row._set function will set position_1, position_2 etc.</span>
          <span class="c1"># row._set(&#39;position&#39;, peak.position)</span>
          <span class="c1"># row._set(&#39;position_uncertainty&#39;, peak.positionError)</span>

          <span class="c1"># Add the assignments</span>
          <span class="n">ll</span> <span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">_idTuple</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">attrName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
              <span class="p">(</span><span class="s1">&#39;chainCodes&#39;</span><span class="p">,</span> <span class="s1">&#39;sequenceCodes&#39;</span><span class="p">,</span> <span class="s1">&#39;residueTypes&#39;</span><span class="p">,</span> <span class="s1">&#39;atomNames&#39;</span><span class="p">)</span>
          <span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="n">attrName</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>
              <span class="n">row</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">jj</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">val</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
          <span class="c1"># # Add the assignments</span>
          <span class="c1"># ll =list(zip(*(x._idTuple if x else (None, None, None, None) for x in tt)))</span>
          <span class="c1"># row._set(&#39;chain_code&#39;, ll[0])</span>
          <span class="c1"># row._set(&#39;sequence_code&#39;, ll[1])</span>
          <span class="c1"># row._set(&#39;residue_name&#39;, ll[2])</span>
          <span class="c1"># row._set(&#39;atom_name&#39;, ll[3])</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No assignments - just make one unassigned row</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">rowdata</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">position</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]):</span>
          <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">positionError</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;positionError&#39;</span><span class="p">]):</span>
          <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="c1"># # NB the row._set function will set position_1, position_2 etc.</span>
        <span class="c1"># row._set(&#39;position&#39;, peak.position)</span>
        <span class="c1"># row._set(&#39;position_uncertainty&#39;, peak.positionError)</span>


    <span class="k">if</span> <span class="n">exportCompleteSpectrum</span> <span class="ow">and</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrumHits</span><span class="p">:</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_spectrum_hit&#39;</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">spectrumHit</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrumHits</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">spectrumHit</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ccpn_spectrum_hit&#39;</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">exportCompleteSpectrum</span> <span class="ow">and</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">integralLists</span><span class="p">:</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_integral_list&#39;</span>

      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">removeNameEndings</span><span class="p">):</span>
          <span class="n">loop</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">integralList</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">integralLists</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">integralList</span><span class="p">))</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integralList</span><span class="o">.</span><span class="n">serial</span>

      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_integral&#39;</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">removeNameEndings</span><span class="p">):</span>
          <span class="n">loop</span><span class="o">.</span><span class="n">removeColumn</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">integral</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">integrals</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">integral</span><span class="p">))</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;integral_serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integral</span><span class="o">.</span><span class="n">serial</span>
        <span class="n">values</span> <span class="o">=</span><span class="n">integral</span><span class="o">.</span><span class="n">slopes</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;slopes&#39;</span><span class="p">]):</span>
          <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">lowerlimits</span><span class="p">,</span><span class="n">upperLimits</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">integral</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;lowerLimits&#39;</span><span class="p">]):</span>
          <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerlimits</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;upperLimits&#39;</span><span class="p">]):</span>
          <span class="n">row</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperLimits</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="c1"># row._set(&#39;slopes&#39;, integral.slopes)</span>
        <span class="c1"># row._set(&#39;lower_limits&#39;, lowerlimits)</span>
        <span class="c1"># row._set(&#39;upper_limits&#39;, upperLimits)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ccpn_integral_list&#39;</span><span class="p">]</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ccpn_integral&#39;</span><span class="p">]</span>

      <span class="c1"># NB do more later (e.g. SpectrumReference)</span>

    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CcpnNefWriter.peakRestraintLinks2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.peakRestraintLinks2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">peakRestraintLinks2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restraintLists</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RestraintList</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">restraintList</span> <span class="ow">in</span> <span class="n">restraintLists</span><span class="p">:</span>
      <span class="n">restraintListFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">restraintList</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">restraintListFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">restraint</span> <span class="ow">in</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">restraints</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">restraint</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span>
            <span class="n">peakListFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">peakListFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
              <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">peakListFrame</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span> <span class="n">restraintListFrame</span><span class="p">,</span> <span class="n">restraint</span><span class="o">.</span><span class="n">serial</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
      <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;nef_peak_restraint_links&#39;</span>
      <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_id&#39;</span><span class="p">,</span> <span class="s1">&#39;restraint_list_id&#39;</span><span class="p">,</span> <span class="s1">&#39;restraint_id&#39;</span><span class="p">,</span> <span class="p">)</span>
      <span class="c1"># Set up frame</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">restraintLists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_peak_restraint_link&#39;</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">rowdata</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">rowdata</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="CcpnNefWriter.spectrumGroup2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.spectrumGroup2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">spectrumGroup2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrumGroup</span><span class="p">:</span><span class="n">SpectrumGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert SpectrumGroup to CCPN NEF saveframe&quot;&quot;&quot;</span>

    <span class="c1"># Set up frame</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;ccpn_spectrum_group&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">spectrumGroup</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">spectrumGroup</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="p">[</span><span class="n">spectrumGroup</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>

    <span class="c1"># Fill in loop</span>
    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_group_spectrum&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">spectra</span> <span class="o">=</span> <span class="n">spectrumGroup</span><span class="o">.</span><span class="n">spectra</span>
    <span class="k">if</span> <span class="n">spectra</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">spectrumGroup</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CcpnNefWriter.sample2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.sample2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">sample2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span><span class="n">Sample</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert Sample to CCPN NEF saveframe&quot;&quot;&quot;</span>

    <span class="c1"># Set up frame</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;ccpn_sample&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>

    <span class="c1"># Fill in loop</span>
    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_sample_component&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">sampleComponents</span>
    <span class="k">if</span> <span class="n">components</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">sampleComponent</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">sampleComponent</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefWriter.substance2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.substance2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">substance2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substance</span><span class="p">:</span><span class="n">Substance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert Substance to CCPN NEF saveframe&quot;&quot;&quot;</span>

    <span class="c1"># Set up frame</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;ccpn_substance&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">substance</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">substance</span><span class="o">.</span><span class="n">labelling</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">substance</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">substanceType</span> <span class="o">=</span> <span class="n">substance</span><span class="o">.</span><span class="n">substanceType</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;substance_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">substanceType</span>
    <span class="k">if</span> <span class="n">substanceType</span> <span class="o">==</span> <span class="s1">&#39;Molecule&#39;</span><span class="p">:</span>
      <span class="n">apiMolecule</span> <span class="o">=</span> <span class="n">substance</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">molecule</span>
      <span class="k">if</span> <span class="n">apiMolecule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sequence_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">substance</span><span class="o">.</span><span class="n">sequenceString</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;start_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apiMolecule</span><span class="o">.</span><span class="n">sortedMolResidues</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seqCode</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_cyclic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apiMolecule</span><span class="o">.</span><span class="n">isStdCyclic</span>
        <span class="n">molType</span> <span class="o">=</span> <span class="n">apiMolecule</span><span class="o">.</span><span class="n">molType</span>
        <span class="k">if</span> <span class="n">molType</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">molType</span><span class="p">:</span>
          <span class="c1"># &#39;protein&#39;, &#39;DNA&#39;, or &#39;RNA&#39;. Excludes &#39;DNA/RNA&#39;</span>
          <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mol_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molType</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ccpn2SaveFrameName</span><span class="p">[</span><span class="n">substance</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>

    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_substance_synonym&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">synonyms</span> <span class="o">=</span> <span class="n">substance</span><span class="o">.</span><span class="n">synonyms</span>
    <span class="k">if</span> <span class="n">synonyms</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">synonym</span> <span class="ow">in</span> <span class="n">synonyms</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">((</span><span class="n">synonym</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefWriter.notes2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.notes2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">notes2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Note</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert Notes to CCPN NEF saveframe&quot;&quot;&quot;</span>

    <span class="c1"># Set up frame</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;ccpn_notes&#39;</span>
    <span class="k">if</span> <span class="n">notes</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_note&#39;</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">notes</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loopRowData</span><span class="p">(</span><span class="n">loopName</span><span class="p">,</span> <span class="n">note</span><span class="p">))</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">serial</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">coreConstants</span><span class="o">.</span><span class="n">isoTimeFormat</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;last_modified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">lastModified</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">coreConstants</span><span class="o">.</span><span class="n">isoTimeFormat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefWriter.additionalData2Nef"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefWriter.additionalData2Nef">[docs]</a>  <span class="k">def</span> <span class="nf">additionalData2Nef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Make singleton saveFrame for additional data (ccpnInternalData)&quot;&quot;&quot;</span>

    <span class="c1"># Set up frame</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;ccpn_additional_data&#39;</span>
    <span class="n">pid2Obj</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_pid2Obj</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">className</span> <span class="ow">in</span> <span class="n">_coreImportOrder</span><span class="p">:</span>
      <span class="c1"># Use importOrder to get all classNames. The actual order does not matter here.</span>
      <span class="n">dd</span> <span class="o">=</span> <span class="n">pid2Obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">className</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="n">internalData</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">ccpnInternalData</span>
          <span class="k">if</span> <span class="n">internalData</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">longPid</span><span class="p">]</span> <span class="o">=</span> <span class="n">internalData</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newNefSaveFrame</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_internal_data&#39;</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">newRow</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">jsonIo</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


  <span class="k">def</span> <span class="nf">_saveFrameNefOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveframes</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">]]</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Reorder saveframes in NEF export order, and filter out Nones&quot;&quot;&quot;</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">saveframe</span> <span class="ow">in</span> <span class="n">saveframes</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">saveframe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">saveframe</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">],</span> <span class="p">[])</span>
        <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saveframe</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">saveFrameWritingOrder</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dd</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown saveframe types in export: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">def</span> <span class="nf">_loopRowData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loopName</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">wrapperObj</span><span class="p">:</span><span class="n">AbstractWrapperObject</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fill in a loop row data dictionary from master mapping and wrapperObj.</span>
<span class="sd">    Unmapped data to be added afterwards&quot;&quot;&quot;</span>

    <span class="n">rowdata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">neftag</span><span class="p">,</span><span class="n">attrstring</span> <span class="ow">in</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">attrstring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rowdata</span><span class="p">[</span><span class="n">neftag</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">attrstring</span><span class="p">)(</span><span class="n">wrapperObj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rowdata</span>

  <span class="k">def</span> <span class="nf">_newNefSaveFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapperObj</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="n">AbstractWrapperObject</span><span class="p">],</span>
                      <span class="n">category</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create new NEF saveframe of category for wrapperObj using data from self.Nef2CcpnMap</span>
<span class="sd">    The functions will fill in top level items and make loops, but not</span>
<span class="sd">    fill in loop data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">string2FramecodeString</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">category</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="c1"># Set up frame</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="s1">&#39;sf_category&#39;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">wrapperObj</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># Add data</span>
      <span class="n">frameMap</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">itemvalue</span> <span class="ow">in</span> <span class="n">frameMap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">itemvalue</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">result</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">)(</span><span class="n">wrapperObj</span><span class="p">))</span>
          <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># TODO get rid of the try - except</span>
            <span class="c1"># You can get this error if a) the mapping is incorrect</span>
            <span class="c1"># The dotted navigation expression can not always be followed</span>
            <span class="c1"># as is the case e.g. for (PeakList.)spectrum._wrappedData.dataStore.headerSize&#39;</span>
            <span class="c1"># where the dataStore is sometimes None</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Could not get </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span> <span class="n">wrapperObj</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># This is a loop</span>
          <span class="k">assert</span> <span class="n">itemvalue</span> <span class="o">==</span> <span class="n">_isALoop</span><span class="p">,</span> <span class="s2">&quot;Invalid item specifier in Nef2CcpnMap: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">itemvalue</span><span class="p">,)</span>
          <span class="n">result</span><span class="o">.</span><span class="n">newLoop</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>



  <span class="c1">####################################################################################</span>
  <span class="c1">#</span>
  <span class="c1">###    NEF reader code:</span>
  <span class="c1">#</span>
  <span class="c1">####################################################################################</span>


<div class="viewcode-block" id="CcpnNefReader"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader">[docs]</a><span class="k">class</span> <span class="nc">CcpnNefReader</span><span class="p">:</span>
  <span class="c1"># Importer functions - used for converting saveframes and loops</span>
  <span class="n">importers</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">specificationFile</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
               <span class="n">testing</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saveFrameName</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="n">testing</span>

    <span class="c1"># Map for resolving crosslinks in NEF file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frameCode2Object</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Map for speeding up restraint reading</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dataSet2ItemMap</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_nmrResidueMap</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">defaultDataSetSerial</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">defaultNmrChain</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mainDataSetSerial</span> <span class="o">=</span> <span class="bp">None</span>


<div class="viewcode-block" id="CcpnNefReader.getNefData"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.getNefData">[docs]</a>  <span class="k">def</span> <span class="nf">getNefData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get NEF data structure from file&quot;&quot;&quot;</span>
    <span class="n">nmrDataExtent</span> <span class="o">=</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">parseNefFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">dataBlocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nmrDataExtent</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">dataBlock</span> <span class="o">=</span> <span class="n">dataBlocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Initialise afresh for every file read</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dataSet2ItemMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_nmrResidueMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">dataBlock</span></div>

  <span class="c1"># def loadNewProject(self, path:str):</span>
  <span class="c1">#   &quot;&quot;&quot;Load NEF file at path into project&quot;&quot;&quot;</span>
  <span class="c1">#</span>
  <span class="c1">#   dataBlock = self.getNefData(path)</span>
  <span class="c1">#   project = self.application.newProject(dataBlock.name)</span>
  <span class="c1">#   self.application._echoBlocking += 1</span>
  <span class="c1">#   self.application.project._undo.increaseBlocking()</span>
  <span class="c1">#   try:</span>
  <span class="c1">#     self.importNewProject(project, dataBlock)</span>
  <span class="c1">#   finally:</span>
  <span class="c1">#     self.application._echoBlocking -= 1</span>
  <span class="c1">#     self.application.project._undo.decreaseBlocking()</span>
  <span class="c1">#</span>
  <span class="c1">#   #</span>
  <span class="c1">#   return project</span>

  <span class="k">def</span> <span class="nf">_getSaveFramesInOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataBlock</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrDataBlock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OD</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get saveframes in fixed reading order as Ordereddict(category:[saveframe,])&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">OD</span><span class="p">(((</span><span class="n">x</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saveFrameReadingOrder</span><span class="p">))</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">otherFrames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">saveFrameName</span><span class="p">,</span> <span class="n">saveFrame</span> <span class="ow">in</span> <span class="n">dataBlock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">sf_category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sf_category&#39;</span><span class="p">)</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sf_category</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">ll</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">otherFrames</span>
      <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="CcpnNefReader.importNewProject"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.importNewProject">[docs]</a>  <span class="k">def</span> <span class="nf">importNewProject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">dataBlock</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrDataBlock</span><span class="p">,</span>
                       <span class="n">projectIsEmpty</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import entire project from dataBlock into empty Project&quot;&quot;&quot;</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


    <span class="c1"># TODO Add error handling</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">defaultChainCode</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">saveframeOrderedDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSaveFramesInOrder</span><span class="p">(</span><span class="n">dataBlock</span><span class="p">)</span>

    <span class="c1"># Load metadata and molecular system first</span>
    <span class="n">metaDataFrame</span> <span class="o">=</span> <span class="n">dataBlock</span><span class="p">[</span><span class="s1">&#39;nef_nmr_meta_data&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saveFrameName</span> <span class="o">=</span> <span class="s1">&#39;nef_nmr_meta_data&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_nef_nmr_meta_data</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">metaDataFrame</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">saveframeOrderedDict</span><span class="p">[</span><span class="s1">&#39;nef_nmr_meta_data&#39;</span><span class="p">]</span>

    <span class="n">saveFrame</span> <span class="o">=</span> <span class="n">dataBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nef_molecular_system&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">saveFrame</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">saveFrameName</span> <span class="o">=</span> <span class="s1">&#39;nef_molecular_system&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">load_nef_molecular_system</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">saveframeOrderedDict</span><span class="p">[</span><span class="s1">&#39;nef_molecular_system&#39;</span><span class="p">]</span>

    <span class="c1"># Load assignments, or preload from shiftlists</span>
    <span class="c1"># to make sure &#39;@&#39; and &#39;#&#39; identifiers match the right serials</span>
    <span class="n">saveFrame</span> <span class="o">=</span> <span class="n">dataBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_assignment&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">saveFrame</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">saveFrameName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_assignment&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">load_ccpn_assignments</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">)</span>
      <span class="k">del</span> <span class="n">saveframeOrderedDict</span><span class="p">[</span><span class="s1">&#39;ccpn_assignment&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">preloadAssignmentData</span><span class="p">(</span><span class="n">dataBlock</span><span class="p">)</span>

    <span class="c1"># t1 = time.time()</span>
    <span class="c1"># print (&#39;@~@~ NEF load starting frames&#39;, t1-t0)</span>

    <span class="k">for</span> <span class="n">sf_category</span><span class="p">,</span> <span class="n">saveFrames</span> <span class="ow">in</span> <span class="n">saveframeOrderedDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">saveFrame</span> <span class="ow">in</span> <span class="n">saveFrames</span><span class="p">:</span>
        <span class="n">saveFrameName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveFrameName</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">name</span>

        <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sf_category</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">importer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;WARNING, unknown saveframe category&quot;</span><span class="p">,</span> <span class="n">sf_category</span><span class="p">,</span> <span class="n">saveFrameName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># NB - newObject may be project, for some saveframes.</span>
          <span class="n">result</span> <span class="o">=</span> <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">AbstractWrapperObject</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frameCode2Object</span><span class="p">[</span><span class="n">saveFrameName</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
          <span class="c1"># elif not isinstance(result, list):</span>
          <span class="c1">#   self.warning(&quot;Unexpected return %s while reading %s&quot; %</span>
          <span class="c1">#                (result, saveFrameName))</span>

          <span class="c1"># Handle unmapped elements</span>
          <span class="n">extraTags</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">saveFrame</span>
                       <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">sf_category</span><span class="p">]</span>
                       <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sf_category&#39;</span><span class="p">,</span> <span class="s1">&#39;sf_framecode&#39;</span><span class="p">)]</span>
          <span class="k">if</span> <span class="n">extraTags</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING - unused tags in saveframe </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">saveFrameName</span><span class="p">,</span> <span class="n">extraTags</span><span class="p">))</span>
            <span class="c1"># TODO put here function that stashes data in object, or something</span>
            <span class="c1"># ues newObject here</span>
          <span class="c1"># t2 = time.time()</span>
          <span class="c1"># print(&#39;@~@~ loaded&#39;, saveFrameName, t2-t1)</span>
          <span class="c1"># t1 = t2</span>

    <span class="c1"># Put metadata in main dataset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">updateMetaData</span><span class="p">(</span><span class="n">metaDataFrame</span><span class="p">)</span>


    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loaded NEF file, time = &#39;</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
      <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;====&gt; &#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="bp">None</span></div>


<div class="viewcode-block" id="CcpnNefReader.load_nef_nmr_meta_data"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_nmr_meta_data">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_nmr_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load nef_nmr_meta_data saveFrame&quot;&quot;&quot;</span>

    <span class="c1"># Other data are read in here at the end of the load</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mainDataSetSerial</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_dataset_serial&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span></div>

    <span class="c1"># TODO - store data in this saveframe</span>
    <span class="c1"># for now we store none of this, as the storage slots are in DataSet, not Project</span>
    <span class="c1"># Maybe for another load function?</span>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_nmr_meta_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_nmr_meta_data</span>


<div class="viewcode-block" id="CcpnNefReader.load_nef_molecular_system"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_molecular_system">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_molecular_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load nef_molecular_system saveFrame&quot;&quot;&quot;</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="s1">&#39;nef_molecular_system&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ccpnTag</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">ccpnTag</span> <span class="o">==</span> <span class="n">_isALoop</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
          <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
          <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="bp">None</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_molecular_system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_molecular_system</span>


<div class="viewcode-block" id="CcpnNefReader.load_nef_sequence"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_sequence">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load nef_sequence loop&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">chainData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">chainCode</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;chain_code&#39;</span><span class="p">]</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="n">chainData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chainCode</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">ll</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">chainData</span><span class="p">[</span><span class="n">chainCode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="n">defaultChainCode</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">chainData</span><span class="p">:</span>
      <span class="n">defaultChainCode</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
      <span class="c1"># Replace chainCode None with default chainCode</span>
      <span class="c1"># Selecting the first value that is not already taken.</span>
      <span class="k">while</span> <span class="n">defaultChainCode</span> <span class="ow">in</span> <span class="n">chainData</span><span class="p">:</span>
        <span class="n">defaultChainCode</span> <span class="o">=</span> <span class="n">commonUtil</span><span class="o">.</span><span class="n">incrementName</span><span class="p">(</span><span class="n">defaultChainCode</span><span class="p">)</span>
      <span class="n">chainData</span><span class="p">[</span><span class="n">defaultChainCode</span><span class="p">]</span> <span class="o">=</span> <span class="n">chainData</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">defaultChainCode</span> <span class="o">=</span> <span class="n">defaultChainCode</span>


    <span class="n">sequence2Chain</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tags</span> <span class="o">=</span><span class="p">(</span><span class="s1">&#39;residue_name&#39;</span><span class="p">,</span> <span class="s1">&#39;linking&#39;</span><span class="p">,</span> <span class="s1">&#39;residue_variant&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chainCode</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chainData</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
      <span class="n">compoundName</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_compound_name&#39;</span><span class="p">)</span>
      <span class="n">role</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_chain_role&#39;</span><span class="p">)</span>
      <span class="n">comment</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_chain_comment&#39;</span><span class="p">)</span>
      <span class="n">sequence</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linking&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;dummy&#39;</span><span class="p">:</span>
          <span class="n">row</span><span class="p">[</span><span class="s1">&#39;residue_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dummy.&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;residue_name&#39;</span><span class="p">]</span>

      <span class="n">lastChain</span> <span class="o">=</span> <span class="n">sequence2Chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">lastChain</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">newSubstance</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">fetchNefSubstance</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">compoundName</span><span class="p">)</span>
        <span class="n">newChain</span> <span class="o">=</span> <span class="n">newSubstance</span><span class="o">.</span><span class="n">createChain</span><span class="p">(</span><span class="n">shortName</span><span class="o">=</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
                                            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">sequence2Chain</span><span class="p">[</span><span class="n">sequence</span><span class="p">]</span> <span class="o">=</span> <span class="n">newChain</span>

        <span class="c1"># Set variant codes:</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">residue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newChain</span><span class="o">.</span><span class="n">residues</span><span class="p">):</span>
          <span class="n">variantCode</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

          <span class="k">if</span> <span class="n">variantCode</span><span class="p">:</span>

            <span class="n">atomNamesRemoved</span><span class="p">,</span> <span class="n">atomNamesAdded</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">getAtomNameDifferences</span><span class="p">()</span>


            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">variantCode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
              <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Should not be necessary but costs nothing to catch those errors</span>
              <span class="n">atom</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">getAtom</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
              <span class="k">if</span> <span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                  <span class="n">residue</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Incorrect variantCode </span><span class="si">%s</span><span class="s2">: No atom named </span><span class="si">%s</span><span class="s2"> found in </span><span class="si">%s</span><span class="s2">. Skipping ...&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">variantCode</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">residue</span><span class="p">)</span>
                  <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="n">atom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

              <span class="k">elif</span> <span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                  <span class="n">residue</span><span class="o">.</span><span class="n">newAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="n">residue</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Incorrect variantCode </span><span class="si">%s</span><span class="s2">: Atom named </span><span class="si">%s</span><span class="s2"> already present in </span><span class="si">%s</span><span class="s2">. Skipping ...&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">variantCode</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">residue</span><span class="p">)</span>
                  <span class="p">)</span>

              <span class="k">else</span><span class="p">:</span>
                <span class="n">residue</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                  <span class="s2">&quot;Incorrect variantCode </span><span class="si">%s</span><span class="s2">: must start with &#39;+&#39; or &#39;-&#39;. Skipping ...&quot;</span>
                  <span class="o">%</span> <span class="n">variantCode</span>
                <span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">newChain</span> <span class="o">=</span> <span class="n">lastChain</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">shortName</span><span class="o">=</span><span class="n">chainCode</span><span class="p">)</span>
        <span class="n">newChain</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="n">newChain</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span>

      <span class="k">for</span> <span class="n">apiResidue</span> <span class="ow">in</span> <span class="n">newChain</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">sortedResidues</span><span class="p">():</span>
        <span class="c1"># Necessary to guarantee against name clashes</span>
        <span class="c1"># Direct access to avoid unnecessary notifiers</span>
        <span class="n">apiResidue</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s1">&#39;seqInsertCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;__@~@~__&#39;</span>
      <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">apiResidue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newChain</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">sortedResidues</span><span class="p">()):</span>
        <span class="c1"># NB we have to loop over API residues to be sure we get the residues</span>
        <span class="c1"># in creation order rather than sorted order</span>
        <span class="n">residue</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">_data2Obj</span><span class="p">[</span><span class="n">apiResidue</span><span class="p">]</span>
        <span class="n">residue</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sequence_code&#39;</span><span class="p">))</span>
        <span class="n">residue</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>

      <span class="c1"># Necessary as notification is blanked here:</span>
      <span class="n">newChain</span><span class="o">.</span><span class="n">_resetIds</span><span class="p">()</span>

      <span class="c1">#</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newChain</span><span class="p">)</span>

      <span class="c1"># Add Residue comments</span>
      <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">apiResidue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newChain</span><span class="o">.</span><span class="n">residues</span><span class="p">):</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
          <span class="n">apiResidue</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">comment</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_sequence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_sequence</span>


<div class="viewcode-block" id="CcpnNefReader.load_nef_covalent_links"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_covalent_links">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_covalent_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load nef_sequence loop&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">id1</span> <span class="o">=</span> <span class="n">Pid</span><span class="o">.</span><span class="n">createId</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;chain_code_1&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence_code_1&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;residue_name_1&#39;</span><span class="p">,</span> <span class="s1">&#39;atom_name_1&#39;</span><span class="p">,</span> <span class="p">)))</span>
      <span class="n">id2</span> <span class="o">=</span> <span class="n">Pid</span><span class="o">.</span><span class="n">createId</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;chain_code_2&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence_code_2&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;residue_name_2&#39;</span><span class="p">,</span> <span class="s1">&#39;atom_name_2&#39;</span><span class="p">,</span> <span class="p">)))</span>
      <span class="n">atom1</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">getAtom</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span>
      <span class="n">atom2</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">getAtom</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown atom </span><span class="si">%s</span><span class="s2"> for bond to </span><span class="si">%s</span><span class="s2">. Skipping...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">))</span>
      <span class="k">elif</span> <span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown atom </span><span class="si">%s</span><span class="s2"> for bond to </span><span class="si">%s</span><span class="s2">. Skipping...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">id1</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
        <span class="n">atom1</span><span class="o">.</span><span class="n">addInterAtomBond</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_covalent_links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_covalent_links</span>



<div class="viewcode-block" id="CcpnNefReader.preloadAssignmentData"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.preloadAssignmentData">[docs]</a>  <span class="k">def</span> <span class="nf">preloadAssignmentData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataBlock</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrDataBlock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set up NmrChains and NmrResidues with reserved names to ensure the serials are OK</span>
<span class="sd">    and create NmrResidues in connencted nmrChains in order</span>

<span class="sd">    NB later we can store serials in CCPN projects, but something is needed that works anyway</span>

<span class="sd">    NB, without CCPN-specific tags you can NOT guarantee that connected stretches are stable,</span>
<span class="sd">    and that serials are put back where they came from.</span>
<span class="sd">    This heuristic creates NmrResidues in connected stretches in the order they are found,</span>
<span class="sd">    but this will break if connected tretches appear in multiple shiftlists and some are partial.&quot;&quot;&quot;</span>


    <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>

    <span class="k">for</span> <span class="n">saveFrameName</span><span class="p">,</span> <span class="n">saveFrame</span> <span class="ow">in</span> <span class="n">dataBlock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

      <span class="c1"># get all NmrResidue data in chemicalshift lists</span>
      <span class="n">assignmentData</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">assignmentData2</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="n">saveFrameName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;nef_chemical_shift_list&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;nef_chemical_shift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
          <span class="n">chainCode</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;chain_code&#39;</span><span class="p">]</span>
          <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">assignmentData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">OD</span><span class="p">())</span>
          <span class="n">assignmentData</span><span class="p">[</span><span class="n">chainCode</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmrResidues</span>
          <span class="n">nmrResidues</span><span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sequence_code&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;residue_name&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="c1"># Create objects with reserved names</span>

      <span class="k">for</span> <span class="n">chainCode</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">assignmentData</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chainCode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;@#&#39;</span> <span class="ow">and</span> <span class="n">chainCode</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
          <span class="c1"># reserved name - make chain</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">project</span><span class="o">.</span><span class="n">fetchNmrChain</span><span class="p">(</span><span class="n">chainCode</span><span class="p">)</span>
          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Could not be done, probably because we have NmrChain &#39;@1&#39;. Leave for later</span>
            <span class="k">pass</span>

      <span class="k">for</span> <span class="n">chainCode</span><span class="p">,</span> <span class="n">nmrResidues</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">assignmentData</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="c1"># Create NmrChain</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">fetchNmrChain</span><span class="p">(</span><span class="n">chainCode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">fetchNmrChain</span><span class="p">(</span><span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">chainCode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">isConnected</span><span class="p">:</span>
          <span class="c1"># Save data for later processing</span>
          <span class="n">assignmentData2</span><span class="p">[</span><span class="n">nmrChain</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmrResidues</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># Create non-assigned NmrResidues to reserve the serials. The rest can wait</span>
          <span class="k">for</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nmrResidues</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">sequenceCode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span> <span class="ow">and</span> <span class="n">sequenceCode</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
              <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">sequenceCode</span><span class="o">=</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="o">=</span><span class="n">residueType</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">nmrChain</span><span class="p">,</span> <span class="n">nmrResidues</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">assignmentData2</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># Create NmrResidues in order, to preserve connection order</span>
        <span class="k">for</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nmrResidues</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="c1"># This time we want all non-offset, regardless of type - as we must get them in order</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">sequenceCode</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;+-&#39;</span>
              <span class="ow">or</span> <span class="ow">not</span> <span class="n">sequenceCode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()):</span>
            <span class="c1"># I.e. for sequenceCodes that do not include an offset</span>
            <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">sequenceCode</span><span class="o">=</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="o">=</span><span class="n">residueType</span><span class="p">)</span></div>


<div class="viewcode-block" id="CcpnNefReader.load_nef_chemical_shift_list"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_chemical_shift_list">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_chemical_shift_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load nef_chemical_shift_list saveFrame&quot;&quot;&quot;</span>

    <span class="c1"># Get ccpn-to-nef mappping for saveframe</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">]</span>
    <span class="n">framecode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>

    <span class="n">parameters</span><span class="p">,</span> <span class="n">loopNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">framecode</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># Make main object</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newChemicalShiftList</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
      <span class="c1"># When testing you want the values to remain as read</span>
      <span class="n">result</span><span class="o">.</span><span class="n">autoUpdate</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="c1"># NB The above is how it ought to work.</span>
      <span class="c1"># The below is how it is working as of July 2016</span>
      <span class="n">result</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">topObject</span><span class="o">.</span><span class="n">shiftAveraging</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># Load loops, with object as parent</span>
    <span class="k">for</span> <span class="n">loopName</span> <span class="ow">in</span> <span class="n">loopNames</span><span class="p">:</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
        <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>

  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_chemical_shift_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_chemical_shift_list</span>

<div class="viewcode-block" id="CcpnNefReader.load_nef_chemical_shift"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_chemical_shift">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_chemical_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span><span class="n">ChemicalShiftList</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load nef_chemical_shift loop&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">creatorFunc</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">newChemicalShift</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;chain_code&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence_code&#39;</span><span class="p">,</span> <span class="s1">&#39;residue_name&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;atom_name&#39;</span><span class="p">))</span>
      <span class="n">element</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;element&#39;</span><span class="p">)</span>
      <span class="n">isotope</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isotope_number&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">element</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isotope</span><span class="p">:</span>
          <span class="n">isotopeCode</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">isotope</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">isotopeCode</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">DEFAULT_ISOTOPE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
      <span class="k">elif</span> <span class="n">isotope</span><span class="p">:</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">commonUtil</span><span class="o">.</span><span class="n">name2ElementSymbol</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">isotopeCode</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">isotope</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">isotopeCode</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">nmrResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produceNmrResidue</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">nmrAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produceNmrAtom</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">tt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">isotopeCode</span><span class="o">=</span><span class="n">isotopeCode</span><span class="p">)</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;nmrAtom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmrAtom</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">creatorFunc</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">))</span>

      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot produce NmrAtom for assignment </span><span class="si">%s</span><span class="s2">. Skipping ChemicalShift&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span>
        <span class="c1"># Should eventually be removed - raise while still testing</span>
        <span class="k">raise</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_chemical_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_chemical_shift</span>

<div class="viewcode-block" id="CcpnNefReader.load_nef_restraint_list"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_restraint_list">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_restraint_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Serves to load nef_distance_restraint_list, nef_dihedral_restraint_list,</span>
<span class="sd">     nef_rdc_restraint_list and ccpn_restraint_list&quot;&quot;&quot;</span>

    <span class="c1"># Get ccpn-to-nef mapping for saveframe</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">]</span>
    <span class="n">framecode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>

    <span class="n">parameters</span><span class="p">,</span> <span class="n">loopNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;nef_distance_restraint_list&#39;</span><span class="p">:</span>
      <span class="n">restraintType</span> <span class="o">=</span> <span class="s1">&#39;Distance&#39;</span>
    <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;nef_dihedral_restraint_list&#39;</span><span class="p">:</span>
      <span class="n">restraintType</span> <span class="o">=</span> <span class="s1">&#39;Dihedral&#39;</span>
    <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;nef_rdc_restraint_list&#39;</span><span class="p">:</span>
      <span class="n">restraintType</span> <span class="o">=</span> <span class="s1">&#39;Rdc&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">restraintType</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_type&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">restraintType</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing restraint_type for saveFrame </span><span class="si">%s</span><span class="s2"> - value was </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">framecode</span><span class="p">,</span> <span class="n">restraintType</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;restraintType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restraintType</span>
    <span class="n">namePrefix</span> <span class="o">=</span> <span class="n">restraintType</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span>

    <span class="c1"># Get name from frameCode, add type disambiguation, and correct for ccpn dataSetSerial addition</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">framecode</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">dataSetSerial</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_dataset_serial&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataSetSerial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">dataSetSerial</span>
      <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">):]</span>

    <span class="c1"># Make main object</span>
    <span class="n">dataSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchDataSet</span><span class="p">(</span><span class="n">dataSetSerial</span><span class="p">)</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">getRestraintList</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># NEF but NOT CCPN has separate namespaces for different restraint types</span>
      <span class="c1"># so we may get name clashes</span>
      <span class="c1"># We should preserve NEF names, but it cannot be helped.</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">namePrefix</span><span class="p">):</span>
        <span class="c1"># Add prefix for disambiguation since NEF but NOT CCPN has separate namespaces</span>
        <span class="c1"># for different constraint types</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">namePrefix</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">while</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">getRestraintList</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="c1"># This way we get a unique name even in the most bizarre cases</span>
          <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">name</span>

    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">newRestraintList</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

    <span class="c1"># Load loops, with object as parent</span>
    <span class="k">for</span> <span class="n">loopName</span> <span class="ow">in</span> <span class="n">loopNames</span><span class="p">:</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">loopName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_restraint&#39;</span><span class="p">):</span>
          <span class="c1"># NBNB HACK: the restrain loop reader needs an itemLength.</span>
          <span class="c1"># There are no other loops currently, but if there ever is they will not need this</span>
          <span class="n">itemLength</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_item_length&#39;</span><span class="p">)</span>
          <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">itemLength</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_distance_restraint_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint_list</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_dihedral_restraint_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint_list</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_rdc_restraint_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint_list</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_restraint_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint_list</span>

<div class="viewcode-block" id="CcpnNefReader.load_nef_restraint"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_restraint">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_restraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restraintList</span><span class="p">:</span><span class="n">RestraintList</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">,</span>
                         <span class="n">itemLength</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Serves to load nef_distance_restraint, nef_dihedral_restraint,</span>
<span class="sd">     nef_rdc_restraint and ccpn_restraint loops&quot;&quot;&quot;</span>

    <span class="c1"># NB Restraint.name - written out for dihedral restraints - is not read.</span>
    <span class="c1"># Which is probably OK, it is derived from the atoms.</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">string2ItemMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataSet2ItemMap</span><span class="p">[</span><span class="n">restraintList</span><span class="o">.</span><span class="n">dataSet</span><span class="p">]</span>

    <span class="c1"># set itemLength if not passed in:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">itemLength</span><span class="p">:</span>
      <span class="n">itemLength</span> <span class="o">=</span> <span class="n">coreConstants</span><span class="o">.</span><span class="n">constraintListType2ItemLength</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">restraintList</span><span class="o">.</span><span class="n">restraintType</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">contributionTags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">map2</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">restraints</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># assignTags = (&#39;chain_code&#39;, &#39;sequence_code&#39;, &#39;residue_name&#39;, &#39;atom_name&#39;)</span>

    <span class="nb">max</span> <span class="o">=</span> <span class="n">itemLength</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">multipleAttributes</span> <span class="o">=</span> <span class="n">OD</span><span class="p">((</span>
      <span class="p">(</span><span class="s1">&#39;chainCodes&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;chain_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
      <span class="p">(</span><span class="s1">&#39;sequenceCodes&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;sequence_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
      <span class="p">(</span><span class="s1">&#39;residueTypes&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;residue_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
      <span class="p">(</span><span class="s1">&#39;atomNames&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;atom_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">))),</span>
    <span class="p">))</span>

    <span class="n">parametersFromLoopRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span>
    <span class="n">defaultChainCode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultChainCode</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>

      <span class="c1"># get or make restraint</span>
      <span class="n">serial</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">)</span>
      <span class="n">restraint</span> <span class="o">=</span> <span class="n">restraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">restraint</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">valuesToContribution</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;serial&#39;</span><span class="p">:</span><span class="n">serial</span><span class="p">}</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_vector_length&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;vectorLength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_figure_of_Merit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;figureOfMerit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_comment&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">restraint</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">newRestraint</span><span class="p">(</span><span class="o">**</span><span class="n">dd</span><span class="p">)</span>
        <span class="n">restraints</span><span class="p">[</span><span class="n">serial</span><span class="p">]</span> <span class="o">=</span> <span class="n">restraint</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">restraint</span><span class="p">)</span>

      <span class="c1"># Get or make restraintContribution</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="n">parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">combinationId</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;combinationId&#39;</span><span class="p">)</span>
      <span class="n">nonAssignmentValues</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">contributionTags</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">combinationId</span><span class="p">:</span>
        <span class="c1"># Items in a combination are ANDed, so each line has one contribution</span>
        <span class="n">contribution</span> <span class="o">=</span> <span class="n">restraint</span><span class="o">.</span><span class="n">newRestraintContribution</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">contribution</span> <span class="o">=</span> <span class="n">valuesToContribution</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nonAssignmentValues</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contribution</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">contribution</span> <span class="o">=</span> <span class="n">restraint</span><span class="o">.</span><span class="n">newRestraintContribution</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
          <span class="n">valuesToContribution</span><span class="p">[</span><span class="n">nonAssignmentValues</span><span class="p">]</span> <span class="o">=</span> <span class="n">contribution</span>

      <span class="c1"># Add item</span>
      <span class="c1"># ll = [row._get(tag)[:itemLength] for tag in assignTags]</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
      <span class="c1"># Reset missing chain codes to default</span>
      <span class="c1"># ll[0] = [x or defaultChainCode for x in ll[0]]</span>

      <span class="n">idStrings</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ll</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">defaultChainCode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="c1"># ChainCode missing - replace with default chain code</span>
          <span class="n">item</span> <span class="o">=</span> <span class="p">(</span><span class="n">defaultChainCode</span><span class="p">,)</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">idStrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">IDSEP</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span><span class="p">))</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">contribution</span><span class="o">.</span><span class="n">addRestraintItem</span><span class="p">(</span><span class="n">idStrings</span><span class="p">,</span> <span class="n">string2ItemMap</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot Add restraintItem </span><span class="si">%s</span><span class="s2">. Identical to previous. Skipping&quot;</span> <span class="o">%</span> <span class="n">idStrings</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_distance_restraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_dihedral_restraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_rdc_restraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_restraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_restraint</span>

<div class="viewcode-block" id="CcpnNefReader.load_nef_nmr_spectrum"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_nmr_spectrum">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_nmr_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="n">dimensionTransferTags</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;dimension_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dimension_2&#39;</span><span class="p">,</span> <span class="s1">&#39;transfer_type&#39;</span><span class="p">,</span> <span class="s1">&#39;is_indirect&#39;</span><span class="p">)</span>

    <span class="c1"># Get ccpn-to-nef mappping for saveframe</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">]</span>
    <span class="n">framecode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>

    <span class="c1"># Get peakList parameters and make peakList</span>
    <span class="n">peakListParameters</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

    <span class="c1"># Get spectrum parameters</span>
    <span class="n">spectrumParameters</span><span class="p">,</span> <span class="n">loopNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
                                                                  <span class="n">ccpnPrefix</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>

    <span class="c1"># Get name from spectrum parameters, or from the frameCode</span>
    <span class="n">spectrumName</span> <span class="o">=</span> <span class="n">framecode</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">peakListSerial</span> <span class="o">=</span> <span class="n">peakListParameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">peakListSerial</span><span class="p">:</span>
      <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">peakListSerial</span>
      <span class="c1"># Remove peakList serial suffix (which was added for disambiguation)</span>
      <span class="c1"># So that multiple peakLists all go to one Spectrum</span>
      <span class="k">if</span> <span class="n">spectrumName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
        <span class="n">spectrumName</span> <span class="o">=</span> <span class="n">spectrumName</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)]</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">getSpectrum</span><span class="p">(</span><span class="n">spectrumName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># Spectrum does not already exist - create it.</span>
      <span class="c1"># NB For CCPN-exported projects spectra with multiple peakLists are handled this way</span>

      <span class="n">frameCode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chemical_shift_list&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">frameCode</span><span class="p">:</span>
        <span class="n">spectrumParameters</span><span class="p">[</span><span class="s1">&#39;chemicalShiftList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameCode2Object</span><span class="p">[</span><span class="n">frameCode</span><span class="p">]</span>

      <span class="n">frameCode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_sample&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">frameCode</span><span class="p">:</span>
        <span class="n">spectrumParameters</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameCode2Object</span><span class="p">[</span><span class="n">frameCode</span><span class="p">]</span>

      <span class="c1"># get per-dimension data - NB these are mandatory and cannot be worked around</span>
      <span class="n">dimensionData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_nef_spectrum_dimension</span><span class="p">(</span><span class="n">project</span><span class="p">,</span>
                                                       <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;nef_spectrum_dimension&#39;</span><span class="p">])</span>
      <span class="c1"># read  dimension transfer data</span>
      <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;nef_spectrum_dimension_transfer&#39;</span>
      <span class="c1"># Those are treated elsewhere</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span>
        <span class="n">transferData</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">SpectrumLib</span><span class="o">.</span><span class="n">MagnetisationTransferTuple</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">dimensionTransferTags</span><span class="p">))</span>
          <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span>
        <span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">transferData</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="n">spectrum</span> <span class="o">=</span> <span class="n">createSpectrum</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">spectrumName</span><span class="p">,</span> <span class="n">spectrumParameters</span><span class="p">,</span> <span class="n">dimensionData</span><span class="p">,</span>
                                <span class="n">transferData</span><span class="o">=</span><span class="n">transferData</span><span class="p">)</span>


      <span class="c1"># Make data storage object</span>
      <span class="n">filePath</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ccpn_spectrum_file_path&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">filePath</span><span class="p">:</span>
        <span class="n">storageParameters</span><span class="p">,</span> <span class="n">loopNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
          <span class="n">ccpnPrefix</span><span class="o">=</span><span class="s1">&#39;spectrum._wrappedData.dataStore&#39;</span>
        <span class="p">)</span>
        <span class="n">storageParameters</span><span class="p">[</span><span class="s1">&#39;numPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">pointCounts</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">addDataStore</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="o">**</span><span class="n">storageParameters</span><span class="p">)</span>

    <span class="c1"># Load CCPN dimensions before peaks</span>
    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_spectrum_dimension&#39;</span>
    <span class="c1"># Those are treated elsewhere</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">load_ccpn_spectrum_dimension</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>

    <span class="c1"># Make PeakLst</span>
    <span class="n">peakList</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">newPeakList</span><span class="p">(</span><span class="o">**</span><span class="n">peakListParameters</span><span class="p">)</span>

    <span class="c1"># Load peaks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_nef_peak</span><span class="p">(</span><span class="n">peakList</span><span class="p">,</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nef_peak&#39;</span><span class="p">))</span>

    <span class="c1"># Load remaining loops, with spectrum as parent</span>
    <span class="k">for</span> <span class="n">loopName</span> <span class="ow">in</span> <span class="n">loopNames</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">loopName</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="p">(</span><span class="s1">&#39;nef_spectrum_dimension&#39;</span><span class="p">,</span> <span class="s1">&#39;ccpn_spectrum_dimension&#39;</span><span class="p">,</span> <span class="s1">&#39;nef_peak&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;nef_spectrum_dimension_transfer&#39;</span><span class="p">):</span>
        <span class="c1"># Those are treated elsewhere</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
          <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
          <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">peakList</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_nmr_spectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_nmr_spectrum</span>


<div class="viewcode-block" id="CcpnNefReader.read_nef_spectrum_dimension_transfer"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.read_nef_spectrum_dimension_transfer">[docs]</a>  <span class="k">def</span> <span class="nf">read_nef_spectrum_dimension_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>

    <span class="n">transferTypes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;onebond&#39;</span><span class="p">,</span> <span class="s1">&#39;Jcoupling&#39;</span><span class="p">,</span> <span class="s1">&#39;Jmultibond&#39;</span><span class="p">,</span> <span class="s1">&#39;relayed&#39;</span><span class="p">,</span> <span class="s1">&#39;through-space&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;relayed-alternate&#39;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dimension_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dimension_2&#39;</span><span class="p">,</span> <span class="s1">&#39;transfer_type&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;is_indirect&#39;</span><span class="p">)]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SpectrumLib</span><span class="o">.</span><span class="n">MagnetisationTransferTuple</span><span class="p">(</span><span class="o">*</span><span class="n">ll</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CcpnNefReader.load_nef_spectrum_dimension_transfer"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_spectrum_dimension_transfer">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_spectrum_dimension_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span><span class="n">Spectrum</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>

    <span class="n">transferTypes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;onebond&#39;</span><span class="p">,</span> <span class="s1">&#39;Jcoupling&#39;</span><span class="p">,</span> <span class="s1">&#39;Jmultibond&#39;</span><span class="p">,</span> <span class="s1">&#39;relayed&#39;</span><span class="p">,</span> <span class="s1">&#39;through-space&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;relayed-alternate&#39;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
      <span class="n">apiExperiment</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">experiment</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span>
      <span class="c1"># Remove invalid data rows</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dimension_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dimension_2&#39;</span><span class="p">,</span> <span class="s1">&#39;transfer_type&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;is_indirect&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">apiExperiment</span><span class="o">.</span><span class="n">findFirstExpDim</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dimension_1&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span>
            <span class="n">apiExperiment</span><span class="o">.</span><span class="n">findFirstExpDim</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dimension_2&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;transfer_type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transferTypes</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Illegal values in nef_spectrum_dimension_transfer: </span><span class="si">%s</span><span class="s2">&quot;</span>
                       <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SpectrumLib</span><span class="o">.</span><span class="n">MagnetisationTransferTuple</span><span class="p">(</span><span class="o">*</span><span class="n">ll</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefReader.process_nef_spectrum_dimension_transfer"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.process_nef_spectrum_dimension_transfer">[docs]</a>  <span class="k">def</span> <span class="nf">process_nef_spectrum_dimension_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span><span class="n">Spectrum</span><span class="p">,</span>
                                              <span class="n">dataLists</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]):</span>
      <span class="c1"># Store expTransfers in API as we can not be sure we will get a refExperiment</span>

      <span class="n">apiExperiment</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">experiment</span>

      <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">dataLists</span><span class="p">:</span>
        <span class="n">expDimRefs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
          <span class="n">expDim</span> <span class="o">=</span> <span class="n">apiExperiment</span><span class="o">.</span><span class="n">findFirstExpDim</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
          <span class="c1"># After spectrum creation there will be one :</span>
          <span class="n">expDimRefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expDim</span><span class="o">.</span><span class="n">sortedExpDimRefs</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">apiExperiment</span><span class="o">.</span><span class="n">findFirstExpTransfer</span><span class="p">(</span><span class="n">expDimRefs</span><span class="o">=</span><span class="n">expDimRefs</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">apiExperiment</span><span class="o">.</span><span class="n">newExpTransfer</span><span class="p">(</span><span class="n">expDimRefs</span><span class="o">=</span><span class="n">expDimRefs</span><span class="p">,</span> <span class="n">transferType</span><span class="o">=</span><span class="n">ll</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                       <span class="n">isDirect</span><span class="o">=</span><span class="ow">not</span> <span class="n">ll</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Duplicate nef_spectrum_dimension_transfer: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ll</span><span class="p">,))</span></div>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_spectrum_dimension"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_spectrum_dimension">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_spectrum_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span><span class="n">Spectrum</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read ccpn_spectrum_dimension loop, set the relevant values,</span>
<span class="sd">    and return the spectrum and other parameters for further processing&quot;&quot;&quot;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">extras</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nefTag2ccpnTag</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="s1">&#39;ccpn_spectrum_dimension&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ccpn_spectrum_dimension is empty&quot;</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">))</span>

    <span class="c1"># Get spectrum attributes</span>
    <span class="k">for</span> <span class="n">nefTag</span><span class="p">,</span> <span class="n">ccpnTag</span> <span class="ow">in</span> <span class="n">nefTag2ccpnTag</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">nefTag</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nefTag</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">ccpnTag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">ccpnTag</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">ccpnTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">extras</span><span class="p">[</span><span class="n">nefTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>

    <span class="c1"># Set main values</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;referencePoints&#39;</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">referencePoints</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;referencePoints&#39;</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">referencePoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">spectrumReferences</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrumReferences</span>
      <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">spectrumReference</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spectrumReferences</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spectrumReference</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
          <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">point</span> <span class="o">=</span> <span class="n">referencePoints</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
          <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
          <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrumReference</span><span class="o">.</span><span class="n">point2Value</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">referencePoints</span> <span class="o">=</span> <span class="n">points</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">referenceValues</span> <span class="o">=</span> <span class="n">values</span>




    <span class="c1"># set storage attributes</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_is_complex&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
      <span class="n">spectrum</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">dataStore</span><span class="o">.</span><span class="n">isComplex</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimension_block_size&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
      <span class="n">spectrum</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">dataStore</span><span class="o">.</span><span class="n">blockSizes</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># set aliasingLimits</span>
    <span class="n">defaultLimits</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
    <span class="n">lowerLimits</span> <span class="o">=</span> <span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lower_aliasing_limit&#39;</span><span class="p">,</span> <span class="n">defaultLimits</span><span class="p">)</span>
    <span class="n">higherLimits</span> <span class="o">=</span> <span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;higher_aliasing_limit&#39;</span><span class="p">,</span> <span class="n">defaultLimits</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">aliasingLimits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lowerLimits</span><span class="p">,</span> <span class="n">higherLimits</span><span class="p">))</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_spectrum_dimension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_spectrum_dimension</span>

  <span class="c1"># def adjustAxisCodes(self, spectrum, dimensionData):</span>
  <span class="c1">#</span>
  <span class="c1">#   pass</span>
  <span class="c1">#   #print (&#39;@~@~ CCPN data. Still TODO&#39;)</span>
  <span class="c1">#</span>
  <span class="c1">#   # Use data to rename axisCodes</span>
  <span class="c1">#   axisCodes = spectrum.axisCodes</span>
  <span class="c1">#   newCodes = list(axisCodes)</span>
  <span class="c1">#   atomTypes = [commonUtil.splitIntFromChars(x)[1] for x in spectrum.isotopeCodes]</span>
  <span class="c1">#   acquisitionAxisCode = spectrum.acquisitionAxisCode</span>
  <span class="c1">#   if acquisitionAxisCode is not None:</span>
  <span class="c1">#     acquisitionDim = axisCodes.index(acquisitionAxisCode) + 1</span>
  <span class="c1">#     if acquisitionAxisCode == atomTypes[acquisitionDim - 1]:</span>
  <span class="c1">#       # this axisCode needs improvement</span>
  <span class="c1">#       for pair in oneBondPairs:</span>
  <span class="c1">#         # First do acquisition dimension</span>
  <span class="c1">#         if acquisitionDim in pair:</span>
  <span class="c1">#           ll = pair.copy()</span>
  <span class="c1">#           ll.remove(acquisitionDim)</span>
  <span class="c1">#           otherDim = ll[0]</span>
  <span class="c1">#           otherCode = axisCodes[otherDim - 1]</span>
  <span class="c1">#           if otherCode == atomTypes[otherDim - 1]:</span>


<div class="viewcode-block" id="CcpnNefReader.read_nef_spectrum_dimension"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.read_nef_spectrum_dimension">[docs]</a>  <span class="k">def</span> <span class="nf">read_nef_spectrum_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read nef_spectrum_dimension loop and convert data to a dictionary</span>
<span class="sd">    of ccpnTag:[per-dimension-value]&quot;&quot;&quot;</span>

    <span class="c1"># NB we are not using absolute_peak_positions - if false what could we do?</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nefTag2ccpnTag</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="s1">&#39;nef_spectrum_dimension&#39;</span><span class="p">]</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">))</span>
    <span class="c1"># rows = [(row[&#39;dimension_id&#39;], row) for row in loop.data]</span>
    <span class="c1"># rows = [tt[1] for tt in sorted(rows)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nef_spectrum_dimension is missing or empty&quot;</span><span class="p">)</span>

    <span class="c1"># Get spectrum attributes</span>
    <span class="k">for</span> <span class="n">nefTag</span><span class="p">,</span> <span class="n">ccpnTag</span> <span class="ow">in</span> <span class="n">nefTag2ccpnTag</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">nefTag</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ccpnTag</span><span class="p">:</span>
          <span class="n">result</span><span class="p">[</span><span class="n">ccpnTag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nefTag</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># Unmapped attributes are passed with the original tag for later processing</span>
          <span class="n">result</span><span class="p">[</span><span class="n">nefTag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nefTag</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_integral_list"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_integral_list">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_integral_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span><span class="n">Spectrum</span><span class="p">,</span>
                              <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IntegralList</span><span class="p">]:</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">creatorFunc</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">newIntegralList</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">integralList</span> <span class="o">=</span> <span class="n">creatorFunc</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
      <span class="n">modelUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="n">integralList</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">],</span> <span class="s1">&#39;integralLists&#39;</span><span class="p">)</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integralList</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_integral"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_integral">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_integral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span><span class="n">Spectrum</span><span class="p">,</span>
                              <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Integral</span><span class="p">]:</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get name map for per-dimension attributes</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">multipleAttributes</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;slopes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;slopes_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;lowerLimits&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;lower_limits_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;upperLimits&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;upper_limits_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
    <span class="p">}</span>

    <span class="n">serial2creatorFunc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">newIntegral</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">integralLists</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">creatorFunc</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">newIntegralList</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">integral</span> <span class="o">=</span> <span class="n">serial2creatorFunc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;integral_list_serial&#39;</span><span class="p">]](</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
      <span class="n">integral</span><span class="o">.</span><span class="n">slopes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;slopes&#39;</span><span class="p">])</span>
      <span class="n">lowerLimits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;lowerLimits&#39;</span><span class="p">])</span>
      <span class="n">upperLimits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;upperLimits&#39;</span><span class="p">])</span>
      <span class="c1"># integral.slopes = row._get(&#39;slopes&#39;)</span>
      <span class="c1"># lowerLimits = row._get(&#39;lower_limits&#39;)</span>
      <span class="c1"># upperLimits = row._get(&#39;upper_limits&#39;)</span>
      <span class="n">integral</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">((</span><span class="n">lowerLimits</span><span class="p">,</span> <span class="n">upperLimits</span><span class="p">))</span>
      <span class="n">modelUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="n">integral</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;integral_serial&#39;</span><span class="p">],</span> <span class="s1">&#39;integrals&#39;</span><span class="p">)</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integral</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefReader.load_nef_peak"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_peak">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakList</span><span class="p">:</span><span class="n">PeakList</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Peak</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Serves to load nef_peak loop&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">dimensionCount</span> <span class="o">=</span> <span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Get name map for per-dimension attributes</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="n">dimensionCount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">multipleAttributes</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;position&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;position_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;positionError&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;position_uncertainty_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;chainCodes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;chain_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;sequenceCodes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;sequence_code_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;residueTypes&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;residue_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
      <span class="s1">&#39;atomNames&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;atom_name_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)),</span>
    <span class="p">}</span>

    <span class="n">peaks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">assignedNmrAtoms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>

      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>

      <span class="c1"># get or make peak</span>
      <span class="n">serial</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span>
      <span class="n">peak</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
      <span class="c1"># TODO check if peak parameters are the same for all rows, and do something about it</span>
      <span class="c1"># For now we simply use the first row that appears</span>
      <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># start of a new peak</span>

        <span class="c1"># finalise last peak</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">assignedNmrAtoms</span><span class="p">:</span>
          <span class="c1"># There is a peak in result, and the peak has assignments to set</span>
          <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assignedNmrAtoms</span> <span class="o">=</span> <span class="n">assignedNmrAtoms</span>
          <span class="n">assignedNmrAtoms</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># make new peak  multipleAttributes</span>
        <span class="c1"># parameters[&#39;position&#39;] = row._get(&#39;position&#39;)[:dimensionCount]</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">])</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;positionError&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;positionError&#39;</span><span class="p">])</span>
        <span class="c1"># parameters[&#39;positionError&#39;] = row._get(&#39;position_uncertainty&#39;)[:dimensionCount]</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">peakList</span><span class="o">.</span><span class="n">newPeak</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">peaks</span><span class="p">[</span><span class="n">serial</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>

      <span class="c1"># Add assignment</span>
      <span class="n">chainCodes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;chainCodes&#39;</span><span class="p">])</span>
      <span class="n">sequenceCodes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;sequenceCodes&#39;</span><span class="p">])</span>
      <span class="n">residueTypes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;residueTypes&#39;</span><span class="p">])</span>
      <span class="n">atomNames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">multipleAttributes</span><span class="p">[</span><span class="s1">&#39;atomNames&#39;</span><span class="p">])</span>
      <span class="c1"># chainCodes = row._get(&#39;chain_code&#39;)[:dimensionCount]</span>
      <span class="c1"># sequenceCodes = row._get(&#39;sequence_code&#39;)[:dimensionCount]</span>
      <span class="c1"># residueTypes = row._get(&#39;residue_name&#39;)[:dimensionCount]</span>
      <span class="c1"># atomNames = row._get(&#39;atom_name&#39;)[:dimensionCount]</span>
      <span class="n">assignments</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chainCodes</span><span class="p">,</span> <span class="n">sequenceCodes</span><span class="p">,</span> <span class="n">residueTypes</span><span class="p">,</span> <span class="n">atomNames</span><span class="p">)</span>
      <span class="n">nmrAtoms</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">foundAssignment</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">):</span>
          <span class="c1"># No assignment</span>
          <span class="n">nmrAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tt</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
          <span class="c1"># Enough for an assignment - make it</span>
          <span class="n">foundAssignment</span> <span class="o">=</span> <span class="bp">True</span>
          <span class="n">nmrResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produceNmrResidue</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
          <span class="n">nmrAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produceNmrAtom</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">tt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
          <span class="n">nmrAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># partial and unusable assignment</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Uninterpretable Peak assignment for peak </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">. Set to None&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span> <span class="n">tt</span><span class="p">))</span>
          <span class="n">nmrAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">foundAssignment</span><span class="p">:</span>
        <span class="n">assignedNmrAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nmrAtoms</span><span class="p">)</span>

    <span class="c1"># finalise last peak</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">assignedNmrAtoms</span><span class="p">:</span>
      <span class="c1"># There is a peak in result, and the peak has assignments to set</span>
      <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assignedNmrAtoms</span> <span class="o">=</span> <span class="n">assignedNmrAtoms</span>
      <span class="n">assignedNmrAtoms</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_peak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_peak</span>


<div class="viewcode-block" id="CcpnNefReader.load_nef_peak_restraint_links"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_peak_restraint_links">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_peak_restraint_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load nef_peak_restraint_links saveFrame&quot;&quot;&quot;</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="s1">&#39;nef_peak_restraint_links&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ccpnTag</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">ccpnTag</span> <span class="o">==</span> <span class="n">_isALoop</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
          <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
          <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">project</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_peak_restraint_links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_peak_restraint_links</span>


<div class="viewcode-block" id="CcpnNefReader.load_nef_peak_restraint_link"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_nef_peak_restraint_link">[docs]</a>  <span class="k">def</span> <span class="nf">load_nef_peak_restraint_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load nef_peak_restraint_link loop&quot;&quot;&quot;</span>

    <span class="n">links</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># NBNB TODO. There was a very strange bug in this function</span>
    <span class="c1"># When I was using PeakList.getPeak(str(serial))</span>
    <span class="c1"># and RestraintList.getRestraint(str(serial), peaks and restraints were</span>
    <span class="c1"># sometimes missed even though the data were present.</span>
    <span class="c1"># Doing the test at tge API level (as now) fixed the problem</span>
    <span class="c1"># THIS SHOULD BE IMPOSSIBLE</span>
    <span class="c1"># At some point we ought to go back, reproduce the bug, and remove the reason for it.</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">peakList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameCode2Object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">peakList</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s2">&quot;No Spectrum saveframe found with framecode </span><span class="si">%s</span><span class="s2">. Skipping peak_restraint_link&quot;</span>
          <span class="o">%</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">continue</span>
      <span class="n">restraintList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameCode2Object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_list_id&#39;</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">restraintList</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s2">&quot;No RestraintList saveframe found with framecode </span><span class="si">%s</span><span class="s2">. Skipping peak_restraint_link&quot;</span>
          <span class="o">%</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_list_id&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">continue</span>
      <span class="n">peak</span> <span class="o">=</span> <span class="n">peakList</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">findFirstPeak</span><span class="p">(</span><span class="n">serial</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peak_id&#39;</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">peak</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s2">&quot;No peak </span><span class="si">%s</span><span class="s2"> found in </span><span class="si">%s</span><span class="s2"> Skipping peak_restraint_link&quot;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peak_id&#39;</span><span class="p">),</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">continue</span>
      <span class="n">restraint</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">findFirstConstraint</span><span class="p">(</span><span class="n">serial</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">restraint</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s2">&quot;No restraint </span><span class="si">%s</span><span class="s2"> found in </span><span class="si">%s</span><span class="s2"> Skipping peak_restraint_link&quot;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_id&#39;</span><span class="p">),</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restraint_list_id&#39;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">continue</span>

      <span class="c1"># Is all worked, now accumulate the lin</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">restraint</span><span class="p">,</span> <span class="p">[])</span>
      <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
      <span class="n">links</span><span class="p">[</span><span class="n">restraint</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>

    <span class="c1"># Set the actual links</span>
    <span class="k">for</span> <span class="n">restraint</span><span class="p">,</span> <span class="n">peaks</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">restraint</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="bp">None</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;nef_peak_restraint_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_nef_peak_restraint_link</span>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_spectrum_group"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_spectrum_group">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_spectrum_group</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;ccpn_spectrum_group reading is not implemented yet&quot;</span><span class="p">)</span>

    <span class="c1"># Get ccpn-to-nef mappping for saveframe</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">]</span>
    <span class="n">framecode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>

    <span class="n">parameters</span><span class="p">,</span> <span class="n">loopNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

    <span class="c1"># Make main object</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newChemicalShiftList</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

    <span class="c1"># Load loops, with object as parent</span>
    <span class="k">for</span> <span class="n">loopName</span> <span class="ow">in</span> <span class="n">loopNames</span><span class="p">:</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
        <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_spectrum_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_spectrum_group</span>

<div class="viewcode-block" id="CcpnNefReader.load_ccpn_group_spectrum"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_group_spectrum">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_group_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span><span class="n">SpectrumGroup</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load ccpn_group_spectrum loop&quot;&quot;&quot;</span>

    <span class="n">spectra</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">peakList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameCode2Object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">peakList</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s2">&quot;No Spectrum saveframe found with framecode </span><span class="si">%s</span><span class="s2">. Skipping peak_restraint_link&quot;</span>
          <span class="o">%</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nmr_spectrum_id&#39;</span><span class="p">)</span>
        <span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">spectra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_group_spectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_group_spectrum</span>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_sample"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_sample">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="c1"># NBNB TODO add crosslinks to spectrum (also for components)</span>

    <span class="c1"># Get ccpn-to-nef mappping for saveframe</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">]</span>
    <span class="n">framecode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>

    <span class="n">parameters</span><span class="p">,</span> <span class="n">loopNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

    <span class="c1"># Make main object</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newSample</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

    <span class="c1"># Load loops, with object as parent</span>
    <span class="k">for</span> <span class="n">loopName</span> <span class="ow">in</span> <span class="n">loopNames</span><span class="p">:</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
        <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_sample</span>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_sample_component"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_sample_component">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_sample_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span><span class="n">Sample</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load ccpn_sample_component loop&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">creatorFunc</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">newSampleComponent</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">creatorFunc</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_sample_component&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_sample_component</span>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_substance"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_substance">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_substance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="c1"># Get ccpn-to-nef mappping for saveframe</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">]</span>
    <span class="n">framecode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
    <span class="n">parameters</span><span class="p">,</span> <span class="n">loopNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromSaveFrame</span><span class="p">(</span><span class="n">saveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;labelling&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
      <span class="n">labelling</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labelling&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">labelling</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">substances</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sequence_string&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sequence</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">previous</span><span class="p">:</span>
      <span class="c1"># We have a &#39;Molecule&#39; type substance with a sequence and no previous occurrence</span>
      <span class="c1"># Create it as new polymer</span>
      <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
      <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;molType&#39;</span><span class="p">:</span><span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mol_type&#39;</span><span class="p">)}</span>
      <span class="n">startNumber</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_number&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">startNumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;startNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startNumber</span>
      <span class="n">isCyclic</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_cyclic&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">isCyclic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;isCyclic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isCyclic</span>
      <span class="c1">#</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">createPolymerSubstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">labelling</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># find or create substance</span>
      <span class="c1"># NB substance could legitimately be existing already, since substances are created</span>
      <span class="c1"># when a chain is created.</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">fetchSubstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">labelling</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">previous</span><span class="p">:</span>
        <span class="c1"># In case this is a new Substance, (known name, different labelling)</span>
        <span class="c1"># set the sequenceString, if any, to the same as previous</span>
        <span class="n">sequenceString</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sequenceString</span>
        <span class="k">if</span> <span class="n">sequenceString</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">result</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">seqString</span> <span class="o">=</span> <span class="n">sequenceString</span>

    <span class="c1"># Whether substance was pre-existing or not</span>
    <span class="c1"># overwrite the missing substance-specific parameters</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Load loops, with object as parent</span>
    <span class="k">for</span> <span class="n">loopName</span> <span class="ow">in</span> <span class="n">loopNames</span><span class="p">:</span>
      <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">importer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importers</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
        <span class="n">importer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_substance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_substance</span>

<div class="viewcode-block" id="CcpnNefReader.load_ccpn_substance_synonym"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_substance_synonym">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_substance_synonym</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span><span class="n">Substance</span><span class="p">,</span> <span class="n">loop</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrLoop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load ccpn_substance_synonym loop&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;synonym&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">synonyms</span> <span class="o">=</span> <span class="n">result</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_substance_synonym&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_substance_synonym</span>

<div class="viewcode-block" id="CcpnNefReader.load_ccpn_assignments"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_assignments">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="c1"># the saveframe contains nothing but three loops:</span>
    <span class="n">nmrChainLoopName</span> <span class="o">=</span> <span class="s1">&#39;nmr_chain&#39;</span>
    <span class="n">nmrResidueLoopName</span> <span class="o">=</span> <span class="s1">&#39;nmr_residue&#39;</span>
    <span class="n">nmrAtomLoopName</span> <span class="o">=</span> <span class="s1">&#39;nmr_atom&#39;</span>

    <span class="n">nmrChains</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nmrResidues</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># read nmr_chain loop</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">nmrChainLoopName</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">creatorFunc</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newNmrChain</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">saveFrame</span><span class="p">[</span><span class="n">nmrChainLoopName</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">creatorFunc</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
      <span class="n">modelUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">],</span> <span class="s1">&#39;nmrChains&#39;</span><span class="p">)</span>
      <span class="n">nmrChains</span><span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;shortName&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nmrChain</span>

    <span class="c1"># read nmr_residue loop</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">nmrResidueLoopName</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">saveFrame</span><span class="p">[</span><span class="n">nmrResidueLoopName</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">chainCode</span> <span class="o">=</span>  <span class="n">row</span><span class="p">[</span><span class="s1">&#39;chain_code&#39;</span><span class="p">]</span>
      <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">nmrChains</span><span class="p">[</span><span class="n">chainCode</span><span class="p">]</span>
      <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">newNmrResidue</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
      <span class="n">modelUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">],</span> <span class="s1">&#39;nmrResidues&#39;</span><span class="p">)</span>
      <span class="n">nmrResidues</span><span class="p">[(</span><span class="n">chainCode</span><span class="p">,</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;sequenceCode&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">nmrChain</span>

    <span class="c1"># read nmr_atom loop</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">nmrAtomLoopName</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">saveFrame</span><span class="p">[</span><span class="n">nmrAtomLoopName</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">chainCode</span> <span class="o">=</span>  <span class="n">row</span><span class="p">[</span><span class="s1">&#39;chain_code&#39;</span><span class="p">]</span>
      <span class="n">sequenceCode</span> <span class="o">=</span>  <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sequence_code&#39;</span><span class="p">]</span>
      <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="p">[(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">)]</span>
      <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">newNmrAtom</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
      <span class="n">modelUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">],</span> <span class="s1">&#39;nmrAtoms&#39;</span><span class="p">)</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_assignments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_assignments</span>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_notes"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_notes">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_notes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="c1"># ccpn_notes contains nothing except for the ccpn_note loop</span>
    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_notes&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">creatorFunc</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newNote</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametersFromLoopRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">map2</span><span class="p">)</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">creatorFunc</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">))</span>

      <span class="c1"># load time stamps and serial = must bypass the API, as they are frozen</span>
      <span class="n">apiNote</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_wrappedData</span>
      <span class="n">created</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
        <span class="n">apiNote</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">created</span><span class="p">,</span> <span class="n">coreConstants</span><span class="o">.</span><span class="n">isoTimeFormat</span><span class="p">)</span>
      <span class="n">lastModified</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_modified&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">lastModified</span><span class="p">:</span>
        <span class="n">apiNote</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s1">&#39;lastModified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">lastModified</span><span class="p">,</span>
                                                             <span class="n">coreConstants</span><span class="o">.</span><span class="n">isoTimeFormat</span><span class="p">)</span>
      <span class="n">serial</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">serial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">modelUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="n">apiNote</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">result</span></div>

  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_notes</span>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_additional_data"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_additional_data">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_additional_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="c1"># ccpn_additional_data contains nothing except for the ccpn_internal_data loop</span>
    <span class="n">loopName</span> <span class="o">=</span> <span class="s1">&#39;ccpn_internal_data&#39;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="n">loopName</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
      <span class="n">pid</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
      <span class="n">project</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">ccpnInternalData</span> <span class="o">=</span> <span class="n">jsonIo</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_additional_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_additional_data</span>


<div class="viewcode-block" id="CcpnNefReader.load_ccpn_dataset"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.load_ccpn_dataset">[docs]</a>  <span class="k">def</span> <span class="nf">load_ccpn_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>

    <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;ccpn_dataset reading is not implemented yet&quot;</span><span class="p">)</span>

    <span class="c1"># Get ccpn-to-nef mappping for saveframe</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_category&#39;</span><span class="p">]</span>
    <span class="n">framecode</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="p">[</span><span class="s1">&#39;sf_framecode&#39;</span><span class="p">]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">nef2CcpnMap</span><span class="p">[</span><span class="n">category</span><span class="p">]</span></div>
  <span class="c1">#</span>
  <span class="n">importers</span><span class="p">[</span><span class="s1">&#39;ccpn_dataset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_ccpn_dataset</span>


  <span class="k">def</span> <span class="nf">_parametersFromSaveFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span><span class="n">OD</span><span class="p">,</span>
                               <span class="n">ccpnPrefix</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract {parameter:value} dictionary and list of loop names from saveFrame</span>

<span class="sd">    The mapping gives the map from NEF tags to ccpn tags.</span>
<span class="sd">    If the ccpn tag is of the form &lt;ccpnPrefix.tag&gt; it is ignored unless</span>
<span class="sd">    the first part of teh tag matches the passed-in ccpnPrefix</span>
<span class="sd">    (NB the ccpnPrefix may contain &#39;.&#39;).&quot;&quot;&quot;</span>

    <span class="c1"># Get attributes that have a simple tag mapping, and make a separate loop list</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">loopNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ccpnPrefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># Normal extraction from saveframe map</span>
      <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ccpnTag</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ccpnTag</span> <span class="o">==</span> <span class="n">_isALoop</span><span class="p">:</span>
          <span class="n">loopNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ccpnTag</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ccpnTag</span><span class="p">:</span>
          <span class="n">val</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># necessary as tags like ccpn_serial should NOT be set if absent of None</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">ccpnTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># extracting tags of the form `ccpnPrefix`.tag</span>
      <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ccpnTag</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ccpnTag</span> <span class="o">==</span> <span class="n">_isALoop</span><span class="p">:</span>
          <span class="n">loopNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ccpnTag</span><span class="p">:</span>
          <span class="n">parts</span> <span class="o">=</span> <span class="n">ccpnTag</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ccpnPrefix</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">saveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
              <span class="c1"># necessary as tags like ccpn_serial should NOT be set if absent of None</span>
              <span class="n">parameters</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">loopNames</span>

<div class="viewcode-block" id="CcpnNefReader.warning"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.warning">[docs]</a>  <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;WARNING in saveFrame</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveFrameName</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span></div>

  <span class="k">def</span> <span class="nf">_parametersFromLoopRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ccpnTag</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="n">ccpnTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">parameters</span>

<div class="viewcode-block" id="CcpnNefReader.produceNmrChain"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.produceNmrChain">[docs]</a>  <span class="k">def</span> <span class="nf">produceNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chainCode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get NmrChain, correcting for possible errors&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">chainCode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">chainCode</span> <span class="o">=</span> <span class="n">coreConstants</span><span class="o">.</span><span class="n">defaultNmrChainCode</span>
    <span class="n">newChainCode</span> <span class="o">=</span> <span class="n">chainCode</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">nmrChain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">fetchNmrChain</span><span class="p">(</span><span class="n">newChainCode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nmrChain</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">newChainCode</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">newChainCode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New NmrChain:</span><span class="si">%s</span><span class="s2"> name caused an error.  Renamed </span><span class="si">%s</span><span class="s2">&quot;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">newChainCode</span><span class="p">))</span></div>

<div class="viewcode-block" id="CcpnNefReader.produceNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.produceNmrResidue">[docs]</a>  <span class="k">def</span> <span class="nf">produceNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chainCode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">residueType</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get NmrResidue, correcting for possible errors&quot;&quot;&quot;</span>

    <span class="n">inputTuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nmrResidueMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">inputTuple</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">result</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sequenceCode</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot produce NmrResidue for sequenceCode: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="n">sequenceCode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">)</span>

    <span class="n">nmrChain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produceNmrChain</span><span class="p">(</span><span class="n">chainCode</span><span class="p">)</span>

    <span class="n">rt</span> <span class="o">=</span> <span class="n">residueType</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">shortName</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">)</span>
      <span class="c1"># return result</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="c1"># This can happen legitimately, e.g. for offset residues</span>
      <span class="c1"># Further processing needed.</span>

      <span class="c1"># Parse values from sequenceCode</span>
      <span class="n">seqNo</span><span class="p">,</span> <span class="n">insertCode</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">commonUtil</span><span class="o">.</span><span class="n">parseSequenceCode</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">residueType</span><span class="p">:</span>
          <span class="c1"># This could be a case where the NmrResidue had been created from an offset NmrResidue</span>
          <span class="c1"># with the residueType therefore missing.</span>
          <span class="c1"># If so, set the residueType</span>
          <span class="c1"># NBNB this also has the effect of having real entries with empty residueType</span>
          <span class="c1"># overridden by clashing entries with residueType set,</span>
          <span class="c1"># but that does make some sense and anyway cannot be helped.</span>

          <span class="c1"># NB this must be a pre-existing residue or it would have been created above.</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">previous</span><span class="o">.</span><span class="n">residueType</span><span class="p">:</span>
              <span class="n">result</span> <span class="o">=</span> <span class="n">previous</span>
              <span class="n">result</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">residueType</span> <span class="o">=</span> <span class="n">residueType</span>
              <span class="c1"># return result</span>
          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Deal with it below</span>
            <span class="k">pass</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Offset NmrResidue - get mainNmrResidue</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%+d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">offset</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="c1"># Fetch the mainNmrResidue. This will create it if it is missing (if possible)</span>
          <span class="n">mainNmrResidue</span> <span class="o">=</span>  <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="c1"># No go</span>
          <span class="n">mainNmrResidue</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">mainNmrResidue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">)</span>
            <span class="c1"># return result</span>
          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Handle lower down</span>
            <span class="k">pass</span>

    <span class="c1"># If e get here, we could not make an NmrResidue that matched the input</span>
    <span class="c1"># Make with modified sequenceCode</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">newSequenceCode</span> <span class="o">=</span> <span class="n">sequenceCode</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">result</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">newSequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="n">newSequenceCode</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">newSequenceCode</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New NmrResidue:</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> name caused an error.  Renamed </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">newSequenceCode</span><span class="p">,</span> <span class="n">rt</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="c1"># Result cannot have been in map, so put it there</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_nmrResidueMap</span><span class="p">[</span><span class="n">inputTuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CcpnNefReader.produceNmrAtom"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.produceNmrAtom">[docs]</a>  <span class="k">def</span> <span class="nf">produceNmrAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">:</span><span class="n">NmrResidue</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">isotopeCode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get NmrAtom from NmrResidue and name, correcting for possible errors&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot produce NmrAtom for atom name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">isotopeCode</span><span class="p">:</span>
      <span class="n">prefix</span> <span class="o">=</span> <span class="n">isotopeCode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">commonUtil</span><span class="o">.</span><span class="n">isotopeCode2Nucleus</span><span class="p">(</span><span class="n">isotopeCode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring unsupported isotopeCode: </span><span class="si">%s</span><span class="s2"> for NmrAtom:</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">isotopeCode</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
          <span class="n">newName</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">@</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NmrAtom name </span><span class="si">%s</span><span class="s2"> does not match isotopeCode </span><span class="si">%s</span><span class="s2"> - renamed to </span><span class="si">%s</span><span class="s2">&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">isotopeCode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">newName</span><span class="p">))</span>
          <span class="n">name</span> <span class="o">=</span> <span class="n">newName</span>

    <span class="n">newName</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">getNmrAtom</span><span class="p">(</span><span class="n">newName</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">Pid</span><span class="o">.</span><span class="n">remapSeparators</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">newNmrAtom</span><span class="p">(</span><span class="n">newName</span><span class="p">,</span> <span class="n">isotopeCode</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">nmrAtom</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="k">pass</span>
      <span class="k">elif</span> <span class="n">isotopeCode</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">isotopeCode</span><span class="p">):</span>
        <span class="c1"># We must ensure that the isotopeCodes match</span>
        <span class="k">return</span> <span class="n">nmrAtom</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># IsotopeCode mismatch. Try to</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="n">isotopeCode</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
          <span class="c1"># Something wrong here.</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Clash between NmrAtom </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) and </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) in </span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">isotopeCode</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">isotopeCode</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">newName</span> <span class="o">=</span> <span class="n">isotopeCode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">newName</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
          <span class="k">continue</span>

      <span class="c1"># If we get here there was an error. Change name and try again</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="n">newName</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">newName</span> <span class="o">+=</span> <span class="s1">&#39;_1&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New NmrAtom:</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> name caused an error.  Renamed </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">newName</span><span class="p">))</span></div>

<div class="viewcode-block" id="CcpnNefReader.updateMetaData"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.updateMetaData">[docs]</a>  <span class="k">def</span> <span class="nf">updateMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metaDataFrame</span><span class="p">:</span><span class="n">StarIo</span><span class="o">.</span><span class="n">NmrSaveFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add meta information to main data set. Must be done at end of read&quot;&quot;&quot;</span>

    <span class="c1"># NBNB NOT WORKING YET!</span>

    <span class="c1"># dataSet = self.fetchDataSet(self.mainDataSetSerial)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mainDataSetSerial</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="CcpnNefReader.fetchDataSet"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.CcpnNefReader.fetchDataSet">[docs]</a>  <span class="k">def</span> <span class="nf">fetchDataSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serial</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch DataSet with given serial.</span>
<span class="sd">    If input is None, use self.defaultDataSetSerial</span>
<span class="sd">    If that too is None, create a new DataSet and use its serial as the default</span>

<span class="sd">    NB when reading, all DataSets with known serials should be instantiated BEFORE calling</span>
<span class="sd">    with input None&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">serial</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">serial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultDataSetSerial</span>

    <span class="k">if</span> <span class="n">serial</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># default not set - create one</span>
      <span class="n">dataSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">newDataSet</span><span class="p">()</span>
      <span class="n">serial</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">serial</span>
      <span class="n">dataSet</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Data_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">serial</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">defaultDataSetSerial</span> <span class="o">=</span> <span class="n">serial</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dataSet2ItemMap</span><span class="p">[</span><span class="n">dataSet</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">_getTempItemMap</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># take or create dataSet matching serial</span>
      <span class="n">dataSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getDataSet</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">dataSet</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dataSet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">newDataSet</span><span class="p">()</span>
        <span class="n">modelUtil</span><span class="o">.</span><span class="n">resetSerial</span><span class="p">(</span><span class="n">dataSet</span><span class="o">.</span><span class="n">_wrappedData</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="s1">&#39;nmrConstraintStores&#39;</span><span class="p">)</span>
        <span class="n">dataSet</span><span class="o">.</span><span class="n">_finaliseAction</span><span class="p">(</span><span class="s1">&#39;rename&#39;</span><span class="p">)</span>
        <span class="n">dataSet</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Data_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">serial</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dataSet2ItemMap</span><span class="p">[</span><span class="n">dataSet</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">_getTempItemMap</span><span class="p">()</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">dataSet</span></div></div>


<div class="viewcode-block" id="createSpectrum"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.createSpectrum">[docs]</a><span class="k">def</span> <span class="nf">createSpectrum</span><span class="p">(</span><span class="n">project</span><span class="p">:</span><span class="n">Project</span><span class="p">,</span> <span class="n">spectrumName</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">spectrumParameters</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span>
                   <span class="n">dimensionData</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">transferData</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Get or create spectrum using dictionaries of attributes, such as read in from NEF.</span>

<span class="sd">  :param spectrumParameters keyword-value dictionary of attribute to set on resulting spectrum</span>

<span class="sd">  :params Dictionary of keyword:list parameters, with per-dimension parameters.</span>
<span class="sd">  Either &#39;axisCodes&#39; or &#39;isotopeCodes&#39; must be present and fully populated.</span>
<span class="sd">  A number of other dimensionData are</span>
<span class="sd">  treated specially (see below)</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">spectrum</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">getSpectrum</span><span class="p">(</span><span class="n">spectrumName</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># Spectrum did not already exist</span>

    <span class="n">dimTags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dimensionData</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># First try to load it - we override the loaded attribute values below</span>
    <span class="c1"># but loading gives a more complete parameter set.</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">filePath</span> <span class="o">=</span> <span class="n">spectrumParameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filePath&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filePath</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filePath</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">dataType</span><span class="p">,</span> <span class="n">subType</span><span class="p">,</span> <span class="n">usePath</span> <span class="o">=</span> <span class="n">ioFormats</span><span class="o">.</span><span class="n">analyseUrl</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;Spectrum&#39;</span><span class="p">:</span>
          <span class="n">spectra</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">loadSpectrum</span><span class="p">(</span><span class="n">usePath</span><span class="p">,</span> <span class="n">subType</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">spectra</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Deliberate - any error should be skipped</span>
        <span class="k">pass</span>
      <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to load spectrum from spectrum path </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filePath</span><span class="p">)</span>
      <span class="k">elif</span> <span class="s1">&#39;axisCodes&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
          <span class="c1"># set axisCodes</span>
          <span class="n">spectrum</span><span class="o">.</span><span class="n">axisCodes</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;axisCodes&#39;</span><span class="p">]</span>

    <span class="n">acquisitionAxisIndex</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s1">&#39;is_acquisition&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;is_acquisition&#39;</span><span class="p">)</span>
      <span class="n">values</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;is_acquisition&#39;</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">acquisitionAxisIndex</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># Spectrum could not be loaded - now create a dummy spectrum</span>

      <span class="k">if</span> <span class="s1">&#39;axisCodes&#39;</span> <span class="ow">in</span> <span class="n">dimTags</span><span class="p">:</span>
        <span class="c1"># We have the axisCodes, from ccpn</span>
        <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;axisCodes&#39;</span><span class="p">)</span>
        <span class="n">axisCodes</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;axisCodes&#39;</span><span class="p">]</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">transferData</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function needs either axisCodes or transferData&quot;</span><span class="p">)</span>

        <span class="n">dimensionIds</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">]</span>

        <span class="c1"># axisCodes were not set - produce a serviceable set</span>
        <span class="n">axisCodes</span> <span class="o">=</span> <span class="n">makeNefAxisCodes</span><span class="p">(</span><span class="n">isotopeCodes</span><span class="o">=</span><span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;isotopeCodes&#39;</span><span class="p">],</span>
                                     <span class="n">dimensionIds</span><span class="o">=</span><span class="n">dimensionIds</span><span class="p">,</span>
                                     <span class="n">acquisitionAxisIndex</span><span class="o">=</span><span class="n">acquisitionAxisIndex</span><span class="p">,</span>
                                     <span class="n">transferData</span><span class="o">=</span><span class="n">transferData</span><span class="p">)</span>


      <span class="c1"># make new spectrum with default parameters</span>
      <span class="n">spectrum</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">createDummySpectrum</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">spectrumName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">acquisitionAxisIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">acquisitionAxisCode</span> <span class="o">=</span> <span class="n">axisCodes</span><span class="p">[</span><span class="n">acquisitionAxisIndex</span><span class="p">]</span>

      <span class="c1"># Delete autocreated peaklist  and reset - we want any read-in peakList to be the first</span>
      <span class="c1"># If necessary an empty PeakList is added downstream</span>
      <span class="n">spectrum</span><span class="o">.</span><span class="n">peakLists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
      <span class="n">spectrum</span><span class="o">.</span><span class="n">_wrappedData</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s1">&#39;_serialDict&#39;</span><span class="p">][</span><span class="s1">&#39;peakLists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># (Re)set all spectrum attributes</span>

    <span class="c1"># First per-dimension ones</span>
    <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;dimension_id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;absolute_peak_positions&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
      <span class="c1"># NB We are not using these. What could we do with them?</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;absolute_peak_positions&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;folding&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;folding&#39;</span><span class="p">)</span>
      <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;folding&#39;</span><span class="p">]]</span>
      <span class="n">spectrum</span><span class="o">.</span><span class="n">foldingModes</span> <span class="o">=</span> <span class="n">values</span>
    <span class="k">if</span> <span class="s1">&#39;pointCounts&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;pointCounts&#39;</span><span class="p">)</span>
      <span class="n">spectrum</span><span class="o">.</span><span class="n">pointCounts</span> <span class="o">=</span> <span class="n">pointCounts</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;pointCounts&#39;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s1">&#39;totalPointCounts&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
        <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;totalPointCounts&#39;</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">totalPointCounts</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="p">[</span><span class="s1">&#39;totalPointCounts&#39;</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">totalPointCounts</span> <span class="o">=</span> <span class="n">pointCounts</span>
    <span class="c1"># Needed below:</span>
    <span class="k">if</span> <span class="s1">&#39;value_first_point&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;value_first_point&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;referencePoints&#39;</span> <span class="ow">in</span> <span class="n">dimensionData</span><span class="p">:</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;referencePoints&#39;</span><span class="p">)</span>
    <span class="c1"># value_first_point = dimensionData.get(&#39;value_first_point&#39;)</span>
    <span class="c1"># if value_first_point is not None:</span>
    <span class="c1">#   dimensionData.pop(&#39;value_first_point&#39;)</span>
    <span class="c1"># referencePoints = dimensionData.get(&#39;referencePoints&#39;)</span>
    <span class="c1"># if referencePoints is not None:</span>
    <span class="c1">#   dimensionData.pop(&#39;referencePoints&#39;)</span>

    <span class="c1"># Remaining per-dimension values match the spectrum. Set them.</span>
    <span class="c1"># NB we use the old (default) values where the new value is None</span>
    <span class="c1"># - some attributes like spectralWidths do not accept None.</span>
    <span class="k">if</span> <span class="s1">&#39;spectrometerFrequencies&#39;</span> <span class="ow">in</span> <span class="n">dimTags</span><span class="p">:</span>
      <span class="c1"># spectrometerFrequencies MUST be set before spectralWidths,</span>
      <span class="c1"># as the spectralWidths are otherwise modified</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;spectrometerFrequencies&#39;</span><span class="p">)</span>
      <span class="n">dimTags</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;spectrometerFrequencies&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">dimTags</span><span class="p">:</span>
      <span class="n">vals</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
      <span class="c1"># Use old values where new ones are None</span>
      <span class="n">oldVals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
      <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">oldVals</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>

    <span class="c1"># Set referencing.</span>
    <span class="n">value_first_point</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value_first_point&#39;</span><span class="p">)</span>
    <span class="n">referencePoints</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;referencePoints&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value_first_point</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1"># If reading NEF we must get value_first_point,</span>
      <span class="c1">#  but in other uses we might be getting referencePoints, referenceValues directly</span>
      <span class="n">referenceValues</span> <span class="o">=</span> <span class="n">dimensionData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;referenceValues&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">referenceValues</span> <span class="ow">and</span> <span class="n">referencePoints</span><span class="p">:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">referencePoints</span> <span class="o">=</span> <span class="n">referencePoints</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">referenceValues</span> <span class="o">=</span> <span class="n">referenceValues</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">referencePoints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># not CCPN data</span>
        <span class="n">referenceValues</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">referenceValues</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value_first_point</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value_first_point</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">referenceValues</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">referenceValues</span> <span class="o">=</span> <span class="n">value_first_point</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">referencePoints</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">referenceValues</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">referencePoints</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">referenceValues</span><span class="p">)</span>
        <span class="n">sw</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectralWidths</span>
        <span class="n">pointCounts</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">pointCounts</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">refVal</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value_first_point</span><span class="p">):</span>
          <span class="n">refPoint</span> <span class="o">=</span> <span class="n">referencePoints</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
          <span class="k">if</span> <span class="n">refVal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">refPoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># if we are here refPoint should never be None, but OK, ...</span>
            <span class="c1"># Set reference to use refPoint</span>
            <span class="n">points</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">refPoint</span>
            <span class="n">refVal</span> <span class="o">-=</span> <span class="p">((</span><span class="n">refPoint</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sw</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="n">pointCounts</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">values</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">refVal</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">referencePoints</span> <span class="o">=</span> <span class="n">points</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">referenceValues</span> <span class="o">=</span> <span class="n">values</span>

    <span class="c1"># Then spectrum-level ones</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">spectrumParameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;dimensionCount&#39;</span><span class="p">:</span>
        <span class="c1"># dimensionCount is handled already and not settable</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">spectrum</span>

  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Spectrum named </span><span class="si">%s</span><span class="s2"> already exists&quot;</span> <span class="o">%</span> <span class="n">spectrumName</span><span class="p">)</span></div>

<div class="viewcode-block" id="makeNefAxisCodes"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.CcpnNefIo.makeNefAxisCodes">[docs]</a><span class="k">def</span> <span class="nf">makeNefAxisCodes</span><span class="p">(</span><span class="n">isotopeCodes</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">dimensionIds</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                     <span class="n">acquisitionAxisIndex</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">transferData</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]):</span>

  <span class="n">nuclei</span> <span class="o">=</span> <span class="p">[</span><span class="n">commonUtil</span><span class="o">.</span><span class="n">splitIntFromChars</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">isotopeCodes</span><span class="p">]</span>
  <span class="n">dimensionToNucleus</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">zip</span><span class="p">(</span><span class="n">dimensionIds</span><span class="p">,</span> <span class="n">nuclei</span><span class="p">)))</span>
  <span class="n">dimensionToAxisCode</span> <span class="o">=</span> <span class="n">dimensionToNucleus</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

  <span class="n">oneBondConnections</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">startNuc</span> <span class="ow">in</span> <span class="s1">&#39;FH&#39;</span><span class="p">:</span>
    <span class="c1"># look for onebond to F or H, the latter taking priority</span>
    <span class="k">for</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">,</span> <span class="n">transferType</span><span class="p">,</span> <span class="n">isIndirect</span> <span class="ow">in</span> <span class="n">transferData</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">transferType</span> <span class="o">==</span> <span class="s1">&#39;onebond&#39;</span><span class="p">:</span>
        <span class="n">nuc1</span><span class="p">,</span> <span class="n">nuc2</span> <span class="o">=</span> <span class="n">dimensionToNucleus</span><span class="p">[</span><span class="n">dim1</span><span class="p">],</span> <span class="n">dimensionToNucleus</span><span class="p">[</span><span class="n">dim2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">startNuc</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nuc1</span><span class="p">,</span> <span class="n">nuc2</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">startNuc</span> <span class="o">==</span> <span class="n">nuc1</span><span class="p">:</span>
            <span class="n">oneBondConnections</span><span class="p">[</span><span class="n">dim1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim2</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">oneBondConnections</span><span class="p">[</span><span class="n">dim2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim1</span>
          <span class="n">dimensionToAxisCode</span><span class="p">[</span><span class="n">dim1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nuc1</span> <span class="o">+</span> <span class="n">nuc2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
          <span class="n">dimensionToAxisCode</span><span class="p">[</span><span class="n">dim2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nuc2</span> <span class="o">+</span> <span class="n">nuc1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

  <span class="n">resultMap</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">acquisitionAtEnd</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="k">if</span> <span class="n">acquisitionAxisIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">acquisitionAtEnd</span> <span class="o">=</span> <span class="n">acquisitionAxisIndex</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">isotopeCodes</span><span class="p">)</span>
    <span class="c1"># if acquisitionAtEnd:</span>
    <span class="c1">#   # reverse, because acquisition end of dimensions should</span>
    <span class="c1">#   # be the one WITHOUT number suffixes</span>
    <span class="c1">#   dimensionIds.reverse()</span>

    <span class="c1"># Put acquisition axis first, to make sure it gets the lowest number</span>
    <span class="c1"># even if it is not teh first to start with.</span>
    <span class="n">acquisitionAxisId</span> <span class="o">=</span> <span class="n">dimensionIds</span><span class="p">[</span><span class="n">acquisitionAxisIndex</span><span class="p">]</span>
    <span class="n">dimensionIds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">acquisitionAxisId</span><span class="p">)</span>
    <span class="n">dimensionIds</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">acquisitionAxisId</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensionIds</span><span class="p">:</span>
    <span class="n">axisCode</span> <span class="o">=</span> <span class="n">dimensionToAxisCode</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">axisCode</span> <span class="ow">in</span> <span class="n">resultMap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ss</span> <span class="o">=</span> <span class="n">axisCode</span>
      <span class="k">while</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">resultMap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">axisCode</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
      <span class="n">otherDim</span> <span class="o">=</span> <span class="n">oneBondConnections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">otherDim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># We are adding a suffix to e.g. Hc. Add the same suffix to equivalent Ch</span>
        <span class="c1"># NB this should only happen for certain 4D experiments.</span>
        <span class="c1"># NB not well tested, but better than leaving in a known error.</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dimensionToAxisCode</span><span class="p">[</span><span class="n">otherDim</span><span class="p">],</span> <span class="n">ii</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">otherDim</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">:</span>
          <span class="n">resultMap</span><span class="p">[</span><span class="n">otherDim</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span>
        <span class="n">dimensionToAxisCode</span><span class="p">[</span><span class="n">otherDim</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span>

    <span class="n">resultMap</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">axisCode</span>
  <span class="n">dimensionIds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="c1"># NBNB new attempt - may not work</span>
  <span class="c1"># if acquisitionAtEnd:</span>
  <span class="c1">#   # put result back in dimension order</span>
  <span class="c1">#   dimensionIds.reverse()</span>
  <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resultMap</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">dimensionIds</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">result</span></div>


<span class="k">def</span> <span class="nf">_printOutMappingDict</span><span class="p">(</span><span class="n">mappingDict</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Utility - print out mapping dict for editing and copying&quot;&quot;&quot;</span>
  <span class="n">saveframeOrder</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;# NEf to CCPN tag mapping (and tag order)&quot;</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">od</span> <span class="ow">in</span> <span class="n">mappingDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">saveframeOrder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">:OD((&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">category</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">od</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;    (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">),&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This must be a loop OD</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;    (</span><span class="si">%s</span><span class="s2">,OD((&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tag2</span><span class="p">,</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
          <span class="k">print</span><span class="p">(</span><span class="s2">&quot;      (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">),&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">tag2</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val2</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;    ))),&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;  )),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;#SaveFrameOrder</span><span class="se">\n</span><span class="s2">[&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">saveframeOrder</span><span class="p">:</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span><span class="nb">repr</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
  <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_exportToNef</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">()):</span>

  <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ccpn&#39;</span><span class="p">):</span>
    <span class="n">outPath</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;nef&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">outPath</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;.nef&#39;</span>

  <span class="kn">from</span> <span class="nn">ccpn.framework.Framework</span> <span class="kn">import</span> <span class="n">createFramework</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
  <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="n">application</span> <span class="o">=</span> <span class="n">createFramework</span><span class="p">()</span>
  <span class="n">application</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">project</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">project</span>
  <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;====&gt; Loaded </span><span class="si">%s</span><span class="s2"> from file in seconds </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time2</span><span class="o">-</span><span class="n">time1</span><span class="p">))</span>
  <span class="n">saveNefProject</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">outPath</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="n">skipPrefixes</span><span class="p">)</span>
  <span class="n">time3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;====&gt; Saved  </span><span class="si">%s</span><span class="s2">  to  NEF file in seconds </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time3</span><span class="o">-</span><span class="n">time2</span><span class="p">))</span>

  <span class="c1"># Needed to clean up notifiers</span>
  <span class="n">project</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">outPath</span>

<span class="k">def</span> <span class="nf">_testNefIo</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">()):</span>

  <span class="kn">from</span> <span class="nn">ccpn.framework.Framework</span> <span class="kn">import</span> <span class="n">createFramework</span>

  <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nef&#39;</span><span class="p">):</span>
    <span class="n">outPath</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.out.nef&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File name does not end in &#39;.nef&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

  <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="n">application</span> <span class="o">=</span> <span class="n">createFramework</span><span class="p">()</span>
  <span class="n">application</span><span class="o">.</span><span class="n">nefReader</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">application</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

  <span class="n">project</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">project</span>
  <span class="c1"># spectrum = project.spectra[0]</span>
  <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;====&gt; Loaded </span><span class="si">%s</span><span class="s2"> from NEF file in seconds </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time2</span><span class="o">-</span><span class="n">time1</span><span class="p">))</span>
  <span class="n">saveNefProject</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">outPath</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="n">skipPrefixes</span><span class="p">)</span>
  <span class="n">time3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;====&gt; Saved  </span><span class="si">%s</span><span class="s2">  to  NEF file in seconds </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time3</span><span class="o">-</span><span class="n">time2</span><span class="p">))</span>
  <span class="c1"># Needed to clean up notifiers</span>
  <span class="n">project</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

  <span class="k">return</span> <span class="n">outPath</span>


<span class="c1"># def _extractVariantsTable(aa_variants_cif:str)-&gt; str:</span>
<span class="c1">#   &quot;&quot;&quot;Read aa-variants.cif file contents and return variants mapping table string&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#   lineformat = &quot;%-15s    %-12s    %-7s    %-15s&quot;</span>
<span class="c1">#   lines =[lineformat % (&#39;MMCIF_code&#39;, &quot;residue_name&quot;, &quot;linking&quot;, &quot;residue_variant&quot;)]</span>
<span class="c1">#</span>
<span class="c1">#   #</span>
<span class="c1">#   # &#39;LL&#39;</span>
<span class="c1">#   # linkingMap = {</span>
<span class="c1">#   #   &#39;LL&#39;:&#39;middle&#39;,</span>
<span class="c1">#   #   &#39;LEO2&#39;:&#39;end&#39;, # deprotonated</span>
<span class="c1">#   #   &#39;LEO2H&#39;:&#39;end&#39;, # deprotonated</span>
<span class="c1">#   #   &#39;LFOH&#39;:&#39;single&#39;, # neutral</span>
<span class="c1">#   #   &#39;LFZW&#39;:&#39;single&#39;, # zwitter</span>
<span class="c1">#   #   &#39;LSN3&#39;:&#39;start&#39;, # protonated</span>
<span class="c1">#   #</span>
<span class="c1">#   # }</span>
<span class="c1">#</span>
<span class="c1">#   names = []</span>
<span class="c1">#</span>
<span class="c1">#   for line in open(aa_variants_cif):</span>
<span class="c1">#</span>
<span class="c1">#     hxt = False</span>
<span class="c1">#</span>
<span class="c1">#     if &#39;data_&#39; in line:</span>
<span class="c1">#       ll = line.strip().split(&#39;_&#39;)</span>
<span class="c1">#       if len(ll) == 2:</span>
<span class="c1">#         pass</span>
<span class="c1">#       else:</span>
<span class="c1">#         name = ll[1]</span>
<span class="c1">#         names.append(name)</span>
<span class="c1">#         ll2 = []</span>
<span class="c1">#         lnk = ll[2]</span>
<span class="c1">#         linking = &#39;.&#39;</span>
<span class="c1">#         if lnk == &#39;LL&#39;:</span>
<span class="c1">#           linking = &#39;middle&#39;</span>
<span class="c1">#         elif lnk == &#39;LEO2&#39;:</span>
<span class="c1">#           linking = &#39;end&#39;</span>
<span class="c1">#         elif lnk == &#39;LEO2H&#39;:</span>
<span class="c1">#           linking = &#39;end&#39;</span>
<span class="c1">#           hxt = True</span>
<span class="c1">#         elif lnk == &#39;LFZW&#39;:</span>
<span class="c1">#           linking = &#39;single&#39;</span>
<span class="c1">#         elif lnk == &#39;LFOH&#39;:</span>
<span class="c1">#           linking = &#39;single&#39;</span>
<span class="c1">#           ll2.append(&#39;-H3&#39;)</span>
<span class="c1">#           hxt = True</span>
<span class="c1">#         elif lnk == &#39;LSN3&#39;:</span>
<span class="c1">#           linking = &#39;start&#39;</span>
<span class="c1">#         else:</span>
<span class="c1">#           print(&#39;WARNING, not recognised&#39;, ll)</span>
<span class="c1">#</span>
<span class="c1">#         if len(ll) &gt; 3:</span>
<span class="c1">#           var = ll[3]</span>
<span class="c1">#           if var[0] == &#39;D&#39;:</span>
<span class="c1">#             ll2.append(&#39;-&#39;+var[1:])</span>
<span class="c1">#           else:</span>
<span class="c1">#             print (&quot;NB Ignoring MMcif variant %s&quot; % var)</span>
<span class="c1">#</span>
<span class="c1">#         # Sort before further treatment, to make sure &#39;+&#39; markers come at the end</span>
<span class="c1">#         ll2.sort()</span>
<span class="c1">#</span>
<span class="c1">#         # Special handling for ASP and GLU - where default is side chain deprotonated</span>
<span class="c1">#         if name == &#39;ASP&#39;:</span>
<span class="c1">#           if &#39;-HD2&#39; in ll2:</span>
<span class="c1">#             ll2.remove(&#39;-HD2&#39;)</span>
<span class="c1">#           else:</span>
<span class="c1">#             ll2.append(&#39;+HD2&#39;)</span>
<span class="c1">#         elif name == &#39;GLU&#39;:</span>
<span class="c1">#           if &#39;-HE2&#39; in ll2:</span>
<span class="c1">#             ll2.remove(&#39;-HE2&#39;)</span>
<span class="c1">#           else:</span>
<span class="c1">#             ll2.append(&#39;+HE2&#39;)</span>
<span class="c1">#         elif name == &#39;HIS&#39;:</span>
<span class="c1">#           if &#39;-HE2&#39; in ll2:</span>
<span class="c1">#             ll2.remove(&#39;-HE2&#39;)</span>
<span class="c1">#           else:</span>
<span class="c1">#             ll2.append(&#39;+HE2&#39;)</span>
<span class="c1">#</span>
<span class="c1">#         # NBNB</span>
<span class="c1">#</span>
<span class="c1">#         if hxt:</span>
<span class="c1">#           ll2.append(&#39;+HXT&#39;)</span>
<span class="c1">#         if ll2:</span>
<span class="c1">#           variant = &#39;,&#39;.join(ll2)</span>
<span class="c1">#         else:</span>
<span class="c1">#           variant = &#39;.&#39;</span>
<span class="c1">#         ss = lineformat % (&#39;_&#39;.join(ll[1:]), name, linking, variant)</span>
<span class="c1">#</span>
<span class="c1">#         lines.append(ss)</span>
<span class="c1">#</span>
<span class="c1">#   #</span>
<span class="c1">#   print (Counter(names))</span>
<span class="c1">#</span>
<span class="c1">#   #</span>
<span class="c1">#   return &#39;\n&#39;.join(lines)</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">sys</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">_testNefIo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ccpn&#39;</span> <span class="p">,))</span>
  <span class="c1"># _testNefIo(path)</span>
  <span class="c1"># nefpath = _exportToNef(path)</span>
  <span class="c1"># _testNefIo(nefpath)</span>
  <span class="c1"># nefpath = _exportToNef(path, skipPrefixes=(&#39;ccpn&#39; ,))</span>
  <span class="c1"># _testNefIo(nefpath, skipPrefixes=(&#39;ccpn&#39;,))</span>
  <span class="c1"># print(_extractVariantsTable(path))</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>