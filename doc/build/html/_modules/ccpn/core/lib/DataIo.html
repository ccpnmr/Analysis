<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpn.core.lib.DataIo &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.core.lib.DataIo</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module Documentation here</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (www.ccpn.ac.uk) 2014 - $Date: 2016-10-18 17:09:43 +0100 (Tue, 18 Oct 2016) $&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="s2">&quot;Wayne Boucher, Rasmus H Fogh, Luca G Mureddu, Simon P Skinner &amp; Geerten W Vuister&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN license. See www.ccpn.ac.uk/license&quot;</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for license text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from www.ccpn.ac.uk/license&quot;</span>
                 <span class="s2">&quot; or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>

<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification:</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: rhfogh $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2016-10-18 17:09:43 +0100 (Tue, 18 Oct 2016) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 9953 $&quot;</span>

<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>



<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span>  <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">ccpn.util.nef</span> <span class="kn">import</span> <span class="n">StarIo</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">CcpnNefIo</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib</span> <span class="kn">import</span> <span class="n">MoleculeLib</span>

<div class="viewcode-block" id="parseNmrPipeScript"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.parseNmrPipeScript">[docs]</a><span class="k">def</span> <span class="nf">parseNmrPipeScript</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Extract data of form -xABC valuex -yABC valuey -zABC valuez</span>
<span class="sd">  as a dictionary of {&#39;ABC:(valuex, valuey, valuez)} from nmrpipr input script&quot;&quot;&quot;</span>
  <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ss</span> <span class="ow">and</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;#!&#39;</span><span class="p">:</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
      <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;-y&#39;</span><span class="p">,</span> <span class="s1">&#39;-z&#39;</span><span class="p">):</span>
          <span class="n">indx</span> <span class="o">=</span> <span class="s1">&#39;xyz&#39;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
          <span class="n">ll</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
          <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">ll</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
          <span class="n">result</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>
          <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="importCyanaRestraints"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.importCyanaRestraints">[docs]</a><span class="k">def</span> <span class="nf">importCyanaRestraints</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">,</span> <span class="n">restraintType</span><span class="o">=</span><span class="s1">&#39;Distance&#39;</span><span class="p">):</span>
  <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

  <span class="n">dataSet</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dataSets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">restraintList</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">newRestraintList</span><span class="p">(</span><span class="n">restraintType</span><span class="o">=</span><span class="n">restraintType</span><span class="p">,</span>
                                           <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Cyana restraint list load&quot;</span><span class="p">)</span>
  <span class="n">extractCyanaRestraints</span><span class="p">(</span><span class="n">restraintList</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="importInsightRestraints"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.importInsightRestraints">[docs]</a><span class="k">def</span> <span class="nf">importInsightRestraints</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">,</span> <span class="n">restraintType</span><span class="o">=</span><span class="s1">&#39;Distance&#39;</span><span class="p">):</span>
  <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

  <span class="n">dataSet</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dataSets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">restraintList</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">newRestraintList</span><span class="p">(</span><span class="n">restraintType</span><span class="o">=</span><span class="n">restraintType</span><span class="p">,</span>
                                           <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Insight restraint list load&quot;</span><span class="p">)</span>
  <span class="n">extractInsightRestraints</span><span class="p">(</span><span class="n">restraintList</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="getProject"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.getProject">[docs]</a><span class="k">def</span> <span class="nf">getProject</span><span class="p">(</span><span class="n">projectPath</span><span class="p">):</span>
  <span class="kn">from</span> <span class="nn">ccpn.framework.Framework</span> <span class="kn">import</span> <span class="n">getFramework</span>
  <span class="n">projectPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">projectPath</span><span class="p">))</span>
  <span class="n">application</span> <span class="o">=</span> <span class="n">getFramework</span><span class="p">()</span>
  <span class="n">application</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">projectPath</span><span class="p">)</span>
  <span class="n">project</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">project</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">project</span></div>


<div class="viewcode-block" id="extractCyanaRestraints"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.extractCyanaRestraints">[docs]</a><span class="k">def</span> <span class="nf">extractCyanaRestraints</span><span class="p">(</span><span class="n">restraintList</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Extract CYANA restraints from tect. NBNB HACK!</span>

<span class="sd">  This is an ad-hoc function to read information from PDB=-deposited</span>
<span class="sd">  restraint blocks, customised for (a) particular case(s)</span>

<span class="sd">  residueTypes are not read, to avoid complications with non-standard</span>
<span class="sd">  DNA/RNA names. User beware&quot;&quot;&quot;</span>
  <span class="n">project</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">_project</span>
  <span class="n">sequenceCodeMap</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
    <span class="n">sequenceCode</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">sequenceCode</span>
    <span class="k">if</span> <span class="n">sequenceCode</span> <span class="ow">in</span> <span class="n">sequenceCodeMap</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate sequenceCode </span><span class="si">%s</span><span class="s2"> in project chains. Aborting&quot;</span> <span class="o">%</span> <span class="n">sequenceCode</span><span class="p">)</span>
    <span class="c1"># NB we convert sequenceCode to int 1) for sorting, 2) because non-int examples will not appear</span>
    <span class="n">sequenceCodeMap</span><span class="p">[</span><span class="n">sequenceCode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">),</span> <span class="n">residue</span><span class="o">.</span><span class="n">residueType</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>

    <span class="c1"># ignore empty and comment lines</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;#!&#39;</span><span class="p">:</span>
      <span class="k">continue</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span>
      <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">atomName</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="n">sequenceCodeMap</span><span class="p">[</span><span class="n">sequenceCode</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">atomName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;QQ&#39;</span><span class="p">):</span>
        <span class="n">atomName</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span> <span class="o">+</span> <span class="n">atomName</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
      <span class="k">elif</span> <span class="n">atomName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atomName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
          <span class="n">atomName</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span> <span class="o">+</span> <span class="n">atomName</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">elif</span> <span class="n">atomName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">residueType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;THR&#39;</span><span class="p">,</span> <span class="s1">&#39;ILE&#39;</span><span class="p">):</span>
          <span class="c1"># NB this hardwires that these methyl groups are NOT stereospecific</span>
          <span class="c1"># That may not be correct, but ...</span>
          <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span> <span class="k">if</span> <span class="n">atomName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="k">else</span> <span class="s1">&#39;y&#39;</span>
          <span class="n">atomName</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span> <span class="o">+</span> <span class="n">atomName</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> <span class="n">ss</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">atomName</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span> <span class="o">+</span> <span class="n">atomName</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
      <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomName</span><span class="p">,))</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="n">restraintList</span><span class="o">.</span><span class="n">createSimpleRestraint</span><span class="p">(</span><span class="n">upperLimit</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">restraintItems</span><span class="o">=</span><span class="p">(</span><span class="n">items</span><span class="p">,))</span></div>




<div class="viewcode-block" id="extractInsightRestraints"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.extractInsightRestraints">[docs]</a><span class="k">def</span> <span class="nf">extractInsightRestraints</span><span class="p">(</span><span class="n">restraintList</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Extract  restraints from text - INsight format ???. NBNB HACK! - assuming format:</span>
<span class="sd">  #NOE_distance</span>
<span class="sd">  1:A_23:H8          1:TYR_162:HD*       3.100  6.400  5.000 100.00 100.00 1000.000  0.00</span>
<span class="sd">  etc.</span>

<span class="sd">  Used for 1nk2</span>

<span class="sd">  This is an ad-hoc function to read information from PDB=-deposited</span>
<span class="sd">  restraint blocks, customised for (a) particular case(s)</span>

<span class="sd">  residueTypes are not read, to avoid complications with non-standard</span>
<span class="sd">  DNA/RNA names. User beware&quot;&quot;&quot;</span>



  <span class="n">conversion</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;H2&#39;1&quot;</span><span class="p">:</span><span class="s2">&quot;H2&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H2&#39;2&quot;</span><span class="p">:</span><span class="s2">&quot;H2&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H2&#39;X&quot;</span><span class="p">:</span><span class="s2">&quot;H2&#39;*&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H5&#39;1&quot;</span><span class="p">:</span><span class="s2">&quot;H5&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H5&#39;2&quot;</span><span class="p">:</span><span class="s2">&quot;H5&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H5&#39;X&quot;</span><span class="p">:</span><span class="s2">&quot;H5&#39;*&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H5M*&quot;</span><span class="p">:</span><span class="s2">&quot;H7%&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H5MX&quot;</span><span class="p">:</span><span class="s2">&quot;H7%&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HN&quot;</span><span class="p">:</span><span class="s2">&quot;H&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HA1&quot;</span><span class="p">:</span><span class="s2">&quot;HA2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HA2&quot;</span><span class="p">:</span><span class="s2">&quot;HA3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HB1&quot;</span><span class="p">:</span><span class="s2">&quot;HB2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HB2&quot;</span><span class="p">:</span><span class="s2">&quot;HB3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HBR&quot;</span><span class="p">:</span><span class="s2">&quot;HB2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HBS&quot;</span><span class="p">:</span><span class="s2">&quot;HB3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HGR&quot;</span><span class="p">:</span><span class="s2">&quot;HG2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HGS&quot;</span><span class="p">:</span><span class="s2">&quot;HG3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HDR&quot;</span><span class="p">:</span><span class="s2">&quot;HD2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HDS&quot;</span><span class="p">:</span><span class="s2">&quot;HD3&quot;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="c1"># Conversions not used for certain residues (given below)</span>
  <span class="n">conditionalConversion</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;HG1&quot;</span><span class="p">:</span><span class="s2">&quot;HG2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HG2&quot;</span><span class="p">:</span><span class="s2">&quot;HG3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HD1&quot;</span><span class="p">:</span><span class="s2">&quot;HD2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HD2&quot;</span><span class="p">:</span><span class="s2">&quot;HD3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HE1&quot;</span><span class="p">:</span><span class="s2">&quot;HE2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HE2&quot;</span><span class="p">:</span><span class="s2">&quot;HE3&quot;</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">conditionalResidueTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PHE&#39;</span><span class="p">,</span> <span class="s1">&#39;TYR&#39;</span><span class="p">,</span> <span class="s1">&#39;TRP&#39;</span><span class="p">,</span> <span class="s1">&#39;HIS&#39;</span><span class="p">,</span> <span class="s1">&#39;THR&#39;</span><span class="p">]</span>

  <span class="n">allAtomNames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

  <span class="n">project</span> <span class="o">=</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">_project</span>
  <span class="n">sequenceCodeMap</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
    <span class="n">sequenceCode</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">sequenceCode</span>
    <span class="k">if</span> <span class="n">sequenceCode</span> <span class="ow">in</span> <span class="n">sequenceCodeMap</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate sequenceCode </span><span class="si">%s</span><span class="s2"> in project chains. Aborting&quot;</span> <span class="o">%</span> <span class="n">sequenceCode</span><span class="p">)</span>
    <span class="c1"># NB we convert sequenceCode to int 1) for sorting, 2) because non-int examples will not appear</span>
    <span class="n">sequenceCodeMap</span><span class="p">[</span><span class="n">sequenceCode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">shortName</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residue</span><span class="o">.</span><span class="n">residueType</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>

    <span class="c1"># ignore empty and comment lines</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;#!&#39;</span><span class="p">:</span>
      <span class="k">continue</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="n">upper</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">upper</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
      <span class="n">upper</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">target</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
      <span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">atomId</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
      <span class="n">dummy</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">atomName</span> <span class="o">=</span> <span class="n">atomId</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
      <span class="n">residueType</span><span class="p">,</span> <span class="n">sequenceCode</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="n">sequenceCodeMap</span><span class="p">[</span><span class="n">sequenceCode</span><span class="p">]</span>

      <span class="n">ss</span> <span class="o">=</span> <span class="n">conversion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">ss</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ss2</span> <span class="o">=</span> <span class="n">conditionalConversion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomName</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ss2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">conditionalResidueTypes</span> <span class="k">if</span> <span class="n">residueType</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)]):</span>
          <span class="c1"># do conditional name conversion</span>
          <span class="n">atomName</span> <span class="o">=</span> <span class="n">ss2</span>
        <span class="k">elif</span> <span class="n">atomName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span> <span class="ow">and</span> <span class="n">atomName</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
          <span class="n">atomName</span> <span class="o">=</span> <span class="n">atomName</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">atomName</span> <span class="o">=</span> <span class="n">ss</span>

      <span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">atomName</span><span class="p">,</span> <span class="n">residueType</span><span class="p">))</span>

      <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tt</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomName</span><span class="p">,)))</span>
    <span class="n">restraintList</span><span class="o">.</span><span class="n">createSimpleRestraint</span><span class="p">(</span><span class="n">lowerLimit</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upperLimit</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span> <span class="n">targetValue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                                        <span class="n">restraintItems</span><span class="o">=</span><span class="p">(</span><span class="n">items</span><span class="p">,))</span>

  <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allAtomNames</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1">:&quot;&quot;,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span><span class="p">,))</span></div>



<div class="viewcode-block" id="parseCyanaPeakList"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.parseCyanaPeakList">[docs]</a><span class="k">def</span> <span class="nf">parseCyanaPeakList</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parse cyana peakList, returning labels (in order) and a list of lines, one per peak&quot;&quot;&quot;</span>

  <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
  <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
      <span class="n">upperline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
      <span class="k">if</span> <span class="s1">&#39; DIMENSIONS&#39;</span> <span class="ow">in</span> <span class="n">upperline</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">dimensionCount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">dimensionCount</span>
      <span class="k">elif</span> <span class="s1">&#39;INAME&#39;</span> <span class="ow">in</span> <span class="n">upperline</span><span class="p">:</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="loadCasdRdcList"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.loadCasdRdcList">[docs]</a><span class="k">def</span> <span class="nf">loadCasdRdcList</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Load RDC constraint lists from CASD rdc file&quot;&quot;&quot;</span>
  <span class="n">chainCode</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shortName</span>

  <span class="n">dataSet</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dataSets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

  <span class="c1"># Get list name</span>
  <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">basename</span><span class="p">:</span>
    <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
  <span class="n">name</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>

  <span class="n">restraintLists</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="s1">&#39;#!&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
          <span class="c1"># restraint</span>
          <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
          <span class="n">sq1</span><span class="p">,</span> <span class="n">type1</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">sq2</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">atom2</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
          <span class="n">restraintItems</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sq1</span><span class="p">,</span> <span class="n">type1</span><span class="p">,</span> <span class="n">atom1</span><span class="p">)),</span>
                             <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sq2</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>
                             <span class="p">),)</span>
          <span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">]]</span>
          <span class="n">restraintList</span> <span class="o">=</span> <span class="n">restraintLists</span><span class="p">[</span><span class="n">orientation</span><span class="p">]</span>
          <span class="n">restraintList</span><span class="o">.</span><span class="n">createSimpleRestraint</span><span class="p">(</span><span class="n">targetValue</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                                              <span class="n">restraintItems</span><span class="o">=</span><span class="n">restraintItems</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># Restraint list description</span>
          <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
          <span class="n">orientation</span><span class="p">,</span> <span class="n">magnitude</span><span class="p">,</span> <span class="n">rhombicity</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
          <span class="n">sequenceCode</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
          <span class="n">usename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>
          <span class="n">restraintList</span> <span class="o">=</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">newRestraintList</span><span class="p">(</span><span class="s1">&#39;Rdc&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">usename</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
                                                   <span class="n">tensorMagnitude</span><span class="o">=</span><span class="n">magnitude</span><span class="p">,</span>
                                                   <span class="n">tensorRhombicity</span><span class="o">=</span><span class="n">rhombicity</span><span class="p">,</span>
                                                   <span class="n">tensorSequenceCode</span><span class="o">=</span><span class="n">sequenceCode</span><span class="p">)</span>
          <span class="n">restraintLists</span><span class="p">[</span><span class="n">orientation</span><span class="p">]</span> <span class="o">=</span> <span class="n">restraintList</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">-=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="loadSimplePeakList"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.loadSimplePeakList">[docs]</a><span class="k">def</span> <span class="nf">loadSimplePeakList</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">peakFile</span><span class="p">,</span> <span class="n">axisCodes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skipColumns</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Ad-hoc HACK - load simple peak table file</span>

<span class="sd">  columns are hardwired&quot;&quot;&quot;</span>

  <span class="n">project</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">_project</span>

  <span class="k">if</span> <span class="n">axisCodes</span><span class="p">:</span>
    <span class="n">reordering</span> <span class="o">=</span> <span class="p">[</span><span class="n">axisCodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">axisCodes</span><span class="p">]</span>

  <span class="n">peakList</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">newPeakList</span><span class="p">()</span>
  <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">peakFile</span><span class="p">):</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;!#&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">[</span><span class="n">skipColumns</span><span class="p">:</span><span class="mi">3</span><span class="o">+</span><span class="n">skipColumns</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">axisCodes</span><span class="p">:</span>
          <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reordering</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">skipColumns</span><span class="p">])</span>
        <span class="n">peakList</span><span class="o">.</span><span class="n">newPeak</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">-=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="loadCyanaPeakList"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.loadCyanaPeakList">[docs]</a><span class="k">def</span> <span class="nf">loadCyanaPeakList</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">peakFile</span><span class="p">,</span> <span class="n">axisCodes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Load unassigned Cyana peak file into spectrum.</span>
<span class="sd">  axisCodes (or spectrum.axisCodes) must be the axisCodes of the sepctrum</span>
<span class="sd">  in the order dimensions appear in the cyana peak file&quot;&quot;&quot;</span>

  <span class="n">project</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">project</span>

  <span class="n">dummy</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">parseCyanaPeakList</span><span class="p">(</span><span class="n">peakFile</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">axisCodes</span><span class="p">:</span>
    <span class="n">reordering</span> <span class="o">=</span> <span class="p">[</span><span class="n">axisCodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">axisCodes</span><span class="p">]</span>

  <span class="n">peakList</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">newPeakList</span><span class="p">()</span>
  <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
      <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]]</span>
      <span class="k">if</span> <span class="n">axisCodes</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reordering</span><span class="p">]</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;volumeError&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
      <span class="n">peakList</span><span class="o">.</span><span class="n">newPeak</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">-=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="loadCasdPeakList"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.loadCasdPeakList">[docs]</a><span class="k">def</span> <span class="nf">loadCasdPeakList</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">nmrPipeScriptFile</span><span class="p">,</span> <span class="n">peakFile</span><span class="p">,</span> <span class="n">spectrumName</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;NB this assumes unassigned, cyana format peak lists, and uses the nmrpipe</span>
<span class="sd">  script file to extract spectrum parameters&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">spectrumName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">peakFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">basename</span><span class="p">:</span>
      <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="n">spectrumName</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
  <span class="n">inp</span> <span class="o">=</span> <span class="n">parseNmrPipeScript</span><span class="p">(</span><span class="n">nmrPipeScriptFile</span><span class="p">)</span>
  <span class="n">labels</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">parseCyanaPeakList</span><span class="p">(</span><span class="n">peakFile</span><span class="p">)</span>

  <span class="n">reordering</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span><span class="p">[</span><span class="s1">&#39;LAB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>

  <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;spectrometerFrequencies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s1">&#39;OBS&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">reordering</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;spectralWidthsHz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s1">&#39;SW&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">reordering</span><span class="p">]</span>
  <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">reordering</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="n">points</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pointCounts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;referencePoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;referenceValues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s1">&#39;CAR&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">reordering</span><span class="p">]</span>

  <span class="c1"># Map axis codes using std Cyana convention for NOESY</span>
  <span class="c1"># NBNB this is a HACK, and not generally valid</span>
  <span class="n">axisCodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;1H&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;13C&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hc&#39;</span>
      <span class="k">elif</span> <span class="s1">&#39;15N&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hn&#39;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span>
    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;13C&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;1H&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Ch&#39;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;15N&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;1H&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Nh&#39;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
    <span class="k">elif</span> <span class="n">code</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="ow">and</span> <span class="s1">&#39;1H&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
      <span class="n">axisCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;axisCodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axisCodes</span>

  <span class="n">isotopeCodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span>
  <span class="n">isotopeCodeMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="s1">&#39;1H&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="s1">&#39;13C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="s1">&#39;15N&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span><span class="s1">&#39;19F&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="s1">&#39;31P&#39;</span><span class="p">}</span>
  <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotopeCodes</span><span class="p">):</span>
    <span class="n">isotopeCodes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">isotopeCodeMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">code</span><span class="p">)</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;isotopeCodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isotopeCodes</span>

  <span class="n">maxPoints</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">acquisitionAxisCode</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;axisCodes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">pointCount</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pointCount</span> <span class="o">&gt;</span> <span class="n">maxPoints</span><span class="p">:</span>
      <span class="n">maxPoints</span> <span class="o">=</span> <span class="n">pointCount</span>
      <span class="n">acquisitionAxisCode</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;axisCodes&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>

  <span class="n">spectrumParameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;acquisitionAxisCode&#39;</span><span class="p">:</span><span class="n">acquisitionAxisCode</span><span class="p">}</span>

  <span class="n">spectrum</span> <span class="o">=</span> <span class="n">CcpnNefIo</span><span class="o">.</span><span class="n">createSpectrum</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">spectrumName</span><span class="p">,</span> <span class="n">spectrumParameters</span><span class="o">=</span><span class="n">spectrumParameters</span><span class="p">,</span>
                                      <span class="n">dimensionData</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

  <span class="n">peakList</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">newPeakList</span><span class="p">()</span>
  <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
      <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]]</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;volumeError&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
      <span class="n">peakList</span><span class="o">.</span><span class="n">newPeak</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">-=</span> <span class="mi">1</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">peakList</span></div>

<div class="viewcode-block" id="readNmrStarChemicalShifts"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.readNmrStarChemicalShifts">[docs]</a><span class="k">def</span> <span class="nf">readNmrStarChemicalShifts</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>  <span class="n">chainOrder</span><span class="o">=</span><span class="s1">&#39;CAB&#39;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Read chemical shifts from star file at path into project</span>

<span class="sd">  chainOrder are the vhsinCOdes to use, in order of the BMRB entity codes&quot;&quot;&quot;</span>
  <span class="n">dataExtent</span> <span class="o">=</span> <span class="n">StarIo</span><span class="o">.</span><span class="n">parseNmrStarFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wrapInDataBlock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">dataBlock</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataExtent</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">newShiftLists</span> <span class="o">=</span> <span class="n">loadNmrStarChemicalShifts</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">dataBlock</span><span class="p">,</span> <span class="n">chainOrder</span><span class="o">=</span><span class="n">chainOrder</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">nmrChain</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">:</span>
    <span class="n">alignNmrChain</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">)</span>
    <span class="n">collapseXH3Groups</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">)</span>
    <span class="n">convertBmrbAmbiguousAtoms</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="alignNmrChain"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.alignNmrChain">[docs]</a><span class="k">def</span> <span class="nf">alignNmrChain</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Correct sequenceCodes in an assigned nmrChain to compensate for a sequence offset</span>
<span class="sd">  relative to the molecular system.</span>

<span class="sd">  Will only modify data if all residues match in the result, but not in the starting</span>
<span class="sd">  situation, and will choose the smallest (most negative) value of offset that achieves this.&quot;&quot;&quot;</span>

  <span class="n">chain</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">chain</span>
  <span class="k">if</span> <span class="n">chain</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">return</span>

  <span class="n">reference</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="n">x</span><span class="o">.</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">residueType</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residues</span>
                           <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">residueType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">))</span>
  <span class="n">sequence</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="n">x</span><span class="o">.</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">residueType</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">nmrResidues</span>
                           <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">residueType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">))</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">MoleculeLib</span><span class="o">.</span><span class="n">sequenceMatchOffset</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">offset</span><span class="p">:</span>
    <span class="c1"># reassign all NmrResidues in chain with offset</span>
    <span class="c1"># NB we need to deassign first, to avoid potential name clashes</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">nmrResidues</span><span class="p">:</span>
      <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span><span class="p">))</span>
      <span class="n">nmrResidue</span><span class="o">.</span><span class="n">deassign</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
      <span class="n">nmrResidue</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">sequenceCode</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span>
                          <span class="n">residueType</span><span class="o">=</span><span class="n">residueType</span><span class="p">)</span></div>


<div class="viewcode-block" id="loadNmrStarChemicalShifts"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.loadNmrStarChemicalShifts">[docs]</a><span class="k">def</span> <span class="nf">loadNmrStarChemicalShifts</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">nmrStarDatablock</span><span class="p">,</span><span class="n">chainOrder</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ChemicalShiftList&#39;</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Extract NmrStar ChemicalShifts to new ChemicalShiftList.</span>
<span class="sd">  Chains will be named A, B, ... taking the next free letter</span>

<span class="sd">  NB This is a quick hack. E.g.No use is made of author naming info.&quot;&quot;&quot;</span>

  <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">defaultChainCodeValues</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>
  <span class="n">chainCodes</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">chainCodeIndex</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">chainCodeValues</span> <span class="o">=</span> <span class="n">chainOrder</span> <span class="ow">or</span> <span class="n">defaultChainCodeValues</span>

  <span class="n">shiftFrames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nmrStarDatablock</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;assigned_chemical_shifts&#39;</span><span class="p">]</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">shiftFrames</span><span class="p">:</span>
    <span class="k">return</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shiftFrames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING, multiple shift lists:&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shiftFrames</span><span class="p">))</span>


  <span class="n">blockName</span> <span class="o">=</span> <span class="n">nmrStarDatablock</span><span class="o">.</span><span class="n">name</span>
  <span class="k">for</span> <span class="n">shiftSaveFrame</span> <span class="ow">in</span> <span class="n">shiftFrames</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">shiftSaveFrame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_chem_shift&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shiftFrames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">blockName</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">blockName</span><span class="p">,</span> <span class="n">shiftSaveFrame</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">chemicalShiftList</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">newChemicalShiftList</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                     <span class="n">autoUpdate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                     <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Loaded from NmrStar&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chemicalShiftList</span><span class="p">)</span>
    <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">loop</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">entityId</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entity_assembly_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entityId</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">entityId</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entity_id&#39;</span><span class="p">)</span>
        <span class="n">chainCode</span> <span class="o">=</span> <span class="n">chainCodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entityId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chainCode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">chainCode</span> <span class="o">=</span> <span class="n">chainCodeValues</span><span class="p">[</span><span class="n">chainCodeIndex</span><span class="p">]</span>
          <span class="n">chainCodeIndex</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">chainCodes</span><span class="p">[</span><span class="n">entityId</span><span class="p">]</span> <span class="o">=</span> <span class="n">chainCode</span>
        <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">fetchNmrChain</span><span class="p">(</span><span class="n">chainCode</span><span class="p">)</span>

        <span class="n">sequenceCode</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;seq_id&#39;</span><span class="p">]</span>
        <span class="n">residueType</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;comp_id&#39;</span><span class="p">]</span>

        <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">fetchNmrResidue</span><span class="p">(</span><span class="n">sequenceCode</span><span class="o">=</span><span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="o">=</span><span class="n">residueType</span><span class="p">)</span>

        <span class="n">atomName</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;atom_id&#39;</span><span class="p">]</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_type&#39;</span><span class="p">)</span>
        <span class="n">massNumber</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atom_isotope_number&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nucleus</span> <span class="ow">and</span> <span class="n">massNumber</span><span class="p">:</span>
          <span class="n">isotopeCode</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">massNumber</span><span class="p">,</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">isotopeCode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ambiguityCode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ambiguity_code&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ambiguityCode</span><span class="p">:</span>
          <span class="n">ambiguityCode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ambiguityCode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="c1"># Ungainly and slow.</span>
          <span class="c1"># But we want to use New, in order to pass in the isotopeCode</span>
          <span class="c1"># (just in case the name does not start with the right letter)</span>
          <span class="c1"># And we want to get the previous atom when there is one.</span>
          <span class="c1">#&#39; This also avoids messing with remapping names with dots in etc.</span>
          <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">newNmrAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">atomName</span><span class="p">,</span> <span class="n">isotopeCode</span><span class="o">=</span><span class="n">isotopeCode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">fetchNmrAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">atomName</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">ccpnInternalData</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dd</span><span class="p">:</span>
          <span class="n">dd</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">ccpnInternalData</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># NB when the same NmrAtom appears twice we get the ambiguity code</span>
        <span class="c1"># and original name from the LAST occurrence</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ambiguityCode&#39;</span><span class="p">:</span><span class="n">ambiguityCode</span><span class="p">,</span> <span class="s1">&#39;originalName&#39;</span><span class="p">:</span><span class="n">atomName</span><span class="p">})</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_err&#39;</span><span class="p">)</span>
        <span class="n">chemicalShift</span> <span class="o">=</span> <span class="n">chemicalShiftList</span><span class="o">.</span><span class="n">newChemicalShift</span><span class="p">(</span><span class="n">nmrAtom</span><span class="o">=</span><span class="n">nmrAtom</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
          <span class="n">valueError</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Original name: </span><span class="si">%s</span><span class="s1">, ambiguityCode: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomName</span><span class="p">,</span> <span class="n">ambiguityCode</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="n">project</span><span class="o">.</span><span class="n">_appBase</span><span class="o">.</span><span class="n">_echoBlocking</span> <span class="o">-=</span> <span class="mi">1</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="collapseXH3Groups"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.collapseXH3Groups">[docs]</a><span class="k">def</span> <span class="nf">collapseXH3Groups</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">:</span><span class="s1">&#39;NmrChain&#39;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convert triplets of NmrAtoms to single CH3/NH3 NmrAtoms</span>
<span class="sd">  and change &#39;*&#39; to &#39;%&#39;.</span>

<span class="sd">  Triplets Habc1,Habc2,Habc3 will be converted to Habc%</span>
<span class="sd">  provided they are not of the form &#39;Hijk&#39; or &#39;H@ijk&#39; where &#39;ijk&#39; is an integer.</span>


<span class="sd">  NB This will miss N-terminal NH3 groups, but the alternative might catch</span>
<span class="sd">  non-XH3 groups.&quot;&quot;&quot;</span>

  <span class="n">chainCode</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">shortName</span>

  <span class="c1"># group protons into potential XH3 groups</span>
  <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">nmrResidues</span><span class="p">:</span>

    <span class="n">sequenceCode</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">sequenceCode</span>
    <span class="n">residueType</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span>
      <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;123&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;123&#39;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())):</span>
          <span class="c1"># The first line should recognise methyl groups, but not</span>
          <span class="c1"># E.g. H11,H12,H13, which could be a small molecule</span>
          <span class="c1"># This heuristic will treat anything up to H33 as single</span>
          <span class="c1"># and higher numbers as methyls if there is a triplet</span>
          <span class="n">prefix</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">ll</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="p">[])</span>
          <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">)</span>
          <span class="n">groups</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>

      <span class="k">elif</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
        <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">newName</span><span class="p">)</span>


    <span class="c1"># Merge and rename XH3 group NmrAtoms</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">getNmrAtom</span><span class="p">(</span><span class="n">newName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="c1"># NB by the nature of the preceding loop the names CAN ONLY be</span>
          <span class="c1"># `prefix&gt;`1, `prefix`2, `prefix`3</span>
          <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
            <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">newName</span><span class="p">,</span> <span class="n">mergeToExisting</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">nmrChain</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot create new XH3 group </span><span class="si">%s</span><span class="s2"> - group already exists&quot;</span>
                                         <span class="o">%</span> <span class="n">previous</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span></div>

<div class="viewcode-block" id="convertBmrbAmbiguousAtoms"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.convertBmrbAmbiguousAtoms">[docs]</a><span class="k">def</span> <span class="nf">convertBmrbAmbiguousAtoms</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convert NmrAtoms with na.ccpnInternalData[&#39;ambiguityCode&#39;] 2 or 3</span>
<span class="sd">  to the &#39;xy&#39; convention.</span>
<span class="sd">  Names are of form &#39;Nabi&#39;  or &#39;Nabi%&#39; or &#39;NAbi*&#39; where &#39;N&#39; is a one-letter nucleus code.</span>
<span class="sd">  &#39;ab&#39; is any string that is not an integer or &#39;@&#39; followed by an integer</span>
<span class="sd">  and &#39;i&#39; is 1, 2 or 3.</span>
<span class="sd">  The new names will be of the form &#39;Nabx&#39; or &#39;Naby&#39; or &#39;Nabx%&#39;, &#39;Naby%&#39;</span>

<span class="sd">  If &#39;abi&#39; for one nucleus name matches &#39;abi&#39; for another nucleus name,</span>
<span class="sd">  (e.g. HG1 and CG1), both will match after name substitution (to e.g. HGx and CGx)</span>
<span class="sd">  In these cases, if ANY nucleus is ambiguous, all will be treated as ambiguous.</span>

<span class="sd">  If matching names are found for i==1, i==2, and i==3, (should not happen), no changes are made</span>

<span class="sd">  NBNB inconsistent ambiguity codes are NOT guaranteed to give sensible results</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">chainCode</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">shortName</span>

  <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">nmrResidues</span><span class="p">:</span>

    <span class="n">sequenceCode</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">sequenceCode</span>
    <span class="n">residueType</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span>

    <span class="n">type4NmrAtoms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># group NmrAtoms into potential matching groups</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span>

      <span class="n">dd2</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">ccpnInternalData</span>
      <span class="k">if</span> <span class="n">dd2</span><span class="p">:</span>
        <span class="n">ambiguityCode</span> <span class="o">=</span> <span class="n">dd2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ambiguityCode&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">ambiguityCode</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">if</span> <span class="n">ambiguityCode</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># interresidue ambiguity</span>
        <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">ambiguityCode</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="c1"># interchain ambiguity</span>
        <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">ambiguityCode</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="c1"># unknown ambiguity</span>
        <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sequenceCode</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">residueType</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">ambiguityCode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># intraresidue ambiguity</span>
        <span class="n">type4NmrAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">)</span>

      <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
        <span class="c1"># special case, ambiguous atom pairs ending in &#39; or &#39;&#39;</span>
        <span class="c1"># Deal with them singly</span>
        <span class="k">if</span> <span class="n">ambiguityCode</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
          <span class="c1"># Ambiguous = set the name</span>
          <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">):</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;y&#39;</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span>
          <span class="c1"># NB, if the name is already taken we get a nameclash</span>
          <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">newName</span><span class="p">)</span>

      <span class="c1"># elif name.endswith(&#39;&quot;&#39;):</span>
      <span class="c1">#   # Should not happen, but it looks like &quot; can be used instead of &#39;&#39;        dd2 = nmrAtom.ccpnInternalData</span>
      <span class="c1">#   dd2 = nmrAtom.ccpnInternalData</span>
      <span class="c1">#   if dd2:</span>
      <span class="c1">#     xx = dd2.get(&#39;ambiguityCode&#39;)</span>
      <span class="c1">#     if xx in (&#39;2&#39;,&#39;3&#39;):</span>
      <span class="c1">#       # Ambiguous = set the name</span>
      <span class="c1">#       newName = name[:-1] + &#39;y&#39;</span>
      <span class="c1">#       # NB, if the name is already taken we get a nameclash</span>
      <span class="c1">#       print (&#39;@~@~newName&#39;, newName)</span>
      <span class="c1">#       nmrAtom.assignTo(chainCode, sequenceCode, residueType, newName)</span>
      <span class="c1">#       nmrAtom.ccpnInternalData[&#39;originalName&#39;] = name</span>


      <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;123&#39;</span><span class="p">:</span>
          <span class="n">locator</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;%*&#39;</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;123&#39;</span><span class="p">:</span>
          <span class="n">locator</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
          <span class="n">indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">locator</span> <span class="ow">or</span> <span class="n">locator</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">locator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span> <span class="ow">and</span> <span class="n">locator</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">):</span>
          <span class="k">continue</span>

        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">locator</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">groups</span><span class="p">[</span><span class="n">locator</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nucleus</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
        <span class="n">dd</span><span class="p">[</span><span class="n">nucleus</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll</span>
        <span class="n">ll</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmrAtom</span>

    <span class="k">if</span> <span class="n">type4NmrAtoms</span><span class="p">:</span>
      <span class="c1"># We have ambiguous-in-residue atoms. name them.</span>
      <span class="n">type4NmrAtoms</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">type4NmrAtoms</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">nmrAtom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">type4NmrAtoms</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">ii</span><span class="p">]</span>
        <span class="n">newName</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">newName</span><span class="p">)</span>

    <span class="c1"># Rename to &#39;XY&#39; name form</span>
    <span class="k">for</span> <span class="n">locator</span><span class="p">,</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

      <span class="c1"># Remove indices where there are no NmrAtoms, and check for ambiguity codes:</span>
      <span class="n">ambiguityCode</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

          <span class="n">na</span> <span class="o">=</span> <span class="n">ll</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
          <span class="k">if</span> <span class="n">na</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dd2</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">ccpnInternalData</span>
            <span class="k">if</span> <span class="n">dd2</span><span class="p">:</span>
              <span class="n">xx</span> <span class="o">=</span> <span class="n">dd2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ambiguityCode&#39;</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ambiguityCode</span> <span class="o">=</span> <span class="n">xx</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">ll2</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">ll2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">ambiguityCode</span><span class="p">:</span>
        <span class="c1"># There are ambiguous atoms (code 2=geminal or code 3=aromatic ring)</span>
        <span class="c1"># Set ALL matching names with ambiguous XY names</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
          <span class="c1"># We now have one or two atoms for each nucleus.</span>
          <span class="c1"># Rename first slot as x, second slot as y</span>
          <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;xy&#39;</span>
          <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;%*&#39;</span><span class="p">:</span>
                  <span class="n">newName</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="n">newName</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="c1"># NB, if the name is already taken we get a nameclash</span>
                <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignTo</span><span class="p">(</span><span class="n">chainCode</span><span class="p">,</span> <span class="n">sequenceCode</span><span class="p">,</span> <span class="n">residueType</span><span class="p">,</span> <span class="n">newName</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># There are NmrAtoms with names ending all of 1,2,3</span>
          <span class="c1"># This is not a clear case - do nothing</span>
          <span class="n">nmrChain</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;ambigous assignments, code </span><span class="si">%s</span><span class="s2">, not renamed to &#39;xy&#39; name - inconsistent set: </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">ambiguityCode</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">])</span>
          <span class="p">)</span></div>

<div class="viewcode-block" id="remapRestraintItems"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.remapRestraintItems">[docs]</a><span class="k">def</span> <span class="nf">remapRestraintItems</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Remap restraintItems from original names to massaged names</span>

<span class="sd">  - relies on NmrAtom.ccpnInternalData[&#39;originalName&#39;] being set&quot;&quot;&quot;</span>
  <span class="n">remap</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>
    <span class="n">atomId</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">_id</span>
    <span class="n">originalName</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">ccpnInternalData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;originalName&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">originalName</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">atomId</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atomId</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;XY&#39;</span><span class="p">:</span>
          <span class="n">origId</span> <span class="o">=</span> <span class="n">atomId</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">originalName</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># CH3 groups are already correct</span>
          <span class="n">origId</span> <span class="o">=</span> <span class="n">atomId</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">stub</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">atomId</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">origId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stub</span><span class="p">,</span> <span class="n">originalName</span><span class="p">)</span>
      <span class="n">remap</span><span class="p">[</span><span class="n">origId</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomId</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">remap</span><span class="p">[</span><span class="n">atomId</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomId</span>

  <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">restraintContributions</span><span class="p">:</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">contribution</span><span class="o">.</span><span class="n">restraintItems</span><span class="p">:</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">remap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">ss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;O%&#39;</span><span class="p">:</span>
            <span class="n">project</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---&gt; Restraint item </span><span class="si">%s</span><span class="s2"> could not be found in restraint map - </span><span class="si">%s</span><span class="s2">&quot;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">contribution</span><span class="p">))</span>
          <span class="n">val</span> <span class="o">=</span> <span class="n">ss</span>
        <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
      <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="n">contribution</span><span class="o">.</span><span class="n">restraintItems</span> <span class="o">=</span> <span class="n">items</span></div>

<div class="viewcode-block" id="loadDocrProject"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.loadDocrProject">[docs]</a><span class="k">def</span> <span class="nf">loadDocrProject</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">projectPath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">bmrbEntryPath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">casdDirectory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">chainOrder</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Project&#39;</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Load DOCR project, reading chemical shifts from bmrbEntryPath,</span>
<span class="sd">  with allowance for ambiguity codes 2 and 3, mapping  restraints to match</span>
<span class="sd">  NmrAtom names</span>

<span class="sd">  If casdDirectory is given, read peak lists from std Montelions CASD-2013 file structure</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># Get project</span>
  <span class="kn">from</span> <span class="nn">ccpn.framework.Framework</span> <span class="kn">import</span> <span class="n">getFramework</span>
  <span class="n">application</span> <span class="o">=</span> <span class="n">getFramework</span><span class="p">()</span>
  <span class="n">project</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">loadProject</span><span class="p">(</span><span class="n">projectPath</span><span class="p">)</span>

  <span class="c1"># Save project with new name - done now to get right name and path for further operations</span>
  <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">projectPath</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">basename</span><span class="p">:</span>
    <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
  <span class="n">projectPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
  <span class="n">project</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">projectPath</span><span class="p">)</span>

  <span class="n">nefPath</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;.raw.nef&#39;</span>
  <span class="n">CcpnNefIo</span><span class="o">.</span><span class="n">saveNefProject</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">nefPath</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ccpn&#39;</span><span class="p">,))</span>

  <span class="c1"># Correct restraint item names to avoid ambiguous CCPN names</span>
  <span class="n">cleanUpDocrProject</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

  <span class="n">nefPath</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;.cleaned.nef&#39;</span>
  <span class="n">CcpnNefIo</span><span class="o">.</span><span class="n">saveNefProject</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">nefPath</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ccpn&#39;</span><span class="p">,))</span>

  <span class="c1"># Load chemical shifts from BMRB file</span>
  <span class="n">readNmrStarChemicalShifts</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">bmrbEntryPath</span><span class="p">,</span> <span class="n">chainOrder</span><span class="o">=</span><span class="n">chainOrder</span><span class="p">)</span>

  <span class="c1"># remap restraint items to use new names</span>
  <span class="n">remapRestraintItems</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

  <span class="n">project</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
  <span class="c1">#</span>
  <span class="k">return</span> <span class="n">project</span></div>

<div class="viewcode-block" id="loadCasdData"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.loadCasdData">[docs]</a><span class="k">def</span> <span class="nf">loadCasdData</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">casdDirectory</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;&quot;AD-HOC function: Load Montelione CASD data - with file names hardwired&quot;&quot;&quot;</span>

  <span class="c1"># Remove restraint lists = we read in those from the CASD data</span>
  <span class="n">dataSet</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dataSets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">restraintList</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="o">.</span><span class="n">restraintLists</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">restraintList</span><span class="o">.</span><span class="n">restraintType</span> <span class="o">==</span> <span class="s1">&#39;Rdc&#39;</span><span class="p">:</span>
      <span class="n">restraintList</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

  <span class="c1"># Read spectrum parameters and peakLists</span>
  <span class="k">for</span> <span class="n">peakFile</span><span class="p">,</span> <span class="n">scriptFile</span> <span class="ow">in</span> <span class="p">(</span>
      <span class="c1">#(&#39;simnoe_15N_final.peaks&#39;, &#39;simnoesy/Convert_N15_noesy_HSQC.csh&#39;),</span>
      <span class="p">(</span><span class="s1">&#39;final_peaks/alinoe_final.peaks&#39;</span><span class="p">,</span> <span class="s1">&#39;simnoesy/Convert_C13_noesy_HSQC.csh&#39;</span><span class="p">),</span>
      <span class="p">(</span><span class="s1">&#39;final_peaks/aronoe_final.peaks&#39;</span><span class="p">,</span> <span class="s1">&#39;aronoesy/Convert_C13_noesy_HSQC.csh&#39;</span><span class="p">),</span>
  <span class="p">):</span>
    <span class="n">scriptPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casdDirectory</span><span class="p">,</span> <span class="n">scriptFile</span><span class="p">)</span>
    <span class="n">peakPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casdDirectory</span><span class="p">,</span> <span class="n">peakFile</span><span class="p">)</span>
    <span class="n">loadCasdPeakList</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">scriptPath</span><span class="p">,</span> <span class="n">peakPath</span><span class="p">)</span>

  <span class="c1"># # Read .rdc files - NB do not need remapping</span>
  <span class="c1"># for ss in os.listdir(casdDirectory):</span>
  <span class="c1">#   if ss.endswith(&#39;.rdc&#39;):</span>
  <span class="c1">#     path = os.path.join(casdDirectory, ss)</span>
  <span class="c1">#     loadCasdRdcList(project, path)</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casdDirectory</span><span class="p">,</span> <span class="s1">&#39;final_peaks/cya.rdc&#39;</span><span class="p">)</span>
  <span class="n">loadCasdRdcList</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

  <span class="c1">#</span>
  <span class="n">project</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<span class="c1"># def cleanUpRestraintNames(project):</span>
<span class="c1">#   &quot;&quot;&quot;Change strange restraint names to sensible ones</span>
<span class="c1">#</span>
<span class="c1">#   NBNB Ad-hoc hack&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#   conversion = {</span>
<span class="c1">#     &quot;H2&#39;1&quot;:&quot;H2&#39;&quot;,</span>
<span class="c1">#     &quot;H2&#39;2&quot;:&quot;H2&#39;&#39;&quot;,</span>
<span class="c1">#     &quot;H5&#39;1&quot;:&quot;H5&#39;&quot;,</span>
<span class="c1">#     &quot;H5&#39;2&quot;:&quot;H5&#39;&#39;&quot;,</span>
<span class="c1">#     &quot;H5M*&quot;:&quot;H7%&quot;,</span>
<span class="c1">#     &quot;H5MX&quot;:&quot;H7%&quot;,</span>
<span class="c1">#   }</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#   for contribution in project.restraintContributions:</span>
<span class="c1">#     items = []</span>
<span class="c1">#     for tt in contribution.restraintItems:</span>
<span class="c1">#       ll = []</span>
<span class="c1">#       for atomId in tt:</span>
<span class="c1">#         res, nam = atomId.rsplit(&#39;.&#39;,1)</span>
<span class="c1">#         nam2 = conversion.get(nam)</span>
<span class="c1">#         print (&#39;---&gt;&#39;, res, nam, nam2)</span>
<span class="c1">#         if nam2 is not None:</span>
<span class="c1">#           print (&#39;@~@~ renaming&#39;, res, nam, nam2)</span>
<span class="c1">#           atomId = &#39;%s.%s&#39; % (res, nam2)</span>
<span class="c1">#         ll.append(atomId)</span>
<span class="c1">#       if not ll in items:</span>
<span class="c1">#         # Skip duplicates</span>
<span class="c1">#         items.append(ll)</span>
<span class="c1">#     contribution.restraintItems = items</span>

<div class="viewcode-block" id="cleanUpDocrProject"><a class="viewcode-back" href="../../../../ccpn/ccpn.core.lib.html#ccpn.core.lib.DataIo.cleanUpDocrProject">[docs]</a><span class="k">def</span> <span class="nf">cleanUpDocrProject</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Clean up DOCR project - converting restraints to ambiguous atoms</span>
<span class="sd">  (e.g. HBa/HBb) to restraints to % atoms (e.g. HB%).</span>
<span class="sd">  This is SPECIFIC for DOCR projects, since it appears that only HB% type</span>
<span class="sd">  restraints appear as HBa/HBb&quot;&quot;&quot;</span>

  <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">restraintContributions</span><span class="p">:</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">contribution</span><span class="o">.</span><span class="n">restraintItems</span><span class="p">:</span>
      <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">atomId</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atomId</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;5X&#39;</span><span class="p">,</span> <span class="s1">&#39;5Y&#39;</span><span class="p">):</span>
          <span class="c1"># Special case - DNA/RNA H5&#39;/H5&#39;&#39;</span>
          <span class="c1"># We cannot do that for H2&#39;/H2&#39;&#39; as H2X could be other things as well</span>
          <span class="n">atomId</span> <span class="o">=</span> <span class="n">atomId</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;*&quot;</span>
        <span class="k">elif</span> <span class="n">atomId</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;XY&#39;</span><span class="p">:</span>
          <span class="n">atomId</span> <span class="o">=</span> <span class="n">atomId</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
        <span class="k">elif</span> <span class="n">atomId</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;X%&#39;</span><span class="p">,</span> <span class="s1">&#39;Y%&#39;</span><span class="p">):</span>
          <span class="n">atomId</span> <span class="o">=</span> <span class="n">atomId</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
        <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomId</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="c1"># Skip duplicates</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="n">contribution</span><span class="o">.</span><span class="n">restraintItems</span> <span class="o">=</span> <span class="n">items</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="n">name</span><span class="p">,</span> <span class="n">projectPath</span><span class="p">,</span> <span class="n">bmrbEntryPath</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
  <span class="n">projectPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">projectPath</span><span class="p">))</span>
  <span class="n">bmrbEntryPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">bmrbEntryPath</span><span class="p">))</span>
  <span class="c1"># project = loadDocrProject(name, projectPath, bmrbEntryPath, chainOrder=&#39;CAB&#39;)</span>
  <span class="n">project</span> <span class="o">=</span> <span class="n">loadDocrProject</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">projectPath</span><span class="p">,</span> <span class="n">bmrbEntryPath</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
    <span class="n">casdDirectory</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">casdDirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">casdDirectory</span><span class="p">))</span>
    <span class="n">loadCasdData</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">casdDirectory</span><span class="p">)</span>
    <span class="n">project</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


  <span class="c1"># projectPath, dataPath = sys.argv[1:3]</span>
  <span class="c1"># dataPath = os.path.normpath(os.path.abspath(dataPath))</span>
  <span class="c1"># project = getProject(projectPath)</span>
  <span class="c1"># importInsightRestraints(project, dataPath)</span>
  <span class="c1"># remapRestraintItems(project)</span>
  <span class="c1"># project.save()</span>



  <span class="n">nefPath</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;.nef&#39;</span>
  <span class="n">CcpnNefIo</span><span class="o">.</span><span class="n">saveNefProject</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">nefPath</span><span class="p">,</span> <span class="n">overwriteExisting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skipPrefixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ccpn&#39;</span><span class="p">,))</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>