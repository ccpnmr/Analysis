
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ccpn.AnalysisAssign.modules.SequenceGraph &#8212; Python  documentation</title>
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpn.AnalysisAssign.modules.SequenceGraph</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module Documentation here</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2019&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Ed Brooksbank, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Skinner, S.P., Fogh, R.H., Boucher, W., Ragan, T.J., Mureddu, L.G., &amp; Vuister, G.W.&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;CcpNmr AnalysisAssign: a flexible platform for integrated NMR analysis&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;J.Biomol.Nmr (2016), 66, 111-124, http://doi.org/10.1007/s10858-016-0060-y&quot;</span><span class="p">)</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:32:21 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.0 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2016-05-23 10:02:47 +0100 (Thu, 26 May 2016) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">ccpn.util.OrderedSet</span> <span class="kn">import</span> <span class="n">OrderedSet</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.Pid</span> <span class="kn">import</span> <span class="n">Pid</span>
<span class="kn">from</span> <span class="nn">ccpn.core.NmrAtom</span> <span class="kn">import</span> <span class="n">NmrAtom</span>
<span class="kn">from</span> <span class="nn">ccpn.core.NmrResidue</span> <span class="kn">import</span> <span class="n">NmrResidue</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Peak</span> <span class="kn">import</span> <span class="n">Peak</span>
<span class="kn">from</span> <span class="nn">ccpn.core.Spectrum</span> <span class="kn">import</span> <span class="n">Spectrum</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.AssignmentLib</span> <span class="kn">import</span> <span class="n">getNmrResiduePrediction</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.Notifiers</span> <span class="kn">import</span> <span class="n">Notifier</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.CallBack</span> <span class="kn">import</span> <span class="n">CallBack</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.lib.Strip</span> <span class="kn">import</span> <span class="n">navigateToNmrResidueInDisplay</span><span class="p">,</span> <span class="n">_getCurrentZoomRatio</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.lib.mouseEvents</span> <span class="kn">import</span> <span class="n">makeDragEvent</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Widget</span> <span class="kn">import</span> <span class="n">Widget</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.guiSettings</span> <span class="kn">import</span> <span class="n">textFontSmall</span><span class="p">,</span> <span class="n">textFontSmallBold</span><span class="p">,</span> <span class="n">textFont</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.guiSettings</span> <span class="kn">import</span> <span class="n">getColours</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.guiSettings</span> <span class="kn">import</span> <span class="n">GUINMRATOM_NOTSELECTED</span><span class="p">,</span> <span class="n">GUINMRATOM_SELECTED</span><span class="p">,</span> \
    <span class="n">GUINMRRESIDUE</span><span class="p">,</span> <span class="n">SEQUENCEGRAPHMODULE_LINE</span><span class="p">,</span> <span class="n">SEQUENCEGRAPHMODULE_TEXT</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.modules.CcpnModule</span> <span class="kn">import</span> <span class="n">CcpnModule</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Menu</span> <span class="kn">import</span> <span class="n">Menu</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Icon</span> <span class="kn">import</span> <span class="n">Icon</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.ToolBar</span> <span class="kn">import</span> <span class="n">ToolBar</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.CompoundWidgets</span> <span class="kn">import</span> <span class="n">CheckBoxCompoundWidget</span><span class="p">,</span> <span class="n">ListCompoundWidget</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.PulldownListsForObjects</span> <span class="kn">import</span> <span class="n">NmrChainPulldown</span>
<span class="kn">from</span> <span class="nn">ccpn.core.NmrChain</span> <span class="kn">import</span> <span class="n">NmrChain</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Common</span> <span class="kn">import</span> <span class="n">makeIterableList</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Constants</span> <span class="kn">import</span> <span class="n">ccpnmrJsonData</span>
<span class="kn">from</span> <span class="nn">ccpn.util.Logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.MessageDialog</span> <span class="kn">import</span> <span class="n">showWarning</span><span class="p">,</span> <span class="n">progressManager</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Splitter</span> <span class="kn">import</span> <span class="n">Splitter</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Frame</span> <span class="kn">import</span> <span class="n">Frame</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.modules.SequenceModule</span> <span class="kn">import</span> <span class="n">SequenceModule</span>
<span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.SettingsWidgets</span> <span class="kn">import</span> <span class="n">SequenceGraphSettings</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.AssignmentLib</span> <span class="kn">import</span> <span class="n">getSpinSystemsLocation</span>
<span class="kn">from</span> <span class="nn">ccpn.core.lib.ContextManagers</span> <span class="kn">import</span> <span class="n">notificationEchoBlocking</span><span class="p">,</span> <span class="n">catchExceptions</span><span class="p">,</span> <span class="n">undoBlock</span>
<span class="kn">from</span> <span class="nn">ccpnc.clibrary</span> <span class="kn">import</span> <span class="n">Clibrary</span>


<span class="n">_getNmrIndex</span> <span class="o">=</span> <span class="n">Clibrary</span><span class="o">.</span><span class="n">getNmrResidueIndex</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">()</span>
<span class="n">ALL</span> <span class="o">=</span> <span class="s1">&#39;&lt;all&gt;&#39;</span>


<span class="c1">#==========================================================================================</span>
<span class="c1"># GuiNmrAtom</span>
<span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="GuiNmrAtom"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom">[docs]</a><span class="k">class</span> <span class="nc">GuiNmrAtom</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsTextItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A graphical object specifying the position and name of an atom when created by the Assigner.</span>
<span class="sd">    Can be linked to a Nmr Atom.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mainWindow</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()),</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span> <span class="o">=</span> <span class="n">mainWindow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrAtom</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connectedAtoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># maintain connectivity between guiNmrAtoms</span>
        <span class="c1"># so that lines do not overlap</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setTextInteractionFlags</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextSelectableByMouse</span><span class="p">)</span>

        <span class="c1"># set the highlight colour for dragging to chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colours</span> <span class="o">=</span> <span class="n">getColours</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSelected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultTextColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colours</span><span class="p">[</span><span class="n">GUINMRATOM_SELECTED</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultTextColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colours</span><span class="p">[</span><span class="n">GUINMRATOM_NOTSELECTED</span><span class="p">]))</span>

<div class="viewcode-block" id="GuiNmrAtom.mouseDoubleClickEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom.mouseDoubleClickEvent">[docs]</a>    <span class="k">def</span> <span class="nf">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CCPN INTERNAL - re-implementation of double click event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="GuiNmrAtom.mousePressEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom.mousePressEvent">[docs]</a>    <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CCPN INTERNAL - re-implementation of mouse press event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrAtom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrAtom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span>
            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_raiseContextMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMouseEvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates and raises a context menu enabling items to be disconnected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Menu</span> <span class="kn">import</span> <span class="n">Menu</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

        <span class="n">contextMenu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span><span class="p">(),</span> <span class="n">isFloatWidget</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;deassign all Peaks&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deassignAllPeaksFromNmrAtom</span><span class="p">))</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QCursor</span><span class="p">()</span>
        <span class="n">contextMenu</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">contextMenu</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

<div class="viewcode-block" id="GuiNmrAtom.addConnectedList"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom.addConnectedList">[docs]</a>    <span class="k">def</span> <span class="nf">addConnectedList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connectedAtom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;maintain number of links between adjacent nmrAtoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keyVal</span> <span class="o">=</span> <span class="n">connectedAtom</span>
        <span class="k">if</span> <span class="n">keyVal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="n">keyVal</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="n">keyVal</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="GuiNmrAtom.removeConnectedList"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom.removeConnectedList">[docs]</a>    <span class="k">def</span> <span class="nf">removeConnectedList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connectedAtom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;maintain number of links between adjacent nmrAtoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keyVal</span> <span class="o">=</span> <span class="n">connectedAtom</span>
        <span class="k">if</span> <span class="n">keyVal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="n">keyVal</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Connection does not exist&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GuiNmrAtom.getConnectedList"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom.getConnectedList">[docs]</a>    <span class="k">def</span> <span class="nf">getConnectedList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connectedAtom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve number of links between adjacent nmrAtoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keyVal</span> <span class="o">=</span> <span class="n">connectedAtom</span>
        <span class="k">if</span> <span class="n">keyVal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="n">keyVal</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GuiNmrAtom.clearConnectedList"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom.clearConnectedList">[docs]</a>    <span class="k">def</span> <span class="nf">clearConnectedList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all connections for this guiNmrAtom but do not delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">keyVal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">:</span>
            <span class="n">keyVal</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="n">keyVal</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="GuiNmrAtom.deleteConnectedList"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrAtom.deleteConnectedList">[docs]</a>    <span class="k">def</span> <span class="nf">deleteConnectedList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all connections for this guiNmrAtom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">keyVal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">keyVal</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectedList</span> <span class="o">=</span> <span class="p">{}</span></div></div>


<span class="c1">#==========================================================================================</span>
<span class="c1"># GuiNmrResidue</span>
<span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="GuiNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrResidue">[docs]</a><span class="k">class</span> <span class="nc">GuiNmrResidue</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsTextItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object linking residues displayed in Assigner and Nmr Residues. Contains functionality for drag and</span>
<span class="sd">    drop assignment in conjunction with the Sequence Module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">caAtom</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">mainWindow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">textFontSmall</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colours</span> <span class="o">=</span> <span class="n">getColours</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultTextColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colours</span><span class="p">[</span><span class="n">GUINMRRESIDUE</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">caAtom</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">caAtom</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">caAtom</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItem</span><span class="o">.</span><span class="n">ItemIsSelectable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrResidue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setTextInteractionFlags</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextSelectableByMouse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mouseMoveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create a drag item if left button pressed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">buttons</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">):</span>

            <span class="n">nmrItem</span> <span class="o">=</span> <span class="bp">self</span>

            <span class="k">if</span> <span class="n">nmrItem</span><span class="p">:</span>
                <span class="n">makeDragEvent</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">widget</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">nmrItem</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">pid</span><span class="p">]},</span> <span class="bp">self</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">(),</span> <span class="n">action</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MoveAction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSelected</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">showNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">mouseDoubleClickEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>

    <span class="c1"># def _raiseLineMenu(self, scene, event):</span>
    <span class="c1">#     &quot;&quot;&quot;Creates and raises a context menu enabling items to be disconnected</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     from ccpn.ui.gui.widgets.Menu import Menu</span>
    <span class="c1">#     from functools import partial</span>
    <span class="c1">#</span>
    <span class="c1">#     cursor = QtGui.QCursor()</span>
    <span class="c1">#     contextMenu = Menu(&#39;&#39;, event.widget(), isFloatWidget=True)</span>
    <span class="c1">#     pressed = self.scene.mouseGrabberItem()</span>
    <span class="c1">#</span>
    <span class="c1">#     if self.selectedLine:</span>
    <span class="c1">#         thisLine = self.selectedLine</span>
    <span class="c1">#         contextMenu.addAction(&#39;deassign nmrAtoms from Peak: %s&#39; % str(thisLine._peak.id))</span>
    <span class="c1">#         contextMenu.addSeparator()</span>
    <span class="c1">#         if thisLine._peak:</span>
    <span class="c1">#</span>
    <span class="c1">#             # skip if nothing connected</span>
    <span class="c1">#             if not thisLine._peak.assignedNmrAtoms:</span>
    <span class="c1">#                 return</span>
    <span class="c1">#</span>
    <span class="c1">#             # add the nmrAtoms to the menu</span>
    <span class="c1">#             for nmrAtomList in thisLine._peak.assignedNmrAtoms:</span>
    <span class="c1">#                 for nmrAtom in nmrAtomList:</span>
    <span class="c1">#                     if nmrAtom:</span>
    <span class="c1">#                         contextMenu.addAction(nmrAtom.id, partial(self._deassignPeak, thisLine._peak, nmrAtom))</span>


<span class="c1">#==========================================================================================</span>
<span class="c1"># Assignment line</span>
<span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="AssignmentLine"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.AssignmentLine">[docs]</a><span class="k">class</span> <span class="nc">AssignmentLine</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsLineItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object to create lines between GuiNmrAtoms with specific style, width, colour and displacement.</span>
<span class="sd">    Displacement allows multiplet peak lines to be shown as adjacent lines between the same nmrAtom.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">colour</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
                 <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">peak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">guiAtom1</span><span class="p">:</span> <span class="n">GuiNmrAtom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">guiAtom2</span><span class="p">:</span> <span class="n">GuiNmrAtom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># set the pen colour and style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pen</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="n">colour</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pen</span><span class="o">.</span><span class="n">setCosmetic</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pen</span><span class="o">.</span><span class="n">setWidth</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;dash&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pen</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DotLine</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLine</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1"># store the peak and the guiNmrAtoms that the line connects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak</span> <span class="o">=</span> <span class="n">peak</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="o">=</span> <span class="n">guiAtom1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="o">=</span> <span class="n">guiAtom2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span> <span class="o">=</span> <span class="n">displacement</span>

        <span class="c1"># enable hovering so the current line can be set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptedMouseButtons</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">RightButton</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptHoverEvents</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="AssignmentLine.updateEndPoints"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.AssignmentLine.updateEndPoints">[docs]</a>    <span class="k">def</span> <span class="nf">updateEndPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the endPoints of the line to point. Co-ordinates are relative to the group to</span>
<span class="sd">        which the graphicsItem belongs, in this case the guiNmrResidue group. GuiNmrResidue group is the top level relative to the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guiAtom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiAtom1</span>
        <span class="n">guiAtom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiAtom2</span>
        <span class="n">residue1</span> <span class="o">=</span> <span class="n">guiAtom1</span><span class="o">.</span><span class="n">guiNmrResidueGroup</span>
        <span class="n">residue2</span> <span class="o">=</span> <span class="n">guiAtom2</span><span class="o">.</span><span class="n">guiNmrResidueGroup</span>

        <span class="n">rx1</span> <span class="o">=</span> <span class="n">residue1</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="n">ry1</span> <span class="o">=</span> <span class="n">residue1</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="n">rx2</span> <span class="o">=</span> <span class="n">residue2</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="n">ry2</span> <span class="o">=</span> <span class="n">residue2</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>

        <span class="n">atom1Rect</span> <span class="o">=</span> <span class="n">guiAtom1</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span>
        <span class="n">atom2Rect</span> <span class="o">=</span> <span class="n">guiAtom2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="n">atom1Rect</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">atom1Rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">atom2Rect</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">atom2Rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>

        <span class="n">x1</span> <span class="o">=</span> <span class="n">guiAtom1</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>  <span class="c1"># + rx1</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">guiAtom1</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>  <span class="c1"># + ry1</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">guiAtom2</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">rx2</span> <span class="o">-</span> <span class="n">rx1</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">guiAtom2</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">ry2</span> <span class="o">-</span> <span class="n">ry1</span><span class="p">)</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">guiAtom1</span><span class="o">.</span><span class="n">connectedList</span><span class="p">[</span><span class="n">guiAtom2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">disp</span> <span class="o">=</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displacement</span> <span class="o">-</span> <span class="n">count</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">disp</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">offsetX</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">disp</span>
        <span class="n">offsetY</span> <span class="o">=</span> <span class="o">-</span><span class="n">dx</span> <span class="o">*</span> <span class="n">disp</span>
        <span class="n">kx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>  <span class="c1"># shorten the lines along length</span>
        <span class="n">ky1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h1</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
        <span class="n">kx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">w2</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
        <span class="n">ky2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h2</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>

        <span class="n">xOff1</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># offset to centre of bounding box</span>
        <span class="n">yOff1</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">xOff2</span> <span class="o">=</span> <span class="n">w2</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">yOff2</span> <span class="o">=</span> <span class="n">h2</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="n">x1</span> <span class="o">+=</span> <span class="n">xOff1</span> <span class="o">+</span> <span class="n">kx1</span> <span class="o">+</span> <span class="n">offsetX</span>
        <span class="n">y1</span> <span class="o">+=</span> <span class="n">yOff1</span> <span class="o">+</span> <span class="n">ky1</span> <span class="o">+</span> <span class="n">offsetY</span>
        <span class="n">x2</span> <span class="o">+=</span> <span class="n">xOff2</span> <span class="o">-</span> <span class="n">kx2</span> <span class="o">+</span> <span class="n">offsetX</span>
        <span class="n">y2</span> <span class="o">+=</span> <span class="n">yOff2</span> <span class="o">-</span> <span class="n">ky2</span> <span class="o">+</span> <span class="n">offsetY</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setLine</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentLine.paint"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.AssignmentLine.paint">[docs]</a>    <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Automatically update the end-points of the assignment lines to point to the correct guiNmrAtoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateEndPoints</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">paint</span><span class="p">(</span><span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">widget</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentLine.hoverEnterEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.AssignmentLine.hoverEnterEvent">[docs]</a>    <span class="k">def</span> <span class="nf">hoverEnterEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">selectedLine</span> <span class="o">=</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AssignmentLine.hoverLeaveEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.AssignmentLine.hoverLeaveEvent">[docs]</a>    <span class="k">def</span> <span class="nf">hoverLeaveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">selectedLine</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AssignmentLine.mousePressEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.AssignmentLine.mousePressEvent">[docs]</a>    <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Required to respond to mouse press events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<span class="c1">#==========================================================================================</span>
<span class="c1"># GuiNmrResidueGroup</span>
<span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="GuiNmrResidueGroup"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrResidueGroup">[docs]</a><span class="k">class</span> <span class="nc">GuiNmrResidueGroup</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsItemGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group item to group all nmrAtoms/connecting lines of nmrResidue</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">caAtom</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">mainWindow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrResidue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossChainCount</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossChainResidue</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueLabel</span> <span class="o">=</span> <span class="n">GuiNmrResidue</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">caAtom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueLabel</span><span class="p">)</span>

<div class="viewcode-block" id="GuiNmrResidueGroup.mousePressEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrResidueGroup.mousePressEvent">[docs]</a>    <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueLabel</span><span class="o">.</span><span class="n">_mousePressEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="GuiNmrResidueGroup.mouseMoveEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrResidueGroup.mouseMoveEvent">[docs]</a>    <span class="k">def</span> <span class="nf">mouseMoveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueLabel</span><span class="o">.</span><span class="n">_mouseMoveEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="GuiNmrResidueGroup.mouseDoubleClickEvent"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.GuiNmrResidueGroup.mouseDoubleClickEvent">[docs]</a>    <span class="k">def</span> <span class="nf">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueLabel</span><span class="o">.</span><span class="n">_mouseDoubleClickEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div></div>


<span class="c1">#==========================================================================================</span>
<span class="c1"># NmrResidueList</span>
<span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="NmrResidueList"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList">[docs]</a><span class="k">class</span> <span class="nc">NmrResidueList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Class to hold the information about each gui object in the scene</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mainWindow</span><span class="p">,</span> <span class="n">settingsWidget</span><span class="p">,</span> <span class="n">lineColour</span><span class="p">,</span> <span class="n">textColour</span><span class="p">,</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise the new object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span> <span class="o">=</span> <span class="n">mainWindow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span> <span class="o">=</span> <span class="n">settingsWidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span> <span class="o">=</span> <span class="n">lineColour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_textColour</span> <span class="o">=</span> <span class="n">textColour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atomSpacing</span> <span class="o">=</span> <span class="n">atomSpacing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span> <span class="o">=</span> <span class="n">scene</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="NmrResidueList.reset"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residueCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectedStretch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectedLine</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># change to an orderedDict so that more nmrChains can be seen in the future</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># referenced by nmrChain</span>

        <span class="c1"># store all visible gui items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># referenced by nmrResidue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># referenced by nmrAtom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiGhostNmrResidues</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># referenced by nmrResidue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtomsFromNmrResidue</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># referenced by nmrResidue -&gt; list(guiNmrAtoms)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ghostList</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># referenced by peak?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># current active nmrChain</span></div>

<div class="viewcode-block" id="NmrResidueList.size"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the number of elements in the list nmrChain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">])</span> <span class="k">if</span> <span class="n">nmrChainId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span> <span class="k">else</span> <span class="kc">None</span></div>

    <span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="NmrResidueList.getIndexNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.getIndexNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">getIndexNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the index in the nmrResidueList of the required nmrResidue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">nmrCh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrCh</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">nmrCh</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span></div>

        <span class="c1"># resList = [item[0] for item in self.allNmrResidues]</span>
        <span class="c1"># if nmrResidue in resList:</span>
        <span class="c1">#     return resList.index(nmrResidue)</span>

<div class="viewcode-block" id="NmrResidueList.deleteNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.deleteNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">deleteNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the index in the nmrResidueList of the required nmrResidue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">nmrCh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrCh</span><span class="p">:</span>
                <span class="n">nmrCh</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt;removing from nmrChains&#39;</span><span class="p">)</span></div>

    <span class="c1"># def deleteNmrResidueIndex(self, index):</span>
    <span class="c1">#     &quot;&quot;&quot;insert into the list as a tuple (obj, dict).</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     return self.allNmrResidues.pop(index)</span>
    <span class="c1">#</span>
    <span class="c1"># def _appendNmrResiduePair(self, nmrResidue, guiAtoms):</span>
    <span class="c1">#     &quot;&quot;&quot;insert into the list as a tuple (obj, dict).</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self.allNmrResidues.append((nmrResidue, guiAtoms))</span>

    <span class="k">def</span> <span class="nf">_insertNmrResiduePair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;insert into the list as a tuple (obj, dict).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nmrChainId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">)</span>

        <span class="c1"># self.allNmrResidues.insert(index, (nmrResidue, guiAtoms))</span>
        <span class="c1"># self.allNmrResidues[index] = (nmrResidue, guiAtoms)</span>

    <span class="c1"># def _getNmrResiduePair(self, index):</span>
    <span class="c1">#     &quot;&quot;&quot;insert into the list as a tuple.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     val = self.allNmrResidues[index]</span>
    <span class="c1">#     return val[0], val[1]</span>
    <span class="c1">#</span>
    <span class="c1"># def _setNmrResiduePair(self, index, nmrResidue, guiAtoms):</span>
    <span class="c1">#     &quot;&quot;&quot;insert into the list as a tuple.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self.allNmrResidues[index] = (nmrResidue, guiAtoms)</span>

    <span class="c1"># def _updateAllNmrResidueSize(self):</span>
    <span class="c1">#     &quot;&quot;&quot;Change the size of this list based on whether mainNmrResidues has changed</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if self.nmrChain:</span>
    <span class="c1">#         mainNmrResidues = self.nmrChain.mainNmrResidues</span>
    <span class="c1">#         if self.nmrChain not in self.allNmrResidues:</span>
    <span class="c1">#             self.allNmrResidues[self.nmrChain] = [None] * len(mainNmrResidues)</span>
    <span class="c1">#</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             resList = self.allNmrResidues[self.nmrChain]</span>
    <span class="c1">#             lenAll = len(resList)</span>
    <span class="c1">#             if lenAll == 0:</span>
    <span class="c1">#                 # create a new list</span>
    <span class="c1">#                 self.allNmrResidues[self.nmrChain] = [None] * len(mainNmrResidues)</span>
    <span class="c1">#</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 # update the list size copying the original data into it</span>
    <span class="c1">#                 ii = _getNmrIndex(resList[0])</span>
    <span class="c1">#                 newList = [None] * len(mainNmrResidues)</span>
    <span class="c1">#                 for res in self.allNmrResidues[self.nmrChain]:</span>
    <span class="c1">#                     index = _getNmrIndex(res)</span>
    <span class="c1">#                     if index and index &lt; len(mainNmrResidues):</span>
    <span class="c1">#                         newList[_getNmrIndex(res)] = res</span>

    <span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="NmrResidueList.addNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.addNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">addNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_insertNmrRes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new nmrResidue at the required position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addNmrResidue</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">nmrResidueIndex</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">,</span> <span class="n">_insertNmrRes</span><span class="o">=</span><span class="n">_insertNmrRes</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_addNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">nmrResidueIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_insertNmrRes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes an Nmr Residue, and adds a residue to the sequence graph</span>
<span class="sd">        corresponding to the Nmr Residue at the required index.</span>
<span class="sd">        Nmr Residue name displayed beneath CA of residue drawn and residue type predictions displayed</span>
<span class="sd">        beneath Nmr Residue name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check whether the guiNmrResidue already exists, and skip</span>
        <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">guiAtoms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># mainNmrResidues = nmrResidue.nmrChain.mainNmrResidues</span>

        <span class="k">if</span> <span class="n">atomSpacing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span> <span class="o">=</span> <span class="n">atomSpacing</span>
        <span class="n">nmrAtomNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">]</span>
        <span class="n">backboneAtoms</span> <span class="o">=</span> <span class="n">DEFAULT_RESIDUE_ATOMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span> <span class="o">==</span> <span class="s1">&#39;GLY&#39;</span><span class="p">:</span>
            <span class="c1"># GLY doesn&#39;t have CB</span>
            <span class="k">del</span> <span class="n">backboneAtoms</span><span class="p">[</span><span class="s1">&#39;CB&#39;</span><span class="p">]</span>

        <span class="c1"># add extra guiAtoms to the list based on the backbone atoms dict above - to self.guiNmrAtomDict[nmrAtoms]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addBackboneAtoms</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">backboneAtoms</span><span class="p">,</span> <span class="n">nmrAtomNames</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">)</span>

        <span class="c1"># add the sideChain atoms to self.guiNmrAtomDict[nmrAtoms]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;showSideChain&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;CB&#39;</span> <span class="ow">in</span> <span class="n">backboneAtoms</span> <span class="ow">and</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span><span class="p">:</span>
                <span class="n">cbAtom</span> <span class="o">=</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CB&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addSideChainAtoms</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">cbAtom</span><span class="p">,</span> <span class="n">nmrAtomNames</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">)</span>

        <span class="c1"># store the reference to all gui NmrAtoms from nmrResidue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtomsFromNmrResidue</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span> <span class="o">=</span> <span class="n">guiAtoms</span>

        <span class="c1"># self._updateAllNmrResidueSize()</span>

        <span class="c1"># # add the new nmrResidue to the current list</span>
        <span class="c1"># if not self.allNmrResidues:</span>
        <span class="c1">#</span>
        <span class="c1">#     # append to the list self.allNmrResidues</span>
        <span class="c1">#     self.allNmrResidues = [None] * len(mainNmrResidues)</span>
        <span class="c1">#     self.allNmrResidues[mainNmrResidues.index(nmrResidue)] = (nmrResidue, guiAtoms)</span>
        <span class="c1">#     # self._appendNmrResiduePair(nmrResidue, guiAtoms)</span>
        <span class="c1">#</span>
        <span class="c1"># else:</span>

        <span class="c1"># insert into the correct nmrChain</span>
        <span class="k">if</span> <span class="n">_insertNmrRes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insertNmrResiduePair</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrResidueIndex</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">)</span>

        <span class="c1"># index = mainNmrResidues.index(nmrResidue)</span>
        <span class="c1"># self.allNmrResidues[nmrResidue][index] = (nmrResidue, guiAtoms)</span>

        <span class="c1"># compile a gui group for this nmrResidue - self.guiNmrResidues[nmrResidue</span>
        <span class="n">newGuiResidueGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assembleGroupResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newGuiResidueGroup</span>

    <span class="k">def</span> <span class="nf">_addGhostResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidueCon1</span><span class="p">:</span> <span class="n">NmrResidue</span><span class="p">,</span>
                         <span class="n">guiRef</span><span class="p">:</span> <span class="n">GuiNmrAtom</span><span class="p">,</span>
                         <span class="n">nmrResidueCon0</span><span class="p">:</span> <span class="n">NmrResidue</span><span class="p">,</span>
                         <span class="n">name1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name0</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">offsetAdjust</span><span class="p">,</span>
                         <span class="n">atomSpacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes an Nmr Residue and a direction, either &#39;-1 or &#39;+1&#39;, and adds a residue to the sequence graph</span>
<span class="sd">        corresponding to the Nmr Residue.</span>
<span class="sd">        Nmr Residue name displayed beneath CA of residue drawn and residue type predictions displayed</span>
<span class="sd">        beneath Nmr Residue name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># need to keep a list of the atoms that have been added so don&#39;t repeat</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">nmrResidueCon0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ghostList</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ghostList</span><span class="p">[</span><span class="n">nmrResidueCon0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">nmrResidueCon1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ghostList</span><span class="p">[</span><span class="n">nmrResidueCon0</span><span class="p">]:</span>
                <span class="c1"># already exists in the dict so exit</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ghostList</span><span class="p">[</span><span class="n">nmrResidueCon0</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>

        <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrResidueCon1</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">atomSpacing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span> <span class="o">=</span> <span class="n">atomSpacing</span>
        <span class="n">nmrAtoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">]</span>
        <span class="n">residueAtoms</span> <span class="o">=</span> <span class="n">DEFAULT_RESIDUE_ATOMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span> <span class="o">==</span> <span class="s1">&#39;GLY&#39;</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">residueAtoms</span><span class="p">[</span><span class="s1">&#39;CB&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">residueAtoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nmrAtoms</span><span class="p">:</span>
                <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">fetchNmrAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nmrAtom</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createGhostGuiNmrAtom</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">)</span>

        <span class="n">newGuiResidueGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assembleGhostResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">lineList</span><span class="p">)</span>
        <span class="n">newGuiResidueGroup</span><span class="o">.</span><span class="n">crossChainCount</span> <span class="o">=</span> <span class="n">count</span>
        <span class="n">newGuiResidueGroup</span><span class="o">.</span><span class="n">crossChainResidue</span> <span class="o">=</span> <span class="n">nmrResidueCon0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ghostList</span><span class="p">[</span><span class="n">nmrResidueCon0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">nmrResidueCon1</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">atoms</span>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_createGuiNmrAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">:</span> <span class="n">NmrAtom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GuiNmrAtom</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a GuiNmrAtom specified by the atomType and graphical position supplied.</span>
<span class="sd">        GuiNmrAtom can be linked to an NmrAtom by supplying it to the function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guiAtom</span> <span class="o">=</span> <span class="n">GuiNmrAtom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">atomType</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="o">=</span><span class="n">nmrAtom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nmrAtom</span><span class="p">:</span>
            <span class="c1"># only add to the dict if the nmrAtom exists</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">[</span><span class="n">nmrAtom</span><span class="p">]</span> <span class="o">=</span> <span class="n">guiAtom</span>
        <span class="k">return</span> <span class="n">guiAtom</span>

    <span class="k">def</span> <span class="nf">_createGhostGuiNmrAtom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">:</span> <span class="n">NmrAtom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GuiNmrAtom</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a GuiNmrAtom specified by the atomType and graphical position supplied.</span>
<span class="sd">        GuiNmrAtom can be linked to an NmrAtom by supplying it to the function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guiAtom</span> <span class="o">=</span> <span class="n">GuiNmrAtom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">atomType</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="o">=</span><span class="n">nmrAtom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nmrAtom</span><span class="p">:</span>
            <span class="c1"># only add to the dict if the nmrAtom exists</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">[</span><span class="n">nmrAtom</span><span class="p">]</span> <span class="o">=</span> <span class="n">guiAtom</span>
        <span class="k">return</span> <span class="n">guiAtom</span>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_nmrAtomID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an id string to retrieve guiNmrAtoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="NmrResidueList.addBackboneAtoms"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.addBackboneAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">addBackboneAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">backboneAtoms</span><span class="p">,</span> <span class="n">atomNames</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;add the backbone atoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">backboneAtoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">atomNames</span><span class="p">:</span>
                <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">fetchNmrAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nmrAtom</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">guiAtoms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createGuiNmrAtom</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmrResidueList.addSideChainAtoms"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.addSideChainAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">addSideChainAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">cbAtom</span><span class="p">,</span> <span class="n">atomNames</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the sideChain atoms above the backbone line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># residue = {}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ATOM_POSITION_DICT</span><span class="p">[</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;boundAtoms&#39;</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">cbAtom</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbAtom</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">atomNames</span><span class="p">:</span>
                    <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">fetchNmrAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nmrAtom</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">newAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createGuiNmrAtom</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">)</span>

                <span class="c1"># self.scene.addItem(newAtom)</span>
                <span class="c1"># residue[k] = newAtom</span>
                <span class="n">guiAtoms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">newAtom</span></div>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_assembleGroupResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">:</span> <span class="n">NmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">GuiNmrAtom</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Takes an Nmr Residue and a dictionary of atom names and GuiNmrAtoms and</span>
<span class="sd">        creates a graphical representation of a residue in the assigner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guiResidueGroup</span> <span class="o">=</span> <span class="n">GuiNmrResidueGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># insert into the gui list and add to the scene</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span> <span class="o">=</span> <span class="n">guiResidueGroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">)</span>

        <span class="c1"># add the atoms to the group and set the reverse link</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">guiAtoms</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">guiResidueGroup</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">guiNmrResidueGroup</span> <span class="o">=</span> <span class="n">guiResidueGroup</span>

        <span class="c1"># add the backbone lines - sidechain will be added in the future</span>
        <span class="k">if</span> <span class="s2">&quot;CB&quot;</span> <span class="ow">in</span> <span class="n">guiAtoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CB&#39;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;H&quot;</span> <span class="ow">in</span> <span class="n">guiAtoms</span> <span class="ow">and</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span> <span class="o">!=</span> <span class="s1">&#39;PRO&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_addGroupResiduePredictions</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">guiResidueGroup</span>

    <span class="k">def</span> <span class="nf">_assembleGhostResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">:</span> <span class="n">NmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">GuiNmrAtom</span><span class="p">],</span> <span class="n">lineList</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes an Nmr Residue and a dictionary of atom names and GuiNmrAtoms and</span>
<span class="sd">        creates a graphical representation of a residue in the assigner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guiResidueGroup</span> <span class="o">=</span> <span class="n">GuiNmrResidueGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiGhostNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span> <span class="o">=</span> <span class="n">guiResidueGroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">)</span>

        <span class="c1"># add the atoms to the group and set the reverse link</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">guiAtoms</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">guiResidueGroup</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">guiNmrResidueGroup</span> <span class="o">=</span> <span class="n">guiResidueGroup</span>

        <span class="c1"># add the backbone lines - sidechain will be added in the future</span>
        <span class="k">if</span> <span class="s2">&quot;CB&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">guiAtoms</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CB&#39;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">lineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;H&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">guiAtoms</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">residueType</span> <span class="o">!=</span> <span class="s1">&#39;PRO&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">lineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">lineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiResidueGroup</span><span class="p">,</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="n">guiAtoms</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">lineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">guiResidueGroup</span>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_addConnectingLineToGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">GuiNmrResidueGroup</span><span class="p">,</span> <span class="n">guiAtom1</span><span class="p">:</span> <span class="n">GuiNmrAtom</span><span class="p">,</span> <span class="n">guiAtom2</span><span class="p">:</span> <span class="n">GuiNmrAtom</span><span class="p">,</span>
                                  <span class="n">colour</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">displacement</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">peak</span><span class="p">:</span> <span class="n">Peak</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a line between two GuiNmrAtoms using the width, colour, displacement and style specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">itemKey</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">lineId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itemKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lineList</span><span class="p">:</span>
            <span class="n">lineList</span><span class="p">[</span><span class="n">itemKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lineList</span><span class="p">[</span><span class="n">itemKey</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="o">==</span> <span class="n">guiAtom1</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="o">==</span> <span class="n">guiAtom2</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">_peak</span> <span class="o">==</span> <span class="n">peak</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="o">==</span> <span class="n">guiAtom1</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="o">==</span> <span class="n">guiAtom2</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">_peak</span> <span class="o">==</span> <span class="n">peak</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add a newLine only if it doesn&#39;t already exists - may cause some gaps in the displacements</span>
            <span class="n">newLine</span> <span class="o">=</span> <span class="n">AssignmentLine</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colour</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
                                     <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">peak</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span>
                                     <span class="n">guiAtom1</span><span class="o">=</span><span class="n">guiAtom1</span><span class="p">,</span> <span class="n">guiAtom2</span><span class="o">=</span><span class="n">guiAtom2</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>

            <span class="n">newLine</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

            <span class="n">lineList</span><span class="p">[</span><span class="n">itemKey</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newLine</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newLine</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="NmrResidueList.addConnectionsBetweenGroups"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.addConnectionsBetweenGroups">[docs]</a>    <span class="k">def</span> <span class="nf">addConnectionsBetweenGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the connections between the groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># connectsNeeded = self._module.nmrResiduesCheckBox.isChecked()     # why was this here?</span>

        <span class="c1"># mainNmrResidues = self.nmrChain.mainNmrResidues</span>
        <span class="c1"># get the list of nmrResidues in the required nmrChain referenced by nmrChainId</span>
        <span class="n">mainNmrResidues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span> <span class="k">if</span> <span class="n">nmrChainId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span> <span class="k">else</span> <span class="p">[]</span>  <span class="c1">#[resPair[0] for resPair in self.nmrChains[nmrChainId]]</span>

        <span class="c1"># iterate through the adjacent pairs</span>
        <span class="k">for</span> <span class="n">prevRes</span><span class="p">,</span> <span class="n">thisRes</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mainNmrResidues</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mainNmrResidues</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>

            <span class="c1"># add the connection the minus residue and point to the right - may need to change for +1 residues</span>
            <span class="c1"># prevRes, prevGuiAtoms = prev</span>
            <span class="c1"># thisRes, thisGuiAtoms = this</span>
            <span class="n">prevGuiAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtomsFromNmrResidue</span><span class="p">[</span><span class="n">prevRes</span><span class="p">]</span>
            <span class="n">thisGuiAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtomsFromNmrResidue</span><span class="p">[</span><span class="n">thisRes</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">prevRes</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="ow">and</span> <span class="n">prevRes</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="ow">is</span> <span class="n">thisRes</span><span class="p">):</span>  <span class="c1"># and connectsNeeded:</span>
                <span class="c1"># connect from this &#39;N&#39; to the previous &#39;C&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">prevRes</span><span class="p">],</span>
                                               <span class="n">prevGuiAtoms</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="n">thisGuiAtoms</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">,</span>
                                               <span class="n">lineId</span><span class="o">=</span><span class="n">thisRes</span><span class="p">)</span></div>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_addGroupResiduePredictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guiResidueGroup</span><span class="p">:</span> <span class="n">GuiNmrResidueGroup</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">:</span> <span class="n">NmrResidue</span><span class="p">,</span> <span class="n">caAtom</span><span class="p">:</span> <span class="n">GuiNmrAtom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets predictions for residue type based on BMRB statistics and determines label positions</span>
<span class="sd">        based on caAtom position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="p">(</span><span class="n">getNmrResiduePrediction</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">chemicalShiftLists</span><span class="p">[</span><span class="mi">0</span><span class="p">])))))</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="n">predictionLabel</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsTextItem</span><span class="p">()</span>
            <span class="n">predictionLabel</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">predictionLabel</span><span class="o">.</span><span class="n">setDefaultTextColor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_textColour</span><span class="p">))</span>
            <span class="n">predictionLabel</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">textFontSmallBold</span><span class="p">)</span>
            <span class="n">predictionLabel</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">caAtom</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">caAtom</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                   <span class="n">caAtom</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>

            <span class="n">guiResidueGroup</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="n">predictionLabel</span><span class="p">)</span>

    <span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="NmrResidueList.updateMainChainPositions"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.updateMainChainPositions">[docs]</a>    <span class="k">def</span> <span class="nf">updateMainChainPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the positions of the group in the scene.</span>
<span class="sd">        May need to set vertical positions when more groups are allowed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nmrChainId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># get the list of nmrResidues in the required nmrChain referenced by nmrChainId</span>
        <span class="c1"># mainNmrResidues = self.nmrChains[nmrChainId]  #[resPair[0] for resPair in self.nmrChains[nmrChainId]]</span>

        <span class="n">mainNmrResidues</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrResidue</span> <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span> <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">nmrChainId</span> <span class="ow">and</span>
                           <span class="ow">not</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">_flaggedForDelete</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mainNmrResidues</span><span class="p">):</span>
            <span class="c1"># nmrResidue, guiAtoms = item</span>
            <span class="c1"># guiAtoms = self.guiNmrAtomsFromNmrResidue[nmrResidue]</span>

            <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">:</span>
                <span class="n">guiItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span>
                <span class="n">guiItem</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="n">ii</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span></div>

<div class="viewcode-block" id="NmrResidueList.updateConnectedChainPositions"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.updateConnectedChainPositions">[docs]</a>    <span class="k">def</span> <span class="nf">updateConnectedChainPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the positions of the groups in the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># update crossChainResidue positions</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiGhostNmrResidues</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">crossChainResidue</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">crossChainResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">crossChainResidue</span><span class="p">]</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">crossChainCount</span>

                <span class="n">newPosx</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
                <span class="n">newPosy</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
                <span class="n">res</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="n">newPosx</span> <span class="o">+</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span><span class="p">,</span>
                                          <span class="n">newPosy</span> <span class="o">+</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mf">2.5</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span><span class="p">))</span></div>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_addAllPeakAssignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add all the peak assignments to the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;peakAssignments&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>

            <span class="c1"># # create a set of sets ordered by spectra for active lines</span>
            <span class="c1"># self.LOCALinterResidueAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
            <span class="c1"># self.LOCALinterChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
            <span class="c1"># self.LOCALcrossChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>

            <span class="c1"># mainNmrResidues = self.nmrChain.mainNmrResidues</span>
            <span class="c1"># get the list of nmrResidues in the required nmrChain referenced by nmrChainId</span>
            <span class="n">mainNmrResidues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span> <span class="k">if</span> <span class="n">nmrChainId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span> <span class="k">else</span> <span class="p">[]</span>  <span class="c1">#[resPair[0] for resPair in self.nmrChains[nmrChainId]]</span>

            <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">mainNmrResidues</span><span class="p">:</span>
                <span class="c1"># guiRes = self.guiNmrAtomsFromNmrResidue[nmrResidue]</span>

                <span class="c1"># add the internally connected Lines</span>
                <span class="n">internalAssignments</span><span class="p">,</span> <span class="n">interChainAssignments</span><span class="p">,</span> <span class="n">crossChainAssignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPeakAssignmentsForResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">internalAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">interChainAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>

                <span class="c1"># add assignment lines and create ghost nmrResidues if required</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToAdjacentGroup</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">crossChainAssignments</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span>

            <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterResidueAtomPairing, self.assignmentLines)</span>
            <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterChainAtomPairing, self.assignmentLines)</span>
            <span class="c1"># self._addPeakAssignmentLinesToAdjacentGroup(self._module.nmrChain, self.LOCALcrossChainAtomPairing,</span>
            <span class="c1">#                                             self.assignmentLines, self.connectingLines)</span>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assignments</span><span class="p">,</span> <span class="n">lineList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the local peak assignments to each guiNmrResidue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">specAssignments</span> <span class="ow">in</span> <span class="n">assignments</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">nmrAtomPair</span> <span class="ow">in</span> <span class="n">specAssignments</span><span class="p">:</span>

                <span class="n">guiNmrAtomPair</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                  <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                  <span class="p">)</span>

                <span class="c1"># skip if not defined</span>
                <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">guiNmrAtomPair</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># get the peak and the spectrum</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span>
                <span class="n">displacement</span> <span class="o">=</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># add the internal line to the guiNmrResidueGroup, should now move when group is moved</span>
                <span class="n">guiNmrResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">guiNmrResidue</span><span class="p">,</span>
                                               <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                               <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                               <span class="n">spectrum</span><span class="o">.</span><span class="n">positiveContourColour</span><span class="p">,</span>
                                               <span class="mf">2.0</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">,</span>
                                               <span class="n">peak</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">lineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">peak</span><span class="p">)</span>

                <span class="c1"># update displacements for both guiNmrAtoms</span>
                <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_addPeakAssignmentLinesToAdjacentGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">assignments</span><span class="p">,</span> <span class="n">peaklineList</span><span class="p">,</span> <span class="n">connectingLineList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the peak assignments to nmrResidues in the same chain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">specAssignments</span> <span class="ow">in</span> <span class="n">assignments</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">nmrAtomPair</span> <span class="ow">in</span> <span class="n">specAssignments</span><span class="p">:</span>

                <span class="n">guiNmrAtomPair</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                  <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                  <span class="p">)</span>

                <span class="c1"># get the peak and the spectrum</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span>

                <span class="k">if</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">newGhostResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addGhostResidue</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">,</span>
                                                            <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                            <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">,</span>
                                                            <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">lineList</span><span class="o">=</span><span class="n">connectingLineList</span><span class="p">)</span>
                    <span class="n">guiNmrAtomPair</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                      <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                      <span class="p">)</span>

                    <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">]</span>
                    <span class="n">displacement</span> <span class="o">=</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">group</span><span class="p">,</span>
                                                   <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">spectrum</span><span class="o">.</span><span class="n">positiveContourColour</span><span class="p">,</span>
                                                   <span class="mf">2.0</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">,</span>
                                                   <span class="n">peak</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">peaklineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">newGhostResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addGhostResidue</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">,</span>
                                                            <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                            <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">,</span>
                                                            <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                            <span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">lineList</span><span class="o">=</span><span class="n">connectingLineList</span><span class="p">)</span>
                    <span class="n">guiNmrAtomPair</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                      <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                      <span class="p">)</span>

                    <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">]</span>
                    <span class="n">displacement</span> <span class="o">=</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">group</span><span class="p">,</span>
                                                   <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">spectrum</span><span class="o">.</span><span class="n">positiveContourColour</span><span class="p">,</span>
                                                   <span class="mf">2.0</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">,</span>
                                                   <span class="n">peak</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">peaklineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
                        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">]</span>
                        <span class="n">displacement</span> <span class="o">=</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">group</span><span class="p">,</span>
                                                       <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                       <span class="n">spectrum</span><span class="o">.</span><span class="n">positiveContourColour</span><span class="p">,</span>
                                                       <span class="mf">2.0</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">,</span>
                                                       <span class="n">peak</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">peaklineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
                        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">]</span>
                        <span class="n">displacement</span> <span class="o">=</span> <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addConnectingLineToGroup</span><span class="p">(</span><span class="n">group</span><span class="p">,</span>
                                                       <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                       <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">spectrum</span><span class="o">.</span><span class="n">positiveContourColour</span><span class="p">,</span>
                                                       <span class="mf">2.0</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">,</span>
                                                       <span class="n">peak</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="n">peaklineList</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="n">nmrResidue</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addConnectedList</span><span class="p">(</span><span class="n">guiNmrAtomPair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_getPeakAssignmentsForResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">nmrAtomIncludeList</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the list of peak assignments from the nmrAtoms</span>
<span class="sd">        interResidueAtomPairing is the linking within the same nmrResidue</span>
<span class="sd">        interChainAtomPairing is the linking within the same chain but to different nmrResidues</span>
<span class="sd">        crossChainAtomPairing is the linking to different chains</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># create a set of sets ordered by spectra</span>
        <span class="n">interResidueAtomPairing</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">spec</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">magnetisationTransfers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">interChainAtomPairing</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">spec</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">magnetisationTransfers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">crossChainAtomPairing</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">spec</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">magnetisationTransfers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># emptyAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>

        <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span>

        <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">_flaggedForDelete</span> <span class="ow">or</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignedPeaks</span><span class="p">:</span>

                <span class="c1"># ignore peaks that are due for delete (can probably also use the notifier list)</span>
                <span class="k">if</span> <span class="n">peak</span><span class="o">.</span><span class="n">_flaggedForDelete</span> <span class="ow">or</span> <span class="n">peak</span><span class="o">.</span><span class="n">isDeleted</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">peakList</span><span class="o">.</span><span class="n">spectrum</span>
                <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>

                    <span class="c1"># find the mainNmrResidue for -1 and +1 connections</span>
                    <span class="n">newCon</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">conNum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assignment</span><span class="p">)):</span>

                        <span class="c1"># assignments could be None</span>
                        <span class="k">if</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span> <span class="ow">and</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">relativeOffset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># and inCon[conNum].nmrResidue.nmrChain.isConnected:</span>

                            <span class="c1"># this is a minus residue so find connected, have to traverse to the previousNmrResidue</span>
                            <span class="c1"># will it always exist?</span>
                            <span class="n">conName</span> <span class="o">=</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                            <span class="n">preN</span> <span class="o">=</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="o">.</span><span class="n">previousNmrResidue</span>
                            <span class="k">if</span> <span class="n">preN</span><span class="p">:</span>
                                <span class="n">newConSwap</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrA</span> <span class="k">for</span> <span class="n">nmrA</span> <span class="ow">in</span> <span class="n">preN</span><span class="o">.</span><span class="n">nmrAtoms</span> <span class="k">if</span> <span class="n">nmrA</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">conName</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">newConSwap</span><span class="p">:</span>
                                    <span class="n">newCon</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">newConSwap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">newCon</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not connected so skip</span>

                        <span class="k">elif</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span> <span class="ow">and</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">relativeOffset</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># and inCon[conNum].nmrResidue.nmrChain.isConnected:</span>

                            <span class="c1"># this is a plus residue so find connected, have to traverse to the nextNmrResidue</span>
                            <span class="c1"># will it always exist?</span>
                            <span class="n">conName</span> <span class="o">=</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                            <span class="n">preN</span> <span class="o">=</span> <span class="n">assignment</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span>
                            <span class="k">if</span> <span class="n">preN</span><span class="p">:</span>
                                <span class="n">newConSwap</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrA</span> <span class="k">for</span> <span class="n">nmrA</span> <span class="ow">in</span> <span class="n">preN</span><span class="o">.</span><span class="n">nmrAtoms</span> <span class="k">if</span> <span class="n">nmrA</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">conName</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">newConSwap</span><span class="p">:</span>
                                    <span class="n">newCon</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">newConSwap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">newCon</span><span class="p">[</span><span class="n">conNum</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not connected so skip</span>

                    <span class="n">assignment</span> <span class="o">=</span> <span class="n">newCon</span>

                    <span class="c1"># only get the assignments a-b if a and b are defined in the spectrum magnetisationTransfers list</span>
                    <span class="k">for</span> <span class="n">mag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">magnetisationTransfers</span><span class="p">[</span><span class="n">spec</span><span class="p">]:</span>
                        <span class="n">nmrAtom0</span> <span class="o">=</span> <span class="n">assignment</span><span class="p">[</span><span class="n">mag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">nmrAtom1</span> <span class="o">=</span> <span class="n">assignment</span><span class="p">[</span><span class="n">mag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">nmrAtom0</span> <span class="o">=</span> <span class="n">nmrAtom0</span> <span class="k">if</span> <span class="n">nmrAtom0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nmrAtom0</span><span class="o">.</span><span class="n">isDeleted</span> <span class="ow">or</span> <span class="n">nmrAtom0</span><span class="o">.</span><span class="n">_flaggedForDelete</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">nmrAtom1</span> <span class="o">=</span> <span class="n">nmrAtom1</span> <span class="k">if</span> <span class="n">nmrAtom1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nmrAtom1</span><span class="o">.</span><span class="n">isDeleted</span> <span class="ow">or</span> <span class="n">nmrAtom1</span><span class="o">.</span><span class="n">_flaggedForDelete</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nmrAtom0</span><span class="p">,</span> <span class="n">nmrAtom1</span><span class="p">):</span>

                            <span class="c1"># ignore nmrAtoms that are not in the include list (if specified)</span>
                            <span class="k">if</span> <span class="n">nmrAtomIncludeList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nmrAtom0</span> <span class="ow">in</span> <span class="n">nmrAtomIncludeList</span> <span class="ow">or</span> <span class="n">nmrAtom1</span> <span class="ow">in</span> <span class="n">nmrAtomIncludeList</span><span class="p">):</span>
                                <span class="k">continue</span>

                            <span class="k">if</span> <span class="p">(</span><span class="n">nmrAtom0</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="ow">is</span> <span class="n">nmrResidue</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nmrAtom1</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="ow">is</span> <span class="n">nmrResidue</span><span class="p">):</span>

                                <span class="c1"># interResidueAtomPairing</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">nmrAtom1</span><span class="p">,</span> <span class="n">nmrAtom0</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interResidueAtomPairing</span><span class="p">[</span><span class="n">spec</span><span class="p">]:</span>
                                    <span class="n">interResidueAtomPairing</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nmrAtom0</span><span class="p">,</span> <span class="n">nmrAtom1</span><span class="p">,</span> <span class="n">peak</span><span class="p">))</span>

                            <span class="k">elif</span> <span class="p">(</span><span class="n">nmrAtom0</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="n">nmrChain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nmrAtom1</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="n">nmrChain</span><span class="p">):</span>

                                <span class="c1"># connections within the same chain</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">nmrAtom1</span><span class="p">,</span> <span class="n">nmrAtom0</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interChainAtomPairing</span><span class="p">[</span><span class="n">spec</span><span class="p">]:</span>
                                    <span class="n">interChainAtomPairing</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nmrAtom0</span><span class="p">,</span> <span class="n">nmrAtom1</span><span class="p">,</span> <span class="n">peak</span><span class="p">))</span>

                            <span class="c1"># elif (nmrAtom0.nmrResidue.nmrChain is nmrChain) and (nmrAtom1.nmrResidue.nmrChain is not nmrChain):</span>
                            <span class="k">else</span><span class="p">:</span>

                                <span class="c1"># connections to a dif</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">nmrAtom1</span><span class="p">,</span> <span class="n">nmrAtom0</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crossChainAtomPairing</span><span class="p">[</span><span class="n">spec</span><span class="p">]:</span>
                                    <span class="n">crossChainAtomPairing</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nmrAtom0</span><span class="p">,</span> <span class="n">nmrAtom1</span><span class="p">,</span> <span class="n">peak</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">interResidueAtomPairing</span><span class="p">,</span> <span class="n">interChainAtomPairing</span><span class="p">,</span> <span class="n">crossChainAtomPairing</span>
        <span class="c1"># return emptyAtomPairing, emptyAtomPairing, crossChainAtomPairing</span>

    <span class="c1">#==========================================================================================</span>
    <span class="c1"># spectrum update</span>

    <span class="k">def</span> <span class="nf">_removeLinesFromScene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineDist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the lines in the group from the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lineList</span> <span class="ow">in</span> <span class="n">lineDist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lineList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">lineDist</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="NmrResidueList.removeAssignmentLinesFromScene"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.removeAssignmentLinesFromScene">[docs]</a>    <span class="k">def</span> <span class="nf">removeAssignmentLinesFromScene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the peakLines from the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removeLinesFromScene</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmrResidueList.removeConnectionLinesFromScene"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.removeConnectionLinesFromScene">[docs]</a>    <span class="k">def</span> <span class="nf">removeConnectionLinesFromScene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the connection from the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removeLinesFromScene</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmrResidueList.clearAllGuiNmrAtoms"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.clearAllGuiNmrAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">clearAllGuiNmrAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;clear the displacements in the nmrAtoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clear the displacement values but keep the dict connections</span>
        <span class="k">for</span> <span class="n">guiAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">guiAtom</span><span class="o">.</span><span class="n">clearConnectedList</span><span class="p">()</span></div>

<div class="viewcode-block" id="NmrResidueList.rebuildPeakAssignments"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.rebuildPeakAssignments">[docs]</a>    <span class="k">def</span> <span class="nf">rebuildPeakAssignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rebuild all the peak assignments in the display after changing the number of spectra.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># remove all previous assignment lines and reset the dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeAssignmentLinesFromScene</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearAllGuiNmrAtoms</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nmrChainId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addAllPeakAssignments</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">)</span>

        <span class="c1"># update the endpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateEndPoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmrResidueList.updateEndPoints"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.updateEndPoints">[docs]</a>    <span class="k">def</span> <span class="nf">updateEndPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the end points from the dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lineList</span> <span class="ow">in</span> <span class="n">lineDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lineList</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">updateEndPoints</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="k">pass</span></div>

<div class="viewcode-block" id="NmrResidueList.updateAssignmentLines"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.updateAssignmentLines">[docs]</a>    <span class="k">def</span> <span class="nf">updateAssignmentLines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the endpoints of the assignment lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateEndPoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmrResidueList.updateConnectionLines"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.updateConnectionLines">[docs]</a>    <span class="k">def</span> <span class="nf">updateConnectionLines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the endpoints of the connection lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateEndPoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmrResidueList.updateGuiResiduePositions"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.updateGuiResiduePositions">[docs]</a>    <span class="k">def</span> <span class="nf">updateGuiResiduePositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">updateMainChain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">updateConnectedChains</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the positions of the residues and connected residues in other chains if required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">updateMainChain</span><span class="p">:</span>
            <span class="c1"># update the group positions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateMainChainPositions</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updateConnectedChains</span><span class="p">:</span>
            <span class="c1"># update crossChainResidue positions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateConnectedChainPositions</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">)</span>

        <span class="c1"># update the endpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateConnectionLines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateAssignmentLines</span><span class="p">()</span></div>

    <span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="NmrResidueList.getAssignmentLinesFromPeaks"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.getAssignmentLinesFromPeaks">[docs]</a>    <span class="k">def</span> <span class="nf">getAssignmentLinesFromPeaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the list of assignment lines attached o the given peaks.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="nf">_addAdjacentResiduesToSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">residueSet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the adjacent nmrResidues into the set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">residueSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>
        <span class="n">nmr</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">previousNmrResidue</span>
        <span class="k">if</span> <span class="n">nmr</span> <span class="ow">and</span> <span class="n">nmr</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="p">:</span>
            <span class="n">residueSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nmr</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="p">)</span>
        <span class="n">nmr</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span>
        <span class="k">if</span> <span class="n">nmr</span> <span class="ow">and</span> <span class="n">nmr</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="p">:</span>
            <span class="n">residueSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nmr</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="p">)</span>

<div class="viewcode-block" id="NmrResidueList.rebuildPeakLines"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.rebuildPeakLines">[docs]</a>    <span class="k">def</span> <span class="nf">rebuildPeakLines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">rebuildPeakLines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">makeListFromPeak</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all lines on the display associated with peak.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># find the current lines associated with the notified peak (or list of peaks)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>

        <span class="c1"># make list of peakLines attached to these peaks</span>
        <span class="n">peakLines</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakLine</span> <span class="k">for</span> <span class="n">peakLineList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                     <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLineList</span>
                     <span class="k">if</span> <span class="n">peakLine</span><span class="o">.</span><span class="n">_peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>
        <span class="n">guiNmrAtomSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">nmrResidueSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">makeListFromPeak</span><span class="p">:</span>
            <span class="c1"># make a list of all the guiNmrAtoms/nmrResidues that are associated with the peak</span>
            <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLines</span><span class="p">:</span>
                <span class="c1"># current associated guiNmrAtoms</span>
                <span class="n">guiNmrAtomSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom1</span><span class="p">)</span>
                <span class="n">guiNmrAtomSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom2</span><span class="p">)</span>

                <span class="c1"># current associated nmrResidues and their previous/nextNmrResidues</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addAdjacentResiduesToSet</span><span class="p">(</span><span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom1</span><span class="o">.</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">nmrResidueSet</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addAdjacentResiduesToSet</span><span class="p">(</span><span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom2</span><span class="o">.</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">nmrResidueSet</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make a new list for creating a peak; necessary for undo of delete peak as the assignedNmrAtom list exists</span>
            <span class="n">assignmentAtoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">nmrAtom</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span>
                                   <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">assignments</span>
                                   <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">assignment</span>
                                   <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">assignmentAtoms</span><span class="p">:</span>
                <span class="n">guiNmrAtomSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">[</span><span class="n">nmrAtom</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addAdjacentResiduesToSet</span><span class="p">(</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">nmrResidueSet</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">guiAtom</span> <span class="ow">in</span> <span class="n">guiNmrAtomSet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">peakLineList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">peakLines</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakLine</span> <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLineList</span>
                             <span class="k">if</span> <span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="ow">is</span> <span class="n">guiAtom</span> <span class="ow">or</span> <span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="ow">is</span> <span class="n">guiAtom</span><span class="p">]</span>

                <span class="c1"># remove all graphic lines</span>
                <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLines</span><span class="p">:</span>
                    <span class="n">peakLineList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">peakLine</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">peakLine</span><span class="p">)</span>

            <span class="c1"># clear connectivity list of guiNmrAtoms, but don&#39;t delete</span>
            <span class="n">guiAtom</span><span class="o">.</span><span class="n">clearConnectedList</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">rebuildPeakLines</span><span class="p">:</span>
            <span class="c1"># now rebuild for the new peak values</span>
            <span class="c1"># assumes that the peakAssignments have changed - possibly use different notifier</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;peakAssignments&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>

                <span class="n">nmrAtomIncludeList</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">guiAtom</span><span class="o">.</span><span class="n">nmrAtom</span> <span class="k">for</span>
                                           <span class="n">guiAtom</span> <span class="ow">in</span>
                                           <span class="n">guiNmrAtomSet</span><span class="p">)</span>

                <span class="c1"># # create a set of sets ordered by spectra for active lines</span>
                <span class="c1"># self.LOCALinterResidueAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
                <span class="c1"># self.LOCALinterChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
                <span class="c1"># self.LOCALcrossChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>

                <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidueSet</span><span class="p">:</span>

                    <span class="c1"># only process residues in the current visible chain</span>
                    <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
                        <span class="c1"># add the internally connected Lines</span>
                        <span class="n">internalAssignments</span><span class="p">,</span> <span class="n">interChainAssignments</span><span class="p">,</span> <span class="n">crossChainAssignments</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">_getPeakAssignmentsForResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span>
                                                               <span class="n">nmrAtomIncludeList</span><span class="o">=</span><span class="n">nmrAtomIncludeList</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">internalAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">interChainAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToAdjacentGroup</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">crossChainAssignments</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span>

                <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterResidueAtomPairing, self.assignmentLines)</span>
                <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterChainAtomPairing, self.assignmentLines)</span>
                <span class="c1"># self._addPeakAssignmentLinesToAdjacentGroup(self._module.nmrChain, self.LOCALcrossChainAtomPairing,</span>
                <span class="c1">#                                             self.assignmentLines, self.connectingLines)</span>

            <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">nmrResidueSet</span> <span class="ow">or</span> <span class="p">[]),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">thisId</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="s1">&#39;noChainId&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateGuiResiduePositions</span><span class="p">(</span><span class="n">thisId</span><span class="p">,</span> <span class="n">updateMainChain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">updateConnectedChains</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="c1">#==========================================================================================</span>

    <span class="k">def</span> <span class="nf">_addNmrAtomToGuiResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">,</span> <span class="n">atomSpacing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the guiNmrAtoms for a newly created/undeleted nmrAtom.</span>
<span class="sd">        Assumes that the nmrAtom/guiNmrAtom does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span>

        <span class="n">guiAtoms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">atomSpacing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span> <span class="o">=</span> <span class="n">atomSpacing</span>
        <span class="n">atomNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">]</span>
        <span class="n">residueAtoms</span> <span class="o">=</span> <span class="n">DEFAULT_RESIDUE_ATOMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">residueAtoms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">atomNames</span><span class="p">:</span>
                <span class="n">fetchedNmrAtom</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">fetchNmrAtom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fetchedNmrAtom</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">fetchedNmrAtom</span> <span class="ow">is</span> <span class="n">nmrAtom</span><span class="p">:</span>
                <span class="n">guiAtoms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createGuiNmrAtom</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">)</span>

        <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIndexNmrResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">oldGuiAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNmrResiduePair</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setNmrResiduePair</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">oldGuiAtoms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">guiAtoms</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">:</span>
            <span class="n">guiResidueGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span>

            <span class="c1"># add the guiAtoms to the group and set the reverse link</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">guiAtoms</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">guiResidueGroup</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">item</span><span class="o">.</span><span class="n">guiNmrResidueGroup</span> <span class="o">=</span> <span class="n">guiResidueGroup</span>

<div class="viewcode-block" id="NmrResidueList.createNmrAtoms"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.createNmrAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">createNmrAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrAtoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new peak lines associated with the created/undeleted nmrAtoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmrAtoms</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrAtoms</span><span class="p">)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtoms</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignedPeaks</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">:</span>
                <span class="c1"># add the new nmrAtoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addNmrAtomToGuiResidues</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebuildPeakLines</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">rebuildPeakLines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">makeListFromPeak</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_searchPeakLines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrAtoms</span><span class="p">,</span> <span class="n">includeDeleted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of the peakLines containing one of the nmrAtoms in the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peakLines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lineList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lineList</span><span class="p">:</span>
                <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">guiAtom1</span><span class="o">.</span><span class="n">nmrAtom</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtoms</span> <span class="ow">and</span> <span class="p">(</span><span class="n">includeDeleted</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">isDeleted</span> <span class="ow">or</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">_flaggedForDelete</span><span class="p">)):</span>
                    <span class="n">peakLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">guiAtom2</span><span class="o">.</span><span class="n">nmrAtom</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtoms</span> <span class="ow">and</span> <span class="p">(</span><span class="n">includeDeleted</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">isDeleted</span> <span class="ow">or</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">_flaggedForDelete</span><span class="p">)):</span>
                    <span class="n">peakLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">peakLines</span>

<div class="viewcode-block" id="NmrResidueList.deleteNmrAtoms"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.deleteNmrAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">deleteNmrAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrAtoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete peak lines associated with the deleted nmrAtoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmrAtoms</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrAtoms</span><span class="p">)</span>
        <span class="n">peakLines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searchPeakLines</span><span class="p">(</span><span class="n">nmrAtoms</span><span class="p">,</span> <span class="n">includeDeleted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakLine</span><span class="o">.</span><span class="n">_peak</span> <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLines</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rebuildPeakLines</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">rebuildPeakLines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="c1">#==========================================================================================</span>

<div class="viewcode-block" id="NmrResidueList.rebuildNmrResidues"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.NmrResidueList.rebuildNmrResidues">[docs]</a>    <span class="k">def</span> <span class="nf">rebuildNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rebuild the peaks of a specified nmrResidue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># now rebuild for the new peak values</span>
        <span class="c1"># assumes that the peakAssignments have changed - possibly use different notifier</span>
        <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">)</span>

        <span class="n">nmrAtomIncludeList</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nmrAtom</span> <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">)</span>
        <span class="n">guiNmrAtomSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">[</span><span class="n">nmrAtom</span><span class="p">]</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtomIncludeList</span>
                             <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">guiAtom</span> <span class="ow">in</span> <span class="n">guiNmrAtomSet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">peakLineList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">peakLines</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakLine</span> <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLineList</span>
                             <span class="k">if</span> <span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="ow">is</span> <span class="n">guiAtom</span> <span class="ow">or</span> <span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="ow">is</span> <span class="n">guiAtom</span><span class="p">]</span>

                <span class="c1"># remove all graphic lines</span>
                <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLines</span><span class="p">:</span>
                    <span class="n">peakLineList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">peakLine</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">peakLine</span><span class="p">)</span>

            <span class="c1"># clear connectivity list of guiNmrAtoms</span>
            <span class="n">guiAtom</span><span class="o">.</span><span class="n">clearConnectedList</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;peakAssignments&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>

            <span class="c1"># # create a set of sets ordered by spectra for active lines</span>
            <span class="c1"># self.LOCALinterResidueAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
            <span class="c1"># self.LOCALinterChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
            <span class="c1"># self.LOCALcrossChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>

            <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span><span class="p">:</span>

                <span class="c1"># only process residues in the current visible chain</span>
                <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">is</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span> <span class="ow">and</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
                    <span class="c1"># add the internally connected Lines</span>
                    <span class="n">internalAssignments</span><span class="p">,</span> <span class="n">interChainAssignments</span><span class="p">,</span> <span class="n">crossChainAssignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPeakAssignmentsForResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span>
                                                                                                                           <span class="n">nmrAtomIncludeList</span><span class="o">=</span><span class="n">nmrAtomIncludeList</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">internalAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">interChainAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToAdjacentGroup</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">crossChainAssignments</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="ow">and</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="p">:</span>
                    <span class="n">nextNmrResidue</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span>

                    <span class="c1"># only process residues in the current visible chain</span>
                    <span class="c1"># add the internally connected Lines</span>
                    <span class="n">internalAssignments</span><span class="p">,</span> <span class="n">interChainAssignments</span><span class="p">,</span> <span class="n">crossChainAssignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPeakAssignmentsForResidue</span><span class="p">(</span><span class="n">nextNmrResidue</span><span class="p">,</span>
                                                                                                                           <span class="n">nmrAtomIncludeList</span><span class="o">=</span><span class="n">nmrAtomIncludeList</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">internalAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">interChainAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToAdjacentGroup</span><span class="p">(</span><span class="n">nextNmrResidue</span><span class="p">,</span> <span class="n">crossChainAssignments</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span>

            <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterResidueAtomPairing, self.assignmentLines)</span>
            <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterChainAtomPairing, self.assignmentLines)</span>
            <span class="c1"># self._addPeakAssignmentLinesToAdjacentGroup(self._module.nmrChain, self.LOCALcrossChainAtomPairing,</span>
            <span class="c1">#                                             self.assignmentLines, self.connectingLines)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updateGuiResiduePositions</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">updateMainChain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">updateConnectedChains</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>

    <span class="c1">#==========================================================================================</span>
    <span class="c1">#==========================================================================================</span>
    <span class="c1">#==========================================================================================</span>


<span class="c1">#==========================================================================================</span>
<span class="c1"># Sequence Graph Main Module</span>
<span class="c1">#==========================================================================================</span>


<span class="n">LINKTOPULLDOWNCLASS</span> <span class="o">=</span> <span class="s1">&#39;linkToPulldownClass&#39;</span>


<div class="viewcode-block" id="SequenceGraphModule"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule">[docs]</a><span class="k">class</span> <span class="nc">SequenceGraphModule</span><span class="p">(</span><span class="n">CcpnModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A module for the display of stretches of sequentially linked and assigned stretches of</span>
<span class="sd">    NmrResidues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">className</span> <span class="o">=</span> <span class="s1">&#39;SequenceGraph&#39;</span>

    <span class="n">includeSettingsWidget</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">maxSettingsState</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># states are defined as: 0: invisible, 1: both visible, 2: only settings visible</span>
    <span class="n">settingsPosition</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>

    <span class="c1"># consistent with nmrResidueTable - move to generic class later</span>
    <span class="n">activePulldownClass</span> <span class="o">=</span> <span class="n">NmrChain</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mainWindow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sequence Graph&#39;</span><span class="p">,</span> <span class="n">nmrChain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">CcpnModule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mainWindow</span><span class="o">=</span><span class="n">mainWindow</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Derive application, project, and current from mainWindow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span> <span class="o">=</span> <span class="n">mainWindow</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">project</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">mainWindow</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">current</span>
            <span class="c1">###self.setMode(&#39;fragment&#39;)  # cannot be moved up!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="n">Splitter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWidget</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceModuleFrame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">setLayout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># self._SequenceGraphFrame = Frame(self.splitter, setLayout=True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainWidget</span><span class="o">.</span><span class="n">getLayout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thisSequenceModule</span> <span class="o">=</span> <span class="n">SequenceModule</span><span class="p">(</span><span class="n">moduleParent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                 <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequenceModuleFrame</span><span class="p">,</span>
                                                 <span class="n">mainWindow</span><span class="o">=</span><span class="n">mainWindow</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">colours</span> <span class="o">=</span> <span class="n">getColours</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colours</span><span class="p">[</span><span class="n">SEQUENCEGRAPHMODULE_LINE</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_textColour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colours</span><span class="p">[</span><span class="n">SEQUENCEGRAPHMODULE_TEXT</span><span class="p">]</span>

        <span class="c1">###frame = Frame(parent=self.mainWidget)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceGraphScrollArea</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QScrollArea</span><span class="p">()</span>
        <span class="c1"># self._sequenceGraphScrollArea.setSizePolicy(QtWidgets.QSizePolicy.Maximum, QtWidgets.QSizePolicy.Maximum)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceGraphScrollArea</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceGraphScrollArea</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequenceGraphScrollArea</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequenceModuleFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">setChildrenCollapsible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># add the settings widgets defined from the following orderedDict - test for refactored</span>
        <span class="n">settingsDict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="s1">&#39;peakAssignments&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span>   <span class="p">:</span> <span class="s1">&#39;Show peak assignments:&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;tipText&#39;</span> <span class="p">:</span> <span class="s1">&#39;Show peak assignments on display coloured by positiveContourColour.&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;callBack&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">,</span>
                                                         <span class="s1">&#39;enabled&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                         <span class="s1">&#39;checked&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                         <span class="s1">&#39;_init&#39;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                         <span class="p">}),</span>
                                    <span class="p">(</span><span class="s1">&#39;treeView&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span>   <span class="p">:</span> <span class="s1">&#39;Tree view:&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;tipText&#39;</span> <span class="p">:</span> <span class="s1">&#39;Show peak assignments as a tree below the main backbone.&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;callBack&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1">#self._updateShowTreeAssignments,</span>
                                                  <span class="s1">&#39;enabled&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                  <span class="s1">&#39;checked&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                  <span class="s1">&#39;_init&#39;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1">#self._updateShowTreeAssignments,</span>
                                                  <span class="p">}),</span>
                                    <span class="p">(</span><span class="s1">&#39;showSideChain&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span>   <span class="p">:</span> <span class="s1">&#39;Show side chain:&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;tipText&#39;</span> <span class="p">:</span> <span class="s1">&#39;Show side chain atoms and connections above the main chain.&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;callBack&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1">#self.showNmrChainFromPulldown,</span>
                                                       <span class="s1">&#39;enabled&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                       <span class="s1">&#39;checked&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                       <span class="s1">&#39;_init&#39;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                       <span class="p">}),</span>
                                    <span class="p">(</span><span class="s1">&#39;sequentialStrips&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span>   <span class="p">:</span> <span class="s1">&#39;Show sequential strips:&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;tipText&#39;</span> <span class="p">:</span> <span class="s1">&#39;Show nmrResidue in all strips.&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;callBack&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1">#self.showNmrChainFromPulldown,</span>
                                                          <span class="s1">&#39;enabled&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                          <span class="s1">&#39;checked&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                          <span class="s1">&#39;_init&#39;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                          <span class="p">}),</span>
                                    <span class="p">(</span><span class="s1">&#39;markPositions&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span>   <span class="p">:</span> <span class="s1">&#39;Mark positions:&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;tipText&#39;</span> <span class="p">:</span> <span class="s1">&#39;Mark positions in all strips.&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;callBack&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1">#self.showNmrChainFromPulldown,</span>
                                                       <span class="s1">&#39;enabled&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                       <span class="s1">&#39;checked&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                       <span class="s1">&#39;_init&#39;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                       <span class="p">}),</span>
                                    <span class="p">(</span><span class="s1">&#39;autoClearMarks&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span>   <span class="p">:</span> <span class="s1">&#39;Auto clear marks:&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;tipText&#39;</span> <span class="p">:</span> <span class="s1">&#39;Auto clear all previous marks&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;callBack&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                        <span class="s1">&#39;enabled&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                        <span class="s1">&#39;checked&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                        <span class="s1">&#39;_init&#39;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                        <span class="p">}),</span>
                                    <span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activePulldownClass</span><span class="p">:</span>
            <span class="n">settingsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(((</span><span class="n">LINKTOPULLDOWNCLASS</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span>   <span class="p">:</span> <span class="s1">&#39;Link to current </span><span class="si">%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">activePulldownClass</span><span class="o">.</span><span class="n">className</span><span class="p">,</span>
                                                       <span class="s1">&#39;tipText&#39;</span> <span class="p">:</span> <span class="s1">&#39;Set/update current </span><span class="si">%s</span><span class="s1"> when selecting from pulldown&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">activePulldownClass</span><span class="o">.</span><span class="n">className</span><span class="p">,</span>
                                                       <span class="s1">&#39;callBack&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                       <span class="s1">&#39;enabled&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                       <span class="s1">&#39;checked&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                       <span class="s1">&#39;_init&#39;</span>   <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                       <span class="p">}),</span>
                                <span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span> <span class="o">=</span> <span class="n">SequenceGraphSettings</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settingsWidget</span><span class="p">,</span> <span class="n">mainWindow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span>
                                               <span class="n">settingsDict</span><span class="o">=</span><span class="n">settingsDict</span><span class="p">,</span>
                                               <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialiseScene</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residueCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span> <span class="o">=</span> <span class="mi">66</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span> <span class="o">=</span> <span class="n">NmrResidueList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lineColour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_textColour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomSpacing</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deleteStore</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">colwidth</span> <span class="o">=</span> <span class="mi">180</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWidget</span><span class="p">,</span> <span class="n">setLayout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">vAlign</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">hAlign</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span> <span class="o">=</span> <span class="n">NmrChainPulldown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">gridSpan</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                 <span class="n">showSelectName</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                 <span class="n">fixedWidths</span><span class="o">=</span><span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="n">colwidth</span><span class="p">,</span> <span class="n">colwidth</span><span class="p">),</span>
                                                 <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">)</span>

        <span class="c1"># self.refreshCheckBox = CheckBoxCompoundWidget(self._MWwidget,</span>
        <span class="c1">#                                               labelText=&#39;Auto refresh NmrChain:&#39;,</span>
        <span class="c1">#                                               checked=True,</span>
        <span class="c1">#                                               fixedWidths=(colwidth, 15),</span>
        <span class="c1">#                                               orientation=&#39;right&#39;, hAlign=&#39;left&#39;,</span>
        <span class="c1">#                                               tipText=&#39;Update display when current.nmrChain changes&#39;,</span>
        <span class="c1">#                                               grid=(0, 1), gridSpan=(1, 1))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequenceCheckBox</span> <span class="o">=</span> <span class="n">CheckBoxCompoundWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span><span class="p">,</span>
                                                       <span class="n">labelText</span><span class="o">=</span><span class="s1">&#39;Show Sequence:&#39;</span><span class="p">,</span>
                                                       <span class="n">checked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                       <span class="n">fixedWidths</span><span class="o">=</span><span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                                                       <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">hAlign</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                                       <span class="n">tipText</span><span class="o">=</span><span class="s1">&#39;Show chain sequences&#39;</span><span class="p">,</span>
                                                       <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_toggleSequence</span><span class="p">,</span>
                                                       <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">gridSpan</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResiduesCheckBox</span> <span class="o">=</span> <span class="n">CheckBoxCompoundWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span><span class="p">,</span>
                                                          <span class="n">labelText</span><span class="o">=</span><span class="s1">&#39;Show all NmrResidues:&#39;</span><span class="p">,</span>
                                                          <span class="n">checked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                          <span class="n">fixedWidths</span><span class="o">=</span><span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
                                                          <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">hAlign</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                                          <span class="n">tipText</span><span class="o">=</span><span class="s1">&#39;Show all the NmrResidues in the NmrChain&#39;</span><span class="p">,</span>
                                                          <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">,</span>
                                                          <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">gridSpan</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settingsWidget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">editingToolbar</span> <span class="o">=</span> <span class="n">ToolBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MWwidget</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">gridSpan</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">hAlign</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">iconSizes</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
        <span class="c1"># self.editingToolbar = ToolBar(self._SequenceModuleFrame, grid=(0, 6), gridSpan=(1, 1), hAlign=&#39;right&#39;, iconSizes=(24,24))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectPreviousAction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editingToolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s2">&quot;disconnectPrevious&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnectPreviousNmrResidue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectPreviousIcon</span> <span class="o">=</span> <span class="n">Icon</span><span class="p">(</span><span class="s1">&#39;icons/disconnectPrevious&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectPreviousAction</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectPreviousIcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectAction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editingToolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s2">&quot;disconnect&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnectNmrResidue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectIcon</span> <span class="o">=</span> <span class="n">Icon</span><span class="p">(</span><span class="s1">&#39;icons/disconnect&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectAction</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectIcon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectNextAction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editingToolbar</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s2">&quot;disconnectNext&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnectNextNmrResidue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectNextIcon</span> <span class="o">=</span> <span class="n">Icon</span><span class="p">(</span><span class="s1">&#39;icons/disconnectNext&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectNextAction</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectNextIcon</span><span class="p">)</span>

        <span class="c1"># add mouse handler for the QGraphicsLineItems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preMouserelease</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">mouseReleaseEvent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">mouseReleaseEvent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sceneMouseRelease</span>

        <span class="c1"># calulate the connections between axes based on experiment types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateMagnetisationTransfers</span><span class="p">()</span>

        <span class="c1"># stop the mainWidget from squishing during a resize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainWidget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">)</span>

        <span class="c1"># install the event filter to handle maximising from floated dock</span>
        <span class="c1"># self.installMaximiseEventHandler(self._maximise, self._closeModule)</span>

        <span class="c1"># initialise notifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registerNotifiers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selectSequence</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sceneMouseRelease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a mouse handler to popupa menu from the contained scene</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">RightButton</span><span class="p">:</span>
            <span class="nb">object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">mouseGrabberItem</span><span class="p">()</span>
            <span class="c1"># print(&#39;&gt;&gt;&gt;grab&#39;, object)</span>
            <span class="k">if</span> <span class="nb">object</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseContextMenu</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preMouserelease</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1"># def _checkLayoutInit(self):</span>
    <span class="c1">#     &quot;&quot;&quot;This is a hack so that the state changes when the layout loads</span>
    <span class="c1">#     After the layout initialise, this function is removed</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self._updateShowTreeAssignments()</span>
    <span class="c1">#     self.assignmentsTreeCheckBox.checkBox.stateChanged.disconnect(self._checkLayoutInit)</span>

    <span class="k">def</span> <span class="nf">_maximise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maximise the attached table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_updateMagnetisationTransfers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the list that defines which couplings there are between the nmrAtoms attached to each peak.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magnetisationTransfers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">_flaggedForDelete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">magnetisationTransfers</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">magnetisationTransfers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">magnetisationTransfers</span><span class="p">[</span><span class="n">spec</span><span class="p">][</span><span class="n">mt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_blockEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Block all updates/signals/notifiers in the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpdatesEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># self.setBlankingAllNotifiers(True)</span>

    <span class="k">def</span> <span class="nf">_unblockEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unblock all updates/signals/notifiers in the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.setBlankingAllNotifiers(False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpdatesEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="SequenceGraphModule.sceneBlocking"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.sceneBlocking">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">sceneBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context manager to handle blocking, unblocking, resizing of the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blockEvents</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># pass control to the calling function</span>
            <span class="k">yield</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unblockEvents</span><span class="p">()</span>

            <span class="c1"># resize to the new items and spawns a repaint</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">itemsBoundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">adjusted</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_updateSpectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update list of current spectra and generate new magnetisationTransfer list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">TRIGGER</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_updateMagnetisationTransfers</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">]:</span>
                <span class="n">nmrChainPid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">nmrChainPid</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sceneBlocking</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">rebuildPeakAssignments</span><span class="p">()</span>

<div class="viewcode-block" id="SequenceGraphModule.selectSequence"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.selectSequence">[docs]</a>    <span class="k">def</span> <span class="nf">selectSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manually select a Sequence from the pullDown</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nmrChain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># logger.warning(&#39;select: No Sequence selected&#39;)</span>
            <span class="c1"># raise ValueError(&#39;select: No Sequence selected&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span><span class="o">.</span><span class="n">selectFirstItem</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">,</span> <span class="n">NmrChain</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;select: Object is not of type Sequence&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;select: Object is not of type Sequence&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">widgetObj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span><span class="o">.</span><span class="n">textList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">widgetObj</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_registerNotifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register the required notifiers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peakNotifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setNotifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                              <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CHANGE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">],</span>
                                              <span class="n">Peak</span><span class="o">.</span><span class="n">className</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_updatePeaks</span><span class="p">,</span>
                                              <span class="n">onceOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># not required</span>
        <span class="c1"># self._nmrChainNotifier = self.setNotifier(self.project,</span>
        <span class="c1">#                                           [Notifier.CHANGE, Notifier.CREATE, Notifier.DELETE],</span>
        <span class="c1">#                                           NmrChain.className,</span>
        <span class="c1">#                                           self._updateNmrChains,</span>
        <span class="c1">#                                           onceOnly=True)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nmrResidueNotifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setNotifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                    <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">RENAME</span><span class="p">],</span>
                                                    <span class="n">NmrResidue</span><span class="o">.</span><span class="n">className</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_updateNmrResidues</span><span class="p">,</span>
                                                    <span class="n">onceOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nmrResidueChangeNotifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setNotifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                          <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CHANGE</span><span class="p">],</span>
                                                          <span class="n">NmrResidue</span><span class="o">.</span><span class="n">className</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">_changeNmrResidues</span><span class="p">,</span>
                                                          <span class="n">onceOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nmrAtomNotifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setNotifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                 <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CHANGE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">],</span>
                                                 <span class="n">NmrAtom</span><span class="o">.</span><span class="n">className</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_updateNmrAtoms</span><span class="p">,</span>
                                                 <span class="n">onceOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># notifier to change the magnetisationTransfer list when new spectrum added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spectrumListNotifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setNotifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                      <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">],</span>
                                                      <span class="n">Spectrum</span><span class="o">.</span><span class="n">className</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_updateSpectra</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_currentNmrResidueNotifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setNotifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">,</span>
                                                           <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">],</span>
                                                           <span class="n">targetName</span><span class="o">=</span><span class="n">NmrResidue</span><span class="o">.</span><span class="n">_pluralLinkName</span><span class="p">,</span>
                                                           <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_selectCurrentNmrResidues</span><span class="p">)</span>

        <span class="c1"># new notifier to respond to changing current nmrChain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activePulldownClass</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setCurrentPulldown</span> <span class="o">=</span> <span class="n">Notifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">,</span>
                                                <span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">],</span>
                                                <span class="n">targetName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">activePulldownClass</span><span class="o">.</span><span class="n">_pluralLinkName</span><span class="p">,</span>
                                                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_selectCurrentPulldownClass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_selectCurrentPulldownClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Respond to change in current activePulldownClass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkBox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">_getCheckBox</span><span class="p">(</span><span class="n">LINKTOPULLDOWNCLASS</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activePulldownClass</span> <span class="ow">and</span> <span class="n">checkBox</span> <span class="ow">and</span> <span class="n">checkBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repopulateModule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CCPN Internal: Repopulate the required widgets in the module</span>
<span class="sd">        This is will be attached to GuiNotifiers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">()</span>

    <span class="c1"># def _updateModule(self, nmrChains=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Update in response to change of current.nmrChains</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     #if nmrChains is None or len(nmrChains)==0: return</span>
    <span class="c1">#     nmrChain = self.current.nmrChain</span>
    <span class="c1">#     if not nmrChain:</span>
    <span class="c1">#         return</span>
    <span class="c1">#</span>
    <span class="c1">#     if not self.refreshCheckBox.isChecked():</span>
    <span class="c1">#         return</span>
    <span class="c1">#</span>
    <span class="c1">#     # select the chain from the pullDown - should automatically change the display</span>
    <span class="c1">#     self.nmrChainPulldown.select(nmrChain.pid)</span>

    <span class="c1"># def setMode(self, mode):</span>
    <span class="c1">#   if self.project.nmrChains:</span>
    <span class="c1">#     self.editingToolbar.hide()</span>
    <span class="c1">#     if mode == &#39;fragment&#39;:</span>
    <span class="c1">#       self.editingToolbar.show()</span>
    <span class="c1">#       #self.nmrChainPulldown.setData([c.pid for c in self.project.nmrChains])</span>
    <span class="c1">#       #self.nmrChainLabel.setText(&#39;NmrChain: &#39;)</span>
    <span class="c1">#     elif mode == &#39;Assigned - backbone&#39;:</span>
    <span class="c1">#       pass</span>
    <span class="c1">#       #self.nmrChainLabel.setText(&#39;Chain: &#39;)</span>
    <span class="c1">#       #self.nmrChainPulldown.setData([self.project.getByPid(&#39;NC:%s&#39; % chain.shortName).pid for chain in self.project.chains if self.project.getByPid(&#39;NC:%s&#39; % chain.shortName)])</span>
    <span class="c1">#     self.modePulldown.select(mode)</span>
    <span class="c1">#     self.setNmrChainDisplay(self.nmrChainPulldown.getText())</span>
    <span class="c1">#   else:</span>
    <span class="c1">#     logger.warning(&#39;No valid NmrChain is selected.&#39;)</span>

    <span class="c1"># def _addAdjacentResiduesToSet(self, nmrResidue, residueSet):</span>
    <span class="c1">#     residueSet.add(nmrResidue)</span>
    <span class="c1">#     nmr = nmrResidue.previousNmrResidue</span>
    <span class="c1">#     if nmr:</span>
    <span class="c1">#         nmr = nmr.mainNmrResidue</span>
    <span class="c1">#         residueSet.add(nmr)</span>
    <span class="c1">#     nmr = nmrResidue.nextNmrResidue</span>
    <span class="c1">#     if nmr:</span>
    <span class="c1">#         nmr = nmr.mainNmrResidue</span>
    <span class="c1">#         residueSet.add(nmr)</span>

    <span class="k">def</span> <span class="nf">_rebuildNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrResidues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rebuild the peaks of a specified nmrResidue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># now rebuild for the new peak values</span>
        <span class="c1"># assumes that the peakAssignments have changed - possibly use different notifier</span>
        <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">)</span>

        <span class="n">nmrAtomIncludeList</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nmrAtom</span> <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">)</span>
        <span class="n">guiNmrAtomSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">[</span><span class="n">nmrAtom</span><span class="p">]</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtomIncludeList</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">guiAtom</span> <span class="ow">in</span> <span class="n">guiNmrAtomSet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">peakLineList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">peakLines</span> <span class="o">=</span> <span class="p">[</span><span class="n">peakLine</span> <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLineList</span>
                             <span class="k">if</span> <span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="ow">is</span> <span class="n">guiAtom</span> <span class="ow">or</span> <span class="n">peakLine</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="ow">is</span> <span class="n">guiAtom</span><span class="p">]</span>

                <span class="c1"># remove all graphic lines</span>
                <span class="k">for</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="n">peakLines</span><span class="p">:</span>
                    <span class="n">peakLineList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">peakLine</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">peakLine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">peakLine</span><span class="p">)</span>

            <span class="c1"># clear connectivity list of guiNmrAtoms</span>
            <span class="n">guiAtom</span><span class="o">.</span><span class="n">clearConnectedList</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;peakAssignments&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>

            <span class="c1"># # create a set of sets ordered by spectra for active lines</span>
            <span class="c1"># self.LOCALinterResidueAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
            <span class="c1"># self.LOCALinterChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>
            <span class="c1"># self.LOCALcrossChainAtomPairing = OrderedDict((spec, set()) for spec in self._module.magnetisationTransfers.keys())</span>

            <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span><span class="p">:</span>

                <span class="c1"># only process residues in the current visible chain</span>
                <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">is</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span> <span class="ow">and</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span><span class="p">:</span>
                    <span class="c1"># add the internally connected Lines</span>
                    <span class="n">internalAssignments</span><span class="p">,</span> <span class="n">interChainAssignments</span><span class="p">,</span> <span class="n">crossChainAssignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_getPeakAssignmentsForResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span>
                                                                                                                                          <span class="n">nmrAtomIncludeList</span><span class="o">=</span><span class="n">nmrAtomIncludeList</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">internalAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">interChainAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToAdjacentGroup</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">crossChainAssignments</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="ow">and</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="p">:</span>
                    <span class="n">nextNmrResidue</span> <span class="o">=</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span>

                    <span class="c1"># only process residues in the current visible chain</span>
                    <span class="c1"># add the internally connected Lines</span>
                    <span class="n">internalAssignments</span><span class="p">,</span> <span class="n">interChainAssignments</span><span class="p">,</span> <span class="n">crossChainAssignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_getPeakAssignmentsForResidue</span><span class="p">(</span><span class="n">nextNmrResidue</span><span class="p">,</span>
                                                                                                                                          <span class="n">nmrAtomIncludeList</span><span class="o">=</span><span class="n">nmrAtomIncludeList</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">internalAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToGroup</span><span class="p">(</span><span class="n">interChainAssignments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_addPeakAssignmentLinesToAdjacentGroup</span><span class="p">(</span><span class="n">nextNmrResidue</span><span class="p">,</span> <span class="n">crossChainAssignments</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">connectingLines</span><span class="p">)</span>

            <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterResidueAtomPairing, self.assignmentLines)</span>
            <span class="c1"># self._addPeakAssignmentLinesToGroup(self.LOCALinterChainAtomPairing, self.assignmentLines)</span>
            <span class="c1"># self._addPeakAssignmentLinesToAdjacentGroup(self._module.nmrChain, self.LOCALcrossChainAtomPairing,</span>
            <span class="c1">#                                             self.assignmentLines, self.connectingLines)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">updateGuiResiduePositions</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">updateMainChain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">updateConnectedChains</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># def _rebuildPeakLines(self, peaks, rebuildPeakLines=False, makeListFromPeak=False):</span>
    <span class="c1">#     &quot;&quot;&quot;Clear all lines on the display associated with peak.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # find the current lines associated with the notified peak (or list of peaks)</span>
    <span class="c1">#     peaks = makeIterableList(peaks)</span>
    <span class="c1">#</span>
    <span class="c1">#     # make list of peakLines attached to these peaks</span>
    <span class="c1">#     peakLines = [peakLine for peakLineList in self.assignmentLines.values()</span>
    <span class="c1">#                  for peakLine in peakLineList</span>
    <span class="c1">#                  if peakLine._peak in peaks]</span>
    <span class="c1">#</span>
    <span class="c1">#     guiNmrAtomSet = set()</span>
    <span class="c1">#     nmrResidueSet = set()</span>
    <span class="c1">#</span>
    <span class="c1">#     if not makeListFromPeak:</span>
    <span class="c1">#         # make a list of all the guiNmrAtoms/nmrResidues that are associated with the peak</span>
    <span class="c1">#         for peakLine in peakLines:</span>
    <span class="c1">#             # current associated guiNmrAtoms</span>
    <span class="c1">#             guiNmrAtomSet.add(peakLine.guiAtom1)</span>
    <span class="c1">#             guiNmrAtomSet.add(peakLine.guiAtom2)</span>
    <span class="c1">#</span>
    <span class="c1">#             # current associated nmrResidues and their previous/nextNmrResidues</span>
    <span class="c1">#             self._addAdjacentResiduesToSet(peakLine.guiAtom1.nmrAtom.nmrResidue, nmrResidueSet)</span>
    <span class="c1">#             self._addAdjacentResiduesToSet(peakLine.guiAtom2.nmrAtom.nmrResidue, nmrResidueSet)</span>
    <span class="c1">#</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         # make a new list for creating a peak; necessary for undo of delete peak as the assignedNmrAtom list exists</span>
    <span class="c1">#         assignmentAtoms = set([nmrAtom for peak in peaks</span>
    <span class="c1">#                                for assignment in peak.assignments</span>
    <span class="c1">#                                for nmrAtom in assignment</span>
    <span class="c1">#                                if nmrAtom in self.guiNmrAtomDict])</span>
    <span class="c1">#         for nmrAtom in assignmentAtoms:</span>
    <span class="c1">#             # for peak in peaks:</span>
    <span class="c1">#             #     for assignment in peak.assignments:</span>
    <span class="c1">#             #         for nmrAtom in assignment:</span>
    <span class="c1">#             #</span>
    <span class="c1">#             #             if nmrAtom in self.guiNmrAtomDict:</span>
    <span class="c1">#             guiNmrAtomSet.add(self.guiNmrAtomDict[nmrAtom])</span>
    <span class="c1">#             self._addAdjacentResiduesToSet(nmrAtom.nmrResidue, nmrResidueSet)</span>
    <span class="c1">#</span>
    <span class="c1">#     for guiAtom in guiNmrAtomSet:</span>
    <span class="c1">#         for peakLineList in self.assignmentLines.values():</span>
    <span class="c1">#             peakLines = [peakLine for peakLine in peakLineList</span>
    <span class="c1">#                          if peakLine.guiAtom1 is guiAtom or peakLine.guiAtom2 is guiAtom]</span>
    <span class="c1">#</span>
    <span class="c1">#             # remove all graphic lines</span>
    <span class="c1">#             for peakLine in peakLines:</span>
    <span class="c1">#                 peakLineList.remove(peakLine)</span>
    <span class="c1">#                 self.scene.removeItem(peakLine)</span>
    <span class="c1">#</span>
    <span class="c1">#         # clear connectivity list of guiNmrAtoms</span>
    <span class="c1">#         guiAtom.clearConnectedList()</span>
    <span class="c1">#</span>
    <span class="c1">#     if rebuildPeakLines:</span>
    <span class="c1">#         # now rebuild for the new peak values</span>
    <span class="c1">#         # assumes that the peakAssignments have changed - possibly use different notifier</span>
    <span class="c1">#         if self._SGwidget.checkBoxes[&#39;peakAssignments&#39;][&#39;checkBox&#39;].isChecked():</span>
    <span class="c1">#             for nmrResidue in nmrResidueSet:</span>
    <span class="c1">#</span>
    <span class="c1">#                 # only process residues in the current visible chain</span>
    <span class="c1">#                 if nmrResidue is nmrResidue.mainNmrResidue and nmrResidue.nmrChain is self.nmrChain:</span>
    <span class="c1">#                     # add the internally connected Lines</span>
    <span class="c1">#                     internalAssignments, interChainAssignments, crossChainAssignments = self._getPeakAssignmentsForResidue(nmrResidue,</span>
    <span class="c1">#                                                                                                                            nmrAtomIncludeList=tuple(</span>
    <span class="c1">#                                                                                                                                    guiAtom.nmrAtom for</span>
    <span class="c1">#                                                                                                                                    guiAtom in</span>
    <span class="c1">#                                                                                                                                    guiNmrAtomSet))</span>
    <span class="c1">#                     self._addPeakAssignmentLinesToGroup(internalAssignments, self.assignmentLines)</span>
    <span class="c1">#                     self._addPeakAssignmentLinesToGroup(interChainAssignments, self.assignmentLines)</span>
    <span class="c1">#                     self._addPeakAssignmentLinesToAdjacentGroup(nmrResidue, crossChainAssignments,</span>
    <span class="c1">#                                                                 self.assignmentLines, self.connectingLines)</span>
    <span class="c1">#</span>
    <span class="c1">#         self._updateGuiResiduePositions(updateMainChain=True, updateConnectedChains=True)</span>

    <span class="k">def</span> <span class="nf">_updatePeaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the peaks in the display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">OBJECT</span><span class="p">]</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">TRIGGER</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sceneBlocking</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;_updatePeaks delete&#39;, peak)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">rebuildPeakLines</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">rebuildPeakLines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;_updatePeaks create&#39;, peak)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">rebuildPeakLines</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">rebuildPeakLines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">makeListFromPeak</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">CHANGE</span><span class="p">:</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;_updatePeaks change&#39;, peak)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">rebuildPeakLines</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">rebuildPeakLines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">makeListFromPeak</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># def _updateNmrChains(self, data):</span>
    <span class="c1">#     &quot;&quot;&quot;Update the nmrChains in the display.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     nmrChain = data[Notifier.OBJECT]</span>
    <span class="c1">#</span>
    <span class="c1">#     # print(&#39;&gt;&gt;&gt;_updateNmrChains&#39;, nmrChain)</span>
    <span class="c1">#     trigger = data[Notifier.TRIGGER]</span>
    <span class="c1">#</span>
    <span class="c1">#     # with self.sceneBlocking():</span>
    <span class="c1">#     #     if trigger == Notifier.DELETE:</span>
    <span class="c1">#     #         print(&#39;&gt;&gt;&gt;delete nmrChain - no action&#39;, nmrChain)</span>
    <span class="c1">#     #</span>
    <span class="c1">#     #     elif trigger == Notifier.CREATE:</span>
    <span class="c1">#     #         print(&#39;&gt;&gt;&gt;create nmrChain - no action&#39;, nmrChain)</span>
    <span class="c1">#     #</span>
    <span class="c1">#     #     elif trigger == Notifier.CHANGE:</span>
    <span class="c1">#     #         print(&#39;&gt;&gt;&gt;change nmrChain - no action&#39;, nmrChain)</span>

    <span class="k">def</span> <span class="nf">_selectCurrentNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifier Callback for selecting current nmrResidue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objList</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">CallBack</span><span class="o">.</span><span class="n">OBJECT</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResiduesCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">objList</span><span class="o">.</span><span class="n">nmrResidue</span>

            <span class="c1"># redraw the nmrResidues if current is in the displayed chain and not already visible</span>
            <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">and</span> <span class="n">nmrResidue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_updateNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the nmrResidues in the display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">OBJECT</span><span class="p">]</span>

        <span class="c1"># print(&#39;&gt;&gt;&gt;_updateNmrResidues&#39;, nmrResidue)</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">TRIGGER</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sceneBlocking</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;delete nmrResidue&#39;, nmrResidue)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deleteNmrResidues</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;create nmrResidue&#39;, nmrResidue)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createNmrResidues</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">):</span>
                    <span class="c1"># print(&#39;&gt;&gt;&gt;error? redraw list&#39;)</span>
                    <span class="c1"># self.setNmrChainDisplay(self.nmrChain)</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">RENAME</span><span class="p">:</span>
                <span class="n">oldPid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">OLDPID</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_renameNmrResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">oldPid</span><span class="p">)</span>

            <span class="c1"># elif trigger == Notifier.CHANGE:</span>
            <span class="c1">#     print(&#39;&gt;&gt;&gt;change nmrResidue - no action&#39;, nmrResidue)</span>
            <span class="c1">#</span>
            <span class="c1"># elif trigger == Notifier.OBSERVE:</span>
            <span class="c1">#     print(&#39;&gt;&gt;&gt;observe nmrResidue - no action&#39;, nmrResidue)</span>

    <span class="k">def</span> <span class="nf">_changeNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the nmrResidues in the display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmrResidue</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">OBJECT</span><span class="p">]</span>

        <span class="c1"># print(&#39;&gt;&gt;&gt;_changeNmrResidues&#39;, nmrResidue)</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">TRIGGER</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sceneBlocking</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">nmrResidues</span> <span class="ow">and</span> <span class="n">nmrResidue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">:</span>
                    <span class="c1"># print(&#39;&gt;&gt;&gt;change nmrResidue - create&#39;, nmrResidue)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createNmrResidues</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">):</span>
                        <span class="c1"># print(&#39;&gt;&gt;&gt;error? redraw list&#39;)</span>
                        <span class="c1"># self.setNmrChainDisplay(self.nmrChain)</span>
                        <span class="k">pass</span>

                <span class="k">elif</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrResidues</span> <span class="ow">and</span> <span class="n">nmrResidue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">nmrResidues</span><span class="p">:</span>
                    <span class="c1"># not in chain, but in residues as other chain</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_deleteGuiNmrResidues</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>
                    <span class="c1"># self._deleteNmrResidues(nmrResidue)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># print(&#39;&gt;&gt;&gt;change2 nmrResidue - create **** rename&#39;, nmrResidue)</span>

                    <span class="c1"># this is the event that fires on a name change</span>
                    <span class="c1"># self._deleteBadNmrResidues(nmrResidue)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_deleteNmrResidues</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createNmrResidues</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">):</span>
                        <span class="c1"># print(&#39;&gt;&gt;&gt;error? redraw list&#39;)</span>
                        <span class="c1"># self.setNmrChainDisplay(self.nmrChain)</span>
                        <span class="k">pass</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
            <span class="c1"># strange error not traced yet, interesting, but not fatal if trapped - think I&#39;ve found it</span>
            <span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_updateNmrAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the nmrAtoms in the display.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Done</span>
        <span class="n">nmrAtom</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">OBJECT</span><span class="p">]</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">TRIGGER</span><span class="p">]</span>

        <span class="c1"># only mainNmrResidues are shown on the screen</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sceneBlocking</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;delete nmrAtom&#39;, nmrAtom)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">deleteNmrAtoms</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">trigger</span> <span class="o">==</span> <span class="n">Notifier</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;create nmrAtom&#39;, nmrAtom)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">createNmrAtoms</span><span class="p">(</span><span class="n">nmrAtom</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_renameNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">,</span> <span class="n">oldPid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset pid for NmrResidue and all offset NmrResidues</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sceneBlocking</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidueLabel</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiGhostNmrResidues</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiGhostNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span><span class="o">.</span><span class="n">nmrResidueLabel</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

            <span class="c1"># nmrChainPid = self.nmrChainPulldown.getText()</span>
            <span class="c1"># if self.project.getByPid(nmrChainPid):</span>
            <span class="c1">#</span>
            <span class="c1">#     for nr in [nmrResidue] + list(nmrResidue.offsetNmrResidues):</span>
            <span class="c1">#         for guiNmrResidueGroup in self.nmrResidueList.guiNmrResidues.values():</span>
            <span class="c1">#             if guiNmrResidueGroup.nmrResidue is nr:</span>
            <span class="c1">#                 guiNmrResidueGroup.nmrResidueLabel._update()</span>

    <span class="k">def</span> <span class="nf">_createNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new nmrResidues in the scene</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;&gt;&gt;&gt;_createNmrResidues&#39;)</span>

        <span class="c1"># get the nmrResidue in the current selected chain</span>
        <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nmrChainId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">thisResList</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrResidue</span> <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span> <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">nmrChainId</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thisResList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_buildNmrResidues</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">thisResList</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_deleteNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the nmrResidue from the scene</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;&gt;&gt;&gt;_deleteNmrResidues&#39;)</span>

        <span class="c1"># get the nmrResidue in the current selected chain</span>
        <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nmrChainId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">thisResList</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrResidue</span> <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span> <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">nmrChainId</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thisResList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_removeNmrResidues</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">thisResList</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_removeNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrResidues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the nmrResidue from the scene</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;&gt;&gt;&gt;  _removeNmrResidues&#39;)</span>

        <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span><span class="p">:</span>

            <span class="c1"># this SHOULD never fail</span>
            <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>

            <span class="c1"># take the current nmrList, and remove the deleted nmrResidue</span>
            <span class="c1"># with the mainNmrResidues - should be correct order or empty</span>
            <span class="n">delResSet</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">])</span> <span class="o">-</span>
                             <span class="n">OrderedSet</span><span class="p">([</span><span class="n">nmrResidue</span><span class="p">]))</span>
            <span class="c1"># print(&#39;&gt;&gt;&gt;    delResSet&#39;, delResSet)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span> <span class="o">=</span> <span class="n">delResSet</span>

            <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># rebuild peak lines, etc, for the previous nmrResidue - may need to check for +1 offsets</span>
                <span class="n">previousNmrResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">][</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rebuildNmrResidues</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">previousNmrResidue</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanupNmrResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="c1"># update the prediction in the sequenceModule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictSequencePosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">])</span>

        <span class="c1"># # ignore if not in the visible chain</span>
        <span class="c1"># ii = self.nmrResidueList.getIndexNmrResidue(nmrResidue)</span>
        <span class="c1"># if ii is not None:</span>
        <span class="c1">#     self.nmrResidueList.deleteNmrResidueIndex(ii)</span>
        <span class="c1">#</span>
        <span class="c1">#     if ii:</span>
        <span class="c1">#         previousNmrResidue, guiAtom = self.nmrResidueList._getNmrResiduePair(ii - 1)</span>
        <span class="c1">#         self._rebuildNmrResidues(previousNmrResidue)</span>

        <span class="c1"># ii = self.predictedStretch.index(nmrResidue)</span>
        <span class="c1"># # nmrResiduesToUpdate = self.predictedStretch[max(0, ii - 1):min(ii + 1, len(self.predictedStretch))]</span>
        <span class="c1">#</span>
        <span class="c1"># # remove from the visible list</span>
        <span class="c1"># self.predictedStretch.pop(ii)</span>
        <span class="c1"># self.guiResiduesShown.pop(ii)</span>
        <span class="c1">#</span>
        <span class="c1"># if ii:</span>
        <span class="c1">#     previousNmrResidue = self.predictedStretch[ii - 1]</span>
        <span class="c1">#     self._rebuildNmrResidues(previousNmrResidue)</span>

        <span class="c1"># if nmrResidue.previousNmrResidue:</span>
        <span class="c1">#     previousNmrResidue = nmrResidue.previousNmrResidue.mainNmrResidue</span>
        <span class="c1">#     self._rebuildNmrResidues(previousNmrResidue)</span>

        <span class="c1"># guiNmrAtomSet = set([self.nmrResidueList.guiNmrAtoms[nmrAtom] for nmrAtom in nmrResidue.nmrAtoms</span>
        <span class="c1">#                      if nmrAtom in self.nmrResidueList.guiNmrAtoms])</span>
        <span class="c1">#</span>
        <span class="c1"># for guiAtom in guiNmrAtomSet:</span>
        <span class="c1">#     for guiLineList in self.nmrResidueList.assignmentLines.values():</span>
        <span class="c1">#         guiLines = [guiLine for guiLine in guiLineList</span>
        <span class="c1">#                     if guiLine.guiAtom1 is guiAtom or guiLine.guiAtom2 is guiAtom]</span>
        <span class="c1">#</span>
        <span class="c1">#         # remove all graphic lines</span>
        <span class="c1">#         for guiLine in guiLines:</span>
        <span class="c1">#             guiLineList.remove(guiLine)</span>
        <span class="c1">#             if guiLine in self.scene.items():</span>
        <span class="c1">#                 self.scene.removeItem(guiLine)</span>
        <span class="c1">#</span>
        <span class="c1">#     for guiLineList in self.nmrResidueList.connectingLines.values():</span>
        <span class="c1">#         guiLines = [guiLine for guiLine in guiLineList</span>
        <span class="c1">#                     if guiLine.guiAtom1 is guiAtom or guiLine.guiAtom2 is guiAtom]</span>
        <span class="c1">#</span>
        <span class="c1">#         # remove all graphic lines</span>
        <span class="c1">#         for guiLine in guiLines:</span>
        <span class="c1">#             guiLineList.remove(guiLine)</span>
        <span class="c1">#             if guiLine in self.scene.items():</span>
        <span class="c1">#                 self.scene.removeItem(guiLine)</span>
        <span class="c1">#</span>
        <span class="c1">#     # clear connectivity list of guiNmrAtoms</span>
        <span class="c1">#     guiAtom.clearConnectedList()</span>
        <span class="c1">#</span>
        <span class="c1"># self.scene.removeItem(self.nmrResidueList.guiNmrResidues[nmrResidue])</span>

    <span class="k">def</span> <span class="nf">_cleanupNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove guiNmrAtoms and guiNmrResidue from scene</span>
<span class="sd">        Clean up dicts in nmrResidueList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guiNmrAtomSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">[</span><span class="n">nmrAtom</span><span class="p">]</span> <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span>
                             <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">guiAtom</span> <span class="ow">in</span> <span class="n">guiNmrAtomSet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">guiLineList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">assignmentLines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">guiLines</span> <span class="o">=</span> <span class="p">[</span><span class="n">guiLine</span> <span class="k">for</span> <span class="n">guiLine</span> <span class="ow">in</span> <span class="n">guiLineList</span>
                            <span class="k">if</span> <span class="n">guiLine</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="ow">is</span> <span class="n">guiAtom</span> <span class="ow">or</span> <span class="n">guiLine</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="ow">is</span> <span class="n">guiAtom</span><span class="p">]</span>

                <span class="c1"># remove all graphic lines</span>
                <span class="k">for</span> <span class="n">guiLine</span> <span class="ow">in</span> <span class="n">guiLines</span><span class="p">:</span>
                    <span class="n">guiLineList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">guiLine</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">guiLine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">guiLine</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">guiLineList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">connectingLines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">guiLines</span> <span class="o">=</span> <span class="p">[</span><span class="n">guiLine</span> <span class="k">for</span> <span class="n">guiLine</span> <span class="ow">in</span> <span class="n">guiLineList</span>
                            <span class="k">if</span> <span class="n">guiLine</span><span class="o">.</span><span class="n">guiAtom1</span> <span class="ow">is</span> <span class="n">guiAtom</span> <span class="ow">or</span> <span class="n">guiLine</span><span class="o">.</span><span class="n">guiAtom2</span> <span class="ow">is</span> <span class="n">guiAtom</span><span class="p">]</span>

                <span class="c1"># remove all graphic lines</span>
                <span class="k">for</span> <span class="n">guiLine</span> <span class="ow">in</span> <span class="n">guiLines</span><span class="p">:</span>
                    <span class="n">guiLineList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">guiLine</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">guiLine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">guiLine</span><span class="p">)</span>

            <span class="c1"># clear connectivity list of guiNmrAtoms</span>
            <span class="n">guiAtom</span><span class="o">.</span><span class="n">clearConnectedList</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">])</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrResidues</span><span class="p">[</span><span class="n">nmrResidue</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">guiNmrAtoms</span><span class="p">[</span><span class="n">nmrAtom</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_deleteGuiNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete items from an old nmrResidue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;&gt;&gt;&gt;_deleteGuiNmrResidues&#39;)</span>

        <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">makeIterableList</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidues</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanupNmrResidue</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">)</span>

        <span class="c1"># nmrChains contain nmrResidue in the wrong place and must be removed before sequence prediction</span>
        <span class="k">for</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">thisResList</span> <span class="o">=</span> <span class="p">[</span><span class="n">nmrResidue</span> <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrList</span> <span class="k">if</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">nmrChainId</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thisResList</span><span class="p">:</span>
                <span class="c1"># update the prediction in the sequenceModule</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictSequencePosition</span><span class="p">(</span><span class="n">thisResList</span><span class="p">)</span>

            <span class="c1"># put all the guiResidueGroups in the correct positions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">updateGuiResiduePositions</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">updateMainChain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">updateConnectedChains</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># guiNmrAtomSet = set([self.nmrResidueList.guiNmrAtoms[nmrAtom] for nmrAtom in nmrResidue.nmrAtoms</span>
            <span class="c1">#                      if nmrAtom in self.nmrResidueList.guiNmrAtoms])</span>
            <span class="c1">#</span>
            <span class="c1"># for guiAtom in guiNmrAtomSet:</span>
            <span class="c1">#     for guiLineList in self.nmrResidueList.assignmentLines.values():</span>
            <span class="c1">#         guiLines = [guiLine for guiLine in guiLineList</span>
            <span class="c1">#                     if guiLine.guiAtom1 is guiAtom or guiLine.guiAtom2 is guiAtom]</span>
            <span class="c1">#</span>
            <span class="c1">#         # remove all graphic lines</span>
            <span class="c1">#         for guiLine in guiLines:</span>
            <span class="c1">#             guiLineList.remove(guiLine)</span>
            <span class="c1">#             if guiLine in self.scene.items():</span>
            <span class="c1">#                 self.scene.removeItem(guiLine)</span>
            <span class="c1">#</span>
            <span class="c1">#     for guiLineList in self.nmrResidueList.connectingLines.values():</span>
            <span class="c1">#         guiLines = [guiLine for guiLine in guiLineList</span>
            <span class="c1">#                     if guiLine.guiAtom1 is guiAtom or guiLine.guiAtom2 is guiAtom]</span>
            <span class="c1">#</span>
            <span class="c1">#         # remove all graphic lines</span>
            <span class="c1">#         for guiLine in guiLines:</span>
            <span class="c1">#             guiLineList.remove(guiLine)</span>
            <span class="c1">#             if guiLine in self.scene.items():</span>
            <span class="c1">#                 self.scene.removeItem(guiLine)</span>
            <span class="c1">#</span>
            <span class="c1">#     # clear connectivity list of guiNmrAtoms</span>
            <span class="c1">#     guiAtom.clearConnectedList()</span>
            <span class="c1">#</span>
            <span class="c1"># self.scene.removeItem(self.nmrResidueList.guiNmrResidues[nmrResidue])</span>

            <span class="c1"># oldInd = self.nmrResidueList.getIndexNmrResidue(nmrResidue)</span>
            <span class="c1"># ii = self.nmrChain.mainNmrResidues</span>
            <span class="c1"># self._storeIndex(nmrResidue, oldInd)</span>

            <span class="c1"># self.nmrResidueList.deleteNmrResidue(nmrResidue)</span>
            <span class="c1"># del self.nmrResidueList.guiNmrResidues[nmrResidue]</span>
            <span class="c1"># for nmrAtom in nmrResidue.nmrAtoms:</span>
            <span class="c1">#     del self.nmrResidueList.guiNmrAtoms[nmrAtom]</span>

    <span class="c1"># def _storeIndex(self, nmrResidue, index):</span>
    <span class="c1">#     &quot;&quot;&quot;Store the index for the undo.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if not nmrResidue in self._deleteStore:</span>
    <span class="c1">#         self._deleteStore[nmrResidue] = []</span>
    <span class="c1">#     self._deleteStore[nmrResidue].append(index)</span>

    <span class="c1"># def _restoreIndex(self, nmrResidue):</span>
    <span class="c1">#     &quot;&quot;&quot;Retrieve the index of the deleted item.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if nmrResidue in self._deleteStore:</span>
    <span class="c1">#         return self._deleteStore[nmrResidue].pop()</span>
    <span class="c1">#</span>
    <span class="c1">#     return None</span>

    <span class="c1"># def _deleteBadNmrResidues(self, nmrResidues):</span>
    <span class="c1">#     &quot;&quot;&quot;Delete the nmrResidue from the scene</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     print(&#39;&gt;&gt;&gt;_deleteBadNmrResidues&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     nmrResidues = makeIterableList(nmrResidues)</span>
    <span class="c1">#</span>
    <span class="c1">#     for nmrResidue in nmrResidues:</span>
    <span class="c1">#</span>
    <span class="c1">#         ii = self.nmrResidueList.getIndexNmrResidue(nmrResidue)</span>
    <span class="c1">#         if ii is not None:</span>
    <span class="c1">#             self.nmrResidueList.deleteNmrResidueIndex(ii)</span>
    <span class="c1">#</span>
    <span class="c1">#             # # ignore if not in the visible chain</span>
    <span class="c1">#             # if nmrResidue in self.predictedStretch:</span>
    <span class="c1">#             #</span>
    <span class="c1">#             #     ii = self.predictedStretch.index(nmrResidue)</span>
    <span class="c1">#             #     # nmrResiduesToUpdate = self.predictedStretch[max(0, ii - 1):min(ii + 1, len(self.predictedStretch))]</span>
    <span class="c1">#             #</span>
    <span class="c1">#             #     # remove from the visible list</span>
    <span class="c1">#             #     self.predictedStretch.pop(ii)</span>
    <span class="c1">#             #     self.guiResiduesShown.pop(ii)</span>
    <span class="c1">#</span>
    <span class="c1">#             if ii:</span>
    <span class="c1">#                 # previousNmrResidue = self.predictedStretch[ii - 1]</span>
    <span class="c1">#                 previousNmrResidue, guiAtom = self.nmrResidueList._getNmrResiduePair(ii - 1)</span>
    <span class="c1">#                 self._rebuildNmrResidues(previousNmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#             # if nmrResidue.previousNmrResidue:</span>
    <span class="c1">#             #     previousNmrResidue = nmrResidue.previousNmrResidue.mainNmrResidue</span>
    <span class="c1">#             #     self._rebuildNmrResidues(previousNmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#             guiNmrAtomSet = set([self.nmrResidueList.guiNmrAtoms[nmrAtom] for nmrAtom in nmrResidue.nmrAtoms])</span>
    <span class="c1">#</span>
    <span class="c1">#             for guiAtom in guiNmrAtomSet:</span>
    <span class="c1">#                 for guiLineList in self.nmrResidueList.assignmentLines.values():</span>
    <span class="c1">#                     guiLines = [guiLine for guiLine in guiLineList</span>
    <span class="c1">#                                 if guiLine.guiAtom1 is guiAtom or guiLine.guiAtom2 is guiAtom]</span>
    <span class="c1">#</span>
    <span class="c1">#                     # remove all graphic lines</span>
    <span class="c1">#                     for guiLine in guiLines:</span>
    <span class="c1">#                         guiLineList.remove(guiLine)</span>
    <span class="c1">#                         if guiLine in self.scene.items():</span>
    <span class="c1">#                             self.scene.removeItem(guiLine)</span>
    <span class="c1">#</span>
    <span class="c1">#                 for guiLineList in self.nmrResidueList.connectingLines.values():</span>
    <span class="c1">#                     guiLines = [guiLine for guiLine in guiLineList</span>
    <span class="c1">#                                 if guiLine.guiAtom1 is guiAtom or guiLine.guiAtom2 is guiAtom]</span>
    <span class="c1">#</span>
    <span class="c1">#                     # remove all graphic lines</span>
    <span class="c1">#                     for guiLine in guiLines:</span>
    <span class="c1">#                         guiLineList.remove(guiLine)</span>
    <span class="c1">#                         if guiLine in self.scene.items():</span>
    <span class="c1">#                             self.scene.removeItem(guiLine)</span>
    <span class="c1">#</span>
    <span class="c1">#                 # clear connectivity list of guiNmrAtoms</span>
    <span class="c1">#                 guiAtom.clearConnectedList()</span>
    <span class="c1">#</span>
    <span class="c1">#             self.scene.removeItem(self.nmrResidueList.guiNmrResidues[nmrResidue])</span>

    <span class="c1"># def _createNmrAtoms(self, nmrAtoms):</span>
    <span class="c1">#     &quot;&quot;&quot;Create new peak lines associated with the created/undeleted nmrAtoms.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     nmrAtoms = makeIterableList(nmrAtoms)</span>
    <span class="c1">#     peaks = [peak for nmrAtom in nmrAtoms for peak in nmrAtom.assignedPeaks]</span>
    <span class="c1">#</span>
    <span class="c1">#     for nmrAtom in nmrAtoms:</span>
    <span class="c1">#         if nmrAtom not in self.guiNmrAtomDict:</span>
    <span class="c1">#             self._addNmrAtomToGuiResidues(nmrAtom)</span>
    <span class="c1">#     self.nmrResidueList.rebuildPeakLines(peaks, rebuildPeakLines=True, makeListFromPeak=True)</span>
    <span class="c1">#</span>
    <span class="c1"># def _deleteNmrAtoms(self, nmrAtoms):</span>
    <span class="c1">#     &quot;&quot;&quot;Delete peak lines associated with the deleted nmrAtoms.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     nmrAtoms = makeIterableList(nmrAtoms)</span>
    <span class="c1">#     peakLines = self._searchPeakLines(nmrAtoms, includeDeleted=True)</span>
    <span class="c1">#     peaks = [peakLine._peak for peakLine in peakLines]</span>
    <span class="c1">#</span>
    <span class="c1">#     self.nmrResidueList.rebuildPeakLines(peaks, rebuildPeakLines=True)</span>

    <span class="c1"># def _removeLinesFromScene(self, lineDist):</span>
    <span class="c1">#     &quot;&quot;&quot;Remove all the peakLines from the scene.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     for lineList in lineDist.values():</span>
    <span class="c1">#         for line in lineList:</span>
    <span class="c1">#             self.scene.removeItem(line)</span>
    <span class="c1">#     lineDist.clear()</span>

    <span class="c1"># def _searchPeakLines(self, nmrAtoms, includeDeleted=False):</span>
    <span class="c1">#     &quot;&quot;&quot;Return a list of the peakLines containing one of the nmrAtoms in the list.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     peakLines = []</span>
    <span class="c1">#     for lineList in self.assignmentLines.values():</span>
    <span class="c1">#         for line in lineList:</span>
    <span class="c1">#             nmrAtom = line.guiAtom1.nmrAtom if line.guiAtom1 else None</span>
    <span class="c1">#             if nmrAtom in nmrAtoms and (includeDeleted or not (nmrAtom.isDeleted or nmrAtom._flaggedForDelete)):</span>
    <span class="c1">#                 peakLines.append(line)</span>
    <span class="c1">#             nmrAtom = line.guiAtom2.nmrAtom if line.guiAtom2 else None</span>
    <span class="c1">#             if nmrAtom in nmrAtoms and (includeDeleted or not (nmrAtom.isDeleted or nmrAtom._flaggedForDelete)):</span>
    <span class="c1">#                 peakLines.append(line)</span>
    <span class="c1">#</span>
    <span class="c1">#     return peakLines</span>

    <span class="k">def</span> <span class="nf">_updateEndPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the end points from the dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lineList</span> <span class="ow">in</span> <span class="n">lineDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lineList</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">updateEndPoints</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_buildNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrResidueList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the new residues in the list, inserting into the predicted stretch at the correct index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;&gt;&gt;&gt;  _buildNmrResidues&#39;)</span>

        <span class="c1"># this SHOULD be a list of only one item but use like this just to be sure</span>
        <span class="k">for</span> <span class="n">nmrResidue</span> <span class="ow">in</span> <span class="n">nmrResidueList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nmrResidue</span> <span class="ow">is</span> <span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="p">:</span>

                <span class="c1"># take the current nmrList, and the new nmrResidue, and get intersection</span>
                <span class="c1"># with the mainNmrResidues - should be correct order or empty</span>
                <span class="n">newResSet</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">OrderedSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">])</span> <span class="o">|</span>
                                  <span class="n">OrderedSet</span><span class="p">([</span><span class="n">nmrResidue</span><span class="p">]))</span> <span class="o">&amp;</span> \
                                 <span class="n">OrderedSet</span><span class="p">(</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">mainNmrResidues</span><span class="p">))</span>  <span class="c1"># keeps the ordering of the second set</span>
                <span class="c1"># print(&#39;&gt;&gt;&gt;    newResSet&#39;, newResSet)</span>

                <span class="c1"># if not showing all nmrResidues then get the connected stretch from the current nmrResidue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResiduesCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                    <span class="c1"># get the connected stretch of mainNmrResidues</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                        <span class="n">mainNmrRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span>
                        <span class="k">if</span> <span class="n">mainNmrRes</span> <span class="ow">in</span> <span class="n">newResSet</span><span class="p">:</span>
                            <span class="n">indL</span> <span class="o">=</span> <span class="n">indR</span> <span class="o">=</span> <span class="n">newResSet</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mainNmrRes</span><span class="p">)</span>
                            <span class="k">while</span> <span class="n">newResSet</span><span class="p">[</span><span class="n">indL</span><span class="p">]</span><span class="o">.</span><span class="n">previousNmrResidue</span> <span class="ow">and</span> <span class="n">indL</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">indL</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">while</span> <span class="n">newResSet</span><span class="p">[</span><span class="n">indR</span><span class="p">]</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="ow">and</span> <span class="n">indR</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">newResSet</span><span class="p">):</span>
                                <span class="n">indR</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">newResSet</span> <span class="o">=</span> <span class="n">newResSet</span><span class="p">[</span><span class="n">indL</span><span class="p">:</span><span class="n">indR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">newResSet</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># update to the new list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">]</span> <span class="o">=</span> <span class="n">newResSet</span>

                <span class="c1"># iterate through and and add new residues that don&#39;t already exists</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">nmrRes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newResSet</span><span class="p">):</span>
                    <span class="c1"># do not _insertNmrRes as the list is built</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">addNmrResidue</span><span class="p">(</span><span class="n">nmrChainId</span><span class="p">,</span> <span class="n">nmrRes</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">_insertNmrRes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># add the connecting lines</span>
        <span class="c1"># guiNmrResidues = [self.guiNmrResidues[nmrResidue] for nmrResidue in nmrResidueList if nmrResidue is nmrResidue.mainNmrResidue]</span>

        <span class="c1"># add the connecting lines</span>
        <span class="c1"># self.nmrResidueList.addConnectionsBetweenGroups()</span>

        <span class="c1"># for ii, res in enumerate(guiNmrResidues):</span>
        <span class="c1">#     if not self.nmrResiduesCheckBox.isChecked() or ii in connectingLinesNeeded:</span>
        <span class="c1">#         self._addConnectingLineToGroup(tuple(self.guiNmrResidues.values())[ii],</span>
        <span class="c1">#                                        res[&#39;C&#39;], self.guiResiduesShown[ii + 1][&#39;N&#39;],</span>
        <span class="c1">#                                        self._lineColour, 1.0, lineList=self.connectingLines, lineId=res)</span>

        <span class="c1"># # add connecting lines</span>
        <span class="c1"># newList = OrderedSet()</span>
        <span class="c1"># connectsNeeded = self._module.nmrResiduesCheckBox.isChecked()</span>
        <span class="c1">#</span>
        <span class="c1"># for nmr in nmrResidueList:</span>
        <span class="c1">#     newList.add(nmr)</span>
        <span class="c1">#     if nmr.nextNmrResidue and nmr.nextNmrResidue.mainNmrResidue:</span>
        <span class="c1">#         newList.add(nmr.nextNmrResidue.mainNmrResidue)</span>
        <span class="c1">#</span>
        <span class="c1">#         nextNmr = nmr.nextNmrResidue.mainNmrResidue</span>
        <span class="c1">#</span>
        <span class="c1">#         indThis = self.nmrResidueList.getIndexNmrResidue(nmr)</span>
        <span class="c1">#         indNext = self.nmrResidueList.getIndexNmrResidue(nextNmr)</span>
        <span class="c1">#</span>
        <span class="c1">#         if indThis is not None and indNext is not None:</span>
        <span class="c1">#             # add connecting line</span>
        <span class="c1">#</span>
        <span class="c1">#             prev = self.nmrResidueList._getNmrResiduePair(indThis)</span>
        <span class="c1">#             this = self.nmrResidueList._getNmrResiduePair(indNext)</span>
        <span class="c1">#</span>
        <span class="c1">#             # add the connection the minus residue and point to the right - may need to change for +1 residues</span>
        <span class="c1">#             prevRes, prevGuiAtoms = prev</span>
        <span class="c1">#             thisRes, thisGuiAtoms = this</span>
        <span class="c1">#</span>
        <span class="c1">#             if (prevRes.nextNmrResidue and prevRes.nextNmrResidue is thisRes) and connectsNeeded:</span>
        <span class="c1">#                 # connect from this &#39;N&#39; to the previous &#39;C&#39;</span>
        <span class="c1">#                 self._addConnectingLineToGroup(self.guiNmrResidues[prevRes],</span>
        <span class="c1">#                                                prevGuiAtoms[&#39;C&#39;], thisGuiAtoms[&#39;N&#39;],</span>
        <span class="c1">#                                                self._lineColour, 1.0, lineList=self.connectingLines,</span>
        <span class="c1">#                                                lineId=thisRes)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">rebuildNmrResidues</span><span class="p">(</span><span class="n">nmrResidueList</span><span class="p">)</span>

        <span class="c1"># update the prediction in the sequenceModule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictSequencePosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">nmrChainId</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># # add the peakAssignments</span>
        <span class="c1"># if self._SGwidget.checkBoxes[&#39;peakAssignments&#39;][&#39;checkBox&#39;].isChecked():</span>
        <span class="c1">#     for nmrResidue in nmrResidueList:</span>
        <span class="c1">#         if nmrResidue is nmrResidue.mainNmrResidue:</span>
        <span class="c1">#             # add the internally connected Lines</span>
        <span class="c1">#             internalAssignments, interChainAssignments, crossChainAssignments = self._getPeakAssignmentsForResidue(nmrResidue)</span>
        <span class="c1">#             self._addPeakAssignmentLinesToGroup(internalAssignments, self.assignmentLines)</span>
        <span class="c1">#             self._addPeakAssignmentLinesToGroup(interChainAssignments, self.assignmentLines)</span>
        <span class="c1">#             self._addPeakAssignmentLinesToAdjacentGroup(nmrResidue, crossChainAssignments,</span>
        <span class="c1">#                                                         self.assignmentLines, self.connectingLines)</span>
        <span class="c1">#</span>
        <span class="c1"># self._updateGuiResiduePositions(updateMainChain=True, updateConnectedChains=True)</span>

<div class="viewcode-block" id="SequenceGraphModule.removeNmrChainNotifiers"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.removeNmrChainNotifiers">[docs]</a>    <span class="k">def</span> <span class="nf">removeNmrChainNotifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove notifiers that are set on nmrChains.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmrChains</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">)</span>
        <span class="n">foundNotifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchNotifiers</span><span class="p">(</span><span class="n">objects</span><span class="o">=</span><span class="n">nmrChains</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">OBSERVE</span><span class="p">],</span> <span class="n">targetName</span><span class="o">=</span><span class="s1">&#39;nmrResidues&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">foundNotifiers</span><span class="p">:</span>
            <span class="c1"># print(&#39;&gt;&gt;&gt;deleting notifier&#39;, notifier)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deleteNotifier</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span></div>

<div class="viewcode-block" id="SequenceGraphModule.addNmrChainNotifiers"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.addNmrChainNotifiers">[docs]</a>    <span class="k">def</span> <span class="nf">addNmrChainNotifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add new notifiers for all nmrChains in the project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">nmrChain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setNotifier</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="p">[</span><span class="n">Notifier</span><span class="o">.</span><span class="n">OBSERVE</span><span class="p">],</span> <span class="n">targetName</span><span class="o">=</span><span class="s1">&#39;nmrResidues&#39;</span><span class="p">,</span>
                             <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_changeNmrResidues</span><span class="p">)</span></div>

<div class="viewcode-block" id="SequenceGraphModule.resetScene"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.resetScene">[docs]</a>    <span class="k">def</span> <span class="nf">resetScene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset all gui items and data in the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">itemsBoundingRect</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thisSequenceModule</span><span class="o">.</span><span class="n">_initialiseChainLabels</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.setNmrChain"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.setNmrChain">[docs]</a>    <span class="k">def</span> <span class="nf">setNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChain</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">=</span> <span class="n">nmrChain</span></div>

<div class="viewcode-block" id="SequenceGraphModule.setNmrChainDisplay"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.setNmrChainDisplay">[docs]</a>    <span class="k">def</span> <span class="nf">setNmrChainDisplay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainOrPid</span><span class="p">):</span>

        <span class="c1"># print(&#39;&gt;&gt;&gt;setNmrChainDisplay&#39;)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nmrChainOrPid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Pid</span><span class="o">.</span><span class="n">isValid</span><span class="p">(</span><span class="n">nmrChainOrPid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resetScene</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="n">nmrChain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">nmrChainOrPid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">nmrChainOrPid</span>

        <span class="c1"># nmrChainOrPid could be &#39;&lt;Select&gt;&#39; in which case nmrChain would be None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nmrChain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetScene</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">=</span> <span class="n">nmrChain</span>
        <span class="n">thisChainId</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span>

        <span class="k">with</span> <span class="n">notificationEchoBlocking</span><span class="p">():</span>

            <span class="c1"># currently only handles one visible nmrChain at a time - but changing to a dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetScene</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setNmrChain</span><span class="p">(</span><span class="n">nmrChain</span><span class="p">)</span>

            <span class="c1"># self.removeNmrChainNotifiers()</span>
            <span class="c1"># self.addNmrChainNotifiers()</span>

            <span class="n">nmrList</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">mainNmrResidues</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResiduesCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                <span class="n">nmrList</span> <span class="o">=</span> <span class="n">nmrChain</span><span class="o">.</span><span class="n">mainNmrResidues</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResiduesCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>

                <span class="c1"># get the connected stretch of mainNmrResidues</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                    <span class="n">mainNmrRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span>
                    <span class="k">if</span> <span class="n">mainNmrRes</span> <span class="ow">in</span> <span class="n">nmrList</span><span class="p">:</span>
                        <span class="n">indL</span> <span class="o">=</span> <span class="n">indR</span> <span class="o">=</span> <span class="n">nmrList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mainNmrRes</span><span class="p">)</span>
                        <span class="k">while</span> <span class="n">nmrList</span><span class="p">[</span><span class="n">indL</span><span class="p">]</span><span class="o">.</span><span class="n">previousNmrResidue</span> <span class="ow">and</span> <span class="n">indL</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">indL</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">while</span> <span class="n">nmrList</span><span class="p">[</span><span class="n">indR</span><span class="p">]</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="ow">and</span> <span class="n">indR</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nmrList</span><span class="p">):</span>
                            <span class="n">indR</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">nmrList</span> <span class="o">=</span> <span class="n">nmrList</span><span class="p">[</span><span class="n">indL</span><span class="p">:</span><span class="n">indR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># add the nmrResidues to the scene</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">nmrRes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nmrList</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">addNmrResidue</span><span class="p">(</span><span class="n">thisChainId</span><span class="p">,</span> <span class="n">nmrRes</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>

            <span class="c1"># add the connecting lines</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">addConnectionsBetweenGroups</span><span class="p">(</span><span class="n">thisChainId</span><span class="p">)</span>

            <span class="c1"># add the peakAssignment lines</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">_addAllPeakAssignments</span><span class="p">(</span><span class="n">thisChainId</span><span class="p">)</span>

            <span class="c1"># put all the guiResidueGroups in the correct positions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">updateGuiResiduePositions</span><span class="p">(</span><span class="n">thisChainId</span><span class="p">,</span> <span class="n">updateMainChain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">updateConnectedChains</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># update the prediction in the sequenceModule</span>
            <span class="k">if</span> <span class="n">thisChainId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictSequencePosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmrResidueList</span><span class="o">.</span><span class="n">nmrChains</span><span class="p">[</span><span class="n">thisChainId</span><span class="p">])</span></div>

<div class="viewcode-block" id="SequenceGraphModule.showNmrChainFromPulldown"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.showNmrChainFromPulldown">[docs]</a>    <span class="k">def</span> <span class="nf">showNmrChainFromPulldown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear and redraw the nmrChain selected from the pulldown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&#39;&gt;&gt;&gt;showNmrChainFromPulldown&#39;)</span>

        <span class="n">nmrChainPid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span><span class="o">.</span><span class="n">getText</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nmrChainPid</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sceneBlocking</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setNmrChainDisplay</span><span class="p">(</span><span class="n">nmrChainPid</span><span class="p">)</span>

            <span class="c1"># check whther to update self.current.nmrChain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setCurrentNmrChain</span><span class="p">(</span><span class="n">nmrChainPid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># nmrChainOrPid could be &#39;&lt;Select&gt;&#39; in which case nmrChain would be None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetScene</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_setCurrentNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrChainOrPid</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nmrChainOrPid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Pid</span><span class="o">.</span><span class="n">isValid</span><span class="p">(</span><span class="n">nmrChainOrPid</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">nmrChain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">nmrChainOrPid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nmrChain</span> <span class="o">=</span> <span class="n">nmrChainOrPid</span>

        <span class="c1"># nmrChainOrPid could be &#39;&lt;Select&gt;&#39; in which case nmrChain would be None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nmrChain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetScene</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">checkBox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">_getCheckBox</span><span class="p">(</span><span class="n">LINKTOPULLDOWNCLASS</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrChain</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">!=</span> <span class="n">nmrChain</span> <span class="ow">and</span> <span class="n">checkBox</span> <span class="ow">and</span> <span class="n">checkBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrChain</span> <span class="o">=</span> <span class="n">nmrChain</span>

<div class="viewcode-block" id="SequenceGraphModule.resetSequenceGraph"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.resetSequenceGraph">[docs]</a>    <span class="k">def</span> <span class="nf">resetSequenceGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the module to the default nmrChain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmrChainPulldown</span><span class="o">.</span><span class="n">pulldownList</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;NC:@-&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_closeModule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CCPN-INTERNAL: used to close the module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self._unRegisterNotifiers()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thisSequenceModule</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_closeModule</span><span class="p">()</span>

<div class="viewcode-block" id="SequenceGraphModule.close"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the table from the commandline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closeModule</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.unlinkNearestNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.unlinkNearestNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">unlinkNearestNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedNmrResidue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="o">.</span><span class="n">previousNmrResidue</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">progressManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="s1">&#39;unlinking Previous NmrResidue to:</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">unlinkPreviousNmrResidue</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                        <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">es</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span><span class="o">.</span><span class="n">previousNmrResidue</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">progressManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="s1">&#39;unlinking Next NmrResidue to:</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">unlinkNextNmrResidue</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                        <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">es</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.disconnectPreviousNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.disconnectPreviousNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">disconnectPreviousNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedNmrResidue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">progressManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="s1">&#39;disconnecting Previous NmrResidue to:</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">disconnectPrevious</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">es</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.disconnectNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.disconnectNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">disconnectNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedNmrResidue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">progressManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="s1">&#39;disconnecting NmrResidue:</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">es</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.disconnectNextNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.disconnectNextNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">disconnectNextNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedNmrResidue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">progressManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="s1">&#39;disconnecting Next NmrResidue to:</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">disconnectNext</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">es</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.disconnectAllNmrResidues"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.disconnectAllNmrResidues">[docs]</a>    <span class="k">def</span> <span class="nf">disconnectAllNmrResidues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedNmrResidue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">progressManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="s1">&#39;disconnecting all NmrResidues connected to:</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">disconnectAll</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">es</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.deassignNmrChain"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.deassignNmrChain">[docs]</a>    <span class="k">def</span> <span class="nf">deassignNmrChain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedNmrResidue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nmrChain</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">progressManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="p">,</span> <span class="s1">&#39;deassigning nmrResidues in NmrChain:</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">deassignNmrChain</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">es</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showNmrChainFromPulldown</span><span class="p">()</span></div>

<div class="viewcode-block" id="SequenceGraphModule.deassignPeak"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.deassignPeak">[docs]</a>    <span class="k">def</span> <span class="nf">deassignPeak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedPeak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selectedNmrAtom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deassign the peak by removing the assigned nmrAtoms from the list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selectedPeak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">selectedPeak</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selectedPeak</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">selectedPeak</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selectedPeak</span><span class="p">,</span> <span class="n">Peak</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;selectedPeak must be of type Peak&#39;</span><span class="p">)</span>
        <span class="n">selectedNmrAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getByPid</span><span class="p">(</span><span class="n">selectedNmrAtom</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selectedNmrAtom</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">selectedNmrAtom</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selectedNmrAtom</span><span class="p">,</span> <span class="n">NmrAtom</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;selectedNmrAtom must be of type NmrAtom&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selectedPeak</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">undoBlock</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">newList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># remove the nmrAtom from the list and replace with None</span>
                    <span class="k">for</span> <span class="n">atomList</span> <span class="ow">in</span> <span class="n">selectedPeak</span><span class="o">.</span><span class="n">assignedNmrAtoms</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">atom</span> <span class="k">if</span> <span class="n">atom</span> <span class="o">!=</span> <span class="n">selectedNmrAtom</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">atomList</span><span class="p">)]</span>
                        <span class="n">newList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>

                    <span class="n">selectedPeak</span><span class="o">.</span><span class="n">assignedNmrAtoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newList</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">es</span><span class="p">:</span>
                    <span class="n">showWarning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowTitle</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">es</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">_isInDebugMode</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">es</span></div>

<div class="viewcode-block" id="SequenceGraphModule.initialiseScene"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.initialiseScene">[docs]</a>    <span class="k">def</span> <span class="nf">initialiseScene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the scene with a new one to reset the size of the scrollbars.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Only needed to be done the first time, scene is resized at the end of setNmrChainDisplay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsScene</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollContents</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollContents</span><span class="o">.</span><span class="n">setRenderHints</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollContents</span><span class="o">.</span><span class="n">setInteractive</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollContents</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollContents</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceGraphScrollArea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrollContents</span><span class="p">)</span></div>

    <span class="c1"># def deassignNmrAtom(self, selectedNmrAtom=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Remove the selected peaks from the assignedPeaks list</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     selectedNmrAtom = self.project.getByPid(selectedNmrAtom) if isinstance(selectedNmrAtom, str) else selectedNmrAtom</span>
    <span class="c1">#     if not isinstance(selectedNmrAtom, NmrAtom):</span>
    <span class="c1">#         raise TypeError(&#39;selectedNmrAtom must be of type NmrAtom&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     if selectedNmrAtom:</span>
    <span class="c1">#         with undoBlock():</span>
    <span class="c1">#             try:</span>
    <span class="c1">#                 atoms = list(selectedNmrAtom.assignedPeaks)</span>
    <span class="c1">#                 # selectedPeak.assignedNmrAtoms = ()</span>
    <span class="c1">#</span>
    <span class="c1">#                 # for peak in selectedNmrAtom.assignedPeaks:</span>
    <span class="c1">#                 #</span>
    <span class="c1">#                 #   allAtoms = list(peak.dimensionNmrAtoms)</span>
    <span class="c1">#                 #   for dim in range(len(peak.dimensionNmrAtoms)):</span>
    <span class="c1">#                 #     dimNmrAtoms = list(peak.dimensionNmrAtoms[dim])</span>
    <span class="c1">#                 #     if selectedNmrAtom in dimNmrAtoms:</span>
    <span class="c1">#                 #       dimNmrAtoms.remove(selectedNmrAtom)</span>
    <span class="c1">#                 #</span>
    <span class="c1">#                 #       # allAtoms = list(peak.dimensionNmrAtoms)</span>
    <span class="c1">#                 #       allAtoms[dim] = dimNmrAtoms</span>
    <span class="c1">#                 #</span>
    <span class="c1">#                 #   peak.dimensionNmrAtoms = allAtoms</span>
    <span class="c1">#</span>
    <span class="c1">#             except Exception as es:</span>
    <span class="c1">#                 showWarning(str(self.windowTitle()), str(es))</span>
    <span class="c1">#                 if self.application._isInDebugMode:</span>
    <span class="c1">#                     raise es</span>

    <span class="c1"># def _assembleGroupResidue(self, nmrResidue: NmrResidue, atoms: typing.Dict[str, GuiNmrAtom], pos=None, lineList=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Takes an Nmr Residue and a dictionary of atom names and GuiNmrAtoms and</span>
    <span class="c1">#     creates a graphical representation of a residue in the assigner</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     guiResidueGroup = GuiNmrResidueGroup(self, nmrResidue, atoms[&#39;CA&#39;], 0)  #atoms[&#39;H&#39;].x())</span>
    <span class="c1">#     self.guiNmrResidues[nmrResidue] = guiResidueGroup</span>
    <span class="c1">#     self.scene.addItem(guiResidueGroup)</span>
    <span class="c1">#</span>
    <span class="c1">#     # add the atoms to the group and set the reverse link</span>
    <span class="c1">#     for item in atoms.values():</span>
    <span class="c1">#         guiResidueGroup.addToGroup(item)</span>
    <span class="c1">#         item.guiNmrResidueGroup = guiResidueGroup</span>
    <span class="c1">#</span>
    <span class="c1">#     # modify the group</span>
    <span class="c1">#     nmrAtoms = [atom.name for atom in nmrResidue.nmrAtoms]</span>
    <span class="c1">#     if &quot;CB&quot; in list(atoms.keys()):</span>
    <span class="c1">#         self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;CA&#39;], atoms[&#39;CB&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#     if &quot;H&quot; in list(atoms.keys()) and nmrResidue.residueType != &#39;PRO&#39;:</span>
    <span class="c1">#         self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;H&#39;], atoms[&#39;N&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#     self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;N&#39;], atoms[&#39;CA&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#     self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;C&#39;], atoms[&#39;CA&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#     self._addGroupResiduePredictions(guiResidueGroup, nmrResidue, atoms[&#39;CA&#39;])</span>
    <span class="c1">#</span>
    <span class="c1">#     return guiResidueGroup</span>

    <span class="c1"># def _assembleGhostResidue(self, nmrResidue: NmrResidue, atoms: typing.Dict[str, GuiNmrAtom], lineList=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Takes an Nmr Residue and a dictionary of atom names and GuiNmrAtoms and</span>
    <span class="c1">#     creates a graphical representation of a residue in the assigner</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     guiResidueGroup = GuiNmrResidueGroup(self, nmrResidue, atoms[&#39;CA&#39;], 0)  #atoms[&#39;H&#39;].x())</span>
    <span class="c1">#     self.guiGhostNmrResidues[nmrResidue] = guiResidueGroup</span>
    <span class="c1">#     self.scene.addItem(guiResidueGroup)</span>
    <span class="c1">#</span>
    <span class="c1">#     # add the atoms to the group and set the reverse link</span>
    <span class="c1">#     for item in atoms.values():</span>
    <span class="c1">#         guiResidueGroup.addToGroup(item)</span>
    <span class="c1">#         item.guiNmrResidueGroup = guiResidueGroup</span>
    <span class="c1">#</span>
    <span class="c1">#     # modify the group</span>
    <span class="c1">#     nmrAtoms = [atom.name for atom in nmrResidue.nmrAtoms]</span>
    <span class="c1">#     if &quot;CB&quot; in list(atoms.keys()):</span>
    <span class="c1">#         self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;CA&#39;], atoms[&#39;CB&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#     if &quot;H&quot; in list(atoms.keys()) and nmrResidue.residueType != &#39;PRO&#39;:</span>
    <span class="c1">#         self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;H&#39;], atoms[&#39;N&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#     self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;N&#39;], atoms[&#39;CA&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#     self._addConnectingLineToGroup(guiResidueGroup, atoms[&#39;C&#39;], atoms[&#39;CA&#39;], self._lineColour, 1.0, lineList=lineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#     # self._addGroupResiduePredictions(guiResidueGroup, nmrResidue, atoms[&#39;CA&#39;])</span>
    <span class="c1">#</span>
    <span class="c1">#     return guiResidueGroup</span>

    <span class="c1"># def addSideChainAtoms(self, nmrResidue, cbAtom, atoms, colour, lineList):</span>
    <span class="c1">#     &quot;&quot;&quot;Add the sideChain atoms and connecting lines above the backbone line.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     residue = {}</span>
    <span class="c1">#     for k, v in ATOM_POSITION_DICT[nmrResidue.residueType].items():</span>
    <span class="c1">#         if k != &#39;boundAtoms&#39;:</span>
    <span class="c1">#             position = [cbAtom.x() + v[0], cbAtom.y() + v[1]]</span>
    <span class="c1">#             nmrAtom = nmrResidue.fetchNmrAtom(name=k)</span>
    <span class="c1">#             newAtom = self._createGuiNmrAtom(k, position, nmrAtom)</span>
    <span class="c1">#             self.scene.addItem(newAtom)</span>
    <span class="c1">#             residue[k] = newAtom</span>
    <span class="c1">#             atoms[k] = newAtom</span>

    <span class="c1"># self.guiNmrAtomDict[nmrAtom] = newAtom</span>

    <span class="c1"># for boundAtomPair in ATOM_POSITION_DICT[nmrResidue.residueType][&#39;boundAtoms&#39;]:</span>
    <span class="c1">#     guiAtom1 = residue[boundAtomPair[0]]</span>
    <span class="c1">#     guiAtom2 = residue[boundAtomPair[1]]</span>
    <span class="c1">#     newLine = AssignmentLine(guiAtom1.x(), guiAtom1.y(), guiAtom2.x(), guiAtom2.y(), colour, 1.0)</span>
    <span class="c1">#     self.scene.addItem(newLine)</span>

    <span class="c1"># def _addNmrAtomToGuiResidues(self, nmrAtom, atomSpacing=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Update the guiNmrAtoms for a newly created/undeleted nmrAtom.</span>
    <span class="c1">#     Assumes that the nmrAtom/guiNmrAtom does not exist</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     nmrResidue = nmrAtom.nmrResidue</span>
    <span class="c1">#</span>
    <span class="c1">#     atoms = {}</span>
    <span class="c1">#     if atomSpacing:</span>
    <span class="c1">#         self.atomSpacing = atomSpacing</span>
    <span class="c1">#     nmrAtoms = [nmrAtom.name for nmrAtom in nmrResidue.nmrAtoms]</span>
    <span class="c1">#     residueAtoms = DEFAULT_RESIDUE_ATOMS.copy()</span>
    <span class="c1">#</span>
    <span class="c1">#     for k, v in residueAtoms.items():</span>
    <span class="c1">#         if k in nmrAtoms:</span>
    <span class="c1">#             fetchedNmrAtom = nmrResidue.fetchNmrAtom(name=k)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             fetchedNmrAtom = None</span>
    <span class="c1">#         if fetchedNmrAtom is nmrAtom:</span>
    <span class="c1">#             atoms[k] = self._createGuiNmrAtom(k, v, nmrAtom)</span>
    <span class="c1">#</span>
    <span class="c1">#     if nmrResidue in self.predictedStretch:</span>
    <span class="c1">#         ii = self.predictedStretch.index(nmrResidue)</span>
    <span class="c1">#         self.guiResiduesShown[ii].update(atoms)</span>
    <span class="c1">#</span>
    <span class="c1">#     if nmrResidue in self.guiNmrResidues:</span>
    <span class="c1">#         guiResidueGroup = self.guiNmrResidues[nmrResidue]</span>
    <span class="c1">#</span>
    <span class="c1">#         # add the atoms to the group and set the reverse link</span>
    <span class="c1">#         for item in atoms.values():</span>
    <span class="c1">#             guiResidueGroup.addToGroup(item)</span>
    <span class="c1">#             item.guiNmrResidueGroup = guiResidueGroup</span>

    <span class="c1"># def addResidue(self, nmrResidue: NmrResidue, nmrResidueIndex: int, atomSpacing=None, lineList=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Takes an Nmr Residue and a direction, either &#39;-1 or &#39;+1&#39;, and adds a residue to the sequence graph</span>
    <span class="c1">#     corresponding to the Nmr Residue.</span>
    <span class="c1">#     Nmr Residue name displayed beneath CA of residue drawn and residue type predictions displayed</span>
    <span class="c1">#     beneath Nmr Residue name</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     atoms = {}</span>
    <span class="c1">#     pos = np.array([0.0, 0.0])</span>
    <span class="c1">#     if atomSpacing:</span>
    <span class="c1">#         self.atomSpacing = atomSpacing</span>
    <span class="c1">#     nmrAtoms = [nmrAtom.name for nmrAtom in nmrResidue.nmrAtoms]</span>
    <span class="c1">#     residueAtoms = DEFAULT_RESIDUE_ATOMS.copy()</span>
    <span class="c1">#</span>
    <span class="c1">#     if nmrResidue.residueType == &#39;GLY&#39;:</span>
    <span class="c1">#         # GLY doesn&#39;t have CB</span>
    <span class="c1">#         del residueAtoms[&#39;CB&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     # add the new nmrResidue to the current list</span>
    <span class="c1">#     if not self.guiResiduesShown:</span>
    <span class="c1">#         for k, v in residueAtoms.items():</span>
    <span class="c1">#             if k in nmrAtoms:</span>
    <span class="c1">#                 nmrAtom = nmrResidue.fetchNmrAtom(name=k)</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 nmrAtom = None</span>
    <span class="c1">#             atoms[k] = self._createGuiNmrAtom(k, v, nmrAtom)</span>
    <span class="c1">#         self.guiResiduesShown.append(atoms)</span>
    <span class="c1">#         self.predictedStretch.append(nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#         # add the sideChain atoms</span>
    <span class="c1">#         if self._SGwidget.checkBoxes[&#39;showSideChain&#39;][&#39;checkBox&#39;].isChecked():</span>
    <span class="c1">#             if &#39;CB&#39; in residueAtoms and nmrResidue.residueType:</span>
    <span class="c1">#                 cbAtom = atoms[&#39;CB&#39;]</span>
    <span class="c1">#                 self.addSideChainAtoms(nmrResidue, cbAtom, atoms, self._lineColour, lineList)</span>
    <span class="c1">#</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         for k, v in residueAtoms.items():</span>
    <span class="c1">#             if k in nmrAtoms:</span>
    <span class="c1">#                 nmrAtom = nmrResidue.fetchNmrAtom(name=k)</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 nmrAtom = None</span>
    <span class="c1">#             atoms[k] = self._createGuiNmrAtom(k, v, nmrAtom)</span>
    <span class="c1">#</span>
    <span class="c1">#         # # insert into the list at the correct position</span>
    <span class="c1">#         # if direction == &#39;-1&#39;:</span>
    <span class="c1">#         #     self.guiResiduesShown.insert(0, atoms)</span>
    <span class="c1">#         #     self.predictedStretch.insert(0, nmrResidue)</span>
    <span class="c1">#         # else:</span>
    <span class="c1">#         #     self.guiResiduesShown.append(atoms)</span>
    <span class="c1">#         #     self.predictedStretch.append(nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#         self.guiResiduesShown.insert(nmrResidueIndex, atoms)</span>
    <span class="c1">#         self.predictedStretch.insert(nmrResidueIndex, nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#         # add the sideChain atoms</span>
    <span class="c1">#         if self._SGwidget.checkBoxes[&#39;showSideChain&#39;][&#39;checkBox&#39;].isChecked():</span>
    <span class="c1">#             if &#39;CB&#39; in residueAtoms and nmrResidue.residueType:</span>
    <span class="c1">#                 cbAtom = atoms[&#39;CB&#39;]</span>
    <span class="c1">#                 self.addSideChainAtoms(nmrResidue, cbAtom, atoms, self._lineColour, lineList)</span>
    <span class="c1">#</span>
    <span class="c1">#     newGuiResidueGroup = self._assembleGroupResidue(nmrResidue, atoms, lineList=lineList)  #, pos[0])</span>
    <span class="c1">#</span>
    <span class="c1">#     return newGuiResidueGroup</span>

    <span class="c1"># def _addGroupResiduePredictions(self, group: GuiNmrResidueGroup, nmrResidue: NmrResidue, caAtom: GuiNmrAtom):</span>
    <span class="c1">#     &quot;&quot;&quot;Gets predictions for residue type based on BMRB statistics and determines label positions</span>
    <span class="c1">#     based on caAtom position.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     predictions = list(set(map(tuple, (getNmrResiduePrediction(nmrResidue, self.project.chemicalShiftLists[0])))))</span>
    <span class="c1">#     predictions.sort(key=lambda a: float(a[1][:-1]), reverse=True)</span>
    <span class="c1">#     for prediction in predictions:</span>
    <span class="c1">#         predictionLabel = QtWidgets.QGraphicsTextItem()</span>
    <span class="c1">#         predictionLabel.setPlainText(prediction[0] + &#39; &#39; + prediction[1])</span>
    <span class="c1">#         predictionLabel.setDefaultTextColor(QtGui.QColor(self._textColour))</span>
    <span class="c1">#         predictionLabel.setFont(textFontSmallBold)</span>
    <span class="c1">#         predictionLabel.setPos(caAtom.x() - caAtom.boundingRect().width() / 2,</span>
    <span class="c1">#                                caAtom.y() + (30 * (predictions.index(prediction) + 2)))</span>
    <span class="c1">#         group.addToGroup(predictionLabel)</span>

    <span class="c1"># def _addResiduePredictions(self, nmrResidue: NmrResidue, caAtom: GuiNmrAtom):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Gets predictions for residue type based on BMRB statistics and determines label positions</span>
    <span class="c1">#     based on caAtom position.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     predictions = list(set(map(tuple, (getNmrResiduePrediction(nmrResidue, self.project.chemicalShiftLists[0])))))</span>
    <span class="c1">#     predictions.sort(key=lambda a: float(a[1][:-1]), reverse=True)</span>
    <span class="c1">#     for prediction in predictions:</span>
    <span class="c1">#         predictionLabel = QtWidgets.QGraphicsTextItem()</span>
    <span class="c1">#         predictionLabel.setPlainText(prediction[0] + &#39; &#39; + prediction[1])</span>
    <span class="c1">#         predictionLabel.setDefaultTextColor(QtGui.QColor(self._textColour))</span>
    <span class="c1">#         predictionLabel.setFont(textFontSmallBold)</span>
    <span class="c1">#         predictionLabel.setPos(caAtom.x() - caAtom.boundingRect().width() / 2,</span>
    <span class="c1">#                                caAtom.y() + (30 * (predictions.index(prediction) + 2)))</span>
    <span class="c1">#         self.scene.addItem(predictionLabel)</span>

<div class="viewcode-block" id="SequenceGraphModule.predictSequencePosition"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.predictSequencePosition">[docs]</a>    <span class="k">def</span> <span class="nf">predictSequencePosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmrResidueList</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predicts sequence position for Nmr residues displayed in the Assigner and highlights appropriate</span>
<span class="sd">        positions in the Sequence Module if it is displayed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nmrResidueList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thisSequenceModule</span><span class="o">.</span><span class="n">_initialiseChainLabels</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">chains</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">chemicalShiftLists</span><span class="p">:</span>

            <span class="n">nmrResidues</span> <span class="o">=</span> <span class="n">nmrResidueList</span>  <span class="c1"># [item[0] for item in nmrResidueList]</span>

            <span class="n">matchesDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">chainNum</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">chains</span><span class="p">):</span>
                <span class="n">matchesDict</span><span class="p">[</span><span class="n">chainNum</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">chemList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">chemicalShiftLists</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">getSpinSystemsLocation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">nmrResidues</span><span class="p">,</span>
                                                   <span class="n">chain</span><span class="p">,</span> <span class="n">chemList</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">matchesDict</span><span class="p">[</span><span class="n">chainNum</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">chainNum</span> <span class="ow">in</span> <span class="n">matchesDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="c1"># possibleMatches = getSpinSystemsLocation(self.project, nmrResidues,</span>
                <span class="c1">#                   self.project.chains[0], self.project.chemicalShiftLists[0])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">thisSequenceModule</span><span class="o">.</span><span class="n">_clearStretches</span><span class="p">(</span><span class="n">chainNum</span><span class="p">)</span>
                <span class="n">possibleMatches</span> <span class="o">=</span> <span class="n">matchesDict</span><span class="p">[</span><span class="n">chainNum</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">possibleMatches</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">chemList</span> <span class="ow">in</span> <span class="n">possibleMatches</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">possibleMatch</span> <span class="ow">in</span> <span class="n">chemList</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">possibleMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibleMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nmrResidues</span><span class="p">):</span>
                                <span class="c1"># if hasattr(self.application, &#39;sequenceModule&#39;):</span>
                                <span class="c1"># self.application.sequenceModule._highlightPossibleStretches(possibleMatch[1])</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">thisSequenceModule</span><span class="o">.</span><span class="n">_highlightPossibleStretches</span><span class="p">(</span><span class="n">chainNum</span><span class="p">,</span> <span class="n">possibleMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_toggleSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequenceCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceModuleFrame</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceModuleFrame</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_addConnectingLineToGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">GuiNmrResidueGroup</span><span class="p">,</span> <span class="n">guiAtom1</span><span class="p">:</span> <span class="n">GuiNmrAtom</span><span class="p">,</span> <span class="n">guiAtom2</span><span class="p">:</span> <span class="n">GuiNmrAtom</span><span class="p">,</span>
                                  <span class="n">colour</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">displacement</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">peak</span><span class="p">:</span> <span class="n">Peak</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lineList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lineId</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a line between two GuiNmrAtoms using the width, colour, displacement and style specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newLine</span> <span class="o">=</span> <span class="n">AssignmentLine</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colour</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
                                 <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">peak</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span>
                                 <span class="n">guiAtom1</span><span class="o">=</span><span class="n">guiAtom1</span><span class="p">,</span> <span class="n">guiAtom2</span><span class="o">=</span><span class="n">guiAtom2</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">)</span>

        <span class="c1"># not sure why this is different</span>
        <span class="c1"># group.addToGroup(newLine)</span>
        <span class="n">newLine</span><span class="o">.</span><span class="n">setParentItem</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="n">itemKey</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">lineId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itemKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lineList</span><span class="p">:</span>
            <span class="n">lineList</span><span class="p">[</span><span class="n">itemKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lineList</span><span class="p">[</span><span class="n">itemKey</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newLine</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newLine</span>

    <span class="c1"># def _createGuiNmrAtom(self, atomType: str, position: tuple, nmrAtom: NmrAtom = None) -&gt; GuiNmrAtom:</span>
    <span class="c1">#     &quot;&quot;&quot;Creates a GuiNmrAtom specified by the atomType and graphical position supplied.</span>
    <span class="c1">#     GuiNmrAtom can be linked to an NmrAtom by supplying it to the function.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     atom = GuiNmrAtom(text=atomType, pos=position, nmrAtom=nmrAtom)</span>
    <span class="c1">#     self.guiNmrAtomDict[nmrAtom] = atom</span>
    <span class="c1">#     return atom</span>
    <span class="c1">#</span>
    <span class="c1"># def _createGhostGuiNmrAtom(self, atomType: str, position: tuple, nmrAtom: NmrAtom = None) -&gt; GuiNmrAtom:</span>
    <span class="c1">#     &quot;&quot;&quot;Creates a GuiNmrAtom specified by the atomType and graphical position supplied.</span>
    <span class="c1">#     GuiNmrAtom can be linked to an NmrAtom by supplying it to the function.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     atom = GuiNmrAtom(text=atomType, pos=position, nmrAtom=nmrAtom)</span>
    <span class="c1">#     self.guiNmrAtomDict[nmrAtom] = atom</span>
    <span class="c1">#     return atom</span>

    <span class="c1"># def _getPeakAssignmentsForResidue(self, nmrResidue, nmrAtomIncludeList=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Get the list of peak assignments from the nmrAtoms</span>
    <span class="c1">#     interResidueAtomPairing is the linking within the same nmrResidue</span>
    <span class="c1">#     interChainAtomPairing is the linking within the same chain but to different nmrResidues</span>
    <span class="c1">#     crossChainAtomPairing is the linking to different chains</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     # create a set of sets ordered by spectra</span>
    <span class="c1">#     interResidueAtomPairing = OrderedDict((spec, set()) for spec in self.magnetisationTransfers.keys())</span>
    <span class="c1">#     interChainAtomPairing = OrderedDict((spec, set()) for spec in self.magnetisationTransfers.keys())</span>
    <span class="c1">#     crossChainAtomPairing = OrderedDict((spec, set()) for spec in self.magnetisationTransfers.keys())</span>
    <span class="c1">#</span>
    <span class="c1">#     nmrChain = nmrResidue.nmrChain</span>
    <span class="c1">#</span>
    <span class="c1">#     for nmrAtom in nmrResidue.nmrAtoms:</span>
    <span class="c1">#</span>
    <span class="c1">#         if nmrAtom._flaggedForDelete or nmrAtom.isDeleted:</span>
    <span class="c1">#             continue</span>
    <span class="c1">#</span>
    <span class="c1">#         if &#39;.ASP&#39; in str(nmrAtom.nmrResidue.id) and nmrAtom.name == &#39;CB&#39;:</span>
    <span class="c1">#             pass</span>
    <span class="c1">#</span>
    <span class="c1">#         for peak in nmrAtom.assignedPeaks:</span>
    <span class="c1">#</span>
    <span class="c1">#             # ignore peaks that are due for delete (can probably also use the notifier list)</span>
    <span class="c1">#             if peak._flaggedForDelete or peak.isDeleted:</span>
    <span class="c1">#                 continue</span>
    <span class="c1">#</span>
    <span class="c1">#             spec = peak.peakList.spectrum</span>
    <span class="c1">#             for assignment in peak.assignments:</span>
    <span class="c1">#</span>
    <span class="c1">#                 # find the mainNmrResidue for -1 and +1 connections</span>
    <span class="c1">#                 newCon = list(assignment)</span>
    <span class="c1">#                 for conNum in range(len(assignment)):</span>
    <span class="c1">#</span>
    <span class="c1">#                     # assignments could be None</span>
    <span class="c1">#                     if assignment[conNum] and assignment[conNum].nmrResidue.relativeOffset == -1:  # and inCon[conNum].nmrResidue.nmrChain.isConnected:</span>
    <span class="c1">#</span>
    <span class="c1">#                         # this is a minus residue so find connected, have to traverse to the previousNmrResidue</span>
    <span class="c1">#                         # will it always exist?</span>
    <span class="c1">#                         conName = assignment[conNum].name</span>
    <span class="c1">#                         preN = assignment[conNum].nmrResidue.mainNmrResidue.previousNmrResidue</span>
    <span class="c1">#                         if preN:</span>
    <span class="c1">#                             newConSwap = [nmrA for nmrA in preN.nmrAtoms if nmrA.name == conName]</span>
    <span class="c1">#                             if newConSwap:</span>
    <span class="c1">#                                 newCon[conNum] = newConSwap[0]</span>
    <span class="c1">#                         else:</span>
    <span class="c1">#                             newCon[conNum] = None  # not connected so skip</span>
    <span class="c1">#</span>
    <span class="c1">#                     elif assignment[conNum] and assignment[conNum].nmrResidue.relativeOffset == +1:  # and inCon[conNum].nmrResidue.nmrChain.isConnected:</span>
    <span class="c1">#</span>
    <span class="c1">#                         # this is a plus residue so find connected, have to traverse to the nextNmrResidue</span>
    <span class="c1">#                         # will it always exist?</span>
    <span class="c1">#                         conName = assignment[conNum].name</span>
    <span class="c1">#                         preN = assignment[conNum].nmrResidue.mainNmrResidue.nextNmrResidue</span>
    <span class="c1">#                         if preN:</span>
    <span class="c1">#                             newConSwap = [nmrA for nmrA in preN.nmrAtoms if nmrA.name == conName]</span>
    <span class="c1">#                             if newConSwap:</span>
    <span class="c1">#                                 newCon[conNum] = newConSwap[0]</span>
    <span class="c1">#                         else:</span>
    <span class="c1">#                             newCon[conNum] = None  # not connected so skip</span>
    <span class="c1">#</span>
    <span class="c1">#                 assignment = newCon</span>
    <span class="c1">#</span>
    <span class="c1">#                 # only get the assignments a-b if a and b are defined in the spectrum magnetisationTransfers list</span>
    <span class="c1">#                 for mag in self.magnetisationTransfers[spec]:</span>
    <span class="c1">#                     nmrAtom0 = assignment[mag[0] - 1]</span>
    <span class="c1">#                     nmrAtom1 = assignment[mag[1] - 1]</span>
    <span class="c1">#                     nmrAtom0 = nmrAtom0 if nmrAtom0 and not (nmrAtom0.isDeleted or nmrAtom0._flaggedForDelete) else None</span>
    <span class="c1">#                     nmrAtom1 = nmrAtom1 if nmrAtom1 and not (nmrAtom1.isDeleted or nmrAtom1._flaggedForDelete) else None</span>
    <span class="c1">#</span>
    <span class="c1">#                     if not None in (nmrAtom0, nmrAtom1):</span>
    <span class="c1">#</span>
    <span class="c1">#                         # ignore nmrAtoms that are not in the include list (if specified)</span>
    <span class="c1">#                         if nmrAtomIncludeList is not None and not (nmrAtom0 in nmrAtomIncludeList or nmrAtom1 in nmrAtomIncludeList):</span>
    <span class="c1">#                             continue</span>
    <span class="c1">#</span>
    <span class="c1">#                         if (nmrAtom0.nmrResidue is nmrResidue) and (nmrAtom1.nmrResidue is nmrResidue):</span>
    <span class="c1">#</span>
    <span class="c1">#                             # interResidueAtomPairing</span>
    <span class="c1">#                             if (nmrAtom1, nmrAtom0, peak) not in interResidueAtomPairing[spec]:</span>
    <span class="c1">#                                 interResidueAtomPairing[spec].add((nmrAtom0, nmrAtom1, peak))</span>
    <span class="c1">#</span>
    <span class="c1">#                         elif (nmrAtom0.nmrResidue.nmrChain is nmrChain) and (nmrAtom1.nmrResidue.nmrChain is nmrChain):</span>
    <span class="c1">#</span>
    <span class="c1">#                             # connections within the same chain</span>
    <span class="c1">#                             if (nmrAtom1, nmrAtom0, peak) not in interChainAtomPairing[spec]:</span>
    <span class="c1">#                                 interChainAtomPairing[spec].add((nmrAtom0, nmrAtom1, peak))</span>
    <span class="c1">#</span>
    <span class="c1">#                         # elif (nmrAtom0.nmrResidue.nmrChain is nmrChain) and (nmrAtom1.nmrResidue.nmrChain is not nmrChain):</span>
    <span class="c1">#                         else:</span>
    <span class="c1">#</span>
    <span class="c1">#                             # connections to a dif</span>
    <span class="c1">#                             if (nmrAtom1, nmrAtom0, peak) not in crossChainAtomPairing[spec]:</span>
    <span class="c1">#                                 crossChainAtomPairing[spec].add((nmrAtom0, nmrAtom1, peak))</span>
    <span class="c1">#</span>
    <span class="c1">#     return interResidueAtomPairing, interChainAtomPairing, crossChainAtomPairing</span>

    <span class="c1"># def _addPeakAssignmentLinesToGroup(self, assignments, lineList):</span>
    <span class="c1">#     for specAssignments in assignments.values():</span>
    <span class="c1">#         for nmrAtomPair in specAssignments:</span>
    <span class="c1">#</span>
    <span class="c1">#             guiNmrAtomPair = (self.guiNmrAtomDict.get(nmrAtomPair[0]),</span>
    <span class="c1">#                               self.guiNmrAtomDict.get(nmrAtomPair[1]),</span>
    <span class="c1">#                               nmrAtomPair[2]</span>
    <span class="c1">#                               )</span>
    <span class="c1">#</span>
    <span class="c1">#             # skip if not defined</span>
    <span class="c1">#             if None in guiNmrAtomPair:</span>
    <span class="c1">#                 continue</span>
    <span class="c1">#</span>
    <span class="c1">#             # get the peak and the spectrum</span>
    <span class="c1">#             peak = guiNmrAtomPair[2]</span>
    <span class="c1">#             spectrum = peak.peakList.spectrum</span>
    <span class="c1">#             displacement = guiNmrAtomPair[0].getConnectedList(guiNmrAtomPair[1])</span>
    <span class="c1">#</span>
    <span class="c1">#             # add the internal line to the guiNmrResidueGroup, should now move when group is moved</span>
    <span class="c1">#             try:</span>
    <span class="c1">#                 group = self.guiNmrResidues[guiNmrAtomPair[0].nmrAtom.nmrResidue]</span>
    <span class="c1">#             except Exception as es:</span>
    <span class="c1">#                 pass</span>
    <span class="c1">#</span>
    <span class="c1">#             self._addConnectingLineToGroup(group,</span>
    <span class="c1">#                                            guiNmrAtomPair[0],</span>
    <span class="c1">#                                            guiNmrAtomPair[1],</span>
    <span class="c1">#                                            spectrum.positiveContourColour,</span>
    <span class="c1">#                                            2.0, displacement=displacement,</span>
    <span class="c1">#                                            peak=peak, lineList=lineList, lineId=peak)</span>
    <span class="c1">#</span>
    <span class="c1">#             # update displacements for both guiNmrAtoms</span>
    <span class="c1">#             guiNmrAtomPair[0].addConnectedList(guiNmrAtomPair[1])</span>
    <span class="c1">#             guiNmrAtomPair[1].addConnectedList(guiNmrAtomPair[0])</span>

    <span class="c1"># def _addPeakAssignmentLinesToAdjacentGroup(self, nmrResidue, assignments, peaklineList, connectingLineList):</span>
    <span class="c1">#     for specAssignments in assignments.values():</span>
    <span class="c1">#         for nmrAtomPair in specAssignments:</span>
    <span class="c1">#</span>
    <span class="c1">#             guiNmrAtomPair = (self.guiNmrAtomDict.get(nmrAtomPair[0]),</span>
    <span class="c1">#                               self.guiNmrAtomDict.get(nmrAtomPair[1]),</span>
    <span class="c1">#                               nmrAtomPair[2]</span>
    <span class="c1">#                               )</span>
    <span class="c1">#</span>
    <span class="c1">#             # get the peak and the spectrum</span>
    <span class="c1">#             peak = guiNmrAtomPair[2]</span>
    <span class="c1">#             spectrum = peak.peakList.spectrum</span>
    <span class="c1">#</span>
    <span class="c1">#             if guiNmrAtomPair[0] is None and guiNmrAtomPair[1] is None:</span>
    <span class="c1">#                 continue</span>
    <span class="c1">#</span>
    <span class="c1">#             if guiNmrAtomPair[0] is None:</span>
    <span class="c1">#                 if nmrAtomPair[1].nmrResidue.nmrChain is not nmrResidue.nmrChain:</span>
    <span class="c1">#                     continue</span>
    <span class="c1">#</span>
    <span class="c1">#                 newGhostResidue = self.addGhostResidue(nmrAtomPair[0].nmrResidue,</span>
    <span class="c1">#                                                        guiNmrAtomPair[1],</span>
    <span class="c1">#                                                        nmrAtomPair[1].nmrResidue,</span>
    <span class="c1">#                                                        nmrAtomPair[0].name,</span>
    <span class="c1">#                                                        nmrAtomPair[1].name,</span>
    <span class="c1">#                                                        True,</span>
    <span class="c1">#                                                        lineList=connectingLineList)</span>
    <span class="c1">#                 guiNmrAtomPair = (self.guiNmrAtomDict.get(nmrAtomPair[0]),</span>
    <span class="c1">#                                   self.guiNmrAtomDict.get(nmrAtomPair[1]),</span>
    <span class="c1">#                                   nmrAtomPair[2]</span>
    <span class="c1">#                                   )</span>
    <span class="c1">#</span>
    <span class="c1">#                 group = self.guiNmrResidues[nmrAtomPair[1].nmrResidue]</span>
    <span class="c1">#                 displacement = guiNmrAtomPair[1].getConnectedList(guiNmrAtomPair[0])</span>
    <span class="c1">#                 self._addConnectingLineToGroup(group,</span>
    <span class="c1">#                                                guiNmrAtomPair[1],</span>
    <span class="c1">#                                                guiNmrAtomPair[0],</span>
    <span class="c1">#                                                spectrum.positiveContourColour,</span>
    <span class="c1">#                                                2.0, displacement=displacement,</span>
    <span class="c1">#                                                peak=peak, lineList=peaklineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#             elif guiNmrAtomPair[1] is None:</span>
    <span class="c1">#                 if nmrAtomPair[0].nmrResidue.nmrChain is not nmrResidue.nmrChain:</span>
    <span class="c1">#                     continue</span>
    <span class="c1">#</span>
    <span class="c1">#                 newGhostResidue = self.addGhostResidue(nmrAtomPair[1].nmrResidue,</span>
    <span class="c1">#                                                        guiNmrAtomPair[0],</span>
    <span class="c1">#                                                        nmrAtomPair[0].nmrResidue,</span>
    <span class="c1">#                                                        nmrAtomPair[1].name,</span>
    <span class="c1">#                                                        nmrAtomPair[0].name,</span>
    <span class="c1">#                                                        True,</span>
    <span class="c1">#                                                        lineList=connectingLineList)</span>
    <span class="c1">#                 guiNmrAtomPair = (self.guiNmrAtomDict.get(nmrAtomPair[0]),</span>
    <span class="c1">#                                   self.guiNmrAtomDict.get(nmrAtomPair[1]),</span>
    <span class="c1">#                                   nmrAtomPair[2]</span>
    <span class="c1">#                                   )</span>
    <span class="c1">#</span>
    <span class="c1">#                 group = self.guiNmrResidues[nmrAtomPair[0].nmrResidue]</span>
    <span class="c1">#                 displacement = guiNmrAtomPair[0].getConnectedList(guiNmrAtomPair[1])</span>
    <span class="c1">#                 self._addConnectingLineToGroup(group,</span>
    <span class="c1">#                                                guiNmrAtomPair[0],</span>
    <span class="c1">#                                                guiNmrAtomPair[1],</span>
    <span class="c1">#                                                spectrum.positiveContourColour,</span>
    <span class="c1">#                                                2.0, displacement=displacement,</span>
    <span class="c1">#                                                peak=peak, lineList=peaklineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 if nmrAtomPair[0].nmrResidue.nmrChain is nmrResidue.nmrChain:</span>
    <span class="c1">#                     group = self.guiNmrResidues[nmrAtomPair[0].nmrResidue]</span>
    <span class="c1">#                     displacement = guiNmrAtomPair[0].getConnectedList(guiNmrAtomPair[1])</span>
    <span class="c1">#                     self._addConnectingLineToGroup(group,</span>
    <span class="c1">#                                                    guiNmrAtomPair[0],</span>
    <span class="c1">#                                                    guiNmrAtomPair[1],</span>
    <span class="c1">#                                                    spectrum.positiveContourColour,</span>
    <span class="c1">#                                                    2.0, displacement=displacement,</span>
    <span class="c1">#                                                    peak=peak, lineList=peaklineList, lineId=nmrResidue)</span>
    <span class="c1">#</span>
    <span class="c1">#                 elif nmrAtomPair[1].nmrResidue.nmrChain is nmrResidue.nmrChain:</span>
    <span class="c1">#                     group = self.guiNmrResidues[nmrAtomPair[1].nmrResidue]</span>
    <span class="c1">#                     displacement = guiNmrAtomPair[1].getConnectedList(guiNmrAtomPair[0])</span>
    <span class="c1">#                     self._addConnectingLineToGroup(group,</span>
    <span class="c1">#                                                    guiNmrAtomPair[1],</span>
    <span class="c1">#                                                    guiNmrAtomPair[0],</span>
    <span class="c1">#                                                    spectrum.positiveContourColour,</span>
    <span class="c1">#                                                    2.0, displacement=displacement,</span>
    <span class="c1">#                                                    peak=peak, lineList=peaklineList, lineId=nmrResidue)</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     continue</span>
    <span class="c1">#</span>
    <span class="c1">#             guiNmrAtomPair[0].addConnectedList(guiNmrAtomPair[1])</span>
    <span class="c1">#             guiNmrAtomPair[1].addConnectedList(guiNmrAtomPair[0])</span>

    <span class="c1"># def addGhostResidue(self, nmrResidueCon1: NmrResidue,</span>
    <span class="c1">#                     guiRef: GuiNmrAtom,</span>
    <span class="c1">#                     nmrResidueCon0: NmrResidue,</span>
    <span class="c1">#                     name1: str, name0: str,</span>
    <span class="c1">#                     offsetAdjust,</span>
    <span class="c1">#                     atomSpacing=None, lineList=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Takes an Nmr Residue and a direction, either &#39;-1 or &#39;+1&#39;, and adds a residue to the sequence graph</span>
    <span class="c1">#     corresponding to the Nmr Residue.</span>
    <span class="c1">#     Nmr Residue name displayed beneath CA of residue drawn and residue type predictions displayed</span>
    <span class="c1">#     beneath Nmr Residue name</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     # need to keep a list of the atoms that have been added so don&#39;t repeat</span>
    <span class="c1">#     count = 0</span>
    <span class="c1">#     if nmrResidueCon0 in self.ghostList:</span>
    <span class="c1">#         count = len(self.ghostList[nmrResidueCon0])</span>
    <span class="c1">#         if nmrResidueCon1 in self.ghostList[nmrResidueCon0]:</span>
    <span class="c1">#             # already exists in the dict so exit</span>
    <span class="c1">#             return</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         self.ghostList[nmrResidueCon0] = ()</span>
    <span class="c1">#</span>
    <span class="c1">#     nmrResidue = nmrResidueCon1</span>
    <span class="c1">#     atoms = {}</span>
    <span class="c1">#     if atomSpacing:</span>
    <span class="c1">#         self.atomSpacing = atomSpacing</span>
    <span class="c1">#     nmrAtoms = [nmrAtom.name for nmrAtom in nmrResidue.nmrAtoms]</span>
    <span class="c1">#     residueAtoms = DEFAULT_RESIDUE_ATOMS.copy()</span>
    <span class="c1">#</span>
    <span class="c1">#     if nmrResidue.residueType == &#39;GLY&#39;:</span>
    <span class="c1">#         del residueAtoms[&#39;CB&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     for k, v in residueAtoms.items():</span>
    <span class="c1">#         if k in nmrAtoms:</span>
    <span class="c1">#             nmrAtom = nmrResidue.fetchNmrAtom(name=k)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             nmrAtom = None</span>
    <span class="c1">#         atoms[k] = self._createGhostGuiNmrAtom(k, v, nmrAtom)</span>
    <span class="c1">#</span>
    <span class="c1">#     newGuiResidueGroup = self._assembleGhostResidue(nmrResidue, atoms, lineList=lineList)</span>
    <span class="c1">#     newGuiResidueGroup.crossChainCount = count</span>
    <span class="c1">#     newGuiResidueGroup.crossChainResidue = nmrResidueCon0</span>
    <span class="c1">#</span>
    <span class="c1">#     self.ghostList[nmrResidueCon0] += (nmrResidueCon1,)</span>
    <span class="c1">#     return atoms</span>

    <span class="k">def</span> <span class="nf">_getDisplays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of displays to navigate - if needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">displays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># check for valid displays</span>
        <span class="n">gids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">displaysWidget</span><span class="o">.</span><span class="n">getTexts</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">displays</span>
        <span class="k">if</span> <span class="n">ALL</span> <span class="ow">in</span> <span class="n">gids</span><span class="p">:</span>
            <span class="n">displays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">spectrumDisplays</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">displays</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">getByGid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gids</span> <span class="k">if</span> <span class="n">gid</span> <span class="o">!=</span> <span class="n">ALL</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">displays</span>

<div class="viewcode-block" id="SequenceGraphModule.navigateToNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.navigateToNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">navigateToNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedNmrResidue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Navigate in selected displays to nmrResidue; skip if none defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmrResidue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nmrResidue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nmrResidue</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nmrResidue=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="n">displays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDisplays</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">displays</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Undefined display module(s); select in settings first&#39;</span><span class="p">)</span>
            <span class="n">showWarning</span><span class="p">(</span><span class="s1">&#39;startAssignment&#39;</span><span class="p">,</span> <span class="s1">&#39;Undefined display module(s);</span><span class="se">\n</span><span class="s1">select in settings first&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="n">undoBlock</span><span class="p">():</span>
            <span class="c1"># optionally clear the marks</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;autoClearMarks&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mainWindow</span><span class="o">.</span><span class="n">clearMarks</span><span class="p">()</span>

            <span class="c1"># navigate the displays</span>
            <span class="k">for</span> <span class="n">display</span> <span class="ow">in</span> <span class="n">displays</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">display</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">strips</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">display</span><span class="o">.</span><span class="n">strips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectrumViews</span><span class="p">:</span>
                    <span class="n">newWidths</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#_getCurrentZoomRatio(display.strips[0].viewRange())</span>
                    <span class="k">if</span> <span class="n">display</span><span class="o">.</span><span class="n">strips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectrumViews</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dimensionCount</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">widths</span> <span class="o">=</span> <span class="n">_getCurrentZoomRatio</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">strips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">viewRange</span><span class="p">())</span>

                    <span class="n">navigateToNmrResidueInDisplay</span><span class="p">(</span><span class="n">nmrResidue</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">stripIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">widths</span><span class="o">=</span><span class="n">newWidths</span><span class="p">,</span>  <span class="c1">#[&#39;full&#39;] * len(display.strips[0].axisCodes),</span>
                                                  <span class="n">showSequentialResidues</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">axisCodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;sequentialStrips&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">(),</span>
                                                  <span class="n">markPositions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SGwidget</span><span class="o">.</span><span class="n">checkBoxes</span><span class="p">[</span><span class="s1">&#39;markPositions&#39;</span><span class="p">][</span><span class="s1">&#39;checkBox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
                                                  <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_raiseContextMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMouseEvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates and raises a context menu enabling items to be disconnected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QCursor</span><span class="p">()</span>
        <span class="n">contextMenu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">isFloatWidget</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">mouseGrabberItem</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">AssignmentLine</span><span class="p">):</span>  <span class="c1"># self.selectedLine:</span>
            <span class="n">thisLine</span> <span class="o">=</span> <span class="n">pressed</span>  <span class="c1">#self.selectedLine</span>

            <span class="k">if</span> <span class="n">thisLine</span><span class="o">.</span><span class="n">_peak</span> <span class="ow">and</span> <span class="n">thisLine</span><span class="o">.</span><span class="n">_peak</span><span class="o">.</span><span class="n">assignedNmrAtoms</span><span class="p">:</span>
                <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;deassign nmrAtoms from Peak: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">thisLine</span><span class="o">.</span><span class="n">_peak</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="n">contextMenu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>

                <span class="c1"># add the nmrAtoms to the menu</span>
                <span class="k">for</span> <span class="n">nmrAtomList</span> <span class="ow">in</span> <span class="n">thisLine</span><span class="o">.</span><span class="n">_peak</span><span class="o">.</span><span class="n">assignedNmrAtoms</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtomList</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nmrAtom</span><span class="p">:</span>

                            <span class="c1"># contextMenu.addAction(nmrAtom.id, partial(self.deassignPeak, thisLine._peak, nmrAtom))</span>

                            <span class="k">if</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">offsetNmrResidues</span><span class="p">:</span>
                                <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deassignPeak</span><span class="p">,</span> <span class="n">thisLine</span><span class="o">.</span><span class="n">_peak</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deassignPeak</span><span class="p">,</span> <span class="n">thisLine</span><span class="o">.</span><span class="n">_peak</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">))</span>

                <span class="n">contextMenu</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">contextMenu</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">contextMenu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressed</span><span class="p">,</span> <span class="n">GuiNmrResidue</span><span class="p">):</span>

            <span class="c1"># create the nmrResidue menu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectPreviousActionMenu</span> <span class="o">=</span> <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectPreviousIcon</span><span class="p">,</span> <span class="s1">&#39;disconnect Previous nmrResidue&#39;</span><span class="p">,</span>
                                                                       <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectPreviousNmrResidue</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectActionMenu</span> <span class="o">=</span> <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectIcon</span><span class="p">,</span> <span class="s1">&#39;disconnect nmrResidue&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectNmrResidue</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectNextActionMenu</span> <span class="o">=</span> <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectNextIcon</span><span class="p">,</span> <span class="s1">&#39;disconnect Next nmrResidue&#39;</span><span class="p">,</span>
                                                                   <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectNextNmrResidue</span><span class="p">))</span>
            <span class="n">contextMenu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectAllActionMenu</span> <span class="o">=</span> <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;disconnect all nmrResidues&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnectAllNmrResidues</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">object</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">residue</span><span class="p">:</span>
                <span class="n">contextMenu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deassignNmrChainActionMenu</span> <span class="o">=</span> <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;deassign nmrChain&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deassignNmrChain</span><span class="p">))</span>

                <span class="n">assign</span> <span class="o">=</span> <span class="n">pressed</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">residue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deassignNmrChainActionMenu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">assign</span><span class="p">)</span>

            <span class="n">contextMenu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_showActionMenu</span> <span class="o">=</span> <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Show nmrResidue&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showNmrResidue</span><span class="p">,</span> <span class="nb">object</span><span class="p">))</span>

            <span class="n">prev</span> <span class="o">=</span> <span class="n">pressed</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">previousNmrResidue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">nxt</span> <span class="o">=</span> <span class="n">pressed</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectPreviousActionMenu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectActionMenu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">prev</span> <span class="ow">or</span> <span class="n">nxt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectNextActionMenu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">nxt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnectAllActionMenu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">prev</span> <span class="ow">or</span> <span class="n">nxt</span><span class="p">)</span>

            <span class="n">contextMenu</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">contextMenu</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="n">contextMenu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressed</span><span class="p">,</span> <span class="n">GuiNmrAtom</span><span class="p">):</span>

            <span class="c1"># create the nmrAtom menu</span>
            <span class="n">contextMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;deassign nmrAtoms from Peaks&#39;</span><span class="p">)</span>
            <span class="n">contextMenu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">pressed</span><span class="o">.</span><span class="n">nmrAtom</span> <span class="ow">and</span> <span class="n">pressed</span><span class="o">.</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignedPeaks</span><span class="p">:</span>

                <span class="c1"># add nmrAtoms to the menu</span>
                <span class="n">allPeaks</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>

                <span class="c1"># add the internal peaks to the list</span>
                <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">pressed</span><span class="o">.</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">assignedPeaks</span><span class="p">:</span>
                    <span class="n">allPeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_addPeaksToMenu</span><span class="p">(</span><span class="n">allPeaks</span><span class="p">,</span> <span class="n">contextMenu</span><span class="p">)</span>

                <span class="n">allAdjacentPeaks</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>

                <span class="n">atom</span> <span class="o">=</span> <span class="n">pressed</span><span class="o">.</span><span class="n">nmrAtom</span>
                <span class="n">atomName</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nmrResidue</span>
                <span class="n">nextRes</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">nextNmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span> <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">nextNmrResidue</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">prevRes</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">previousNmrResidue</span><span class="o">.</span><span class="n">mainNmrResidue</span> <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">previousNmrResidue</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="c1"># add peaks corresponding to the previous residue</span>
                <span class="k">if</span> <span class="n">prevRes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">offRes</span> <span class="ow">in</span> <span class="n">prevRes</span><span class="o">.</span><span class="n">offsetNmrResidues</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">offRes</span><span class="o">.</span><span class="n">relativeOffset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                            <span class="k">for</span> <span class="n">offAtm</span> <span class="ow">in</span> <span class="n">offRes</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>

                                <span class="k">if</span> <span class="n">offAtm</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">atomName</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">offAtm</span><span class="o">.</span><span class="n">assignedPeaks</span><span class="p">:</span>
                                        <span class="n">allAdjacentPeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>

                <span class="c1"># add peaks corresponding to the next residue</span>
                <span class="k">if</span> <span class="n">nextRes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">offRes</span> <span class="ow">in</span> <span class="n">nextRes</span><span class="o">.</span><span class="n">offsetNmrResidues</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">offRes</span><span class="o">.</span><span class="n">relativeOffset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>

                            <span class="k">for</span> <span class="n">offAtm</span> <span class="ow">in</span> <span class="n">offRes</span><span class="o">.</span><span class="n">nmrAtoms</span><span class="p">:</span>

                                <span class="k">if</span> <span class="n">offAtm</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">atomName</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">offAtm</span><span class="o">.</span><span class="n">assignedPeaks</span><span class="p">:</span>
                                        <span class="n">allAdjacentPeaks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">allPeaks</span> <span class="ow">and</span> <span class="n">allAdjacentPeaks</span><span class="p">:</span>
                    <span class="n">contextMenu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_addPeaksToMenu</span><span class="p">(</span><span class="n">allAdjacentPeaks</span><span class="p">,</span> <span class="n">contextMenu</span><span class="p">)</span>

                <span class="n">contextMenu</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">cursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">contextMenu</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">contextMenu</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_addPeaksToMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allPeaks</span><span class="p">,</span> <span class="n">contextMenu</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">allPeaks</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">peak</span> <span class="ow">and</span> <span class="n">peak</span><span class="o">.</span><span class="n">assignedNmrAtoms</span><span class="p">:</span>
                <span class="n">subMenu</span> <span class="o">=</span> <span class="n">contextMenu</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;nmrAtoms&#39;</span><span class="p">)</span>
                <span class="n">subMenu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">nmrAtomList</span> <span class="ow">in</span> <span class="n">peak</span><span class="o">.</span><span class="n">assignedNmrAtoms</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">nmrAtom</span> <span class="ow">in</span> <span class="n">nmrAtomList</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nmrAtom</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">nmrResidue</span><span class="o">.</span><span class="n">offsetNmrResidues</span><span class="p">:</span>
                                <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">nmrAtom</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deassignPeak</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">subMenu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">nmrAtom</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deassignPeak</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">nmrAtom</span><span class="p">))</span>

<div class="viewcode-block" id="SequenceGraphModule.showNmrResidue"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.SequenceGraphModule.showNmrResidue">[docs]</a>    <span class="k">def</span> <span class="nf">showNmrResidue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navigateToNmrResidue</span><span class="p">(</span><span class="n">selectedNmrResidue</span><span class="o">=</span><span class="nb">object</span><span class="o">.</span><span class="n">nmrResidue</span><span class="p">)</span></div></div>


<span class="kn">import</span> <span class="nn">math</span>


<span class="n">atomSpacing</span> <span class="o">=</span> <span class="mi">66</span>
<span class="n">cos36</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">sin36</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">tan36</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">cos54</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">sin54</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">cos60</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sin60</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sin72</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">cos72</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">DEFAULT_RESIDUE_ATOMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                         <span class="s1">&#39;N&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">]),</span>
                         <span class="s1">&#39;CA&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">]),</span>
                         <span class="s1">&#39;CB&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">]),</span>
                         <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">])</span>
                         <span class="p">}</span>

<span class="c1"># Use loadCompoundPickle from chemBuild to load the structure for these; found in compound.variants.bonds</span>

<span class="n">ATOM_POSITION_DICT</span> <span class="o">=</span> <span class="p">{</span>

    <span class="s1">&#39;ALA&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HB%&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;boundAtoms&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)},</span>
    <span class="s1">&#39;CYS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SG&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HG&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)},</span>
    <span class="s1">&#39;ASP&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)},</span>
    <span class="s1">&#39;ASN&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span>  <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;ND2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HD2x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos60</span><span class="p">)),</span>
            <span class="s1">&#39;HD2y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">+</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos60</span><span class="p">)),</span>
            <span class="p">},</span>
    <span class="s1">&#39;GLU&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;HGx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HGy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span>
            <span class="p">},</span>
    <span class="s1">&#39;GLN&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;HGx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HGy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span>  <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;NE2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HD2x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos60</span><span class="p">)),</span>
            <span class="s1">&#39;HD2y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">+</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos60</span><span class="p">)),</span>
            <span class="p">},</span>
    <span class="s1">&#39;PHE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CD1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CD2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CE1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CE2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HD1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HD2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HE1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HE2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CZ&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span> <span class="o">-</span> <span class="n">sin60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HZ&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span> <span class="o">-</span> <span class="n">sin60</span> <span class="o">-</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span>
            <span class="p">},</span>
    <span class="s1">&#39;TYR&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CD1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CD2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CE1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CE2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HD1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HD2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HE1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HE2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CZ&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span> <span class="o">-</span> <span class="n">sin60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HH&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cos60</span> <span class="o">-</span> <span class="n">sin60</span> <span class="o">-</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span>
            <span class="p">},</span>
    <span class="s1">&#39;SER&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;HG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span>
            <span class="p">},</span>
    <span class="s1">&#39;THR&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HG1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HB&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HG2%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span>
            <span class="p">},</span>
    <span class="s1">&#39;MET&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;HGx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HGy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;SD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CE&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HE%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span>
            <span class="p">},</span>
    <span class="s1">&#39;ARG&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;HGx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HGy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;NE&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CZ&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;NH1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos60</span><span class="p">)),</span>
            <span class="s1">&#39;NH2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos60</span><span class="p">)),</span>
            <span class="p">},</span>
    <span class="s1">&#39;VAL&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CGx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;CGy&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;HGx%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;HGy%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">))</span>
            <span class="p">},</span>
    <span class="s1">&#39;LEU&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;HGx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HGy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span>  <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CDx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CDy&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HDx%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;HDy%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos60</span><span class="p">)</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">))</span>
            <span class="p">},</span>
    <span class="s1">&#39;ILE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG1&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;CG2%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;HG1x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;HG1y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;HG2%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="s1">&#39;CD1%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span> <span class="o">-</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HD1%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos60</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">)),</span>
            <span class="p">},</span>
    <span class="s1">&#39;LYS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;HGx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HGy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HDx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HDy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;HEx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HEy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;CE&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;NZ&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;HZ%&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.75</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="p">},</span>
    <span class="s1">&#39;HIS&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;ND1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tan36</span><span class="p">)))),</span>
            <span class="s1">&#39;CD2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tan36</span><span class="p">)))),</span>
            <span class="s1">&#39;NE2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sin36</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tan36</span><span class="p">)))),</span>
            <span class="s1">&#39;CD1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sin36</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tan36</span><span class="p">)))),</span>
            <span class="p">},</span>

    <span class="s1">&#39;TRP&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;HBx&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s1">&#39;HBy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;CG&#39;</span>        <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span> <span class="s1">&#39;CD1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">),</span>
            <span class="s1">&#39;NE1&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">))),</span>
            <span class="s1">&#39;CE2&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin54</span><span class="p">),</span>
                           <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos54</span><span class="p">))),</span>
            <span class="s1">&#39;CD2&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">))),</span>
            <span class="s1">&#39;CE3&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin54</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin60</span><span class="p">)),</span>
                           <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos54</span><span class="p">))),</span>
            <span class="s1">&#39;CZ2&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin54</span><span class="p">),</span>
                           <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos54</span><span class="p">))),</span>
            <span class="s1">&#39;CZ3&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin54</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin60</span><span class="p">)),</span>
                           <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos54</span><span class="p">))),</span>
            <span class="s1">&#39;CH2&#39;</span>       <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos54</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos60</span><span class="p">))),</span>

            <span class="s1">&#39;boundAtoms&#39;</span><span class="p">:</span> <span class="p">((</span><span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="s1">&#39;CD1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="s1">&#39;CD2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CD2&#39;</span><span class="p">,</span> <span class="s1">&#39;CE3&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CD2&#39;</span><span class="p">,</span> <span class="s1">&#39;CE2&#39;</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;CD1&#39;</span><span class="p">,</span> <span class="s1">&#39;NE1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CE2&#39;</span><span class="p">,</span> <span class="s1">&#39;CZ2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CE3&#39;</span><span class="p">,</span> <span class="s1">&#39;CZ3&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CZ3&#39;</span><span class="p">,</span> <span class="s1">&#39;CH2&#39;</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;CZ2&#39;</span><span class="p">,</span> <span class="s1">&#39;CH2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;NE1&#39;</span><span class="p">,</span> <span class="s1">&#39;CE2&#39;</span><span class="p">))</span>
            <span class="p">},</span>

    <span class="s1">&#39;PRO&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;CB&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">)</span> <span class="o">+</span> <span class="n">atomSpacing</span><span class="p">),</span>
        <span class="s1">&#39;CG&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">atomSpacing</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">atomSpacing</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tan36</span><span class="p">)),</span>
        <span class="s1">&#39;CD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">+</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">cos72</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">atomSpacing</span> <span class="o">*</span> <span class="n">sin72</span><span class="p">)</span> <span class="o">+</span> <span class="n">atomSpacing</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1"># if residueType == &#39;ALA&#39;:</span>
<span class="c1">#       hb = self._createGuiNmrAtom(&#39;HB%&#39;, (cbAtom.x(), cbAtom.y()-self.atomSpacing))</span>
<span class="c1">#       self.scene.addItem(hb)</span>
<span class="c1">#       self._addConnectingLine(hb, cbAtom, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#</span>
<span class="c1">#     if residueType == &#39;CYS&#39;:</span>
<span class="c1">#       sg = self._createGuiNmrAtom(&#39;SG&#39;, (cbAtom.x(), cbAtom.y()-self.atomSpacing))</span>
<span class="c1">#       hg = self._createGuiNmrAtom(&#39;HG&#39;, (cbAtom.x(), cbAtom.y()-(2*self.atomSpacing)))</span>
<span class="c1">#       self.scene.addItem(sg)</span>
<span class="c1">#       self.scene.addItem(hg)</span>
<span class="c1">#       self._addConnectingLine(sg, cbAtom, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#       self._addConnectingLine(sg, hg, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#</span>
<span class="c1">#     if residueType == &#39;ASP&#39;:</span>
<span class="c1">#       hb2 = self._createGuiNmrAtom(&#39;HBx&#39;, (cbAtom.x()-(self.atomSpacing*0.75), cbAtom.y()))</span>
<span class="c1">#       hb3 = self._createGuiNmrAtom(&#39;HBy&#39;, (cbAtom.x()+(self.atomSpacing*0.75), cbAtom.y()))</span>
<span class="c1">#       cg = self._createGuiNmrAtom(&#39;CG&#39;, (cbAtom.x(), cbAtom.y()-self.atomSpacing))</span>
<span class="c1">#       self.scene.addItem(hb2)</span>
<span class="c1">#       self.scene.addItem(hb3)</span>
<span class="c1">#       self.scene.addItem(cg)</span>
<span class="c1">#       self._addConnectingLine(hb2, cbAtom, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#       self._addConnectingLine(hb3, cbAtom, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#       self._addConnectingLine(cg, cbAtom, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#</span>
<span class="c1">#     if residueType == &#39;GLU&#39;:</span>
<span class="c1">#       hb2 = self._createGuiNmrAtom(&#39;HBx&#39;, (cbAtom.x()-(self.atomSpacing*0.75), cbAtom.y()))</span>
<span class="c1">#       hb3 = self._createGuiNmrAtom(&#39;HBy&#39;, (cbAtom.x()+(self.atomSpacing*0.75), cbAtom.y()))</span>
<span class="c1">#       cg = self._createGuiNmrAtom(&#39;CG&#39;, (cbAtom.x(), cbAtom.y()-self.atomSpacing))</span>
<span class="c1">#       hg2 = self._createGuiNmrAtom(&#39;HBx&#39;, (cg.x()-(self.atomSpacing*0.75), cbAtom.y()))</span>
<span class="c1">#       hg3 = self._createGuiNmrAtom(&#39;HBy&#39;, (cg.x()+(self.atomSpacing*0.75), cbAtom.y()))</span>
<span class="c1">#       cd = self._createGuiNmrAtom(&#39;CD&#39;, (cbAtom.x(), cbAtom.y()-(2*self.atomSpacing)))</span>
<span class="c1">#       self.scene.addItem(hb2)</span>
<span class="c1">#       self.scene.addItem(hb3)</span>
<span class="c1">#       self.scene.addItem(cg)</span>
<span class="c1">#       self.scene.addItem(hg2)</span>
<span class="c1">#       self.scene.addItem(hg3)</span>
<span class="c1">#       self.scene.addItem(cd)</span>
<span class="c1">#       self._addConnectingLine(hb2, cbAtom, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#       self._addConnectingLine(hb3, cbAtom, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#       self._addConnectingLine(cg, hg2, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#       self._addConnectingLine(cg, hg3, &#39;white&#39;, 1.0, 0.0)</span>
<span class="c1">#       self._addConnectingLine(cg, cd, &#39;white&#39;, 1.0, 0.0)</span>

<div class="viewcode-block" id="greekKey"><a class="viewcode-back" href="../../../../ccpn/ccpn.AnalysisAssign.modules.html#ccpn.AnalysisAssign.modules.SequenceGraph.greekKey">[docs]</a><span class="k">def</span> <span class="nf">greekKey</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">greekSort</span> <span class="o">=</span> <span class="s1">&#39;0123456789ABGDEZHQIKLMNXOPRSTUFCYWabgdezhqiklmnxoprstufcyw&#39;</span>
    <span class="n">greekLetterCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">greekSort</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">word</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]),)</span>
        <span class="n">key</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">greekSort</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">greekSort</span> <span class="k">else</span> <span class="n">greekLetterCount</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">key</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.Application</span> <span class="kn">import</span> <span class="n">TestApplication</span>
    <span class="kn">from</span> <span class="nn">ccpn.ui.gui.widgets.TextEditor</span> <span class="kn">import</span> <span class="n">TextEditor</span>
    <span class="kn">from</span> <span class="nn">ccpnmodel.ccpncore.lib.assignment.ChemicalShift</span> <span class="kn">import</span> <span class="n">PROTEIN_ATOM_NAMES</span><span class="p">,</span> <span class="n">ALL_ATOMS_SORTED</span>

    <span class="n">isotopes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;13C&#39;</span><span class="p">,</span> <span class="s1">&#39;1H&#39;</span><span class="p">,</span> <span class="s1">&#39;15N&#39;</span><span class="p">]</span>
    <span class="n">axisCodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]</span>

    <span class="n">atoms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;CB&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ALL_ATOMS_SORTED</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">thisDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">isotope</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axisCodes</span><span class="p">,</span> <span class="n">isotopes</span><span class="p">):</span>
        <span class="n">thisDict</span><span class="p">[</span><span class="n">isotope</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">at</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">axis</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="n">greekKey</span><span class="p">)</span>

    <span class="c1"># app = TestApplication()</span>
    <span class="c1">#</span>
    <span class="c1"># popup = SequenceGraphModule()</span>
    <span class="c1">#</span>
    <span class="c1"># popup.show()</span>
    <span class="c1"># popup.raise_()</span>
    <span class="c1"># app.start()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Python  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.0.
    </div>
  </body>
</html>