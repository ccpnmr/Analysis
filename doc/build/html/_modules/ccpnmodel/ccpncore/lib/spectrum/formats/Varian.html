<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ccpnmodel.ccpncore.lib.spectrum.formats.Varian &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="../../../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../../_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="../../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccpnmodel.ccpncore.lib.spectrum.formats.Varian</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module Documentation here</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Licence, Reference and Credits</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) CCPN project (http://www.ccpn.ac.uk) 2014 - 2017&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wayne Boucher, Ed Brooksbank, Rasmus H Fogh, Luca Mureddu, Timothy J Ragan &amp; Geerten W Vuister&quot;</span><span class="p">)</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CCPN licence. See http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpnLicense for licence text&quot;</span><span class="p">)</span>
<span class="n">__reference__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For publications, please use reference from http://www.ccpn.ac.uk/v3-software/downloads/license&quot;</span><span class="p">,</span>
               <span class="s2">&quot;or ccpnmodel.ccpncore.memops.Credits.CcpNmrReference&quot;</span><span class="p">)</span>

<span class="c1">#=========================================================================================</span>
<span class="c1"># Last code modification</span>
<span class="c1">#=========================================================================================</span>
<span class="n">__modifiedBy__</span> <span class="o">=</span> <span class="s2">&quot;$modifiedBy: CCPN $&quot;</span>
<span class="n">__dateModified__</span> <span class="o">=</span> <span class="s2">&quot;$dateModified: 2017-07-07 16:33:15 +0100 (Fri, July 07, 2017) $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision: 3.0.b5 $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Created</span>
<span class="c1">#=========================================================================================</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;$Author: CCPN $&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Date: 2017-04-07 10:28:48 +0000 (Fri, April 07, 2017) $&quot;</span>
<span class="c1">#=========================================================================================</span>
<span class="c1"># Start of code</span>
<span class="c1">#=========================================================================================</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">array</span><span class="o">,</span> <span class="nn">re</span>

<span class="c1"># from ccpn.util.Common import checkIsotope</span>

<span class="c1"># from memops.qtgui.MessageDialog import showError</span>

<span class="c1"># Varian uses convention H1, C13, etc.</span>
<span class="c1"># CCPN uses convention 1H, 13C, etc.</span>
<span class="n">nucVarianRe</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^([A-Z]+)(\d+)$&#39;</span><span class="p">)</span>
<span class="n">nucCcpnRe</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(\d+)([A-Z]+)$&#39;</span><span class="p">)</span>

<span class="n">VNMR_FILE_HEADER_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">VNMR_BLOCK_HEADER_SIZE</span> <span class="o">=</span> <span class="mi">28</span>

<span class="n">FILE_TYPE</span> <span class="o">=</span> <span class="s1">&#39;Varian&#39;</span>

<div class="viewcode-block" id="readParams"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.readParams">[docs]</a><span class="k">def</span> <span class="nf">readParams</span><span class="p">(</span><span class="n">filePath</span><span class="p">):</span>

  <span class="n">dirName</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">fileName</span> <span class="o">==</span> <span class="s1">&#39;procpar&#39;</span><span class="p">:</span>
    <span class="n">dataFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="s1">&#39;datdir&#39;</span><span class="p">,</span> <span class="s1">&#39;phasefile&#39;</span><span class="p">)</span>
  
  <span class="k">elif</span> <span class="n">fileName</span> <span class="o">==</span> <span class="s1">&#39;phasefile&#39;</span><span class="p">:</span>
    <span class="n">dataFile</span> <span class="o">=</span> <span class="n">filePath</span>
    <span class="n">dirName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>
    <span class="n">filePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="s1">&#39;procpar&#39;</span><span class="p">)</span>

  <span class="n">wordSize</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">isFloatData</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="n">sampledValues</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">sampledSigmas</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">pulseProgram</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">dataScale</span> <span class="o">=</span> <span class="mf">1.0</span>
  
  <span class="k">try</span><span class="p">:</span>
    <span class="n">ccpnParams</span> <span class="o">=</span> <span class="n">parseProcparFile</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
    <span class="n">dataFileParams</span> <span class="o">=</span> <span class="n">readDataFileHeader</span><span class="p">(</span><span class="n">dataFile</span><span class="p">)</span>
  <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Varian spectrum parameter read for </span><span class="si">%s</span><span class="s1"> failed: </span><span class="si">%s</span><span class="s1">&#39;</span>
    <span class="c1"># showError(&#39;Error&#39;, msg % (filePath, err))</span>
    <span class="k">return</span>
  
  <span class="n">blockSizes</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">ccpnParams</span><span class="p">[</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span>
  <span class="n">numPoints</span> <span class="o">=</span> <span class="n">ccpnParams</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
  <span class="n">isotopes</span> <span class="o">=</span> <span class="n">ccpnParams</span><span class="p">[</span><span class="s1">&#39;nuc&#39;</span><span class="p">]</span>
  <span class="n">specFreqs</span> <span class="o">=</span> <span class="n">ccpnParams</span><span class="p">[</span><span class="s1">&#39;sf&#39;</span><span class="p">]</span>
  <span class="n">specWidths</span> <span class="o">=</span> <span class="n">ccpnParams</span><span class="p">[</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span>
  <span class="n">refPoints</span> <span class="o">=</span> <span class="n">ccpnParams</span><span class="p">[</span><span class="s1">&#39;refpt&#39;</span><span class="p">]</span>
  <span class="n">refPpms</span> <span class="o">=</span> <span class="n">ccpnParams</span><span class="p">[</span><span class="s1">&#39;refppm&#39;</span><span class="p">]</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;firstBlock&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
    <span class="c1"># in this case are using transposed data so everything is backwards</span>
    <span class="c1"># TBD: not sure what to do in 3D, etc.</span>
    <span class="n">numPoints</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">isotopes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">specFreqs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">specWidths</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">refPoints</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">refPpms</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

  <span class="n">blockSize</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;ntraces&#39;</span><span class="p">]</span>
  <span class="n">blockHeaderSize</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;nbheaders&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">VNMR_BLOCK_HEADER_SIZE</span>
  <span class="n">headerSize</span> <span class="o">=</span> <span class="n">VNMR_FILE_HEADER_SIZE</span> 
  <span class="n">headerSize</span> <span class="o">+=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;firstBlock&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">blockSize</span><span class="o">+</span><span class="n">blockHeaderSize</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">:</span>
    <span class="n">blockSizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">blockSize</span><span class="p">,]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">blockSizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span>
    <span class="n">blockSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numPoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">blockSizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">blockSize</span> <span class="o">//</span> <span class="n">numPoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># TBD: is it always a multiple??</span>
  
  <span class="n">isBigEndian</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;big&#39;</span>
  <span class="k">if</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;swapped&#39;</span><span class="p">]:</span>
    <span class="n">isBigEndian</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">isBigEndian</span>

  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">FILE_TYPE</span><span class="p">,</span> <span class="n">dataFile</span><span class="p">,</span> <span class="n">numPoints</span><span class="p">,</span> <span class="n">blockSizes</span><span class="p">,</span>
          <span class="n">wordSize</span><span class="p">,</span> <span class="n">isBigEndian</span><span class="p">,</span> <span class="n">isFloatData</span><span class="p">,</span>
          <span class="n">headerSize</span><span class="p">,</span> <span class="n">blockHeaderSize</span><span class="p">,</span>
          <span class="n">isotopes</span><span class="p">,</span> <span class="n">specFreqs</span><span class="p">,</span>
          <span class="n">specWidths</span><span class="p">,</span> <span class="n">refPoints</span><span class="p">,</span> <span class="n">refPpms</span><span class="p">,</span>
          <span class="n">sampledValues</span><span class="p">,</span> <span class="n">sampledSigmas</span><span class="p">,</span>
          <span class="n">pulseProgram</span><span class="p">,</span> <span class="n">dataScale</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="varian2ccpn"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.varian2ccpn">[docs]</a><span class="k">def</span> <span class="nf">varian2ccpn</span><span class="p">(</span><span class="n">varianNuc</span><span class="p">):</span>

  <span class="n">match</span> <span class="o">=</span> <span class="n">nucVarianRe</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">varianNuc</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="ccpn2varian"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.ccpn2varian">[docs]</a><span class="k">def</span> <span class="nf">ccpn2varian</span><span class="p">(</span><span class="n">ccpnNuc</span><span class="p">):</span>

  <span class="n">match</span> <span class="o">=</span> <span class="n">nucCcpnRe</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ccpnNuc</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="getInt"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getInt">[docs]</a><span class="k">def</span> <span class="nf">getInt</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
  <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: field &quot;</span><span class="si">%s</span><span class="s1">&quot; = </span><span class="si">%s</span><span class="s1"> is not an integer:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="getFloat"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getFloat">[docs]</a><span class="k">def</span> <span class="nf">getFloat</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
  <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: field &quot;</span><span class="si">%s</span><span class="s1">&quot; = </span><span class="si">%s</span><span class="s1"> is not a real number:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="getString"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getString">[docs]</a><span class="k">def</span> <span class="nf">getString</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>

  <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
  <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">line</span></div>

<div class="viewcode-block" id="parseProcparFile"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.parseProcparFile">[docs]</a><span class="k">def</span> <span class="nf">parseProcparFile</span><span class="p">(</span><span class="n">procparFile</span><span class="p">):</span>

  <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;procparFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">procparFile</span>

  <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">procparFile</span><span class="p">,</span> <span class="s1">&#39;rU&#39;</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>

    <span class="n">line1</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">line1</span><span class="p">:</span>

      <span class="c1"># Subtype (integer)</span>
      <span class="c1">#  0: undefined</span>
      <span class="c1">#  1: real</span>
      <span class="c1">#  2: string</span>
      <span class="c1">#  3: delay</span>
      <span class="c1">#  4: flag</span>
      <span class="c1">#  5: frequency</span>
      <span class="c1">#  6: pulse</span>
      <span class="c1">#  7: integer</span>

      <span class="c1"># Basictype (integer)</span>
      <span class="c1">#  0: undefined</span>
      <span class="c1">#  1: real</span>
      <span class="c1">#  2: string</span>

      <span class="n">fields</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: need 11 fields, have </span><span class="si">%d</span><span class="s1">:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">line1</span><span class="p">))</span>

      <span class="n">parname</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">subtype</span> <span class="o">=</span> <span class="n">getInt</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;subtype&#39;</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
      <span class="n">basictype</span> <span class="o">=</span> <span class="n">getInt</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;basictype&#39;</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
      <span class="n">active</span> <span class="o">=</span> <span class="n">getInt</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">parname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: name = </span><span class="si">%s</span><span class="s1"> is a repeat:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">parname</span><span class="p">,</span> <span class="n">line1</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">subtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: subtype = </span><span class="si">%d</span><span class="s1">, must be in range 0-7:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">subtype</span><span class="p">,</span> <span class="n">line1</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">basictype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: basictype = </span><span class="si">%d</span><span class="s1">, must be in range 0-2:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">basictype</span><span class="p">,</span> <span class="n">line1</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">basictype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: basictype = </span><span class="si">%d</span><span class="s1">, do not know how to deal with case 0:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">basictype</span><span class="p">,</span> <span class="n">line1</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">active</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: active = </span><span class="si">%d</span><span class="s1">, must be 0 or 1:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">line1</span><span class="p">))</span>

      <span class="n">line2</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">fields</span> <span class="o">=</span> <span class="n">line2</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: need at least 2 fields, have </span><span class="si">%d</span><span class="s1">:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">line2</span><span class="p">))</span>
      <span class="n">value_len</span> <span class="o">=</span> <span class="n">getInt</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;value_len&#39;</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
 
      <span class="k">if</span> <span class="n">basictype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># (real)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">value_len</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;line number </span><span class="si">%d</span><span class="s1">: need </span><span class="si">%d</span><span class="s1"> fields, have </span><span class="si">%d</span><span class="s1">:</span><span class="se">\n</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">value_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">line2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">getVal</span> <span class="ow">in</span> <span class="p">(</span><span class="n">getInt</span><span class="p">,</span> <span class="n">getFloat</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="n">value</span> <span class="o">=</span> <span class="n">getVal</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
              <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
              <span class="k">pass</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">getString</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">for</span> <span class="n">getVal</span> <span class="ow">in</span> <span class="p">(</span><span class="n">getInt</span><span class="p">,</span> <span class="n">getFloat</span><span class="p">):</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">getVal</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="k">break</span>
              <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">val</span> <span class="o">=</span> <span class="n">getString</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span> <span class="c1"># basictype == 2 (string)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">getString</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">if</span> <span class="n">value_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
          <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">value_len</span><span class="p">):</span>
            <span class="n">line2</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getString</span><span class="p">(</span><span class="n">line2</span><span class="p">))</span>

      <span class="n">params</span><span class="p">[</span><span class="n">parname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

      <span class="n">line3</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="n">line1</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="k">finally</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNumDim</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNumPoints</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getSpecFreq</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getSpecWidth</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;nuc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getNuclei</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;refppm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getRefPpm</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;refpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getRefPoint</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ccpnParams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span>

  <span class="k">return</span> <span class="n">dd</span></div>

<span class="c1"># a lot of below is based on Sparky vnmr2ucsf code</span>
<span class="c1"># but in 3D they always transpose D2 and D3, so that needs looking at</span>

<div class="viewcode-block" id="getNumDim"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getNumDim">[docs]</a><span class="k">def</span> <span class="nf">getNumDim</span><span class="p">(</span><span class="n">procparParams</span><span class="p">):</span>

  <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ni&#39;</span><span class="p">,</span> <span class="s1">&#39;ni2&#39;</span><span class="p">,</span> <span class="s1">&#39;ni3&#39;</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">ndim</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">break</span>

  <span class="k">return</span> <span class="n">ndim</span></div>

<div class="viewcode-block" id="getNumPoints"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getNumPoints">[docs]</a><span class="k">def</span> <span class="nf">getNumPoints</span><span class="p">(</span><span class="n">procparParams</span><span class="p">):</span>

  <span class="n">ndim</span> <span class="o">=</span> <span class="n">getNumDim</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span> <span class="s1">&#39;fn1&#39;</span><span class="p">,</span> <span class="s1">&#39;fn2&#39;</span><span class="p">,</span> <span class="s1">&#39;fn3&#39;</span><span class="p">)</span>
  <span class="c1"># /2 because it looks like Varian needs that factor</span>
  <span class="n">npts</span> <span class="o">=</span> <span class="p">[</span><span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)]</span>

  <span class="k">return</span> <span class="n">npts</span></div>

<span class="c1"># this follows instructions from Peter Howe</span>
<span class="c1"># axis is the display axis, so might not be set or might be wrong</span>
<span class="c1"># but this seems to be the only way to get at the isotope</span>
<span class="c1"># and Varian do H1, C13, etc., instead of 1H, 13C, etc.</span>
<div class="viewcode-block" id="getNuclei"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getNuclei">[docs]</a><span class="k">def</span> <span class="nf">getNuclei</span><span class="p">(</span><span class="n">procparParams</span><span class="p">):</span>

  <span class="n">ndim</span> <span class="o">=</span> <span class="n">getNumDim</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>

  <span class="c1"># below maps axis character to key to use to determine isotope</span>
  <span class="n">axisMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="s1">&#39;tn&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;dn&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;dn&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="s1">&#39;dn2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="s1">&#39;dn3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="s1">&#39;dn4&#39;</span><span class="p">}</span>

  <span class="n">axis</span> <span class="o">=</span> <span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;axis&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ndim</span><span class="p">:</span>
    <span class="n">nuclei</span> <span class="o">=</span> <span class="p">[</span><span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axisMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;tn&#39;</span><span class="p">),</span> <span class="s1">&#39;H1&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">[:</span><span class="n">ndim</span><span class="p">]]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">nuclei</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">*</span> <span class="p">[</span><span class="s1">&#39;H1&#39;</span><span class="p">]</span>

  <span class="n">nuclei</span> <span class="o">=</span> <span class="p">[</span><span class="n">varian2ccpn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nuclei</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">nuclei</span></div>

<div class="viewcode-block" id="getSpecFreq"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getSpecFreq">[docs]</a><span class="k">def</span> <span class="nf">getSpecFreq</span><span class="p">(</span><span class="n">procparParams</span><span class="p">):</span>

  <span class="n">nucKeys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tn&#39;</span><span class="p">,</span> <span class="s1">&#39;dn&#39;</span><span class="p">,</span> <span class="s1">&#39;dn2&#39;</span><span class="p">,</span> <span class="s1">&#39;dn3&#39;</span><span class="p">)</span>
  <span class="n">sfKeys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sfrq&#39;</span><span class="p">,</span> <span class="s1">&#39;dfrq&#39;</span><span class="p">,</span> <span class="s1">&#39;dfrq2&#39;</span><span class="p">,</span> <span class="s1">&#39;dfrq3&#39;</span><span class="p">)</span>

  <span class="n">nuclei</span> <span class="o">=</span> <span class="n">getNuclei</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>
  <span class="n">nuclei</span> <span class="o">=</span> <span class="p">[</span><span class="n">ccpn2varian</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nuclei</span><span class="p">]</span>

  <span class="n">sf</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">nucleus</span> <span class="ow">in</span> <span class="n">nuclei</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nucKeys</span><span class="p">):</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">nucleus</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># arbitrary</span>
    <span class="n">sf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sfKeys</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>

  <span class="k">return</span> <span class="n">sf</span></div>

<div class="viewcode-block" id="getSpecWidth"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getSpecWidth">[docs]</a><span class="k">def</span> <span class="nf">getSpecWidth</span><span class="p">(</span><span class="n">procparParams</span><span class="p">):</span>

  <span class="n">ndim</span> <span class="o">=</span> <span class="n">getNumDim</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sw&#39;</span><span class="p">,</span> <span class="s1">&#39;sw1&#39;</span><span class="p">,</span> <span class="s1">&#39;sw2&#39;</span><span class="p">,</span> <span class="s1">&#39;sw3&#39;</span><span class="p">)</span>
  <span class="n">sw</span> <span class="o">=</span> <span class="p">[</span><span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)]</span>

  <span class="k">return</span> <span class="n">sw</span></div>

<div class="viewcode-block" id="getRefPoint"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getRefPoint">[docs]</a><span class="k">def</span> <span class="nf">getRefPoint</span><span class="p">(</span><span class="n">procparParams</span><span class="p">):</span>

  <span class="c1">#npts = getNumPoints(procparParams)</span>
  <span class="c1">#refpt = [1.0+0.5*float(x) for x in npts]</span>

  <span class="n">ndim</span> <span class="o">=</span> <span class="n">getNumDim</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>
  <span class="n">refpt</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">*</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">refpt</span></div>

<div class="viewcode-block" id="getRefPpm"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.getRefPpm">[docs]</a><span class="k">def</span> <span class="nf">getRefPpm</span><span class="p">(</span><span class="n">procparParams</span><span class="p">):</span>

  <span class="n">ndim</span> <span class="o">=</span> <span class="n">getNumDim</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;rfl&#39;</span><span class="p">,</span> <span class="s1">&#39;rfl1&#39;</span><span class="p">,</span> <span class="s1">&#39;rfl2&#39;</span><span class="p">,</span> <span class="s1">&#39;rfl3&#39;</span><span class="p">)</span>
  <span class="n">refloc</span> <span class="o">=</span> <span class="p">[</span><span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)]</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;rfp&#39;</span><span class="p">,</span> <span class="s1">&#39;rfp1&#39;</span><span class="p">,</span> <span class="s1">&#39;rfp2&#39;</span><span class="p">,</span> <span class="s1">&#39;rfp3&#39;</span><span class="p">)</span>
  <span class="n">reffreq</span> <span class="o">=</span> <span class="p">[</span><span class="n">procparParams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)]</span>

  <span class="n">sw</span> <span class="o">=</span> <span class="n">getSpecWidth</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>
  <span class="n">sf</span> <span class="o">=</span> <span class="n">getSpecFreq</span><span class="p">(</span><span class="n">procparParams</span><span class="p">)</span>

  <span class="n">refppm</span> <span class="o">=</span> <span class="p">[((</span><span class="n">sw</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">reffreq</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">refloc</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">/</span> <span class="n">sf</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)]</span>

  <span class="k">return</span> <span class="n">refppm</span></div>

<span class="c1"># file header and block header status bits</span>
<span class="n">VNMR_S_DATA</span>         <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>    <span class="c1"># 0 = no data, 1 = data</span>
<span class="n">VNMR_S_SPEC</span>         <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>    <span class="c1"># 0 = FID, 1 = spectrum</span>
<span class="n">VNMR_S_32</span>           <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>    <span class="c1"># *</span>
<span class="n">VNMR_S_FLOAT</span>        <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>    <span class="c1"># 0 = integer, 1 = floating point</span>
<span class="n">VNMR_S_COMPLEX</span>      <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>    <span class="c1"># 0 = real, 1 = complex</span>
<span class="n">VNMR_S_HYPERCOMPLEX</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>    <span class="c1"># 1 = hypercomplex</span>

<span class="c1"># file header status bits</span>
<span class="n">VNMR_S_ACQPAR</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>    <span class="c1"># 0 = not Acqpar, 1 = Acqpar</span>
<span class="n">VNMR_S_SECND</span>        <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>    <span class="c1"># 0 = first FT, 1 = second FT</span>
<span class="n">VNMR_S_TRANSF</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>    <span class="c1"># 0 = regular, 1 = transposed</span>
<span class="n">VNMR_S_NP</span>           <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>   <span class="c1"># 1 = np dimension is active</span>
<span class="n">VNMR_S_NF</span>           <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>   <span class="c1"># 1 = nf dimension is active</span>
<span class="n">VNMR_S_NI</span>           <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>   <span class="c1"># 1 = ni dimension is active</span>
<span class="n">VNMR_S_NI2</span>          <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>   <span class="c1"># 1 = ni2 dimension is active</span>

<span class="c1"># block header status bits</span>
<span class="n">VNMR_S_MORE_BLOCKS</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>    <span class="c1"># 0 = absent, 1 = present</span>
<span class="n">VNMR_S_NP_COMPLEX</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>    <span class="c1"># 0 = real, 1 = complex</span>
<span class="n">VNMR_S_NF_COMPLEX</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>    <span class="c1"># 0 = real, 1 = complex</span>
<span class="n">VNMR_S_NI_COMPLEX</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>   <span class="c1"># 0 = real, 1 = complex</span>
<span class="n">VNMR_S_NI2_COMPLEX</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>   <span class="c1"># 0 = real, 1 = complex</span>

<div class="viewcode-block" id="readDataFileHeader"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.readDataFileHeader">[docs]</a><span class="k">def</span> <span class="nf">readDataFileHeader</span><span class="p">(</span><span class="n">dataFile</span><span class="p">):</span>

  <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;dataFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataFile</span>

  <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataFile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">VNMR_FILE_HEADER_SIZE</span><span class="p">)</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VNMR_FILE_HEADER_SIZE</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;dataFile is of size </span><span class="si">%d</span><span class="s1"> &lt; </span><span class="si">%d</span><span class="s1">, which is header size&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="n">VNMR_FILE_HEADER_SIZE</span><span class="p">))</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>  <span class="c1"># integer</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>  <span class="c1"># unsigned short</span>
  <span class="n">x</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
  <span class="n">y</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
  <span class="n">ebytes</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
  <span class="n">swapped</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="k">if</span> <span class="n">ebytes</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ebytes</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
    <span class="n">y</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
    <span class="n">swapped</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;nblocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># number of blocks in file</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ntraces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="c1"># number of traces per block</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>         <span class="c1"># number of elements per trace</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ebytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>     <span class="c1"># number of bytes per element</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tbytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>     <span class="c1"># number of bytes per trace</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bbytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>     <span class="c1"># number of bytes per block</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;vers_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>   <span class="c1"># software version, file_id status bits</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>    <span class="c1"># status of whole file</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;nbheaders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="c1"># number of block headers per block</span>

  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;swapped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapped</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_DATA</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_spec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_SPEC</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_32&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_32</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_float&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_FLOAT</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_complex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_COMPLEX</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_hypercomplex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_HYPERCOMPLEX</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_acqpar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_ACQPAR</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_secnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_SECND</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_transf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_TRANSF</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_np&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_NP</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_nf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_NF</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_ni&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_NI</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_ni2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_NI2</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  
  <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_data&#39;</span><span class="p">]:</span>
    <span class="n">determineFirstDataBlock</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;firstBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="determineFirstDataBlock"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.determineFirstDataBlock">[docs]</a><span class="k">def</span> <span class="nf">determineFirstDataBlock</span><span class="p">(</span><span class="n">dataFileParams</span><span class="p">):</span>

  <span class="k">for</span> <span class="n">firstBlock</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;nblocks&#39;</span><span class="p">]):</span>
    <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;firstBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstBlock</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">readDataBlockHeader</span><span class="p">(</span><span class="n">dataFileParams</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_data&#39;</span><span class="p">]:</span>
      <span class="k">break</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;firstBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># arbitrary</span></div>
 
<div class="viewcode-block" id="readDataBlockHeader"><a class="viewcode-back" href="../../../../../../ccpnmodel/ccpnmodel.ccpncore.lib.spectrum.formats.html#ccpnmodel.ccpncore.lib.spectrum.formats.Varian.readDataBlockHeader">[docs]</a><span class="k">def</span> <span class="nf">readDataBlockHeader</span><span class="p">(</span><span class="n">dataFileParams</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

  <span class="n">dataFile</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;dataFile&#39;</span><span class="p">]</span>
  <span class="n">nbheaders</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;nbheaders&#39;</span><span class="p">]</span>
  <span class="n">nblocks</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;nblocks&#39;</span><span class="p">]</span>
  <span class="n">np</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">]</span>
  <span class="n">ntraces</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;ntraces&#39;</span><span class="p">]</span>
  <span class="n">swapped</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;swapped&#39;</span><span class="p">]</span>
  <span class="n">firstBlock</span> <span class="o">=</span> <span class="n">dataFileParams</span><span class="p">[</span><span class="s1">&#39;firstBlock&#39;</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">block</span> <span class="o">&gt;=</span> <span class="n">nblocks</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;block = </span><span class="si">%d</span><span class="s1">, must be in range 0 to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">nblocks</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

  <span class="n">block</span> <span class="o">+=</span> <span class="n">firstBlock</span>

  <span class="n">block_size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span> <span class="o">*</span> <span class="n">ntraces</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">VNMR_FILE_HEADER_SIZE</span> <span class="o">+</span> <span class="n">block</span><span class="o">*</span><span class="p">(</span><span class="n">nbheaders</span><span class="o">*</span><span class="n">VNMR_BLOCK_HEADER_SIZE</span><span class="o">+</span><span class="n">block_size</span><span class="p">)</span>

  <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataFile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">VNMR_BLOCK_HEADER_SIZE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbheaders</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">header1</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">VNMR_BLOCK_HEADER_SIZE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">header1</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VNMR_BLOCK_HEADER_SIZE</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;header for block </span><span class="si">%d</span><span class="s1"> only read as size </span><span class="si">%d</span><span class="s1">, expecting </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="n">VNMR_BLOCK_HEADER_SIZE</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">header1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">header1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VNMR_BLOCK_HEADER_SIZE</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;header1 for block </span><span class="si">%d</span><span class="s1"> only read as size </span><span class="si">%d</span><span class="s1">, expecting </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header1</span><span class="p">),</span> <span class="n">VNMR_BLOCK_HEADER_SIZE</span><span class="p">))</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>  <span class="c1"># integer</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>  <span class="c1"># unsigned short</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>  <span class="c1"># float</span>
  <span class="n">x</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
  <span class="n">y</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
  <span class="n">z</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">swapped</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
    <span class="n">y</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
    <span class="n">z</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>

  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ctcount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lpval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rpval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lvl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tlt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_DATA</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_spec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_SPEC</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_32&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_32</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_float&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_FLOAT</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_complex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_COMPLEX</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;s_hypercomplex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VNMR_S_HYPERCOMPLEX</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">True</span> <span class="ow">or</span> <span class="bp">False</span>

  <span class="k">if</span> <span class="n">header1</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>  <span class="c1"># unsigned short</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>  <span class="c1"># float</span>
    <span class="n">y</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header1</span><span class="p">)</span>
    <span class="n">z</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">swapped</span><span class="p">:</span>
      <span class="n">y</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
      <span class="n">z</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;status1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lpval1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rpval1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">params</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">Python  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>